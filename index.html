<!DOCTYPE html>
<html lang="it" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- NUOVO: Content Security Policy per una maggiore sicurezza -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net/npm/chart.js https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' https: data:;
        connect-src 'self';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <title>App Gestione PCA - CHRYSAS (Versione Definitiva)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js" defer></script>
    
    <!-- MODIFICATO: Stili completamente riscritti per la sidebar e miglioramenti UI -->
    <style>
        :root {
            --print-header-bg: #f2f2f2;
            --print-border-color: #999;
            --print-text-primary: #000;
            --print-text-secondary: #333;
        }

        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .dark body { background-color: #0f172a; }

        /* --- Logica Sidebar Riscostruita --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 16rem; /* w-64 */
            transition: transform 0.3s ease-in-out;
            will-change: transform;
            z-index: 1000;
        }

        #main-container {
            transition: padding-left 0.3s ease-in-out;
        }

        /* Stili Mobile (< 1024px) */
        @media (max-width: 1023px) {
            #sidebar {
                transform: translateX(-100%); /* Nascosta di default */
            }
            .sidebar-open #sidebar {
                transform: translateX(0); /* Mostrata con .sidebar-open sul contenitore */
            }
            #main-container {
                padding-left: 0;
            }
            .sidebar-overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
                z-index: 999;
            }
            .sidebar-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
        }

        /* Stili Desktop (>= 1024px) */
        @media (min-width: 1024px) {
            #sidebar {
                transform: translateX(0); /* Visibile di default */
            }
            #main-container {
                padding-left: 16rem; /* Contenuto spostato */
            }
            .sidebar-collapsed #sidebar {
                transform: translateX(-100%); /* Nascosta con .sidebar-collapsed sul contenitore */
            }
            .sidebar-collapsed #main-container {
                padding-left: 0;
            }
            .sidebar-overlay {
                display: none; /* Overlay non necessario */
            }
        }

        .sidebar-link { transition: background-color 0.2s, color 0.2s; }
        .sidebar-link.active { @apply bg-blue-600 text-white font-semibold; }
        
        /* --- UI Generale --- */
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s, transform 0.3s; z-index: 1050; }
        .toast.show { opacity: 1; bottom: 40px; transform: translateX(-50%) scale(1); }
        button, .sidebar-link { transition: all 0.2s ease-in-out; }
        button:hover:not(:disabled), .sidebar-link:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        button:active:not(:disabled) { transform: translateY(0px); box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .content-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1040; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .dark .modal-box { background-color: #1e293b; }

        .accordion-header { cursor: pointer; transition: background-color 0.2s; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; }
        .accordion-content.open { max-height: 5000px; padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-header.open .accordion-icon { transform: rotate(180deg); }

        @media print {
            body, #print-area { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; }
            @page { size: A4; margin: 1.5cm; }
        }
        .form-input:invalid, .form-select:invalid, .form-textarea:invalid { border-color: #ef4444; }
        .hidden { display: none; }
    </style>
    
    <script id="app-script" defer>
    document.addEventListener('DOMContentLoaded', () => {

    const App = {
        config: {
            STORAGE_KEY: 'pca_app_data_idb_v11',
            TABS: [
                { id: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>' },
                { id: 'lista-pca', label: 'Lista Controlli', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' },
                { id: 'nuovo-pca', label: 'Esegui Controllo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' },
                { id: 'impostazioni', label: 'Impostazioni', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>' }
            ],
             CHECK_TEMPLATES_PERIODIC: [
                { id: "pca01", title: "PCA 01: Scarichi Idrici ed Approvvigionamento", icon: "üíß", significativita: "ALTA", items: ["Autorizzazione allo scarico acque reflue domestiche presente e valida?", "Autorizzazione allo scarico acque reflue industriali presente e valida?", "Rispetto delle prescrizioni contenute nelle autorizzazioni?", "Corretta gestione acque di lavorazione (es. scavo pali)?", "Kit di emergenza anti-sversamento presente e completo?", "Manutenzione impianti di depurazione/trattamento registrata?"] },
                { id: "pca02", title: "PCA 02: Terre e Rocce da Scavo", icon: "‚õ∞Ô∏è", significativita: "ALTA", items: ["Aree di stoccaggio temporaneo identificate e conformi al PUT?", "Separazione dei cumuli per categorie omogenee?", "Documento di Trasporto (DDT) per le terre conforme e presente?", "Copertura dei cassoni dei mezzi in transito?"] },
                { id: "pca03", title: "PCA 03: Emissioni in Atmosfera", icon: "üí®", significativita: "ALTA", items: ["Autorizzazioni per impianti (es. calcestruzzo) presenti e valide?", "Copertura mezzi per trasporto materiali polverulenti?", "Bagnatura piste e/o cumuli eseguita regolarmente?", "Velocit√† dei mezzi in cantiere limitata a 30 km/h?", "Impianto lavaruote funzionante ed utilizzato?"] },
                { id: "pca04", title: "PCA 04: Rifiuti", icon: "üóëÔ∏è", significativita: "ALTA", items: ["Deposito temporaneo (DTR) ordinato e pulito?", "Rifiuti separati per CER e con corretta cartellonistica?", "Stoccaggio rifiuti pericolosi conforme (aree, bacini)?", "Registro di carico/scarico aggiornato (entro 10gg)?", "Quarta copia FIR ricevuta entro 90 giorni?"] },
                { id: "pca05", title: "PCA 05: Sostanze Pericolose ed Emergenze", icon: "‚ò£Ô∏è", significativita: "MEDIA", items: ["Schede di Sicurezza (SDS) disponibili e aggiornate?", "Stoccaggio sostanze su bacini di contenimento idonei?", "Aree di stoccaggio segnalate e adeguate?", "Personale formato per la gestione delle emergenze?"] },
                { id: "pca06", title: "PCA 06: Rumore e Vibrazioni", icon: "üîä", significativita: "MEDIA", items: ["Autorizzazione in deroga per rumore presente (se necessaria)?", "Rispetto degli orari di lavoro previsti?", "Barriere acustiche (se previste) integre ed efficaci?", "Manutenzione ordinaria dei mezzi per ridurre il rumore?", "Eseguita misurazione fonometrica periodica?"] },
                { id: "pca07", title: "PCA 07: Suolo e Sottosuolo", icon: "üå±", significativita: "ALTA", items: ["Assenza di contaminazioni visive del suolo (macchie, sversamenti)?", "Corretto stoccaggio del terreno vegetale in cumuli separati?", "Utilizzo delle apposite vasche per lavaggio betoniere?", "Gestione corretta del calcestruzzo in esubero?"] },
                { id: "pca08", title: "PCA 08: Beni Culturali e Archeologici", icon: "üè∫", significativita: "ALTA", items: ["Presenza di archeologo durante le attivit√† di scavo?", "Notifica agli enti competenti in caso di ritrovamento?", "Corretta gestione e inventario dei reperti?", "Disboscamento limitato alle aree strettamente necessarie?"] }
            ],
            WBS_DATA: { 'GA': { descrizione: 'Gallerie Artificiali', lavorazioni: ['Scavo di sbancamento', 'Posa armature e getti CLS', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti'] }, 'GN': { descrizione: 'Gallerie Naturali', lavorazioni: ['Scavo in naturale', 'Consolidamenti (spritz-beton, centine)', 'Rivestimenti e impermeabilizzazioni'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti', 'Vibrazioni'] }, 'AS': { descrizione: 'Opere in Sotterraneo', lavorazioni: ['Scavi e rivestimenti', 'Opere di sostegno e drenaggi'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Consumi'] }, 'TR': { descrizione: 'Trincee', lavorazioni: ['Scavi di trincea', 'Opere di sostegno (pali, diaframmi)', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Beni Culturali'] }, 'RI': { descrizione: 'Rilevati', lavorazioni: ['Formazione corpo del rilevato', 'Opere di sostegno', 'Sistemazioni idrauliche'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'VI': { descrizione: 'Viadotti', lavorazioni: ['Pali di fondazione e fondazioni', 'Elevazione pile e spalle', 'Varo impalcato e soletta'], aspetti: ['Rumore', 'Vibrazioni', 'Rifiuti', 'Sostanze Pericolose'] }, 'CB': { descrizione: 'Campo Base', lavorazioni: ['Installazione e gestione uffici/dormitori/mensa', 'Manutenzione aree e servizi'], aspetti: ['Acque', 'Rifiuti', 'Rumore', 'Consumi'] }, 'CO': { descrizione: 'Cantiere Operativo', lavorazioni: ['Allestimento aree stoccaggio', 'Gestione impianto di betonaggio', 'Officina e manutenzione mezzi'], aspetti: ['Polveri', 'Rumore', 'Acque', 'Rifiuti', 'Sostanze Pericolose'] }, 'NV': { descrizione: 'Nuova Viabilit√†', lavorazioni: ['Scavi e rilevati per nuova viabilit√†', 'Formazione sottofondi e pavimentazioni', 'Opere idrauliche e finiture'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'FA': { descrizione: 'Fabbricati', lavorazioni: ['Scavi e fondazioni', 'Elevazione strutture', 'Finiture e impianti'], aspetti: ['Polveri', 'Rumore', 'Rifiuti', 'Consumi'] } },
            ASPETTO_TO_PCA_ID_MAP: { 'Polveri': 'pca03', 'Rumore': 'pca06', 'Vibrazioni': 'pca06', 'Acque': 'pca01', 'Suolo': 'pca07', 'Rifiuti': 'pca04', 'Terre e Rocce': 'pca02', 'Sostanze Pericolose': 'pca05', 'Rifornimenti': 'pca05', 'Consumi': 'pca05', 'Beni Culturali': 'pca08' },
            FREQUENCY_MAP: { 'ALTA': { text: 'FREQUENZA ALTA', schedule: '(es. settimanale)', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', days: 7 }, 'MEDIA': { text: 'FREQUENZA MEDIA', schedule: '(es. quindicinale)', color: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300', days: 15 }, 'BASSA': { text: 'FREQUENZA BASSA', schedule: '(es. mensile)', color: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300', days: 30 } },
            CHECK_TEMPLATES_PRELIMINARE: [{ id: "stato_luoghi", title: "Verifica Stato dei Luoghi (Punto Zero)", icon: "üìç", items: ["Analisi vincoli specifici e servit√π completata", "Mappatura recettori sensibili eseguita", "Stato della vegetazione documentato", "Verificata assenza di rifiuti preesistenti", "Verificata assenza di contaminazione pregressa"] }],
            CHECK_TEMPLATES_FINALE: [{ id: "ripristino", title: "Verifica Ripristino Finale", icon: "‚úÖ", items: ["Area riconsegnata come da verbale preliminare", "Completa rimozione rifiuti e attrezzature", "Opere di ripristino ambientale eseguite", "Assenza di impatti residui visibili"] }],
            WBS_SIGNIFICANCE_MAP: {},
        },
        state: { isSaving: false, tempPhotos: {}, activeChart: null, data: [], isSidebarOpen: localStorage.getItem('sidebarOpen') === 'true' },
        dom: {},
        
        async init() {
            this.dom = {
                appContainer: document.getElementById('app-container'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarNav: document.getElementById('sidebar-nav'),
                mainContent: document.getElementById('main-content'),
                pageTitle: document.getElementById('page-title'),
                currentDate: document.getElementById('current-date'),
                toast: document.getElementById('toast'),
                printArea: document.getElementById('print-area'),
                modal: document.getElementById('modal-overlay'),
                theme: { toggleBtn: document.getElementById('theme-toggle'), darkIcon: document.getElementById('theme-toggle-dark-icon'), lightIcon: document.getElementById('theme-toggle-light-icon') },
                sidebarToggleBtn: document.getElementById('sidebar-toggle-btn')
            };
            this.ui.renderNav();
            this._computeWbsSignificance();
            this.handlers.attachGlobalListeners();
            this.ui.applyTheme(localStorage.getItem('theme') === 'dark', true);
            this.ui.setSidebarState(this.state.isSidebarOpen);
            this.state.data = await this.store.getAll();
            await this.ui.showTab('dashboard');
        },
        
        _computeWbsSignificance() {
            const significanceValues = { 'ALTA': 2, 'MEDIA': 1, 'BASSA': 0 };
            for (const wbsCode in this.config.WBS_DATA) {
                const wbsData = this.config.WBS_DATA[wbsCode];
                let maxSignificance = -1;
                const requiredPcaIds = new Set(wbsData.aspetti.map(a => this.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                requiredPcaIds.forEach(pcaId => {
                    const template = this.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === pcaId);
                    if (template && template.significativita) {
                        const sigValue = significanceValues[template.significativita];
                        if (sigValue > maxSignificance) { maxSignificance = sigValue; }
                    }
                });
                const significanceKey = Object.keys(significanceValues).find(key => significanceValues[key] === maxSignificance);
                if (significanceKey) { this.config.WBS_SIGNIFICANCE_MAP[wbsCode] = significanceKey; }
            }
        },

        store: {
            dbStore: idbKeyval.createStore('pca-db', 'reports'),
            async getAll() { return (await idbKeyval.get(App.config.STORAGE_KEY, this.dbStore)) || []; },
            async saveAll(reports) {
                await idbKeyval.set(App.config.STORAGE_KEY, reports, this.dbStore);
                App.state.data = reports;
            },
            async getById(id) {
                const reports = await this.getAll();
                return reports.find(r => r.id === parseInt(id));
            },
            async save(newReport) {
                const reports = await this.getAll();
                const reportId = parseInt(newReport.id);
                const existingIndex = reports.findIndex(r => parseInt(r.id) === reportId);
                if (existingIndex !== -1) {
                    reports[existingIndex] = newReport;
                } else {
                    reports.push(newReport);
                }
                await this.saveAll(reports);
            },
            async delete(id) {
                let reports = await this.getAll();
                reports = reports.filter(r => r.id !== parseInt(id));
                await this.saveAll(reports);
            },
            async getNextId() {
                const reports = await this.getAll();
                return (reports.reduce((max, r) => Math.max(max, parseInt(r.id) || 0), 0) + 1);
            },
            getDashboardStats() {
                const reports = App.state.data; let openNc = 0, totalChecks = 0, compliantChecks = 0; const ncByAspect = {};
                reports.forEach(report => {
                    if (report.type === 'periodico' && report.checks) {
                        Object.entries(report.checks).forEach(([aspectId, aspectChecks]) => {
                            const template = App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === aspectId);
                            if (!template || !aspectChecks) return;
                            aspectChecks.forEach(check => {
                                if (check.result && check.result !== 'NA') {
                                    totalChecks++;
                                    if (check.result === 'C') compliantChecks++;
                                    if (check.result === 'NC') {
                                        openNc++;
                                        ncByAspect[template.title] = (ncByAspect[template.title] || 0) + 1;
                                    }
                                }
                            });
                        });
                    }
                });
                const avgCompliance = totalChecks > 0 ? `${((compliantChecks / totalChecks) * 100).toFixed(0)}%` : 'N.D.';
                return { totalPca: reports.length, openNc, totalChecks, avgCompliance, ncByAspect };
            },
        },
        
        ui: {
            renderMap: { 'dashboard': 'renderDashboard', 'lista-pca': 'renderListaPca', 'nuovo-pca': 'renderNuovoPca', 'impostazioni': 'renderImpostazioni' },
            showToast(message, type = 'success') {
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
                App.dom.toast.textContent = message;
                App.dom.toast.className = `toast px-6 py-3 rounded-lg text-white font-medium shadow-lg ${colors[type]}`;
                setTimeout(() => { App.dom.toast.classList.add('show'); }, 10);
                setTimeout(() => { App.dom.toast.classList.remove('show'); }, 4000);
            },
            showModal(config) {
                return new Promise((resolve) => {
                    const { title, message, confirmText = 'Conferma', cancelText = 'Annulla', confirmColor = 'bg-red-600' } = config;
                    App.dom.modal.innerHTML = `
                        <div class="modal-box">
                            <h3 class="text-xl font-bold mb-4">${this.sanitize(title)}</h3>
                            <p class="text-slate-600 dark:text-slate-300 mb-6">${this.sanitize(message)}</p>
                            <div class="flex justify-end gap-4">
                                <button id="modal-cancel" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">${this.sanitize(cancelText)}</button>
                                <button id="modal-confirm" class="px-5 py-2 text-white rounded-md ${confirmColor} hover:opacity-90 font-semibold">${this.sanitize(confirmText)}</button>
                            </div>
                        </div>`;
                    App.dom.modal.classList.add('visible');
                    
                    const confirmBtn = document.getElementById('modal-confirm');
                    const cancelBtn = document.getElementById('modal-cancel');
                    const closeModal = (decision) => {
                        App.dom.modal.classList.remove('visible');
                        resolve(decision);
                    };
                    confirmBtn.onclick = () => closeModal(true);
                    cancelBtn.onclick = () => closeModal(false);
                    App.dom.modal.onclick = (e) => { if (e.target === App.dom.modal) closeModal(false); };
                });
            },
            async showTab(tabId) {
                const tab = App.config.TABS.find(t => t.id === tabId);
                if (!tab) return;
                App.dom.sidebarNav.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.dataset.tabId === tabId));
                App.dom.pageTitle.textContent = tab.label;
                
                App.dom.mainContent.classList.remove('content-fade-in');
                void App.dom.mainContent.offsetWidth;

                const renderFunctionName = this.renderMap[tabId];
                if (this[renderFunctionName]) await this[renderFunctionName]();
                
                App.dom.mainContent.classList.add('content-fade-in');
            },
            renderNav() { App.dom.sidebarNav.innerHTML = App.config.TABS.map(t => `<a href="#" data-tab-id="${t.id}" class="sidebar-link flex items-center px-4 py-3 mt-2 text-slate-600 dark:text-slate-300 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">${t.icon} ${t.label}</a>`).join(''); },
            renderDashboard() {
                const stats = App.store.getDashboardStats();
                const frequencyStatuses = this.getFrequencyStatuses();
                App.dom.mainContent.innerHTML = App.templates.dashboard(stats, frequencyStatuses.dueList);
                const ctx = document.getElementById('ncChart')?.getContext('2d');
                if (!ctx) return;
                if (App.state.activeChart) App.state.activeChart.destroy();
                App.state.activeChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(stats.ncByAspect).map(l => l.substring(l.indexOf(':') + 1).trim()), datasets: [{ data: Object.values(stats.ncByAspect), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false }, tooltip: { displayColors: false } } } });
            },
            renderImpostazioni() {
                App.dom.mainContent.innerHTML = App.templates.settings();
                App.handlers.attachSettingsListeners();
            },
            renderListaPca() {
                const reports = [...App.state.data].sort((a, b) => (parseInt(b.id) || 0) - (parseInt(a.id) || 0));
                const frequencyStatuses = this.getFrequencyStatuses();
                App.dom.mainContent.innerHTML = App.templates.pcaList(reports, frequencyStatuses.statusMap);
                App.handlers.attachPcaListListeners();
            },
            getFrequencyStatuses() {
                const reports = App.state.data;
                const latestReportByWbs = {};
                [...reports].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                    if (r.type === 'periodico' && r.wbs) {
                        const wbsCode = r.wbs.substring(0, 2).toUpperCase();
                        if (!latestReportByWbs[wbsCode]) {
                            latestReportByWbs[wbsCode] = r;
                        }
                    }
                });

                const statusMap = {};
                const dueList = [];
                const now = new Date();
                
                for (const wbsCode in App.config.WBS_SIGNIFICANCE_MAP) {
                    const significance = App.config.WBS_SIGNIFICANCE_MAP[wbsCode];
                    if (!significance) continue;

                    const report = latestReportByWbs[wbsCode];
                    const interval = App.config.FREQUENCY_MAP[significance].days;
                    
                    if(report) {
                        const lastDate = new Date(report.date + 'T00:00:00');
                        const dueDate = new Date(new Date(report.date + 'T00:00:00').setDate(lastDate.getDate() + interval));
                        const daysDiff = (dueDate - now) / (1000 * 3600 * 24);
                        
                        let status;
                        if (daysDiff < 0) {
                            status = { text: 'Scaduto', color: 'bg-red-100 text-red-800', icon: 'üî•', nextDate: dueDate };
                            dueList.push({ wbs: wbsCode, status: status, days: Math.round(daysDiff) });
                        } else if (daysDiff <= 3) {
                            status = { text: 'In Scadenza', color: 'bg-yellow-100 text-yellow-800', icon: '‚ö†Ô∏è', nextDate: dueDate };
                            dueList.push({ wbs: wbsCode, status: status, days: Math.round(daysDiff) });
                        } else {
                            status = { text: 'OK', color: 'bg-green-100 text-green-800', icon: '‚úÖ', nextDate: dueDate };
                        }
                        statusMap[wbsCode] = status;

                    } else {
                        const status = { text: 'Da Eseguire', color: 'bg-gray-200 text-gray-800', icon: '‚û°Ô∏è', nextDate: null };
                        statusMap[wbsCode] = status;
                        dueList.push({ wbs: wbsCode, status: status, days: -Infinity });
                    }
                }
                dueList.sort((a,b) => a.days - b.days);
                return { statusMap, dueList };
            },
            async renderNuovoPca() {
                const nextId = await App.store.getNextId();
                const today = new Date().toISOString().slice(0, 10);
                App.dom.mainContent.innerHTML = App.templates.newPcaForm({ nextId, today });
                App.handlers.attachNewPcaFormListeners();
                this.updateFormRequirements('periodico');
            },
            updateFormRequirements(type) {
                const isPeriodico = type === 'periodico';
                document.getElementById('wbs-section').style.display = isPeriodico ? 'block' : 'none';
                document.getElementById('manual-section').style.display = isPeriodico ? 'none' : 'block';
                document.getElementById('checklist-container-periodico').style.display = isPeriodico ? 'block' : 'none';
                document.getElementById('checklist-container-preliminare').style.display = type === 'preliminare' ? 'block' : 'none';
                document.getElementById('checklist-container-finale').style.display = type === 'finale' ? 'block' : 'none';
                
                const wbsInputs = ['pca-wbs-input', 'pca-lavorazione-select', 'pca-inspector-wbs'];
                const manualInputs = ['wbs-manual', 'inspector-manual', 'activities-manual'];
                
                wbsInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', isPeriodico));
                manualInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', !isPeriodico));
            },
            applyTheme(isDark, isInitial = false) {
                document.documentElement.classList.toggle('dark', isDark);
                App.dom.theme.darkIcon.classList.toggle('hidden', !isDark);
                App.dom.theme.lightIcon.classList.toggle('hidden', isDark);
                if (!isInitial) localStorage.setItem('theme', isDark ? 'dark' : 'light');
            },
            // MODIFICATO: Logica di gestione dello stato della sidebar corretta
            setSidebarState(isOpen) {
                App.state.isSidebarOpen = isOpen;
                localStorage.setItem('sidebarOpen', isOpen.toString());
                
                if (window.innerWidth < 1024) {
                    // Mobile: usa .sidebar-open per mostrare la sidebar come overlay
                    App.dom.appContainer.classList.toggle('sidebar-open', isOpen);
                    App.dom.sidebarOverlay.classList.toggle('visible', isOpen);
                } else {
                    // Desktop: usa .sidebar-collapsed per nascondere la sidebar e spostare il contenuto
                    App.dom.appContainer.classList.toggle('sidebar-collapsed', !isOpen);
                }
            },
            toggleSidebar() {
                this.setSidebarState(!App.state.isSidebarOpen);
            },
            resetPcaForm: () => { App.state.tempPhotos = {}; App.ui.renderNuovoPca(); },
            async prepareAndPrintReport(reportId) {
                const report = await App.store.getById(reportId);
                if (!report) return App.ui.showToast("Report non trovato", "error");
                let templates;
                if (report.type === 'preliminare') templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                else if (report.type === 'finale') templates = App.config.CHECK_TEMPLATES_FINALE;
                else templates = App.config.CHECK_TEMPLATES_PERIODIC;
                App.dom.printArea.innerHTML = App.templates.printReport(report, templates);
                setTimeout(() => window.print(), 100);
            },
            sanitize(str) {
                if (typeof str !== 'string') return str;
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }
        },

        handlers: {
            // MODIFICATO: Listener globali migliorati per la sidebar e aggiunto listener per resize
            attachGlobalListeners() {
                // Click su una voce di menu
                App.dom.sidebarNav.addEventListener('click', e => { 
                    const link = e.target.closest('.sidebar-link');
                    if (link) { 
                        e.preventDefault(); 
                        App.ui.showTab(link.dataset.tabId);
                        // Su mobile, chiudi sempre la sidebar dopo la selezione
                        if(window.innerWidth < 1024) { 
                            App.ui.setSidebarState(false); 
                        }
                    } 
                });
                
                // Toggle del tema
                App.dom.theme.toggleBtn.addEventListener('click', () => App.ui.applyTheme(!document.documentElement.classList.contains('dark')));
                
                // Bottone principale per aprire/chiudere la sidebar
                App.dom.sidebarToggleBtn.addEventListener('click', () => App.ui.toggleSidebar());
                
                // Overlay scuro (chiude la sidebar su mobile)
                App.dom.sidebarOverlay.addEventListener('click', () => App.ui.setSidebarState(false));
                
                // Data corrente
                App.dom.currentDate.textContent = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                // NUOVO: Gestione del ridimensionamento della finestra per la sidebar
                window.addEventListener('resize', () => {
                    App.ui.setSidebarState(App.state.isSidebarOpen);
                });
            },
            attachPcaListListeners() {
                App.dom.mainContent.addEventListener('click', async (e) => {
                    const printBtn = e.target.closest('.print-pca-btn');
                    const deleteBtn = e.target.closest('.delete-pca-btn');
                    if (printBtn) this.onPrintPca(printBtn.dataset.id);
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        const confirmed = await App.ui.showModal({
                            title: 'Conferma Eliminazione',
                            message: `Sei sicuro di voler eliminare il Controllo N¬∞ ${id}? L'azione √® irreversibile.`,
                            confirmText: 'Elimina',
                            confirmColor: 'bg-red-600'
                        });
                        if (confirmed) this.onDeletePca(id);
                    }
                });
            },
            onPrintPca: (id) => App.ui.prepareAndPrintReport(id),
            async onDeletePca(reportId) {
                await App.store.delete(reportId);
                App.ui.showToast(`Controllo N¬∞ ${reportId} eliminato.`, 'info');
                await App.ui.showTab('lista-pca');
            },
            attachNewPcaFormListeners() {
                const form = document.getElementById('new-pca-form'); if (!form) return;
                form.addEventListener('submit', (e) => this.onNewPcaSubmit(e));
                form.addEventListener('click', (e) => { 
                    if (e.target.matches('.add-photo-btn')) e.target.previousElementSibling.click(); 
                    if (e.target.matches('#cancel-pca-btn')) App.ui.resetPcaForm();
                    if (e.target.id === 'add-cer-row-btn') this.addCerRow();
                    if (e.target.closest('.cer-delete-row-btn')) e.target.closest('.cer-row').remove();
                    
                    const accordionHeader = e.target.closest('.accordion-header');
                    if (accordionHeader) {
                        const content = accordionHeader.nextElementSibling;
                        accordionHeader.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
                form.querySelectorAll('.photo-input').forEach(i => i.addEventListener('change', (e) => this.onPhotoUpload(e)));
                form.addEventListener('change', (e) => {
                    if (e.target.type === 'radio' && e.target.name.startsWith('check_')) {
                        const extraContentId = `extra_content_wrapper_${e.target.name}`;
                        const extraContentEl = document.getElementById(extraContentId);
                        if (extraContentEl) {
                            const isCompliant = e.target.value === 'C';
                            extraContentEl.classList.toggle('visible', isCompliant);
                            extraContentEl.querySelectorAll('input, select, textarea').forEach(input => {
                                input.toggleAttribute('required', isCompliant);
                            });
                        }
                    }
                });
                document.getElementById('pca-type')?.addEventListener('change', (e) => App.ui.updateFormRequirements(e.target.value));
                document.getElementById('pca-wbs-input')?.addEventListener('input', (e) => {
                    const wbsCodeFull = e.target.value.toUpperCase(); const wbsCode = wbsCodeFull.substring(0, 2); const wbsData = App.config.WBS_DATA[wbsCode]; const lavorazioneSelect = document.getElementById('pca-lavorazione-select');
                    
                    const accordionContents = document.querySelectorAll('#checklist-container-periodico .accordion-content');
                    const accordionHeaders = document.querySelectorAll('#checklist-container-periodico .accordion-header');
                    
                    lavorazioneSelect.innerHTML = '<option value="">-- Prima inserisci WBS --</option>';
                    lavorazioneSelect.disabled = true;
                    document.querySelectorAll('.pca-sheet-accordion').forEach(el => el.style.display = 'none');
                    accordionContents.forEach(c => c.classList.remove('open'));
                    accordionHeaders.forEach(h => h.classList.remove('open'));


                    if (wbsData && wbsCodeFull.length >= 2) {
                        lavorazioneSelect.innerHTML = '<option value="">-- Seleziona Lavorazione --</option>';
                        wbsData.lavorazioni.forEach(lav => { const option = document.createElement('option'); option.value = lav; option.textContent = lav; lavorazioneSelect.appendChild(option); });
                        lavorazioneSelect.disabled = false;
                        
                        const requiredPcaIds = new Set(wbsData.aspetti.map(a => App.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                        let firstAccordionEl = null;

                        requiredPcaIds.forEach((sheetId, index) => { 
                            const accordionEl = document.getElementById(`accordion-${sheetId}`);
                            if (accordionEl) {
                                accordionEl.style.display = 'block';
                                if (index === 0) {
                                    firstAccordionEl = accordionEl;
                                }
                            }
                        });

                        if (firstAccordionEl) {
                            const header = firstAccordionEl.querySelector('.accordion-header');
                            const content = firstAccordionEl.querySelector('.accordion-content');
                            header.classList.add('open');
                            content.classList.add('open');
                        }
                    }
                });
            },
            async onNewPcaSubmit(e) {
                e.preventDefault();
                if (App.state.isSaving) return;
                App.state.isSaving = true;
                const saveBtn = document.getElementById('save-pca-btn');
                if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Salvando...</span>`; }

                try {
                    const form = e.target;
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        throw new Error('Compilare tutti i campi obbligatori.');
                    }
                    const formData = new FormData(form);
                    const reportType = formData.get('type');
                    
                    const sanitize = App.ui.sanitize;
                    const newReport = { 
                        id: parseInt(formData.get('id')), 
                        type: sanitize(reportType), 
                        date: sanitize(formData.get('date')), 
                        inspector: sanitize(reportType === 'periodico' ? formData.get('inspector-wbs') : formData.get('inspector-manual')), 
                        wbs: sanitize(reportType === 'periodico' ? formData.get('wbs-input') : formData.get('wbs-manual')), 
                        activities: sanitize(reportType === 'periodico' ? formData.get('lavorazione') : formData.get('activities-manual')), 
                        checks: {}, 
                        observations: {}, 
                        photos: {},
                        extras: {},
                        cerData: []
                    };

                    let templates;
                    if (reportType === 'preliminare') templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                    else if (reportType === 'finale') templates = App.config.CHECK_TEMPLATES_FINALE;
                    else templates = App.config.CHECK_TEMPLATES_PERIODIC;

                    templates.forEach(template => {
                        const sheetElement = document.getElementById(`accordion-${template.id}`);
                        if (sheetElement && window.getComputedStyle(sheetElement).display !== 'none') {
                            newReport.checks[template.id] = template.items.map((item, idx) => ({ item: sanitize(item), result: sanitize(formData.get(`check_${template.id}_${idx}`)) }));
                            newReport.observations[template.id] = sanitize(formData.get(`observation_${template.id}`));
                            newReport.extras[template.id] = {};
                            
                            template.items.forEach((item, idx) => {
                                const baseName = `check_${template.id}_${idx}`;
                                if (formData.get(baseName) === 'C') {
                                    newReport.extras[template.id][idx] = {};
                                    for(const [key, value] of formData.entries()) {
                                        if (key.startsWith(`extra_${baseName}`)) {
                                            const fieldName = key.replace(`extra_${baseName}_`, '');
                                            newReport.extras[template.id][idx][fieldName] = sanitize(value);
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    for (const key in App.state.tempPhotos) {
                        const parts = key.split('_');
                        const templateId = parts[1];
                        const itemIndex = parts[2];
                        if (!newReport.photos[templateId]) newReport.photos[templateId] = {};
                        newReport.photos[templateId][itemIndex] = App.state.tempPhotos[key];
                    }

                    const cerContainer = document.getElementById('cer-table-rows');
                    if (cerContainer) {
                        cerContainer.querySelectorAll('.cer-row').forEach(row => {
                            const rowData = {};
                            row.querySelectorAll('input, select').forEach(input => {
                                const keyParts = input.name.split('_');
                                const key = keyParts[1];
                                rowData[key] = input.type === 'checkbox' ? input.checked : sanitize(input.value);
                            });
                             if (Object.values(rowData).some(v => v !== '' && v !== false && v !== null)) {
                                 newReport.cerData.push(rowData);
                             }
                        });
                    }
                    
                    await App.store.save(newReport);
                    App.ui.showToast('Controllo salvato con successo!', 'success');
                    App.ui.resetPcaForm();
                    await App.ui.showTab('lista-pca');
                } catch (error) {
                    App.ui.showToast(error.message, 'error');
                } finally {
                    App.state.isSaving = false;
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Salva Controllo'; }
                }
            },
            addCerRow() {
                const index = Date.now(); 
                const container = document.getElementById('cer-table-rows');
                if (!container) return;

                const row = document.createElement('div');
                row.className = 'cer-row grid grid-cols-2 md:grid-cols-9 gap-2 items-center';
                row.innerHTML = `
                    <input type="text" name="cer_produttore_${index}" placeholder="CER/Produttore" class="form-input text-xs col-span-2 md:col-span-1">
                    <input type="text" name="cer_ubicazione_${index}" placeholder="Ubicazione" class="form-input text-xs col-span-2 md:col-span-1">
                    <input type="text" name="cer_verbale_${index}" placeholder="Verbale N." class="form-input text-xs col-span-2 md:col-span-1">
                    <input type="text" name="cer_prova_${index}" placeholder="Rapp. Prova N." class="form-input text-xs col-span-2 md:col-span-1">
                    <select name="cer_identificato_${index}" class="form-select text-xs col-span-1"><option value="si">S√¨</option><option value="no" selected>No</option></select>
                    <select name="cer_delimitato_${index}" class="form-select text-xs col-span-1"><option value="si">S√¨</option><option value="no" selected>No</option></select>
                    <div class="flex items-center justify-center"><input type="checkbox" name="cer_produzione_${index}" class="form-checkbox h-4 w-4"></div>
                    <div class="flex items-center justify-center"><input type="checkbox" name="cer_carico_${index}" class="form-checkbox h-4 w-4"></div>
                    <button type="button" class="cer-delete-row-btn text-red-500 hover:text-red-700 p-1 justify-self-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                container.appendChild(row);
            },
            async onPhotoUpload(e) { const input = e.target; const key = input.dataset.key; const previewContainer = document.getElementById(`preview_${key}`); const file = input.files[0]; if (!file || !previewContainer) return; previewContainer.innerHTML = `<span class="text-xs text-slate-500">Carico...</span>`; try { const dataUrl = await this.resizeImage(file, 1024); previewContainer.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover rounded" alt="Anteprima">`; App.state.tempPhotos[key] = dataUrl; } catch (err) { previewContainer.innerHTML = App.templates.imagePlaceholderIcon(); delete App.state.tempPhotos[key]; App.ui.showToast("Errore nel caricamento foto.", "error"); } },
            resizeImage: (file, maxSize) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { let { width, height } = img; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.8)); }; img.onerror = reject; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); }),
            async attachSettingsListeners() { 
                document.getElementById('export-btn')?.addEventListener('click', this.exportData); 
                document.getElementById('import-btn')?.addEventListener('click', () => document.getElementById('import-file').click()); 
                document.getElementById('import-file')?.addEventListener('change', async (e) => {
                     const confirmed = await App.ui.showModal({
                        title: 'Conferma Importazione',
                        message: "ATTENZIONE: i dati attuali verranno SOVRASCRITTI in modo permanente. Continuare?",
                        confirmText: 'Sovrascrivi e Importa',
                        confirmColor: 'bg-orange-500'
                    });
                    if (confirmed) this.importData(e);
                }); 
            },
            async exportData() { const data = await App.store.getAll(); if (data.length === 0) return App.ui.showToast("Nessun dato da esportare.", 'info'); const dataStr = JSON.stringify(data, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `pca_backup_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); App.ui.showToast("Esportazione dati completata.", 'success'); },
            importData(e) { 
                const file = e.target.files[0]; if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = async (event) => { 
                    try { 
                        const data = JSON.parse(event.target.result); 
                        if (!Array.isArray(data)) throw new Error("File non valido"); 
                        await App.store.saveAll(data); 
                        App.ui.showToast("Dati importati con successo!", 'success'); 
                        await App.ui.showTab('dashboard'); 
                    } catch (err) { App.ui.showToast("Errore: il file di backup non √® valido.", 'error'); } 
                }; 
                reader.readAsText(file); 
                e.target.value = '';
            },
        },
        
        templates: {
            dashboard: (stats, dueList) => {
                let dueListHtml = '<p class="text-slate-500 dark:text-slate-400">Tutti i controlli sono aggiornati.</p>';
                if (dueList.length > 0) {
                    dueListHtml = `<ul class="space-y-3">${dueList.map(item => `
                        <li class="flex items-center justify-between p-3 rounded-lg bg-slate-100 dark:bg-slate-700/50">
                            <div>
                                <span class="font-bold">${item.wbs}</span>
                                <span class="text-sm text-slate-500 dark:text-slate-400 ml-2">${App.config.WBS_DATA[item.wbs].descrizione}</span>
                            </div>
                            <span class="text-sm font-semibold px-2 py-0.5 rounded-full ${item.status.color}">${item.status.text}</span>
                        </li>`).join('')}</ul>`;
                }
                const cards = [
                    { label: 'Controlli Totali', value: stats.totalPca, color: 'text-blue-500', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>' },
                    { label: 'NC Aperte', value: stats.openNc, color: stats.openNc > 0 ? 'text-red-500' : 'text-slate-800 dark:text-white', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>' },
                    { label: 'Controlli Periodici', value: stats.totalChecks, color: 'text-indigo-500', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>' },
                    { label: 'Conformit√† Media', value: stats.avgCompliance, color: stats.avgCompliance !== 'N.D.' ? 'text-green-500' : 'text-slate-800 dark:text-white', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' }
                ];
                return `<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    ${cards.map(card => `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm flex items-center gap-5">
                        <div class="p-3 rounded-full bg-slate-100 dark:bg-slate-700 ${card.color}">${card.icon}</div>
                        <div>
                            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">${card.label}</h3>
                            <p class="mt-1 text-3xl font-semibold ${card.color}">${card.value}</p>
                        </div>
                    </div>`).join('')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-4">Non Conformit√† per Aspetto</h3>
                        <div class="relative h-96 w-full"><canvas id="ncChart"></canvas></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-4">Controlli da Eseguire</h3>
                        <div class="max-h-96 overflow-y-auto pr-2">${dueListHtml}</div>
                    </div>
                </div>`;
            },
            pcaList: (reports, wbsFrequencyStatus) => {
                return `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-transparent text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-700/50">
                                <tr>
                                    ${['ID','Data','Tipo','WBS/Area','Lavorazione','Stato NC', 'Stato Frequenza', 'Prossimo Controllo', 'Azioni'].map(h=>`<th class="p-4 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                ${reports.length===0?`<tr><td colspan="9" class="p-8 text-center text-slate-500">Nessun controllo compilato.</td></tr>`:reports.map(report=>{
                                    const ncCount=Object.values(report.checks||{}).flat().filter(c=>c&&c.result==='NC').length;
                                    const typeLabels={'periodico':'Periodico','preliminare':'Preliminare','finale':'Finale'};
                                    const wbsCode = report.wbs ? report.wbs.substring(0,2).toUpperCase() : null;
                                    const freqStatus = report.type === 'periodico' && wbsCode ? wbsFrequencyStatus[wbsCode] : null;
                                    
                                    return `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors duration-200">
                                        <td class="p-4 font-medium">${report.id}</td>
                                        <td class="p-4 whitespace-nowrap">${new Date(report.date+"T00:00:00").toLocaleDateString('it-IT')}</td>
                                        <td class="p-4 font-medium">${typeLabels[report.type]||'N.D.'}</td>
                                        <td class="p-4">${report.wbs||'N.A.'}</td>
                                        <td class="p-4">${report.activities||'N.A.'}</td>
                                        <td class="p-4 font-semibold ${ncCount>0?'text-red-500':'text-green-500'}">${report.type!=='periodico'?'-':(ncCount>0?`${ncCount} NC`:'Conforme')}</td>
                                        <td class="p-4">
                                            ${freqStatus ? `<span class="text-xs font-semibold px-2 py-1 rounded-full ${freqStatus.color}">${freqStatus.text}</span>` : '-'}
                                        </td>
                                        <td class="p-4 whitespace-nowrap">
                                            ${freqStatus && freqStatus.nextDate ? freqStatus.nextDate.toLocaleDateString('it-IT') : '-'}
                                        </td>
                                        <td class="p-4">
                                            <div class="flex items-center gap-4">
                                                <button data-id="${report.id}" class="print-pca-btn text-slate-500 hover:text-blue-600" title="Stampa"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button>
                                                <button data-id="${report.id}" class="delete-pca-btn text-slate-500 hover:text-red-600" title="Elimina"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },
            imagePlaceholderIcon: () => `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`,

            extraContent: {
                'pca01_0': () => `<div class="w-full md:w-1/2"><label for="extra_check_pca01_0_auth" class="form-label">N¬∞ Autorizzazione</label><input type="text" id="extra_check_pca01_0_auth" name="extra_check_pca01_0_auth" class="form-input"></div>`,
                'pca01_1': () => `<div class="w-full md:w-1/2"><label for="extra_check_pca01_1_auth" class="form-label">N¬∞ Autorizzazione</label><input type="text" id="extra_check_pca01_1_auth" name="extra_check_pca01_1_auth" class="form-input"></div>`,
                'pca01_4': (id, idx) => App.templates.photoUpload(id, idx),
                'pca01_5': () => `<div class="w-full md:w-1/2"><label for="extra_check_pca01_5_revisione" class="form-label">Data Ultima Revisione</label><input type="date" id="extra_check_pca01_5_revisione" name="extra_check_pca01_5_revisione" class="form-input"></div>`,
                'pca02_0': (id, idx) => App.templates.photoUpload(id, idx),
                'pca02_1': (id, idx) => App.templates.photoUpload(id, idx),
                'pca02_2': () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="extra_check_pca02_2_ddt" class="form-label">N¬∞ DDT</label><input type="text" id="extra_check_pca02_2_ddt" name="extra_check_pca02_2_ddt" class="form-input"></div><div><label for="extra_check_pca02_2_targa" class="form-label">Targa</label><input type="text" id="extra_check_pca02_2_targa" name="extra_check_pca02_2_targa" class="form-input"></div></div>`,
                'pca03_0': () => `<div class="w-full md:w-1/2"><label for="extra_check_pca03_0_auth" class="form-label">N¬∞ Autorizzazione</label><input type="text" id="extra_check_pca03_0_auth" name="extra_check_pca03_0_auth" class="form-input"></div>`,
                'pca04_0': (id, idx) => App.templates.photoUpload(id, idx),
                'pca04_1': () => `<div class="w-full"><label class="form-label mb-2 block">Dettaglio Rifiuti per CER</label><div id="cer-table" class="space-y-3"><div class="hidden md:grid grid-cols-9 gap-2 text-xs font-bold text-slate-500 dark:text-slate-400"><span class="md:col-span-1">CER/Produttore</span><span class="md:col-span-1">Ubicazione</span><span class="md:col-span-1">Verbale N.</span><span class="md:col-span-1">Rapp. Prova N.</span><span class="md:col-span-1 text-center">Identif.</span><span class="md:col-span-1 text-center">Delim.</span><span class="md:col-span-1 text-center">In Prod.</span><span class="md:col-span-1 text-center">In Carico</span><span class="md:col-span-1"></span></div><div id="cer-table-rows" class="space-y-2"></div></div><button type="button" id="add-cer-row-btn" class="mt-4 px-3 py-1.5 bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 rounded-md text-sm font-semibold hover:bg-blue-200 dark:hover:bg-blue-900">+ Aggiungi Riga</button></div>`,
                'pca04_2': (id, idx) => App.templates.photoUpload(id, idx),
                'pca05_0': (id, idx) => App.templates.photoUpload(id, idx),
                'pca05_1': (id, idx) => App.templates.photoUpload(id, idx),
                'pca06_4': () => `<div class="space-y-4"> <h4 class="font-semibold text-sm text-slate-700 dark:text-slate-300">Dettagli Misurazione Fonometro</h4> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div><label for="extra_check_pca06_4_punto" class="form-label">Punto di Misura</label><input type="text" id="extra_check_pca06_4_punto" name="extra_check_pca06_4_punto" class="form-input" placeholder="Es. Bordo cantiere Ovest"></div> <div><label for="extra_check_pca06_4_strumento" class="form-label">Strumento Utilizzato</label><input type="text" id="extra_check_pca06_4_strumento" name="extra_check_pca06_4_strumento" class="form-input" placeholder="Marca, Modello, Seriale"></div> <div><label for="extra_check_pca06_4_misurato" class="form-label">Valore Misurato (dBA)</label><input type="number" step="0.1" id="extra_check_pca06_4_misurato" name="extra_check_pca06_4_misurato" class="form-input"></div> <div><label for="extra_check_pca06_4_limite" class="form-label">Valore Limite (dBA)</label><input type="number" step="0.1" id="extra_check_pca06_4_limite" name="extra_check_pca06_4_limite" class="form-input"></div> <div class="md:col-span-2"><label for="extra_check_pca06_4_taratura" class="form-label">Data Ultima Taratura Strumento</label><input type="date" id="extra_check_pca06_4_taratura" name="extra_check_pca06_4_taratura" class="form-input"></div> </div> </div>`,
            },
            
            photoUpload(templateId, itemIndex) {
                const key = `extra_${templateId}_${itemIndex}`;
                return `<div><label class="text-sm font-medium mb-2 block">Rilievo Fotografico</label><div class="flex items-center gap-4"><div id="preview_${key}" class="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded flex items-center justify-center text-slate-400">${this.imagePlaceholderIcon()}</div><input type="file" accept="image/*" class="photo-input hidden" data-key="${key}"><button type="button" class="add-photo-btn px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-md text-sm font-semibold hover:bg-slate-300 dark:hover:bg-slate-500">Aggiungi</button></div></div>`
            },

            renderChecklist(templates) {
                return templates.map(t => {
                    const significativitaBadgeColor = t.significativita === 'ALTA' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    
                    return `<div id="accordion-${t.id}" class="pca-sheet-accordion bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm" style="display:none;">
                        <div class="accordion-header p-4 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700/50">
                            <h3 class="text-lg font-semibold flex items-center gap-3">${t.icon} ${t.title}</h3>
                            <div class="flex items-center gap-4">
                                ${t.significativita ? `<span class="hidden sm:inline-block text-xs font-medium px-2.5 py-0.5 rounded-full ${significativitaBadgeColor}">SIGNIFICATIVIT√Ä ${t.significativita}</span>` : ''}
                                <svg class="accordion-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div class="accordion-content px-4">
                            <div class="space-y-3">
                                ${t.items.map((item, idx) => {
                                    const baseName = `check_${t.id}_${idx}`;
                                    const extraContentKey = `${t.id}_${idx}`;
                                    const extraContentFn = this.extraContent[extraContentKey];
                                    const extraContentHTML = extraContentFn ? extraContentFn(t.id, idx) : '';

                                    return `<div class="check-item-wrapper border-t border-slate-200 dark:border-slate-700 py-3">
                                        <div class="check-item flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                                            <label class="mr-4 text-sm flex-1">${item}</label>
                                            <div class="flex items-center gap-x-5 text-sm flex-shrink-0">
                                                <div class="flex items-center"><input id="${baseName}_c" name="${baseName}" type="radio" value="C" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500"><label for="${baseName}_c" class="ml-2 block">S√¨</label></div>
                                                <div class="flex items-center"><input id="${baseName}_nc" name="${baseName}" type="radio" value="NC" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500"><label for="${baseName}_nc" class="ml-2 block">No</label></div>
                                                <div class="flex items-center"><input id="${baseName}_na" name="${baseName}" type="radio" value="NA" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked><label for="${baseName}_na" class="ml-2 block">N.A.</label></div>
                                            </div>
                                        </div>
                                        ${extraContentHTML ? `<div id="extra_content_wrapper_${baseName}" class="extra-content-wrapper mt-4 pl-4 border-l-2 border-slate-200 dark:border-slate-700"><div class="extra-content-inner pt-2 pb-2">${extraContentHTML}</div></div>` : ''}
                                    </div>`
                                }).join('')}
                            </div>
                            <div class="mt-6">
                                <label class="text-sm font-medium mb-2 block">Osservazioni e Misure Correttive Generali</label>
                                <textarea name="observation_${t.id}" class="form-textarea" rows="3"></textarea>
                            </div>
                        </div>
                    </div>` 
                }).join('');
            },

            newPcaForm({ nextId, today }) {
                return `<form id="new-pca-form" novalidate class="space-y-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">1. Dati Generali</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="pca-id" class="form-label">Verbale N¬∞</label><input type="number" id="pca-id" name="id" class="form-input" value="${nextId}" required></div>
                            <div><label for="pca-date" class="form-label">Data</label><input type="date" id="pca-date" name="date" value="${today}" class="form-input" required></div>
                            <div class="md:col-span-2"><label for="pca-type" class="form-label">Tipo di Controllo</label><select id="pca-type" name="type" class="form-select" required><option value="periodico" selected>Periodico (da WBS)</option><option value="preliminare">Preliminare (Ante Operam)</option><option value="finale">Finale (Post Operam)</option></select></div>
                        </div>
                        <div id="wbs-section" class="mt-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="pca-wbs-input" class="form-label">1. Inserisci Codice WBS</label><input type="text" id="pca-wbs-input" name="wbs-input" class="form-input" placeholder="Es. RI12, GA01..."></div>
                                <div><label for="pca-lavorazione-select" class="form-label">2. Seleziona Lavorazione</label><select id="pca-lavorazione-select" name="lavorazione" class="form-select" disabled><option value="">-- Prima inserisci WBS --</option></select></div>
                            </div>
                            <div><label for="pca-inspector-wbs" class="form-label">Compilatore</label><input type="text" id="pca-inspector-wbs" name="inspector-wbs" class="form-input" placeholder="Nome e Funzione"></div>
                        </div>
                        <div id="manual-section" class="mt-6 space-y-4" style="display: none;">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="wbs-manual" class="form-label">Area di Riferimento</label><input id="wbs-manual" name="wbs-manual" class="form-input" placeholder="Es. Campo Base, Area X..."></div>
                                <div><label for="inspector-manual" class="form-label">Compilatore</label><input id="inspector-manual" name="inspector-manual" class="form-input" placeholder="Nome e Funzione"></div>
                            </div>
                            <div><label for="activities-manual" class="form-label">Oggetto del controllo</label><textarea id="activities-manual" name="activities-manual" class="form-textarea" rows="2"></textarea></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">2. Checklist di Controllo</h2>
                        <div id="checklist-container-periodico" class="space-y-4">${this.renderChecklist(App.config.CHECK_TEMPLATES_PERIODIC)}</div>
                        <div id="checklist-container-preliminare" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_PRELIMINARE)}</div>
                        <div id="checklist-container-finale" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_FINALE)}</div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-pca-btn" class="px-6 py-3 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">Annulla</button>
                        <button type="submit" id="save-pca-btn" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold flex items-center justify-center">Salva Controllo</button>
                    </div>
                </form>
                <style> 
                    .form-label { @apply text-sm font-medium text-slate-600 dark:text-slate-300; } 
                    .form-input, .form-select, .form-textarea { @apply mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white dark:bg-slate-900 text-sm; } 
                    .form-checkbox { @apply rounded border-slate-300 dark:border-slate-600 text-blue-600 focus:ring-blue-500; }
                    .extra-content-wrapper { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; }
                    .extra-content-wrapper.visible { max-height: 1000px; }
                </style>`;
            },
            settings: () => `<div class="space-y-8 max-w-2xl"><div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm"><h2 class="text-xl font-bold mb-2">Archiviazione Dati</h2><p class="text-slate-500 dark:text-slate-400 mb-4 text-sm">Salva una copia di sicurezza dei tuoi verbali su un file, o ripristina i dati da un backup precedente.</p><div class="flex gap-4 flex-wrap"><button id="export-btn" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">Esporta Dati</button><button id="import-btn" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">Importa Dati</button><input type="file" id="import-file" class="hidden" accept=".json"></div></div></div>`,
            
            printReport(report, templates) {
                const chrysasLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp';
                const rtiLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/RTI.bmp';
                const typeLabels = { 'periodico': 'Controllo Periodico', 'preliminare': 'Ispezione Preliminare (Ante Operam)', 'finale': 'Ispezione Finale (Post Operam)' };
                
                const renderExtras = (templateId, itemIndex) => {
                    const extraData = report.extras?.[templateId]?.[itemIndex];
                    if (!extraData || Object.keys(extraData).length === 0) return '';
                    let html = '<div style="font-size: 9pt; margin: 6px 0 6px 20px; padding: 8px; background-color: #f8f8f8; border-left: 2px solid #ddd;">';
                    for (const [key, value] of Object.entries(extraData)) {
                       const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                       html += `<span style="display: inline-block; min-width: 140px;"><strong>${formattedKey}:</strong></span> ${value || 'N.D.'} <br>`;
                    }
                    html += '</div>';
                    return html;
                };
                
                 const renderPhoto = (templateId, itemIndex) => {
                    const photoSrc = report.photos?.[templateId]?.[itemIndex];
                    if (!photoSrc) return '';
                    return `<div style="margin-top: 8px; margin-left: 20px;"><h4 style="font-weight: bold; font-size: 9pt; margin-bottom: 4px;">Rilievo Fotografico:</h4><img src="${photoSrc}" style="max-width: 350px; border-radius: 4px; display: block; border: 1px solid #ddd;" alt="Foto allegata"></div>`;
                };

                const reportBody = `
                    <h1 style="text-align: center; font-size: 1.6rem; margin-bottom: 0.5rem; font-weight: bold; color: var(--print-text-primary);">Piano Controllo Ambientale</h1>
                    <p style="text-align: center; font-size: 1.2rem; margin-bottom: 2.5rem; color: var(--print-text-secondary);">Verbale N¬∞ ${report.id}</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2.5rem; font-size: 10pt;">
                        <tbody>
                            <tr>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg); width: 20%;">Data</td>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color); width: 30%;">${new Date(report.date + "T00:00:00").toLocaleDateString('it-IT')}</td>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg); width: 20%;">WBS/Area</td>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color); width: 30%;">${report.wbs || 'N.A.'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg);">Tipo Verbale</td>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color);" colspan="3">${typeLabels[report.type] || 'N.D.'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg);">Lavorazione/Oggetto</td>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color);" colspan="3">${report.activities || 'N.A.'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg);">Compilato da</td>
                                <td style="padding: 8px; border: 1px solid var(--print-border-color);" colspan="3">${report.inspector || 'N.D.'}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    ${templates.map(t => {
                        const checks = report.checks ? report.checks[t.id] : null;
                        if (!checks || checks.length === 0) return '';
                        const observationsText = report.observations ? (report.observations[t.id] || '') : '';
                        
                        let cerTableHtml = '';
                        if(t.id === 'pca04' && report.cerData && report.cerData.length > 0) {
                            cerTableHtml += '<h3 style="font-weight:bold; font-size: 11pt; margin: 1.5rem 0 0.5rem 0;">Dettaglio Rifiuti CER</h3><table style="width:100%; font-size: 8pt; border-collapse:collapse;"><thead><tr style="background-color:var(--print-header-bg);">';
                            const headers = ['CER/Prod.', 'Ubic.', 'Verbale', 'Rapp. Prova', 'Ident.', 'Delim.', 'In Prod.', 'In Carico'];
                            headers.forEach(h => cerTableHtml += `<th style="border:1px solid var(--print-border-color); padding: 5px; text-align: left;">${h}</th>`);
                            cerTableHtml += '</tr></thead><tbody>';
                            report.cerData.forEach(row => {
                                cerTableHtml += `<tr>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px;">${row.produttore || ''}</td>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px;">${row.ubicazione || ''}</td>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px;">${row.verbale || ''}</td>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px;">${row.prova || ''}</td>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px; text-align:center;">${row.identificato || ''}</td>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px; text-align:center;">${row.delimitato || ''}</td>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px; text-align:center;">${row.produzione ? 'S√¨' : 'No'}</td>
                                    <td style="border:1px solid var(--print-border-color); padding: 5px; text-align:center;">${row.carico ? 'S√¨' : 'No'}</td>
                               </tr>`;
                            });
                            cerTableHtml += '</tbody></table>';
                        }

                        return `<div style="margin-bottom: 2rem; page-break-inside: avoid;">
                            <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem; color: var(--print-text-primary);">
                                <span style="font-size: 1.5rem; vertical-align: -0.2em; margin-right: 0.5rem;">${t.icon}</span>${t.title}
                            </h2>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><tbody>
                            ${checks.map((item, idx) => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px 0; vertical-align: top; color: var(--print-text-secondary);">
                                        ${item.item}
                                        ${renderExtras(t.id, idx)}
                                        ${renderPhoto(t.id, idx)}
                                    </td>
                                    <td style="padding: 8px 0; text-align: right; font-weight: bold; width: 80px; vertical-align: top; color: ${item.result==='NC'?'#D32F2F':'var(--print-text-primary)'};">${item.result || 'N.D.'}</td>
                                </tr>`).join('')}
                            </tbody></table>
                            ${(observationsText.trim() !== '') ? `<div style="background-color: #f8f8f8; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 1rem; page-break-inside: avoid;"><h3 style="font-weight: bold; margin-bottom: 0.5rem; font-size: 11pt;">Osservazioni e Misure Correttive</h3><p style="font-size: 10pt; white-space: pre-wrap; margin: 0;">${observationsText}</p></div>` : ''}
                            ${cerTableHtml}
                        </div>`;
                    }).join('')}`;

                return `<div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #333; font-size: 10pt;">
                    <header>
                        <table style="width:100%; border-collapse: collapse;">
                            <tr>
                                <td style="width:50%; text-align:left; vertical-align:middle;">
                                    <img src="${chrysasLogoUrl}" alt="Logo CHRYSAS" style="height: 40px;">
                                </td>
                                <td style="width:50%; text-align:right; vertical-align:middle;">
                                    <img src="${rtiLogoUrl}" alt="Logo RTI" style="height: 50px;">
                                </td>
                            </tr>
                        </table>
                        <hr style="margin-top: 1rem; margin-bottom: 1.5rem; border: 0; border-top: 2px solid var(--print-text-primary);">
                    </header>
                    
                    ${reportBody}
                    
                    <footer style="position: fixed; bottom: 0; left: 1.5cm; right: 1.5cm; height: 1.5cm; text-align: center; font-size: 8pt; color: #888; border-top: 1px solid #ccc; padding-top: 1rem;">
                        Documento generato in data ${new Date().toLocaleDateString('it-IT')}
                    </footer>
                </div>`;
            }
        }
    };

    App.init().catch(err => {
        console.error("ERRORE FATALE DURANTE L'INIZIALIZZAZIONE:", err);
        document.body.innerHTML = `<div style='padding: 2rem; text-align: center; font-family: sans-serif; color: #ef4444;'><h1>Errore Critico</h1><p>Impossibile avviare l'applicazione. Potrebbe esserci un problema con le dipendenze esterne o un errore nello script. Controlla la console (F12) per i dettagli.</p></div>`;
    });
});
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col">
            <div class="h-16 flex items-center justify-center px-6 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                <img src="https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp" alt="Logo CHRYSAS" class="h-8">
            </div>
            <nav id="sidebar-nav" class="flex-grow px-4 py-6 overflow-y-auto"></nav>
        </aside>
        
        <div id="sidebar-overlay"></div>

        <div id="main-container" class="relative w-full">
            <!-- Header -->
            <header class="h-16 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Toggle Menu">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold"></h2>
                </div>

                <div class="flex items-center gap-6">
                    <img src="https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/RTI.bmp" alt="Loghi Partner" class="h-10 hidden sm:block">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" aria-label="Toggle dark mode">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="text-right hidden sm:block"><span id="current-date" class="text-sm text-slate-500 dark:text-slate-400"></span></div>
                </div>
            </header>
            
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6"></main>
        </div>
    </div>
    <div id="toast" class="toast px-6 py-3 rounded-lg text-white font-medium shadow-lg" role="alert" aria-live="polite"></div>
    <div id="print-area" class="hidden"></div>
    <div id="modal-overlay" class="modal-overlay"></div>
</body>
</html>
