html
<!DOCTYPE html>
<html lang="it" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Content Security Policy: Assicura che vengano caricate risorse solo da sorgenti attendibili -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net/npm/chart.js https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' https: data:;
        connect-src 'self' https://api.open-meteo.com;
        object-src 'none';
        base-uri 'self';
        form-action 'none';
    ">
    <title>App Gestione PCA - CHRYSAS (v3.1)</title>
    
    <!-- Caricamento font da Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Inclusione di Tailwind CSS e Chart.js per la grafica e la visualizzazione dati -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <!-- Libreria per la gestione dell'IndexedDB (storage locale) -->
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js" defer></script>
    
    <style>
        /* Stili personalizzati per tema scuro e layout */
        :root {
            --print-header-bg: #f2f2f2;
            --print-border-color: #bbb;
            --print-text-primary: #000;
            --print-text-secondary: #333;
        }

        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .dark body { background-color: #0f172a; } /* Colore di sfondo tema scuro */

        /* Layout Sidebar responsivo */
        #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 16rem; transition: transform 0.3s ease-in-out; will-change: transform; z-index: 1000; }
        #main-container { transition: padding-left 0.3s ease-in-out; }

        @media (max-width: 1023px) { /* Breakpoint per schermi piccoli */
            #sidebar { transform: translateX(-100%); } /* Sidebar nascosta di default */
            .sidebar-open #sidebar { transform: translateX(0); } /* Sidebar visibile quando aperta */
            #main-container { padding-left: 0; } /* Rimuove padding quando sidebar √® chiusa */
            .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
            .sidebar-overlay.visible { opacity: 1; pointer-events: auto; } /* Overlay visibile quando sidebar √® aperta */
        }
        @media (min-width: 1024px) { /* Breakpoint per schermi grandi */
            #sidebar { transform: translateX(0); } /* Sidebar sempre visibile */
            #main-container { padding-left: 16rem; } /* Padding a sinistra per main content */
            .sidebar-collapsed #sidebar { transform: translateX(-100%); } /* Sidebar collassata */
            .sidebar-collapsed #main-container { padding-left: 0; } /* Rimuove padding quando sidebar √® collassata */
            .sidebar-overlay { display: none; } /* Overlay non necessario su schermi grandi */
        }

        /* Stili per link sidebar */
        .sidebar-link { transition: background-color 0.2s, color 0.2s; }
        .sidebar-link.active { @apply bg-blue-600 text-white font-semibold; } /* Stile per link attivo */
        
        /* Stili per notifiche Toast */
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s, transform 0.3s; z-index: 1050; }
        .toast.show { opacity: 1; bottom: 40px; transform: translateX(-50%) scale(1); } /* Animazione toast */
        
        /* Effetti hover/active per bottoni e link */
        button, .sidebar-link, .dashboard-card { transition: all 0.2s ease-in-out; }
        button:hover:not(:disabled), .sidebar-link:hover, .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px -1px rgb(0 0 0 / 0.1), 0 2px 6px -2px rgb(0 0 0 / 0.1); }
        button:active:not(:disabled) { transform: translateY(0px); box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); }
        button:disabled { opacity: 0.6; cursor: not-allowed; } /* Stile bottoni disabilitati */
        
        /* Animazione fade-in per contenuti */
        .content-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Stili Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1040; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .dark .modal-box { background-color: #1e293b; } /* Colore sfondo modal tema scuro */

        /* Widget Meteo */
        #weather-widget { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; color: #475569; }
        .dark #weather-widget { color: #cbd5e1; }
        #weather-widget .loader, .photo-preview .loader { width: 1.25rem; height: 1.25rem; border: 2px solid #e2e8f0; border-top-color: #64748b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } } /* Animazione loader */

        /* Accordion/Gruppi PCA */
        .accordion-header, .grouped-pca-header { cursor: pointer; transition: background-color 0.2s; }
        .accordion-content, .grouped-pca-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, margin 0.4s ease-in-out, opacity 0.3s; opacity: 0; }
        .conditional-section { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out, margin 0.4s ease-out, opacity 0.3s ease-out; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; }
        .accordion-content.open, .grouped-pca-content.open, .conditional-section.visible { max-height: 5000px; opacity: 1; } /* Transizione per apertura accordion/sezioni */
        .conditional-section.visible { padding-top: 1rem; padding-bottom: 1rem; margin-top: 1rem; }
        .accordion-icon, .grouped-pca-icon { transition: transform 0.3s; }
        .accordion-header.open .accordion-icon, .grouped-pca-header.open .grouped-pca-icon { transform: rotate(180deg); } /* Rotazione icona per accordion aperto */
        .grouped-pca-content.open { margin-top: 0.5rem; }

        /* Stili Form (Input, Label, Checkbox) */
        .form-label { font-size: 0.875rem; font-weight: 500; color: #475569; }
        .dark .form-label { color: #d1d5db; }
        .form-input, .form-select, .form-textarea { margin-top: 0.25rem; display: block; width: 100%; border-radius: 0.375rem; background-color: #ffffff; font-size: 0.875rem; border: 2px solid #cbd5e1; transition: border-color 0.2s, box-shadow 0.2s; padding: 0.5rem 0.75rem; }
        .dark .form-input, .dark .form-select, .dark .form-textarea { background-color: #1f2937; border-color: #4b5563; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); border-color: #3b82f6; } /* Focus state */
        .form-input:invalid, .form-select:invalid, .form-textarea:invalid { border-color: #ef4444 !important; } /* Validazione non valida */
        .form-checkbox { height: 1rem; width: 1rem; border-radius: 0.25rem; border-color: #d1d5db; color: #3b82f6; }
        .dark .form-checkbox { border-color: #4b5563; }
        .form-checkbox:focus { box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); }
        
        /* Utility Class */
        .hidden { display: none; }
        
        /* Photo Uploader */
        .photo-uploader { position: relative; width: 5rem; height: 5rem; flex-shrink: 0; }
        .photo-preview { width: 100%; height: 100%; background-color: #f3f4f6; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed #d1d5db; cursor: pointer; transition: border-color 0.2s; }
        .dark .photo-preview { background-color: #374151; border-color: #4b5563; }
        .photo-preview:hover { border-color: #3b82f6; }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .remove-photo-btn { position: absolute; top: -0.5rem; right: -0.5rem; background-color: #ef4444; color: white; border-radius: 9999px; width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .remove-photo-btn:hover { transform: scale(1.1); }

        /* Tabelal CER per Rifiuti */
        .cer-table-wrapper { overflow-x: auto; }
        .cer-table { min-width: 1200px; }

        /* Stili per la Stampa */
        @media print {
            body, #print-area { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            body > *:not(#print-area-wrapper) { display: none !important; } /* Nasconde tutto tranne l'area di stampa */
            #print-area-wrapper { display: block !important; } /* Mostra l'area di stampa */
            @page {
                size: A4;
                margin: 2.5cm 1.5cm; /* Margini di stampa */
                @top-center { content: element(header); } /* Intestazione pagina */
                @bottom-center { content: element(footer); } /* Pi√® di pagina */
            }
            header.print-header { position: running(header); } /* Definisce l'area per l'intestazione */
            footer.print-footer { position: running(footer); } /* Definisce l'area per il pi√® di pagina */
            .page-break { page-break-after: always; } /* Forza un'interruzione di pagina */
            .no-break { page-break-inside: avoid; } /* Evita la divisione di elementi su pi√π pagine */
        }
    </style>
    
    <script id="app-script" defer>
    // Gestore globale per errori JavaScript non catturati.
    window.onerror = function(message, source, lineno, colno, error) {
        console.error("ERRORE GLOBALE NON GESTITO:", { message, source, lineno, colno, error });
        try {
            // Tenta di mostrare un toast se l'UI √® inizializzata
            App.ui?.showToast('Si √® verificato un errore inatteso. L\'app continuer√† a funzionare.', 'error');
        } catch(e) {
            // Se l'UI non √® ancora pronta, tenta di mostrare un messaggio pi√π generico.
            const toast = document.getElementById('toast');
            if(toast) {
                toast.textContent = 'Errore critico. Ricaricare la pagina.';
                toast.className = 'toast px-6 py-3 rounded-lg text-white font-medium shadow-lg bg-red-600 show';
            }
        }
        return true; // Impedisce la propagazione dell'errore al gestore predefinito del browser
    };
    
    document.addEventListener('DOMContentLoaded', () => {

    const App = {
        config: {
            STORAGE_KEY: 'pca_app_data_idb_v17', // Chiave per IndexedDB
            TABS: [ // Definizione delle schede principali dell'applicazione
                { id: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>' },
                { id: 'lista-pca', label: 'Lista Verbali', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' },
                { id: 'nuovo-pca', label: 'Nuovo PCA', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' },
                { id: 'sopralluogo', label: 'Verbale Sopralluogo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><circle cx="12" cy="15" r="2"></circle><path d="M12 10v3"></path></svg>' },
                { id: 'impostazioni', label: 'Impostazioni', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82V9a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0-1.51 1 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>' }
            ],
            // Dati Work Breakdown Structure (WBS) con descrizioni e lavorazioni/aspetti associati.
            WBS_DATA: { 'GA': { descrizione: 'Gallerie Artificiali', lavorazioni: ['Scavo di sbancamento', 'Posa armature e getti CLS', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti'] }, 'GN': { descrizione: 'Gallerie Naturali', lavorazioni: ['Scavo in naturale', 'Consolidamenti (spritz-beton, centine)', 'Rivestimenti e impermeabilizzazioni'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti', 'Vibrazioni'] }, 'AS': { descrizione: 'Aree di Stoccaggio', lavorazioni: ['Scavi e rivestimenti', 'Opere di sostegno e drenaggi'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Consumi'] }, 'TR': { descrizione: 'Trincee', lavorazioni: ['Scavi di trincea', 'Opere di sostegno (pali, diaframmi)', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Beni Culturali'] }, 'RI': { descrizione: 'Rilevati', lavorazioni: ['Formazione corpo del rilevato', 'Opere di sostegno', 'Sistemazioni idrauliche'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'VI': { descrizione: 'Viadotti', lavorazioni: ['Pali di fondazione e fondazioni', 'Elevazione pile e spalle', 'Varo impalcato e soletta'], aspetti: ['Rumore', 'Vibrazioni', 'Rifiuti', 'Sostanze Pericolose'] }, 'CB': { descrizione: 'Campo Base', lavorazioni: ['Installazione e gestione uffici/dormitori/mensa', 'Manutenzione aree e servizi'], aspetti: ['Acque', 'Rifiuti', 'Rumore', 'Consumi'] }, 'CO': { descrizione: 'Cantiere Operativo', lavorazioni: ['Allestimento aree stoccaggio', 'Gestione impianto di betonaggio', 'Officina e manutenzione mezzi'], aspetti: ['Polveri', 'Rumore', 'Acque', 'Rifiuti', 'Sostanze Pericolose'] }, 'NV': { descrizione: 'Nuova Viabilit√†', lavorazioni: ['Scavi e rilevati per nuova viabilit√†', 'Formazione sottofondi e pavimentazioni', 'Opere idrauliche e finiture'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'FA': { descrizione: 'Fabbricati', lavorazioni: ['Scavi e fondazioni', 'Elevazione strutture', 'Finiture e impianti'], aspetti: ['Polveri', 'Rumore', 'Rifiuti', 'Consumi'] } },
            // Template per i controlli periodici con significativit√† e item specifici.
            CHECK_TEMPLATES_PERIODIC: [ 
                { id: "pca01", title: "PCA 01: Scarichi Idrici ed Approvvigionamento", icon: "üíß", significativita: "ALTA", items: ["Autorizzazione allo scarico acque reflue domestiche presente e valida?", "Autorizzazione allo scarico acque reflue industriali presente e valida?", "Rispetto delle prescrizioni contenute nelle autorizzazioni?", "Corretta gestione acque di lavorazione (es. scavo pali)?", "Kit di emergenza anti-sversamento presente e completo?", "Manutenzione impianti di depurazione/trattamento registrata?"] }, 
                { id: "pca02", title: "PCA 02: Terre e Rocce da Scavo", icon: "‚õ∞Ô∏è", significativita: "ALTA", items: ["Aree di stoccaggio temporaneo identificate e conformi al PUT?", "Separazione dei cumuli per categorie omogenee?", "Documento di Trasporto (DDT) per le terre conforme e presente?", "Copertura dei cassoni dei mezzi in transito?"] }, 
                { id: "pca03", title: "PCA 03: Emissioni in Atmosfera", icon: "üí®", significativita: "ALTA", items: ["Autorizzazioni per impianti (es. calcestruzzo) presenti e valide?", "Copertura mezzi per trasporto materiali polverulenti?", "Bagnatura piste e/o cumuli eseguita regolarmente?", "Velocit√† dei mezzi in cantiere limitata a 30 km/h?", "Impianto lavaruote funzionante ed utilizzato?"] }, 
                { id: "pca04", title: "PCA 04: Rifiuti", icon: "üóëÔ∏è", significativita: "ALTA", items: ["Deposito temporaneo (DTR) ordinato e pulito?", "Rifiuti separati per CER e con corretta cartellonistica?", "Stoccaggio rifiuti pericolosi conforme (aree, bacini)?", "Registro di carico/scarico aggiornato (entro 10gg)?", "Quarta copia FIR ricevuta entro 90 giorni?"] }, 
                { id: "pca05", title: "PCA 05: Sostanze Pericolose ed Emergenze", icon: "‚ò£Ô∏è", significativita: "MEDIA", items: ["Schede di Sicurezza (SDS) disponibili e aggiornate?", "Stoccaggio sostanze su bacini di contenimento idonei?", "Aree di stoccaggio segnalate e adeguate?", "Personale formato per la gestione delle emergenze?"] }, 
                { id: "pca06", title: "PCA 06: Rumore e Vibrazioni", icon: "üîä", significativita: "MEDIA", items: ["Autorizzazione in deroga per rumore presente (se necessaria)?", "Rispetto degli orari di lavoro previsti?", "Barriere acustiche (se previste) integre ed efficaci?", "Manutenzione ordinaria dei mezzi per ridurre il rumore?", "Eseguita misurazione fonometrica periodica?"] }, 
                { id: "pca07", title: "PCA 07: Suolo e Sottosuolo", icon: "üå±", significativita: "ALTA", items: ["Assenza di contaminazioni visive del suolo (macchie, sversamenti)?", "Corretto stoccaggio del terreno vegetale in cumuli separati?", "Utilizzo delle apposite vasche per lavaggio betoniere?", "Gestione corretta del calcestruzzo in esubero?"] }, 
                { id: "pca08", title: "PCA 08: Beni Culturali e Archeologici", icon: "üè∫", significativita: "ALTA", items: ["Presenza di archeologo durante le attivit√† di scavo?", "Notifica agli enti competenti in caso di ritrovamento?", "Corretta gestione e inventario dei reperti?", "Disboscamento limitato alle aree strettamente necessarie?"] } 
            ],
            // Mappa per associare aspetti WBS ai relativi ID PCA
            ASPETTO_TO_PCA_ID_MAP: { 'Polveri': 'pca03', 'Rumore': 'pca06', 'Vibrazioni': 'pca06', 'Acque': 'pca01', 'Suolo': 'pca07', 'Rifiuti': 'pca04', 'Terre e Rocce': 'pca02', 'Sostanze Pericolose': 'pca05', 'Rifornimenti': 'pca05', 'Consumi': 'pca05', 'Beni Culturali': 'pca08' },
            // Mappa per definire frequenze e colori associati alla significativit√†.
            FREQUENCY_MAP: { 'ALTA': { text: 'FREQUENZA ALTA', schedule: '(es. settimanale)', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', days: 7 }, 'MEDIA': { text: 'FREQUENZA MEDIA', schedule: '(es. quindicinale)', color: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300', days: 15 }, 'BASSA': { text: 'FREQUENZA BASSA', schedule: '(es. mensile)', color: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300', days: 30 } },
            // Template per verifiche preliminari (Ante Operam)
            CHECK_TEMPLATES_PRELIMINARE: [{ id: "preliminare", title: "Verifica Preliminare (Ante Operam)", icon: "üìç", items: ["Eseguita analisi documentale (vincoli, servit√π, prescrizioni)?", "Eseguita mappatura e documentazione dei recettori sensibili?", "Documentato stato della vegetazione con rilievo fotografico?", "Verificata e documentata assenza di rifiuti/materiali preesistenti?", "Verificata e documentata assenza di contaminazioni pregresse (macchie, odori)?"] }],
            // Template per verifiche finali (Post Operam)
            CHECK_TEMPLATES_FINALE: [{ id: "finale", title: "Verifica Finale (Post Operam)", icon: "‚úÖ", items: ["Confronto con verbale preliminare ha dato esito positivo?", "Verificata completa rimozione di rifiuti, attrezzature e materiali di risulta?", "Eseguite correttamente le opere di ripristino ambientale (rinverdimenti, etc)?", "Verificata assenza di impatti residui visibili (contaminazioni, erosioni)?"] }],
            // Mappa per calcolare la significativit√† WBS basata sulle schede PCA associate.
            WBS_SIGNIFICANCE_MAP: {},
            // Mappa per interpretare i codici meteo di Open-Meteo.
            WEATHER_CODE_MAP: { 0: {text:'Sereno', icon:'‚òÄÔ∏è'}, 1: {text:'Prevalentemente sereno', icon:'üå§Ô∏è'}, 2: {text:'Parzialmente nuvoloso', icon:'‚õÖÔ∏è'}, 3: {text:'Nuvoloso', icon:'‚òÅÔ∏è'}, 45: {text:'Nebbia', icon:'üå´Ô∏è'}, 48: {text:'Nebbia con brina', icon:'üå´Ô∏è'}, 51: {text:'Pioggerella leggera', icon:'üå¶Ô∏è'}, 53: {text:'Pioggerella moderata', icon:'üå¶Ô∏è'}, 55: {text:'Pioggerella forte', icon:'üå¶Ô∏è'}, 61: {text:'Pioggia leggera', icon:'üåßÔ∏è'}, 63: {text:'Pioggia moderata', icon:'üåßÔ∏è'}, 65: {text:'Pioggia forte', icon:'üåßÔ∏è'}, 71: {text:'Nevicata leggera', icon:'‚ùÑÔ∏è'}, 73: {text:'Nevicata moderata', icon:'‚ùÑÔ∏è'}, 75: {text:'Nevicata forte', icon:'‚ùÑÔ∏è'}, 80: {text:'Rovescio leggero', icon:'üåßÔ∏è'}, 81: {text:'Rovescio moderato', icon:'üåßÔ∏è'}, 82: {text:'Rovescio violento', icon:'üåßÔ∏è'}, 95: {text:'Temporale', icon:'‚õàÔ∏è'}, 96: {text:'Temporale con grandine', icon:'‚õàÔ∏è'} }
        },
        // Stato globale dell'applicazione
        state: { 
            isSaving: false, // Flag per prevenire salvataggi multipli
            tempPhotos: {}, // Cache temporanea per le foto caricate
            activeChart: null, // Riferimento al grafico attivo (per eventuale distruzione)
            data: [], // Array principale contenente tutti i verbali salvati
            isSidebarOpen: localStorage.getItem('sidebarOpen') !== 'false', // Stato sidebar caricato da localStorage
            currentWeather: null, // Dati meteo correnti
            currentLocation: null // Dati geolocalizzazione correnti
        },
        dom: {}, // Riferimenti agli elementi DOM principali
        
        // Inizializzazione dell'applicazione
        async init() {
            this.dom = { // Mapping degli elementi DOM chiave per un accesso pi√π rapido
                appContainer: document.getElementById('app-container'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarNav: document.getElementById('sidebar-nav'),
                mainContent: document.getElementById('main-content'),
                pageTitle: document.getElementById('page-title'),
                currentDate: document.getElementById('current-date'),
                toast: document.getElementById('toast'),
                printAreaWrapper: document.getElementById('print-area-wrapper'),
                modal: document.getElementById('modal-overlay'),
                theme: { toggleBtn: document.getElementById('theme-toggle'), darkIcon: document.getElementById('theme-toggle-dark-icon'), lightIcon: document.getElementById('theme-toggle-light-icon') },
                sidebarToggleBtn: document.getElementById('sidebar-toggle-btn'),
                weatherWidget: document.getElementById('weather-widget')
            };
            this.ui.renderNav(); // Renderizza la navigazione della sidebar
            this._computeWbsSignificance(); // Pre-calcola la significativit√† per ogni WBS
            this.handlers.attachGlobalListeners(); // Collega listener globali (theme, sidebar toggle, etc.)
            this.ui.applyTheme(localStorage.getItem('theme') === 'dark', true); // Applica tema iniziale
            this.ui.setSidebarState(this.state.isSidebarOpen); // Imposta stato iniziale sidebar
            try {
                this.state.data = await this.store.getAll(); // Carica i dati da IndexedDB
            } catch (err) {
                console.error("Errore critico nel caricamento da IndexedDB:", err);
                this.ui.showToast("Errore nel caricare i dati. L'archivio potrebbe essere corrotto.", 'error');
                this.state.data = [];
            }
            await this.ui.showTab('dashboard'); // Mostra la scheda dashboard all'avvio
            this.services.fetchLocationAndWeather(); // Richiede e visualizza meteo e geolocalizzazione
        },
        
        // Calcola la significativit√† complessiva per ogni WBS basata sulle schede PCA associate.
        _computeWbsSignificance() {
            const significanceValues = { 'ALTA': 2, 'MEDIA': 1, 'BASSA': 0 }; // Ponderazione significativit√†
            for (const wbsCode in this.config.WBS_DATA) {
                const wbsData = this.config.WBS_DATA[wbsCode];
                let maxSignificance = -1;
                // Trova tutti gli ID delle schede PCA necessarie per questo WBS
                const requiredPcaIds = new Set(wbsData.aspetti.map(a => this.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                requiredPcaIds.forEach(pcaId => {
                    const template = this.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === pcaId);
                    if (template && template.significativita) {
                        const sigValue = significanceValues[template.significativita];
                        if (sigValue > maxSignificance) { maxSignificance = sigValue; }
                    }
                });
                // Determina la significativit√† massima trovata e la mappa al WBS code
                const significanceKey = Object.keys(significanceValues).find(key => significanceValues[key] === maxSignificance);
                if (significanceKey) { this.config.WBS_SIGNIFICANCE_MAP[wbsCode] = significanceKey; }
            }
        },

        // Modulo per la gestione dello storage (IndexedDB tramite idb-keyval)
        store: {
            dbStore: idbKeyval.createStore('pca-db', 'reports'), // Crea uno store per i report
            // Recupera tutti i report salvati
            async getAll() { return (await idbKeyval.get(App.config.STORAGE_KEY, this.dbStore)) || []; },
            // Salva l'intero set di report
            async saveAll(reports) {
                await idbKeyval.set(App.config.STORAGE_KEY, reports, this.dbStore);
                App.state.data = reports; // Aggiorna lo stato globale
            },
            // Recupera un singolo report tramite ID
            async getById(id) {
                const reports = await this.getAll();
                return reports.find(r => r && String(r.id) === String(id));
            },
            // Salva o aggiorna un report
            async save(newReport) {
                const reports = await this.getAll();
                const reportId = String(newReport.id);
                const existingIndex = reports.findIndex(r => r && String(r.id) === reportId);
                if (existingIndex !== -1) {
                    reports[existingIndex] = newReport; // Aggiorna report esistente
                } else {
                    reports.push(newReport); // Aggiunge nuovo report
                }
                await this.saveAll(reports);
            },
            // Elimina un report tramite ID
            async delete(id) {
                let reports = await this.getAll();
                reports = reports.filter(r => r && String(r.id) !== String(id));
                await this.saveAll(reports);
            },
            // Genera il prossimo ID univoco (es. 'PCA-1', 'PCA-2')
            async getNextId(prefix = '') {
                const reports = await this.getAll();
                const relevantIds = reports
                    .map(r => String(r.id))
                    .filter(id => id.startsWith(prefix))
                    .map(id => parseInt(id.replace(prefix, ''), 10))
                    .filter(num => !isNaN(num));
                
                const maxId = relevantIds.length > 0 ? Math.max(...relevantIds) : 0;
                return prefix + (maxId + 1); // Costruisce il nuovo ID
            },
            // Calcola statistiche per la dashboard
            getDashboardStats() {
                const reports = App.state.data; 
                let openNc = 0; // Conteggio Non Conformit√† aperte
                let totalChecks = 0; // Totale check eseguiti
                let compliantChecks = 0; // Check conformi
                const ncByAspect = {}; // Conteggio NC per aspetto
                reports.forEach(report => {
                    // Processa solo PCA periodici con check compilati
                    if (report && report.type === 'periodico' && report.checks) {
                        Object.entries(report.checks).forEach(([aspectId, aspectChecks]) => {
                            const template = App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === aspectId);
                            if (!template || !aspectChecks) return;
                            aspectChecks.forEach(check => {
                                if (check && check.result && check.result !== 'NA') { // Conta solo check completati (C o NC)
                                    totalChecks++;
                                    if (check.result === 'C') compliantChecks++;
                                    if (check.result === 'NC') {
                                        openNc++;
                                        ncByAspect[template.title] = (ncByAspect[template.title] || 0) + 1; // Incrementa conteggio NC per aspetto
                                    }
                                }
                            });
                        });
                    }
                });
                const avgCompliance = totalChecks > 0 ? `${((compliantChecks / totalChecks) * 100).toFixed(0)}%` : 'N.D.'; // Calcola conformit√† media
                return { totalPca: reports.length, openNc, totalChecks, avgCompliance, ncByAspect };
            },
        },

        // Modulo per servizi esterni (es. API meteo)
        services: {
            // Richiede la posizione dell'utente e recupera i dati meteo
            async fetchLocationAndWeather() {
                const widget = App.dom.weatherWidget;
                if (!widget) return;
                widget.innerHTML = `<div class="loader"></div><span>Geolocalizzazione...</span>`; // Mostra loader

                if (!navigator.geolocation) { // Verifica supporto geolocalizzazione
                    widget.innerHTML = '<span>Geolocalizzazione non supportata.</span>';
                    App.state.currentWeather = null;
                    App.state.currentLocation = null;
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => { // Successo geolocalizzazione
                        const { latitude, longitude } = position.coords;
                        App.state.currentLocation = { latitude: latitude.toFixed(5), longitude: longitude.toFixed(5) };
                        // Costruisce URL API Open-Meteo
                        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude.toFixed(2)}&longitude=${longitude.toFixed(2)}&current=temperature_2m,precipitation,weather_code,wind_speed_10m`;
                        try {
                            const response = await fetch(apiUrl);
                            if (!response.ok) throw new Error('Risposta API non valida');
                            const data = await response.json();
                            App.state.currentWeather = data.current; // Salva dati meteo nello stato
                            App.ui.renderWeather(data.current); // Aggiorna UI widget meteo
                        } catch (error) {
                            console.error("Errore API meteo:", error);
                            widget.textContent = 'Meteo non disponibile';
                            App.state.currentWeather = null;
                        }
                    },
                    (error) => { // Errore geolocalizzazione
                        console.warn("Errore geolocalizzazione:", error.message);
                        widget.innerHTML = '<span>Geolocalizzazione negata.</span>';
                        App.state.currentWeather = null;
                        App.state.currentLocation = null;
                    }
                );
            },
            // Restituisce un saluto basato sull'ora del giorno
            getGreeting() {
                const hour = new Date().getHours();
                if (hour < 12) return 'Buongiorno';
                if (hour < 18) return 'Buon pomeriggio';
                return 'Buonasera';
            }
        },
        
        // Modulo per la gestione dell'interfaccia utente (UI)
        ui: {
            // Mappa delle funzioni di rendering per ogni scheda
            renderMap: { 
                'dashboard': 'renderDashboard', 
                'lista-pca': 'renderListaPca', 
                'nuovo-pca': 'renderNuovoPca', 
                'sopralluogo': 'renderNuovoSopralluogo', 
                'impostazioni': 'renderImpostazioni' 
            },
            // Mostra una notifica toast temporanea
            showToast(message, type = 'success') {
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
                App.dom.toast.textContent = message;
                // Applica classi per mostrare il toast con animazione
                App.dom.toast.className = `toast px-6 py-3 rounded-lg text-white font-medium shadow-lg ${colors[type]}`;
                setTimeout(() => { App.dom.toast.classList.add('show'); }, 10);
                setTimeout(() => { App.dom.toast.classList.remove('show'); }, 4000); // Rimozione dopo 4 secondi
            },
            // Mostra un modale di conferma
            showModal(config) {
                return new Promise((resolve) => {
                    const { title, message, confirmText = 'Conferma', cancelText = 'Annulla', confirmColor = 'bg-red-600' } = config;
                    // Costruisce il contenuto HTML del modale
                    App.dom.modal.innerHTML = `
                        <div class="modal-box">
                            <h3 class="text-xl font-bold mb-4">${this.sanitize(title)}</h3>
                            <p class="text-slate-600 dark:text-slate-300 mb-6">${this.sanitize(message)}</p>
                            <div class="flex justify-end gap-4">
                                <button id="modal-cancel" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">${this.sanitize(cancelText)}</button>
                                <button id="modal-confirm" class="px-5 py-2 text-white rounded-md ${confirmColor} hover:opacity-90 font-semibold">${this.sanitize(confirmText)}</button>
                            </div>
                        </div>`;
                    App.dom.modal.classList.add('visible'); // Mostra il modale
                    
                    // Aggiunge listener per i bottoni di conferma/annulla e per il click esterno
                    const confirmBtn = document.getElementById('modal-confirm');
                    const cancelBtn = document.getElementById('modal-cancel');
                    const closeModal = (decision) => {
                        App.dom.modal.classList.remove('visible'); // Nasconde il modale
                        resolve(decision); // Risolve la Promise con la decisione dell'utente
                    };
                    confirmBtn.onclick = () => closeModal(true);
                    cancelBtn.onclick = () => closeModal(false);
                    // Chiude modale se si clicca fuori dal contenuto
                    App.dom.modal.onclick = (e) => { if (e.target === App.dom.modal) closeModal(false); };
                });
            },
            // Mostra la scheda selezionata, aggiornando la navigazione e il contenuto
            async showTab(tabId) {
                App.state.tempPhotos = {}; // Resetta le foto temporanee al cambio scheda
                const tab = App.config.TABS.find(t => t.id === tabId);
                if (!tab) return;
                // Aggiorna lo stato attivo nella sidebar
                App.dom.sidebarNav.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.dataset.tabId === tabId));
                App.dom.pageTitle.textContent = tab.label; // Aggiorna il titolo della pagina
                
                // Attiva animazione fade-in per il nuovo contenuto
                App.dom.mainContent.classList.remove('content-fade-in');
                void App.dom.mainContent.offsetWidth; // Forza un reflow per riavviare l'animazione

                const renderFunctionName = this.renderMap[tabId];
                if (this[renderFunctionName]) await this[renderFunctionName](); // Chiama la funzione di rendering specifica
                
                App.dom.mainContent.classList.add('content-fade-in'); // Applica animazione fade-in
            },
            // Renderizza la navigazione della sidebar basandosi sulla configurazione dei tab
            renderNav() { 
                App.dom.sidebarNav.innerHTML = App.config.TABS.map(t => 
                    `<a href="#" data-tab-id="${t.id}" class="sidebar-link flex items-center px-4 py-3 mt-2 text-slate-600 dark:text-slate-300 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">${t.icon} ${t.label}</a>`
                ).join(''); 
            },
            // Renderizza la dashboard principale con statistiche e grafici
            renderDashboard() {
                const stats = App.store.getDashboardStats(); // Recupera le statistiche
                const frequencyStatuses = this.getFrequencyStatuses(); // Ottiene lo stato dei controlli periodici
                const greeting = App.services.getGreeting(); // Saluto basato sull'ora
                
                App.dom.mainContent.innerHTML = App.templates.dashboard(stats, frequencyStatuses.dueList, greeting); // Inietta il template dashboard
                
                // Configurazione e rendering del grafico delle Non Conformit√†
                const ctx = document.getElementById('ncChart')?.getContext('2d');
                if (!ctx) return; // Esce se il canvas non esiste
                if (App.state.activeChart) App.state.activeChart.destroy(); // Distrugge grafico precedente se esiste
                const chartData = {
                    labels: Object.keys(stats.ncByAspect).map(l => l.substring(l.indexOf(':') + 1).trim()), // Etichette (titoli PCA)
                    datasets: [{
                        label: 'NC',
                        data: Object.values(stats.ncByAspect), // Dati (conteggio NC)
                        backgroundColor: 'rgba(239, 68, 68, 0.7)', // Colore barra (Red-500)
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                };
                // Crea il nuovo grafico
                App.state.activeChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // Assi invertiti per grafico a barre orizzontali
                        scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }, // Scala X parte da 0, precisione intera
                        plugins: { legend: { display: false }, tooltip: { displayColors: false } } // Nasconde legenda e colori tooltip
                    }
                });
            },
            // Renderizza la sezione Impostazioni
            renderImpostazioni() {
                App.dom.mainContent.innerHTML = App.templates.settings();
                App.handlers.attachSettingsListeners(); // Collega listener specifici per impostazioni
            },
            // Renderizza la lista dei verbali, raggruppati per tipo (WBS, Sopralluogo, ecc.)
            renderListaPca() {
                try {
                    // Copia i dati e li ordina per data (dal pi√π recente al meno recente)
                    const reports = [...App.state.data].sort((a, b) => ( (b.date > a.date) ? 1 : -1 ));
                    const frequencyStatuses = this.getFrequencyStatuses(); // Ottiene lo stato di frequenza per i PCA periodici
                    
                    // Raggruppa i verbali per tipo (WBS, Sopralluogo, etc.)
                    const groupedReports = reports.reduce((acc, report) => {
                        if (!report || !report.type) {
                            console.warn("Saltato report corrotto:", report);
                            return acc;
                        }
                        let key;
                        // Assegna una chiave di raggruppamento basata sul tipo di report
                        if(report.type === 'periodico') {
                           key = report.wbs ? report.wbs.substring(0, 2).toUpperCase() : 'Generico'; // Usa codice WBS o 'Generico'
                        } else if (report.type === 'sopralluogo') {
                           key = 'Sopralluoghi';
                        } else if (report.type === 'preliminare') {
                           key = 'Ispezioni Preliminari';
                        } else if (report.type === 'finale') {
                           key = 'Ispezioni Finali';
                        } else {
                           key = 'Generico';
                        }

                        if (!acc[key]) acc[key] = { // Crea il gruppo se non esiste
                           descrizione: App.config.WBS_DATA[key]?.descrizione || key.replace(/([A-Z])/g, ' $1').trim(), // Descrizione WBS o chiave formattata
                           reports: []
                        };
                        acc[key].reports.push(report); // Aggiunge il report al gruppo
                        return acc;
                    }, {});

                    // Renderizza il template con i verbali raggruppati
                    App.dom.mainContent.innerHTML = App.templates.pcaGroupedList(groupedReports, frequencyStatuses.statusMap);
                    App.handlers.attachPcaListListeners(); // Collega listener per le azioni nella lista PCA
                } catch(err) {
                    console.error("Errore durante il rendering della lista PCA:", err);
                    App.dom.mainContent.innerHTML = `<p class="text-red-500">Impossibile visualizzare la lista dei controlli.</p>`;
                }
            },
            // Calcola lo stato di frequenza per i controlli periodici (OK, In Scadenza, Scaduto, Da Eseguire)
            getFrequencyStatuses() {
                const reports = App.state.data;
                const latestReportByWbs = {}; // Trova l'ultimo report per ogni WBS
                // Ordina per data decrescente e memorizza il primo report trovato per ogni WBS
                [...reports].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                    if (r && r.type === 'periodico' && r.wbs) {
                        const wbsCode = r.wbs.substring(0, 2).toUpperCase();
                        if (!latestReportByWbs[wbsCode]) {
                            latestReportByWbs[wbsCode] = r;
                        }
                    }
                });

                const statusMap = {}; // Mappa per lo stato di ogni WBS
                const dueList = []; // Lista dei controlli in scadenza o scaduti
                const now = new Date(); // Data attuale
                
                // Itera su tutti i WBS definiti con una significativit√†
                for (const wbsCode in App.config.WBS_SIGNIFICANCE_MAP) {
                    const significance = App.config.WBS_SIGNIFICANCE_MAP[wbsCode];
                    if (!significance) continue;

                    const report = latestReportByWbs[wbsCode]; // Recupera l'ultimo report per questo WBS
                    const interval = App.config.FREQUENCY_MAP[significance].days; // Intervallo in giorni basato sulla frequenza
                    
                    if(report) {
                        // Calcola la data di scadenza
                        const lastDate = new Date(report.date + 'T00:00:00'); // Assicura che la data sia interpretata correttamente
                        const dueDate = new Date(new Date(report.date + 'T00:00:00').setDate(lastDate.getDate() + interval));
                        const daysDiff = (dueDate - now) / (1000 * 3600 * 24); // Differenza giorni
                        
                        let status;
                        // Determina lo stato (Scaduto, In Scadenza, OK)
                        if (daysDiff < 0) { // Scaduto
                            status = { text: 'Scaduto', color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300', icon: 'üî•', nextDate: dueDate };
                            dueList.push({ wbs: wbsCode, status: status, days: Math.round(daysDiff) }); // Aggiunge alla lista dei "dovuti"
                        } else if (daysDiff <= 3) { // In Scadenza (ultimi 3 giorni)
                            status = { text: 'In Scadenza', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300', icon: '‚ö†Ô∏è', nextDate: dueDate };
                            dueList.push({ wbs: wbsCode, status: status, days: Math.round(daysDiff) }); // Aggiunge alla lista dei "dovuti"
                        } else { // OK
                            status = { text: 'OK', color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', icon: '‚úÖ', nextDate: dueDate };
                        }
                        statusMap[wbsCode] = status; // Memorizza lo stato per questo WBS

                    } else {
                        // Se non c'√® nessun report precedente, lo stato √® 'Da Eseguire'
                        const status = { text: 'Da Eseguire', color: 'bg-gray-200 text-gray-800 dark:bg-slate-700 dark:text-slate-300', icon: '‚û°Ô∏è', nextDate: null };
                        statusMap[wbsCode] = status;
                        dueList.push({ wbs: wbsCode, status: status, days: -Infinity }); // Aggiunge alla lista dei "dovuti"
                    }
                }
                dueList.sort((a,b) => a.days - b.days); // Ordina la lista dei "dovuti" per data di scadenza
                return { statusMap, dueList };
            },
            // Aggiorna il widget meteo con i dati ricevuti
            renderWeather(weatherData) {
                const widget = App.dom.weatherWidget;
                if (!widget || !weatherData) return;
                
                const weatherInfo = App.config.WEATHER_CODE_MAP[weatherData.weather_code] || {text: 'N/D', icon: '‚ùì'};
                
                // Aggiorna l'HTML del widget meteo
                widget.innerHTML = `
                    <span title="${weatherInfo.text}" class="text-xl">${weatherInfo.icon}</span>
                    <span class="font-semibold">${weatherData.temperature_2m}¬∞C</span>
                    <span class="hidden sm:inline-flex items-center gap-1" title="Precipitazioni">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" fill="currentColor"><path d="M149.33,181.33,128,202.67,106.67,181.33a40,40,0,0,1,53.33-53.33l-5.33,5.33a32,32,0,0,0-45.34,45.34L128,197.33l18.67-18.66a8,8,0,0,1,11.33,11.33Z" opacity="0.2"></path><path d="M128,24A104.11,104.11,0,0,0,24,128c0,41.94,23.31,81.34,64,98.34V241.6a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16v-15.26c40.69-17,64-56.4,64-98.34A104.11,104.11,0,0,0,128,24Zm8,199.6v-8a16,16,0,0,0-16-16H94.48c-32.32-15.53-50.48-46.72-50.48-79.6,0-48.52,39.48-88,88-88s88,39.48,88,88c0,32.88-18.16,64.07-50.48,79.6H152a16,16,0,0,0-16,16v8Z"></path></svg>
                        ${weatherData.precipitation} mm
                    </span>
                    <span class="hidden sm:inline-flex items-center gap-1" title="Velocit√† del vento">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" fill="currentColor"><path d="M148,168a12,12,0,1,1-12-12A12,12,0,0,1,148,168Z" opacity="0.2"></path><path d="M248,128a12,12,0,0,1-12,12H132v8a24,24,0,0,1-48,0v-8H24a12,12,0,0,1,0-24H84v-8a24,24,0,0,1,48,0v8h104A12,12,0,0,1,248,128ZM108,88a24,24,0,0,1,48,0v8H108Zm0,80v-8h48v8a24,24,0,0,1-48,0Zm40-48a20,20,0,1,0-20,20A20,20,0,0,0,148,120Zm-28,0a8,8,0,1,1,8,8A8,8,0,0,1,120,120Z"></path></svg>
                        ${weatherData.wind_speed_10m.toFixed(1)} km/h
                    </span>
                `;
            },
            // Renderizza il form per un nuovo PCA
            renderNuovoPca() {
                const nextId = await App.store.getNextId('PCA-'); // Ottiene il prossimo ID disponibile
                const today = new Date().toISOString().slice(0, 10); // Data odierna
                App.dom.mainContent.innerHTML = App.templates.newPcaForm({ nextId, today }); // Inietta il template del form
                App.handlers.attachNewPcaFormListeners(); // Collega listener per il form
                this.updateFormRequirements('periodico'); // Imposta lo stato iniziale del form (tipo periodico)
            },
            // Aggiorna la visibilit√† delle sezioni del form (WBS vs Manuale) e delle checklist
            updateFormRequirements(type) {
                const isPeriodico = type === 'periodico';
                // Mostra/nasconde la sezione WBS o quella manuale
                document.getElementById('wbs-section').classList.toggle('visible', isPeriodico);
                document.getElementById('manual-section').classList.toggle('visible', !isPeriodico);
                
                // Mostra/nasconde i contenitori delle checklist in base al tipo di controllo
                document.getElementById('checklist-container-periodico').style.display = isPeriodico ? 'block' : 'none';
                document.getElementById('checklist-container-preliminare').style.display = type === 'preliminare' ? 'block' : 'none';
                document.getElementById('checklist-container-finale').style.display = type === 'finale' ? 'block' : 'none';
                
                // Imposta l'attributo 'required' dinamicamente per i campi WBS o manuali
                const wbsInputs = ['pca-wbs-input', 'pca-lavorazione-select', 'pca-inspector-wbs'];
                const manualInputs = ['wbs-manual', 'inspector-manual', 'activities-manual'];
                
                wbsInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', isPeriodico));
                manualInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', !isPeriodico));
            },
            // Applica il tema (light/dark) all'applicazione
            applyTheme(isDark, isInitial = false) {
                document.documentElement.classList.toggle('dark', isDark); // Aggiunge/rimuove classe 'dark' su <html>
                App.dom.theme.darkIcon.classList.toggle('hidden', !isDark); // Mostra/nasconde icona tema scuro
                App.dom.theme.lightIcon.classList.toggle('hidden', isDark); // Mostra/nasconde icona tema chiaro
                if (!isInitial) localStorage.setItem('theme', isDark ? 'dark' : 'light'); // Salva preferenza tema
            },
            // Imposta lo stato della sidebar (aperta/chiusa/collassata)
            setSidebarState(isOpen) {
                App.state.isSidebarOpen = isOpen;
                localStorage.setItem('sidebarOpen', isOpen.toString()); // Salva stato sidebar
                
                // Aggiorna classi basate sulla larghezza dello schermo
                if (window.innerWidth < 1024) { // Schermi piccoli: toggle classi 'sidebar-open' e 'visible' sull'overlay
                    App.dom.appContainer.classList.toggle('sidebar-open', isOpen);
                    App.dom.sidebarOverlay.classList.toggle('visible', isOpen);
                } else { // Schermi grandi: toggle classe 'sidebar-collapsed'
                    App.dom.appContainer.classList.toggle('sidebar-collapsed', !isOpen);
                }
            },
            // Apre/chiude la sidebar
            toggleSidebar() {
                this.setSidebarState(!App.state.isSidebarOpen);
            },
            // Reset del form PCA per visualizzare di nuovo la schermata di creazione
            resetPcaForm: () => { App.ui.showTab('nuovo-pca'); },
            // Funzione di stampa del verbale
            async print(report) {
                if (!report) { // Verifica se il report √® valido
                    App.ui.showToast("Dati del verbale non validi.", "error");
                    return;
                }
                
                // Renderizza l'HTML specifico per il tipo di report (Sopralluogo o PCA)
                if (report.type === 'sopralluogo') {
                    App.dom.printAreaWrapper.innerHTML = App.templates.printSopralluogo(report);
                } else {
                    let templates;
                    // Determina i template corretti in base al tipo di PCA
                    if (report.type === 'preliminare') {
                        templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                    } else if (report.type === 'finale') {
                        templates = App.config.CHECK_TEMPLATES_FINALE;
                    } else if (report.type === 'periodico') {
                        templates = App.config.CHECK_TEMPLATES_PERIODIC;
                    }

                    if (!templates) { // Gestisce tipi di report non riconosciuti
                        console.error("Tipo di report non valido per la stampa:", report.type, report);
                        App.ui.showToast(`Impossibile stampare: tipo di verbale non riconosciuto ('${report.type}').`, "error");
                        return;
                    }
                    
                    App.dom.printAreaWrapper.innerHTML = App.templates.printReport(report, templates); // Renderizza template PCA
                }

                // Attiva la finestra di stampa del browser dopo un breve ritardo
                setTimeout(() => window.print(), 200);
            },
            // Sanitizza stringhe per prevenire attacchi XSS, convertendo caratteri speciali HTML
            sanitize(str) {
                if (typeof str !== 'string') return str;
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }
        },

        // Gestore degli eventi
        handlers: {
            // Funzione debounce per limitare la frequenza di esecuzione di una funzione
            debounce(func, delay = 300) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            },
            // Collega listener di eventi globali (sidebar, tema, data)
            attachGlobalListeners() { 
                App.dom.sidebarNav.addEventListener('click', e => { 
                    const link = e.target.closest('.sidebar-link');
                    if (link) { 
                        e.preventDefault(); 
                        App.ui.showTab(link.dataset.tabId); // Passa alla scheda selezionata
                        if(window.innerWidth < 1024) { 
                            App.ui.setSidebarState(false); // Chiude sidebar su schermi piccoli
                        }
                    } 
                });
                
                // Listener per cambio tema
                App.dom.theme.toggleBtn.addEventListener('click', () => App.ui.applyTheme(!document.documentElement.classList.contains('dark')));
                
                // Listener per toggle sidebar
                App.dom.sidebarToggleBtn.addEventListener('click', () => App.ui.toggleSidebar());
                
                // Listener per chiudere sidebar tramite overlay
                App.dom.sidebarOverlay.addEventListener('click', () => App.ui.setSidebarState(false));
                
                // Aggiorna la data corrente visualizzata nell'header
                App.dom.currentDate.textContent = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                // Riadatta lo stato della sidebar alla resize della finestra (utile per breakpoint)
                window.addEventListener('resize', () => {
                    App.ui.setSidebarState(App.state.isSidebarOpen);
                });
            },
            // Collega listener per le interazioni nella lista PCA (stampa, eliminazione, espansione gruppi)
            attachPcaListListeners() {
                const container = App.dom.mainContent;
                container.addEventListener('click', async (e) => {
                    const printBtn = e.target.closest('.print-pca-btn');
                    const deleteBtn = e.target.closest('.delete-pca-btn');
                    const header = e.target.closest('.grouped-pca-header'); // Click su header gruppo

                    if (printBtn) { // Azione Stampa
                        printBtn.disabled = true; // Disabilita bottone per evitare click multipli
                        const report = await App.store.getById(printBtn.dataset.id);
                        await App.ui.print(report); // Avvia stampa
                        printBtn.disabled = false; // Riabilita bottone
                    }
                    if (deleteBtn) { // Azione Elimina
                        const id = deleteBtn.dataset.id;
                        const report = await App.store.getById(id);
                        // Chiede conferma all'utente prima di eliminare
                        const confirmed = await App.ui.showModal({
                            title: 'Conferma Eliminazione',
                            message: `Sei sicuro di voler eliminare il verbale N¬∞ ${id} (${report.activities || report.wbs})? L'azione √® irreversibile.`,
                            confirmText: 'Elimina',
                            confirmColor: 'bg-red-600'
                        });
                        if (confirmed) this.onDeletePca(id); // Chiama la funzione di eliminazione
                    }
                    if(header) { // Espande/collassa gruppo PCA
                        const content = header.nextElementSibling; // Il contenuto √® l'elemento successivo all'header
                        header.classList.toggle('open'); // Aggiunge/rimuove classe 'open' all'header
                        content.classList.toggle('open'); // Aggiunge/rimuove classe 'open' al contenuto
                    }
                });
            },
            // Gestisce l'eliminazione di un report
            async onDeletePca(reportId) {
                await App.store.delete(reportId); // Elimina dal database
                App.ui.showToast(`Verbale N¬∞ ${reportId} eliminato.`, 'info');
                await App.ui.showTab('lista-pca'); // Ricarica la lista
            },
            // Collega listener per il form di creazione nuovo PCA
            attachNewPcaFormListeners() {
                const form = document.getElementById('new-pca-form'); if (!form) return;
                form.addEventListener('submit', (e) => this.onNewPcaSubmit(e)); // Listener submit form
                form.addEventListener('click', (e) => { // Listener per click su elementi del form
                    if (e.target.closest('.photo-preview-content')) e.target.closest('.photo-uploader').querySelector('.photo-input').click(); // Apre input file per foto
                    if (e.target.closest('.remove-photo-btn')) this.onPhotoRemove(e); // Rimuove foto
                    if (e.target.matches('#cancel-pca-btn')) App.ui.resetPcaForm(); // Annulla e resetta form
                    if (e.target.matches('#print-draft-btn')) this.onPrintDraft(form); // Stampa bozza
                    if (e.target.id === 'add-cer-row-btn') this.addCerRow(); // Aggiunge riga tabella rifiuti
                    if (e.target.closest('.cer-delete-row-btn')) e.target.closest('tr').remove(); // Rimuove riga tabella rifiuti
                    
                    const accordionHeader = e.target.closest('.accordion-header');
                    if (accordionHeader) { // Apre/chiude accordion PCA
                        const content = accordionHeader.nextElementSibling;
                        accordionHeader.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
                // Listener per cambio file nelle input foto
                form.querySelectorAll('.photo-input').forEach(i => i.addEventListener('change', (e) => this.onPhotoUpload(e)));
                // Listener per cambio stato radio button (per mostrare/nascondere campi NC o condizionali)
                form.addEventListener('change', (e) => {
                    if (e.target.type === 'radio' && e.target.name.startsWith('check_')) {
                        const wrapper = e.target.closest('.check-item-wrapper');
                        const ncObservationWrapper = wrapper.querySelector('.nc-observation-wrapper');
                        if (ncObservationWrapper) {
                             ncObservationWrapper.classList.toggle('visible', e.target.value === 'NC'); // Mostra NC se selezionato 'No'
                        }
                        const conditionalSection = wrapper.querySelector('.conditional-section:not(.nc-observation-wrapper)');
                        if(conditionalSection){
                            conditionalSection.classList.toggle('visible', e.target.value === 'C'); // Mostra campi aggiuntivi se selezionato 'S√¨'
                        }
                    }
                });
                // Listener per cambio tipo di controllo (periodico, preliminare, finale)
                document.getElementById('pca-type')?.addEventListener('change', (e) => App.ui.updateFormRequirements(e.target.value));
                // Listener per input codice WBS: gestisce il caricamento dinamico delle checklist pertinenti
                document.getElementById('pca-wbs-input')?.addEventListener('input', (e) => {
                    const wbsCodeFull = e.target.value.toUpperCase(); const wbsCode = wbsCodeFull.substring(0, 2); const wbsData = App.config.WBS_DATA[wbsCode]; const lavorazioneSelect = document.getElementById('pca-lavorazione-select');
                    
                    const accordionContainer = document.getElementById('checklist-container-periodico');
                    const accordionContents = accordionContainer.querySelectorAll('.accordion-content');
                    const accordionHeaders = accordionContainer.querySelectorAll('.accordion-header');
                    
                    // Resetta opzioni lavorazione e nasconde tutte le checklist
                    lavorazioneSelect.innerHTML = '<option value="">-- Prima inserisci WBS --</option>';
                    lavorazioneSelect.disabled = true;
                    accordionContainer.querySelectorAll('.pca-sheet-accordion').forEach(el => el.style.display = 'none');
                    accordionContents.forEach(c => c.classList.remove('open'));
                    accordionHeaders.forEach(h => h.classList.remove('open'));

                    // Se WBS valido, popola le lavorazioni e mostra le checklist associate agli aspetti
                    if (wbsData && wbsCodeFull.length >= 2) {
                        App.ui.showToast('Checklist per ' + wbsCode + ' caricate.', 'info');
                        lavorazioneSelect.innerHTML = '<option value="">-- Seleziona Lavorazione --</option>';
                        wbsData.lavorazioni.forEach(lav => { const option = document.createElement('option'); option.value = lav; option.textContent = lav; lavorazioneSelect.appendChild(option); });
                        lavorazioneSelect.disabled = false;
                        
                        // Ottiene gli ID delle PCA richieste per questo WBS
                        const requiredPcaIds = new Set(wbsData.aspetti.map(a => App.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                        let firstAccordionEl = null; // Riferimento al primo accordion da aprire

                        requiredPcaIds.forEach((sheetId, index) => { 
                            const accordionEl = document.getElementById(`accordion-${sheetId}`); // Trova elemento accordion
                            if (accordionEl) {
                                accordionEl.style.display = 'block'; // Rende visibile
                                if (index === 0) {
                                    firstAccordionEl = accordionEl; // Memorizza il primo per aprirlo di default
                                }
                            }
                        });

                        if (firstAccordionEl) { // Se esiste un accordion da aprire di default
                            const header = firstAccordionEl.querySelector('.accordion-header');
                            const content = firstAccordionEl.querySelector('.accordion-content');
                            header.classList.add('open'); // Apri header
                            content.classList.add('open'); // Apri contenuto
                        }
                    }
                });
            },
            // Aggiunge una nuova riga vuota alla tabella dei rifiuti (CER)
            addCerRow() {
                const index = Date.now(); // Genera un indice univoco basato sul timestamp
                const container = document.getElementById('cer-table-rows');
                if (!container) return;

                const row = document.createElement('tr');
                row.className = 'cer-row';
                row.innerHTML = App.templates.wasteTableRow(index); // Inietta HTML riga
                container.appendChild(row);
            },
            // Costruisce l'oggetto report dai dati del form
            _buildReportObjectFromForm(form) {
                const formData = new FormData(form);
                const reportType = formData.get('type');
                const sanitize = App.ui.sanitize;
                
                // Crea oggetto report base
                const report = { 
                    id: sanitize(formData.get('id')), 
                    type: sanitize(reportType), 
                    date: sanitize(formData.get('date')), 
                    // Determina l'ispettore e WBS/Attivit√† in base al tipo di controllo
                    inspector: sanitize(reportType === 'periodico' ? formData.get('inspector-wbs') : formData.get('inspector-manual')), 
                    wbs: sanitize(reportType === 'periodico' ? formData.get('wbs-input') : formData.get('wbs-manual')), 
                    activities: sanitize(reportType === 'periodico' ? formData.get('lavorazione') : formData.get('activities-manual')), 
                    weather: App.state.currentWeather, // Dati meteo correnti
                    location: App.state.currentLocation, // Dati geolocalizzazione correnti
                    checks: {}, // Checklists
                    observations: {}, // Osservazioni per checklist
                    photos: {}, // Foto associate ai check
                    cerData: [], // Dati tabella rifiuti
                    extraData: {} // Dati aggiuntivi condizionali
                };
                
                // Determina quale set di template utilizzare (Periodico, Preliminare, Finale)
                let templates;
                if (reportType === 'preliminare') templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                else if (reportType === 'finale') templates = App.config.CHECK_TEMPLATES_FINALE;
                else templates = App.config.CHECK_TEMPLATES_PERIODIC;

                // Itera su tutti i template applicabili per raccogliere i dati dei check
                templates.forEach(template => {
                    const sheetElement = document.getElementById(`accordion-${template.id}`);
                    // Processa solo se la scheda PCA √® visibile (non nascosta dal WBS)
                    if (sheetElement && window.getComputedStyle(sheetElement).display !== 'none') {
                        report.checks[template.id] = template.items.map((item, idx) => {
                            const result = sanitize(formData.get(`check_${template.id}_${idx}`));
                            const nc_observation = result === 'NC' ? sanitize(formData.get(`nc_observation_${template.id}_${idx}`)) : null;
                            
                            // Salva foto temporanee se presenti
                            const photoKey = `photo_${template.id}_${idx}`;
                            if(App.state.tempPhotos[photoKey]) {
                               if(!report.photos[template.id]) report.photos[template.id] = {};
                               report.photos[template.id][idx] = App.state.tempPhotos[photoKey];
                            }
                            
                            // Salva dati aggiuntivi condizionali (es. numero autorizzazione)
                            if (result === 'C') {
                                const extraFields = form.querySelectorAll(`[name^="extra_${template.id}_${idx}"]`);
                                if(extraFields.length > 0) {
                                    if(!report.extraData[template.id]) report.extraData[template.id] = {};
                                    if(!report.extraData[template.id][idx]) report.extraData[template.id][idx] = {};
                                    extraFields.forEach(field => {
                                        const fieldName = field.name.split('_').pop(); // Estrae il nome del campo extra
                                        report.extraData[template.id][idx][fieldName] = sanitize(field.value);
                                    });
                                }
                            }

                            return { item: sanitize(item), result, nc_observation }; // Restituisce l'oggetto check
                        });
                        report.observations[template.id] = sanitize(formData.get(`observation_${template.id}`)); // Salva osservazioni generali
                    }
                });

                // Raccoglie i dati dalla tabella rifiuti (CER)
                const cerContainer = document.getElementById('cer-table-rows');
                if (cerContainer) {
                    cerContainer.querySelectorAll('.cer-row').forEach(row => {
                        // Estrae i dati di ogni riga della tabella rifiuti
                        const rowData = {
                            cer: sanitize(row.querySelector('[name^="cer_produttore"]').value),
                            ubicazione: sanitize(row.querySelector('[name^="cer_ubicazione"]').value),
                            verbaleN: sanitize(row.querySelector('[name^="cer_verbaleN"]').value),
                            verbaleDel: sanitize(row.querySelector('[name^="cer_verbaleDel"]').value),
                            provaN: sanitize(row.querySelector('[name^="cer_provaN"]').value),
                            provaDel: sanitize(row.querySelector('[name^="cer_provaDel"]').value),
                            identificato: sanitize(row.querySelector('[name^="cer_identificato"]').value),
                            delimitato: sanitize(row.querySelector('[name^="cer_delimitato"]').value),
                            produzione: row.querySelector('[name^="cer_produzione"]').checked,
                            carico: row.querySelector('[name^="cer_carico"]').checked,
                            validita: sanitize(row.querySelector('[name^="cer_validita"]').value),
                            note: sanitize(row.querySelector('[name^="cer_note"]').value),
                        };
                        // Aggiunge i dati solo se la riga contiene informazioni
                        if (Object.values(rowData).some(v => (typeof v === 'string' && v.trim() !== '') || (typeof v === 'boolean' && v))) {
                            report.cerData.push(rowData);
                        }
                    });
                }
                return report; // Restituisce l'oggetto report completo
            },
            // Gestisce la stampa della bozza del PCA
            async onPrintDraft(form) {
                const report = this._buildReportObjectFromForm(form);
                await App.ui.print(report);
            },
            // Gestisce l'invio del form per un nuovo PCA
            async onNewPcaSubmit(e) {
                e.preventDefault();
                if (App.state.isSaving) return; // Evita invii multipli
                
                const form = e.target;
                if (!form.checkValidity()) { // Validazione front-end
                    form.reportValidity();
                    App.ui.showToast('Compilare tutti i campi obbligatori evidenziati.', 'error');
                    return;
                }

                App.state.isSaving = true; // Imposta flag salvataggio
                const saveBtn = document.getElementById('save-pca-btn');
                if (saveBtn) { // Mostra stato di salvataggio sul bottone
                    saveBtn.disabled = true; 
                    saveBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Salva Controllo...</span>`; 
                }

                try {
                    const newReport = this._buildReportObjectFromForm(form); // Costruisce l'oggetto report
                    await App.store.save(newReport); // Salva nel database
                    App.ui.showToast('Controllo salvato con successo!', 'success');
                    App.ui.resetPcaForm(); // Resetta il form per crearne uno nuovo
                    await App.ui.showTab('lista-pca'); // Torna alla lista dei verbali
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    App.ui.showToast(error.message || 'Si √® verificato un errore imprevisto.', 'error');
                } finally {
                    App.state.isSaving = false; // Resetta flag salvataggio
                    if (saveBtn) { // Riabilita bottone e resetta testo/icona
                        saveBtn.disabled = false; 
                        saveBtn.innerHTML = '<span>Salva Controllo</span>'; 
                    }
                }
            },
            // Rimuove una foto dall'anteprima e dalla cache temporanea
            onPhotoRemove(e) {
                e.preventDefault();
                e.stopPropagation();
                const uploader = e.target.closest('.photo-uploader');
                const input = uploader.querySelector('.photo-input');
                const preview = uploader.querySelector('.photo-preview-content');
                const key = input.dataset.key; // Chiave della foto (es. 'photo_pca01_0')

                input.value = ''; // Resetta l'input file
                preview.innerHTML = App.templates.imagePlaceholderIcon(); // Mostra placeholder
                delete App.state.tempPhotos[key]; // Rimuove dalla cache
                uploader.querySelector('.remove-photo-btn').classList.add('hidden'); // Nasconde bottone rimuovi
            },
            // Gestisce l'upload di una foto: visualizza anteprima e la salva temporaneamente
            async onPhotoUpload(e) { 
                const input = e.target; 
                const key = input.dataset.key; 
                const uploader = input.closest('.photo-uploader');
                const previewContainer = uploader.querySelector('.photo-preview-content');
                const removeBtn = uploader.querySelector('.remove-photo-btn');
                const file = input.files[0]; 
                
                if (!file || !previewContainer) return; 
                
                previewContainer.innerHTML = `<div class="loader"></div>`; // Mostra loader nell'anteprima
                
                try { 
                    // Ridimensiona l'immagine prima di visualizzarla e salvarla temporaneamente
                    const dataUrl = await this.resizeImage(file, 1024); 
                    previewContainer.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover" alt="Anteprima">`; // Mostra anteprima
                    App.state.tempPhotos[key] = dataUrl; // Salva dataUrl nella cache temporanea
                    removeBtn.classList.remove('hidden'); // Mostra bottone rimuovi
                } catch (err) { 
                    previewContainer.innerHTML = App.templates.imagePlaceholderIcon(); // Mostra placeholder in caso di errore
                    delete App.state.tempPhotos[key]; // Rimuove dalla cache
                    removeBtn.classList.add('hidden'); // Nasconde bottone rimuovi
                    App.ui.showToast("Errore nel caricamento foto.", "error"); 
                } 
            },
            // Funzione per ridimensionare un'immagine usando Canvas
            resizeImage: (file, maxSize) => new Promise((resolve, reject) => { 
                const reader = new FileReader(); 
                reader.onload = e => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        let { width, height } = img;
                        // Calcola nuove dimensioni mantenendo proporzioni e rispettando maxSize
                        if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                        else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } 
                        
                        const canvas = document.createElement('canvas'); 
                        canvas.width = width; 
                        canvas.height = height; 
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height); // Disegna immagine ridimensionata su canvas
                        resolve(canvas.toDataURL('image/jpeg', 0.8)); // Restituisce Data URL in formato JPEG con compressione 0.8
                    }; 
                    img.onerror = reject; // Gestisce errore caricamento immagine
                    img.src = e.target.result; 
                }; 
                reader.onerror = reject; // Gestisce errore lettura file
                reader.readAsDataURL(file); // Legge il file come Data URL
            }),
            // Collega listener per la sezione Impostazioni (export, import, clear all)
            attachSettingsListeners() { 
                document.getElementById('export-btn')?.addEventListener('click', this.exportData); // Listener esporata dati
                document.getElementById('import-btn')?.addEventListener('click', () => document.getElementById('import-file').click()); // Trigger input file importazione
                document.getElementById('import-file')?.addEventListener('change', async (e) => { // Listener cambio file importazione
                       // Chiede conferma prima di sovrascrivere i dati
                       const confirmed = await App.ui.showModal({
                            title: 'Conferma Importazione',
                            message: "ATTENZIONE: i dati attuali verranno SOVRASCRITTI in modo permanente. Continuare?",
                            confirmText: 'Sovrascrivi e Importa',
                            confirmColor: 'bg-orange-500'
                       });
                       if (confirmed) this.importData(e); // Procedi con importazione se confermato
                });
                document.getElementById('clear-all-btn')?.addEventListener('click', this.onClearAllData); // Listener per svuotare tutti i dati
            },
            // Gestisce la richiesta di svuotare completamente l'archivio dati
            async onClearAllData() {
                // Modale di conferma avanzata con richiesta digitazione 'ELIMINA'
                const modalHTML = `
                    <div class="modal-box">
                        <h3 class="text-xl font-bold mb-2 text-red-500">Azione Irreversibile</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-4">Sei assolutamente sicuro di voler eliminare TUTTI i verbali salvati? Questa azione non pu√≤ essere annullata.</p>
                        <p class="text-slate-600 dark:text-slate-300 mb-4">Per confermare, digita "<b>ELIMINA</b>" nel campo sottostante.</p>
                        <input type="text" id="delete-confirm-input" class="form-input w-full mb-6" placeholder="ELIMINA">
                        <div class="flex justify-end gap-4">
                            <button id="modal-cancel" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 rounded-md font-semibold">Annulla</button>
                            <button id="modal-confirm-delete" class="px-5 py-2 text-white rounded-md bg-red-600 font-semibold opacity-50 cursor-not-allowed" disabled>Elimina Tutto</button>
                        </div>
                    </div>`;

                App.dom.modal.innerHTML = modalHTML;
                App.dom.modal.classList.add('visible');

                // Elementi del modale di conferma avanzata
                const confirmInput = document.getElementById('delete-confirm-input');
                const confirmBtn = document.getElementById('modal-confirm-delete');
                const cancelBtn = document.getElementById('modal-cancel');

                // Abilita bottone conferma solo se il testo digitato √® corretto
                confirmInput.addEventListener('input', () => {
                    if (confirmInput.value === 'ELIMINA') {
                        confirmBtn.disabled = false;
                        confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        confirmBtn.disabled = true;
                        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
                
                // Funzione per chiudere il modale e procedere con l'azione
                const closeModal = async (decision) => {
                    App.dom.modal.classList.remove('visible');
                    if (decision) { // Se l'utente ha confermato
                        await App.store.saveAll([]); // Svuota l'archivio salvando un array vuoto
                        await App.ui.showTab('dashboard'); // Torna alla dashboard
                        App.ui.showToast("Archivio svuotato con successo.", "info");
                    }
                };
                
                confirmBtn.onclick = () => closeModal(true); // Chiama closeModal(true) al click di conferma
                cancelBtn.onclick = () => closeModal(false); // Chiama closeModal(false) al click di annulla
                App.dom.modal.onclick = (e) => { if (e.target === App.dom.modal) closeModal(false); }; // Chiude se si clicca fuori
            },
            // Esporta i dati dell'applicazione in un file JSON
            exportData() { 
                const data = await App.store.getAll(); 
                if (data.length === 0) return App.ui.showToast("Nessun dato da esportare.", 'info'); 
                const dataStr = JSON.stringify(data, null, 2); // Formatta JSON
                const blob = new Blob([dataStr], { type: 'application/json' }); // Crea Blob
                const url = URL.createObjectURL(blob); // Crea URL temporaneo per il Blob
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = `pca_backup_${new Date().toISOString().slice(0, 10)}.json`; // Nome file con data
                a.click(); // Simula click sul link per avviare download
                URL.revokeObjectURL(url); // Rilascia l'URL temporaneo
                App.ui.showToast("Esportazione dati completata.", 'success'); 
            },
            // Importa dati da un file JSON sovrascrivendo i dati attuali
            importData(e) { 
                const file = e.target.files[0]; 
                if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = async (event) => { 
                    try { 
                        const data = JSON.parse(event.target.result); // Parsifica il contenuto del file
                        if (!Array.isArray(data)) throw new Error("File non valido"); // Verifica che sia un array
                        await App.store.saveAll(data); // Salva i dati importati
                        App.ui.showToast("Dati importati con successo!", 'success'); 
                        await App.ui.showTab('dashboard'); // Torna alla dashboard
                    } catch (err) { App.ui.showToast("Errore: il file di backup non √® valido.", 'error'); } 
                }; 
                reader.readAsText(file); // Legge il file come testo
                e.target.value = ''; // Resetta il valore dell'input file
            },
            // Collega listener per il form del verbale di sopralluogo
             attachSopralluogoListeners() {
                const form = document.getElementById('new-sopralluogo-form'); if (!form) return;
                form.addEventListener('submit', (e) => this.onSopralluogoSubmit(e)); // Listener submit
                form.addEventListener('click', (e) => { 
                    if (e.target.closest('.photo-preview-content')) e.target.closest('.photo-uploader').querySelector('.photo-input').click(); // Apri input foto
                    if (e.target.closest('.remove-photo-btn')) this.onPhotoRemove(e); // Rimuovi foto
                    if (e.target.matches('#print-draft-btn')) this.onPrintSopralluogoDraft(form); // Stampa bozza
                });
                form.querySelectorAll('.photo-input').forEach(i => i.addEventListener('change', (e) => this.onPhotoUpload(e))); // Listener upload foto
             },
             // Costruisce l'oggetto report per un verbale di sopralluogo
             _buildSopralluogoObjectFromForm(form) {
                const formData = new FormData(form);
                const sanitize = App.ui.sanitize;
                const reportId = sanitize(formData.get('id'));

                // Crea oggetto base per il sopralluogo
                const report = {
                    id: reportId,
                    type: 'sopralluogo',
                    date: sanitize(formData.get('date')),
                    wbs: sanitize(formData.get('wbs')),
                    activities: `Sopralluogo Area: ${sanitize(formData.get('wbs'))}`, // Attivit√† generica
                    inspector: sanitize(formData.get('inspector')),
                    notes: sanitize(formData.get('notes')),
                    weather: App.state.currentWeather, // Dati meteo correnti
                    location: App.state.currentLocation, // Dati geolocalizzazione correnti
                    photos: [] // Array per le foto con didascalie
                };
                
                // Raccoglie le foto e le didascalie dal form
                for(let i = 0; i < 5; i++){
                    const photoKey = `photo_sopralluogo_${i}`;
                    const caption = sanitize(formData.get(`caption_${i}`));
                    if(App.state.tempPhotos[photoKey]){ // Aggiunge foto solo se presente nella cache temporanea
                        report.photos.push({
                            src: App.state.tempPhotos[photoKey],
                            caption: caption
                        });
                    }
                }
                return report;
             },
             // Gestisce la stampa della bozza del verbale di sopralluogo
             async onPrintSopralluogoDraft(form) {
                const report = this._buildSopralluogoObjectFromForm(form);
                await App.ui.print(report);
             },
             // Gestisce l'invio del form per un nuovo verbale di sopralluogo
             async onSopralluogoSubmit(e) {
                e.preventDefault();
                if (App.state.isSaving) return; // Evita invii multipli
                
                const form = e.target;
                if (!form.checkValidity()) { // Validazione form
                    form.reportValidity();
                    App.ui.showToast('Compilare tutti i campi obbligatori evidenziati.', 'error');
                    return;
                }

                App.state.isSaving = true; // Imposta flag salvataggio
                const saveBtn = form.querySelector('button[type="submit"]');
                if (saveBtn) { // Aggiorna stato bottone
                    saveBtn.disabled = true; 
                    saveBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Salvando...</span>`; 
                }
                
                try {
                    const newReport = this._buildSopralluogoObjectFromForm(form); // Costruisce oggetto report
                    await App.store.save(newReport); // Salva nel database
                    App.ui.showToast('Verbale di Sopralluogo salvato!', 'success');
                    await App.ui.showTab('lista-pca'); // Torna alla lista verbali

                } catch (error) {
                    console.error("Errore durante il salvataggio del sopralluogo:", error);
                    App.ui.showToast(error.message || 'Si √® verificato un errore imprevisto.', 'error');
                } finally {
                    App.state.isSaving = false; // Resetta flag salvataggio
                    if (saveBtn) { // Riabilita bottone
                        saveBtn.disabled = false; 
                        saveBtn.innerHTML = '<span>Salva Verbale</span>'; 
                    }
                }
            }
        },
        
        // Modulo per i template HTML generati dinamicamente
        templates: {
            // Template per la Dashboard
            dashboard: (stats, dueList, greeting) => {
                // HTML per la lista dei controlli da eseguire/in scadenza
                let dueListHtml = '<p class="text-slate-500 dark:text-slate-400">Tutti i controlli periodici sono aggiornati.</p>';
                if (dueList.length > 0) {
                    dueListHtml = `<ul class="space-y-3">${dueList.map(item => `
                        <li class="flex items-center justify-between p-3 rounded-lg bg-slate-100 dark:bg-slate-700/50">
                            <div>
                                <span class="font-bold">${item.wbs}</span>
                                <span class="text-sm text-slate-500 dark:text-slate-400 ml-2">${App.config.WBS_DATA[item.wbs]?.descrizione || 'Sconosciuto'}</span>
                            </div>
                            <span class="text-sm font-semibold px-2 py-0.5 rounded-full ${item.status.color}">${item.status.text}</span>
                        </li>`).join('')}</ul>`;
                }
                // Carte riassuntive per statistiche principali
                const cards = [
                    { label: 'Verbali Totali', value: stats.totalPca, color: 'blue', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>' },
                    { label: 'NC Aperte', value: stats.openNc, color: 'red', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>' },
                    { label: 'Check Eseguiti', value: stats.totalChecks, color: 'indigo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>' },
                    { label: 'Conformit√† Media', value: stats.avgCompliance, color: 'green', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' }
                ];
                // Struttura HTML della dashboard
                return `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold">${greeting}!</h2>
                    <p class="text-slate-500 dark:text-slate-400">Ecco un riepilogo della situazione attuale.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    ${cards.map(card => `
                    <div class="dashboard-card bg-white dark:bg-slate-800 p-5 rounded-lg shadow-sm flex items-center gap-5 border-t-4 border-${card.color}-500">
                        <div class="p-3 rounded-full bg-slate-100 dark:bg-slate-700 text-${card.color}-500">${card.icon}</div>
                        <div>
                            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">${card.label}</h3>
                            <p class="mt-1 text-3xl font-semibold text-slate-800 dark:text-slate-100">${card.value}</p>
                        </div>
                    </div>`).join('')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-4">Non Conformit√† per Aspetto (PCA Periodici)</h3>
                        <div class="relative h-96 w-full"><canvas id="ncChart"></canvas></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-4">Controlli Periodici da Eseguire</h3>
                        <div class="max-h-96 overflow-y-auto pr-2">${dueListHtml}</div>
                    </div>
                </div>`;
            },
            // Template per la lista dei PCA raggruppati per WBS o tipo
            pcaGroupedList: (groupedReports, frequencyStatuses) => {
                // Definisce un ordine specifico per i gruppi (es. Sopralluoghi prima dei WBS)
                const groupOrder = ['Sopralluoghi', 'Ispezioni Preliminari', 'Ispezioni Finali', ...Object.keys(App.config.WBS_DATA)];
                 // Ordina le chiavi dei gruppi in base all'ordine definito
                 const sortedGroupKeys = Object.keys(groupedReports).sort((a, b) => {
                    const indexA = groupOrder.indexOf(a);
                    const indexB = groupOrder.indexOf(b);
                    if (indexA === -1) return 1; // Gruppi sconosciuti vanno alla fine
                    if (indexB === -1) return -1;
                    return indexA - indexB; // Ordina in base all'indice in groupOrder
                });

                // Messaggio se non ci sono verbali
                if (sortedGroupKeys.length === 0) {
                    return `<div class="text-center p-8 bg-white dark:bg-slate-800 rounded-lg shadow-sm">
                                <h3 class="text-xl font-semibold">Nessun verbale trovato</h3>
                                <p class="text-slate-500 dark:text-slate-400 mt-2">Inizia compilando il tuo primo verbale da "Nuovo PCA" o "Verbale Sopralluogo".</p>
                            </div>`;
                }
                
                // Struttura HTML per i verbali raggruppati
                return `<div class="space-y-4">
                    ${sortedGroupKeys.map(groupKey => {
                        const group = groupedReports[groupKey];
                        const reports = group.reports;
                        const reportCount = reports.length;
                        
                        // Ogni gruppo √® un accordion
                        return `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm overflow-hidden">
                            <div class="grouped-pca-header p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700">
                                <div class="flex items-center gap-4">
                                    <span class="font-bold text-blue-600 dark:text-blue-400">${groupKey}</span>
                                    <h3 class="text-lg font-semibold">${group.descrizione}</h3>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full dark:bg-blue-900 dark:text-blue-200">${reportCount} ${reportCount === 1 ? 'verbale' : 'verbali'}</span>
                                    <svg class="grouped-pca-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                            <div class="grouped-pca-content">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-transparent text-sm">
                                        <thead class="bg-slate-100 dark:bg-slate-800">
                                            <tr>
                                                ${['ID','Data','Tipo','Oggetto / WBS','Stato Frequenza', 'Prossimo Controllo', 'Azioni'].map(h=>`<th class="p-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">${h}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                            ${reports.map(report => {
                                                const wbsCode = report.wbs ? report.wbs.substring(0,2).toUpperCase() : null;
                                                const freqStatus = report.type === 'periodico' && wbsCode ? frequencyStatuses[wbsCode] : null; // Ottiene stato frequenza se PCA periodico
                                                const typeLabels={'periodico':'PCA Periodico','preliminare':'PCA Preliminare','finale':'PCA Finale', 'sopralluogo': 'Sopralluogo'}; // Etichette tipi report
                                                const typeColors={'periodico':'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300','preliminare':'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300','finale':'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', 'sopralluogo': 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-300'}; // Colori per tipi report
                                                return `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                                                    <td class="p-3 font-medium">${report.id}</td>
                                                    <td class="p-3 whitespace-nowrap">${new Date(report.date+"T00:00:00").toLocaleDateString('it-IT')}</td>
                                                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeColors[report.type]||'bg-gray-100 text-gray-800'}">${typeLabels[report.type]||'N.D.'}</span></td>
                                                    <td class="p-3">${report.activities||report.wbs||'N.A.'}</td>
                                                    <td class="p-3">
                                                        ${freqStatus ? `<span class="text-xs font-semibold px-2 py-1 rounded-full ${freqStatus.color}">${freqStatus.text}</span>` : '-'}
                                                    </td>
                                                    <td class="p-3 whitespace-nowrap">
                                                        ${freqStatus && freqStatus.nextDate ? freqStatus.nextDate.toLocaleDateString('it-IT') : '-'}
                                                    </td>
                                                    <td class="p-3">
                                                        <div class="flex items-center gap-4">
                                                            <button data-id="${report.id}" class="print-pca-btn text-slate-500 hover:text-blue-600" title="Stampa Verbale"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button>
                                                            <button data-id="${report.id}" class="delete-pca-btn text-slate-500 hover:text-red-600" title="Elimina Verbale"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                                        </div>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`
                    }).join('')}
                </div>`;
            },
            // Icona placeholder per l'upload di immagini
            imagePlaceholderIcon: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-slate-400 dark:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>`,
            // Genera il markup per l'upload di una singola foto
            photoUpload(key) {
                return `<div class="photo-uploader">
                    <input type="file" accept="image/*" class="photo-input hidden" data-key="${key}">
                    <div class="photo-preview">
                        <div class="photo-preview-content flex items-center justify-center w-full h-full">
                           ${this.imagePlaceholderIcon()}
                        </div>
                    </div>
                    <div data-key="${key}" class="remove-photo-btn hidden">&times;</div>
                </div>`
            },
            // Genera il markup HTML per le checklist PCA periodiche
            renderChecklist(templates) {
                return templates.map(t => {
                    // PCA 04 (Rifiuti) viene gestito separatamente con renderWasteSection
                    if (t.id === 'pca04') return ''; 
                    const freqInfo = App.config.FREQUENCY_MAP[t.significativita]; // Informazioni sulla frequenza
                    // Struttura HTML di un singolo accordion PCA
                    return `<div id="accordion-${t.id}" class="pca-sheet-accordion bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm">
                        <div class="accordion-header p-4 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-t-lg">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-3">${t.icon} ${t.title}</h3>
                                ${freqInfo ? `<span class="text-sm font-semibold mt-1 px-2.5 py-1 rounded-full ${freqInfo.color}">${freqInfo.text}</span>` : ''}
                            </div>
                            <svg class="accordion-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="accordion-content p-4">
                            <div class="space-y-4">
                                ${t.items.map((item, idx) => {
                                    const baseName = `check_${t.id}_${idx}`; // Prefisso per name/id degli input radio
                                    const extraContentId = `extra_${t.id}_${idx}`; // Prefisso per campi extra
                                    let extraContentHTML = ''; // Contenuto HTML per campi aggiuntivi condizionali
                                    
                                    // Logica per mostrare campi condizionali basata su ID scheda e indice item
                                    // ************************************************************************
                                    // Questa parte implementa le opzioni condizionate richieste.
                                    // I campi extra (es. N. Autorizzazione) appaiono solo per specifici controlli.
                                    if (t.id === 'pca01' && (idx === 0 || idx === 1)) extraContentHTML = `<div class="w-full md:w-1/2"><label for="${extraContentId}_auth" class="form-label">N¬∞ Autorizzazione</label><input type="text" id="${extraContentId}_auth" name="${extraContentId}_auth" class="form-input"></div>`;
                                    if (t.id === 'pca01' && idx === 5) extraContentHTML = `<div class="w-full md:w-1/2"><label for="${extraContentId}_revisione" class="form-label">Data Ultima Revisione</label><input type="date" id="${extraContentId}_revisione" name="${extraContentId}_revisione" class="form-input"></div>`;
                                    if (t.id === 'pca02' && idx === 2) extraContentHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="${extraContentId}_ddt" class="form-label">N¬∞ DDT</label><input type="text" id="${extraContentId}_ddt" name="${extraContentId}_ddt" class="form-input"></div><div><label for="${extraContentId}_targa" class="form-label">Targa</label><input type="text" id="${extraContentId}_targa" name="${extraContentId}_targa" class="form-input"></div></div>`;
                                    if (t.id === 'pca03' && idx === 0) extraContentHTML = `<div class="w-full md:w-1/2"><label for="${extraContentId}_auth" class="form-label">N¬∞ Autorizzazione</label><input type="text" id="${extraContentId}_auth" name="${extraContentId}_auth" class="form-input"></div>`;
                                    // ************************************************************************
                                    
                                    const photoKey = `photo_${t.id}_${idx}`; // Chiave per la foto associata a questo check
                                    let photoUploaderHTML = '';
                                    // Mostra upload foto solo per check specifici che lo richiedono
                                    if ((t.id === 'pca01' && idx === 4) || (t.id === 'pca02' && (idx === 0 || idx === 1)) || (t.id === 'pca05' && (idx === 0 || idx === 1))) {
                                       photoUploaderHTML = `<div class="flex-shrink-0">${this.photoUpload(photoKey)}</div>`;
                                    }

                                    // Markup per ogni item della checklist
                                    return `<div class="check-item-wrapper border-t border-slate-200 dark:border-slate-700 py-4 first:border-t-0 first:pt-0">
                                        <div class="check-item flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                                            <label class="mr-4 text-sm flex-1 pt-1">${item}</label>
                                            <div class="flex items-center gap-x-5 text-sm flex-shrink-0">
                                                <!-- Radio buttons per S√¨/No/N.A. -->
                                                <div class="flex items-center"><input id="${baseName}_c" name="${baseName}" type="radio" value="C" class="form-checkbox"><label for="${baseName}_c" class="ml-2 block">S√¨</label></div>
                                                <div class="flex items-center"><input id="${baseName}_nc" name="${baseName}" type="radio" value="NC" class="form-checkbox"><label for="${baseName}_nc" class="ml-2 block">No</label></div>
                                                <div class="flex items-center"><input id="${baseName}_na" name="${baseName}" type="radio" value="NA" class="form-checkbox" checked><label for="${baseName}_na" class="ml-2 block">N.A.</label></div>
                                            </div>
                                            ${photoUploaderHTML} <!-- Upload foto se richiesto -->
                                        </div>
                                        <div class="nc-observation-wrapper conditional-section mt-3 pl-4 border-l-2 border-red-500"> <!-- Area per dettaglio Non Conformit√† -->
                                            <label for="nc_observation_${t.id}_${idx}" class="form-label text-red-700 dark:text-red-400">Dettaglio Non Conformit√† / Azione Correttiva</label>
                                            <textarea id="nc_observation_${t.id}_${idx}" name="nc_observation_${t.id}_${idx}" class="form-textarea" rows="2" placeholder="Descrivere il problema e l'azione da intraprendere..."></textarea>
                                        </div>
                                        <div class="conditional-section pl-4 border-l-2 border-blue-500"> <!-- Sezione per campi extra condizionali -->
                                            <div class="flex items-end gap-4">
                                                <div class="flex-grow">${extraContentHTML}</div> <!-- Campi extra (es. N. Aut.) -->
                                                ${photoUploaderHTML} <!-- Upload foto -->
                                            </div>
                                        </div>
                                    </div>`
                                }).join('')}
                            </div>
                            <!-- Sezione Osservazioni Generali per questa checklist -->
                            <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                                <label for="observation_${t.id}" class="text-sm font-medium mb-2 block">Osservazioni Generali</label>
                                <textarea id="observation_${t.id}" name="observation_${t.id}" class="form-textarea" rows="3" placeholder="Inserire qui eventuali osservazioni generali relative a questa checklist..."></textarea>
                            </div>
                        </div>
                    </div>` 
                }).join('');
            },
            // Genera il markup HTML per la sezione Rifiuti (PCA 04) con tabella CER
            renderWasteSection(template) {
                const freqInfo = App.config.FREQUENCY_MAP[template.significativita];
                // Struttura accordion per PCA 04
                return `<div id="accordion-${template.id}" class="pca-sheet-accordion bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm">
                    <div class="accordion-header p-4 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-t-lg">
                        <div>
                            <h3 class="text-lg font-semibold flex items-center gap-3">${template.icon} ${template.title}</h3>
                            ${freqInfo ? `<span class="text-sm font-semibold mt-1 px-2.5 py-1 rounded-full ${freqInfo.color}">${freqInfo.text}</span>` : ''}
                        </div>
                        <svg class="accordion-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content p-4">
                        <div class="space-y-4">
                            ${template.items.map((item, idx) => {
                                const baseName = `check_${template.id}_${idx}`;
                                const photoKey = `photo_${template.id}_${idx}`;
                                let photoUploaderHTML = '';
                                // Mostra upload foto per check specifici
                                if (idx === 0 || idx === 2) { 
                                   photoUploaderHTML = `<div class="flex-shrink-0">${this.photoUpload(photoKey)}</div>`;
                                }
                                // Markup per ogni item di PCA 04
                                return `<div class="check-item-wrapper border-t border-slate-200 dark:border-slate-700 py-4 first:border-t-0 first:pt-0">
                                    <div class="check-item flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                                        <label class="mr-4 text-sm flex-1 pt-1">${item}</label>
                                        <div class="flex items-center gap-x-5 text-sm flex-shrink-0">
                                            <div class="flex items-center"><input id="${baseName}_c" name="${baseName}" type="radio" value="C" class="form-checkbox"><label for="${baseName}_c" class="ml-2 block">S√¨</label></div>
                                            <div class="flex items-center"><input id="${baseName}_nc" name="${baseName}" type="radio" value="NC" class="form-checkbox"><label for="${baseName}_nc" class="ml-2 block">No</label></div>
                                            <div class="flex items-center"><input id="${baseName}_na" name="${baseName}" type="radio" value="NA" class="form-checkbox" checked><label for="${baseName}_na" class="ml-2 block">N.A.</label></div>
                                        </div>
                                         ${photoUploaderHTML}
                                    </div>
                                    <div class="nc-observation-wrapper conditional-section mt-3 pl-4 border-l-2 border-red-500"> <!-- Dettaglio NC -->
                                        <label for="nc_observation_${template.id}_${idx}" class="form-label text-red-700 dark:text-red-400">Dettaglio Non Conformit√† / Azione Correttiva</label>
                                        <textarea id="nc_observation_${template.id}_${idx}" name="nc_observation_${template.id}_${idx}" class="form-textarea" rows="2" placeholder="Descrivere il problema e l'azione da intraprendere..."></textarea>
                                    </div>
                                </div>`
                            }).join('')}
                        </div>
                        <!-- Tabella Dettaglio Rifiuti -->
                        <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                             <h3 class="text-md font-semibold mb-2">Dettaglio Rifiuti Presenti nell'Area</h3>
                             <div class="cer-table-wrapper">
                                 <table class="cer-table w-full border-collapse text-xs">
                                    <thead>
                                        <tr class="bg-slate-100 dark:bg-slate-700">
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-left">CER/Produttore</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-left">Ubicazione</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-left">In Caratterizz. (Verbale N./Del)</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-left">Rapp. Prova (N./Del)</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-center">Ident.</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-center">Delim.</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-center">In Prod.</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-center">In Carico</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-center">Validit√† RDP</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold text-left">Note/Miglioramento</th>
                                            <th class="p-2 border dark:border-slate-600 font-semibold"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="cer-table-rows" class="divide-y divide-slate-200 dark:divide-slate-700">
                                    </tbody>
                                 </table>
                            </div>
                            <!-- Bottone per aggiungere righe alla tabella rifiuti -->
                            <button type="button" id="add-cer-row-btn" class="mt-4 px-3 py-1.5 bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 rounded-md text-sm font-semibold hover:bg-blue-200 dark:hover:bg-blue-900">+ Aggiungi Riga Rifiuto</button>
                        </div>
                        <!-- Osservazioni generali sulla gestione rifiuti -->
                        <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <label for="observation_${template.id}" class="text-sm font-medium mb-2 block">Note Rilevate e NC Generali</label>
                            <textarea id="observation_${template.id}" name="observation_${template.id}" class="form-textarea" rows="3" placeholder="Inserire qui eventuali note o non conformit√† generali relative alla gestione rifiuti..."></textarea>
                        </div>
                    </div>
                </div>`;
            },
            // Genera il markup HTML per la tabella rifiuti (righe)
            wasteTableRow(index) {
                return `
                    <td class="p-1 border dark:border-slate-600"><input type="text" name="cer_produttore_${index}" class="form-input p-1 text-xs"></td>
                    <td class="p-1 border dark:border-slate-600"><input type="text" name="cer_ubicazione_${index}" class="form-input p-1 text-xs"></td>
                    <td class="p-1 border dark:border-slate-600"><div class="flex gap-1"><input type="text" name="cer_verbaleN_${index}" placeholder="N." class="form-input p-1 text-xs w-1/2"><input type="date" name="cer_verbaleDel_${index}" class="form-input p-1 text-xs w-1/2"></div></td>
                    <td class="p-1 border dark:border-slate-600"><div class="flex gap-1"><input type="text" name="cer_provaN_${index}" placeholder="N." class="form-input p-1 text-xs w-1/2"><input type="date" name="cer_provaDel_${index}" class="form-input p-1 text-xs w-1/2"></div></td>
                    <td class="p-1 border dark:border-slate-600 text-center"><select name="cer_identificato_${index}" class="form-select p-1 text-xs"><option value="si">S√¨</option><option value="no" selected>No</option></select></td>
                    <td class="p-1 border dark:border-slate-600 text-center"><select name="cer_delimitato_${index}" class="form-select p-1 text-xs"><option value="si">S√¨</option><option value="no" selected>No</option></select></td>
                    <td class="p-1 border dark:border-slate-600 text-center"><input type="checkbox" name="cer_produzione_${index}" class="form-checkbox h-4 w-4 mx-auto block"></td>
                    <td class="p-1 border dark:border-slate-600 text-center"><input type="checkbox" name="cer_carico_${index}" class="form-checkbox h-4 w-4 mx-auto block"></td>
                    <td class="p-1 border dark:border-slate-600 text-center"><select name="cer_validita_${index}" class="form-select p-1 text-xs"><option value="si">S√¨</option><option value="no" selected>No</option></select></td>
                    <td class="p-1 border dark:border-slate-600"><input type="text" name="cer_note_${index}" class="form-input p-1 text-xs"></td>
                    <td class="p-1 border dark:border-slate-600 text-center">
                        <button type="button" class="cer-delete-row-btn text-red-500 hover:text-red-700 p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
            },
            // Genera il markup HTML completo per il form del nuovo PCA
            newPcaForm({ nextId, today }) {
                const periodicChecklists = this.renderChecklist(App.config.CHECK_TEMPLATES_PERIODIC); // Renderizza checklist periodiche
                const wasteSection = this.renderWasteSection(App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === 'pca04')); // Renderizza sezione rifiuti
                // Struttura del form principale
                return `<form id="new-pca-form" novalidate class="space-y-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">1. Dati Generali PCA</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="pca-id" class="form-label">Verbale N¬∞</label><input type="text" id="pca-id" name="id" class="form-input" value="${nextId}" required></div>
                            <div><label for="pca-date" class="form-label">Data</label><input type="date" id="pca-date" name="date" value="${today}" class="form-input" required></div>
                            <div class="md:col-span-2"><label for="pca-type" class="form-label">Tipo di Controllo</label><select id="pca-type" name="type" class="form-select" required><option value="periodico" selected>Periodico (da WBS)</option><option value="preliminare">Preliminare (Ante Operam)</option><option value="finale">Finale (Post Operam)</option></select></div>
                        </div>
                        <!-- Sezione WBS: visibile solo per PCA periodici -->
                        <div id="wbs-section" class="conditional-section mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="pca-wbs-input" class="form-label">1. Inserisci Codice WBS</label><input type="text" id="pca-wbs-input" name="wbs-input" class="form-input" placeholder="Es. RI12, GA01..."></div>
                                <div><label for="pca-lavorazione-select" class="form-label">2. Seleziona Lavorazione</label><select id="pca-lavorazione-select" name="lavorazione" class="form-select" disabled><option value="">-- Prima inserisci WBS --</option></select></div>
                            </div>
                            <div><label for="pca-inspector-wbs" class="form-label">Compilatore</label><input type="text" id="pca-inspector-wbs" name="inspector-wbs" class="form-input" placeholder="Nome e Funzione"></div>
                        </div>
                        <!-- Sezione Manuale: visibile per controlli Preliminari/Finali o se WBS non valido -->
                        <div id="manual-section" class="conditional-section mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="wbs-manual" class="form-label">Area di Riferimento</label><input id="wbs-manual" name="wbs-manual" class="form-input" placeholder="Es. Campo Base, Area Stoccaggio X..."></div>
                                <div><label for="inspector-manual" class="form-label">Compilatore</label><input id="inspector-manual" name="inspector-manual" class="form-input" placeholder="Nome e Funzione"></div>
                            </div>
                            <div><label for="activities-manual" class="form-label">Oggetto del controllo</label><textarea id="activities-manual" name="activities-manual" class="form-textarea" rows="2" placeholder="Es. Verifica dello stato dei luoghi prima dell'inizio delle attivit√†..."></textarea></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">2. Checklist di Controllo</h2>
                        <!-- Contenitori per le checklist, gestiti dinamicamente da JS -->
                        <div id="checklist-container-periodico" class="space-y-4">${periodicChecklists}${wasteSection}</div>
                        <div id="checklist-container-preliminare" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_PRELIMINARE)}</div>
                        <div id="checklist-container-finale" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_FINALE)}</div>
                    </div>
                    <!-- Bottoni di azione -->
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-pca-btn" class="px-6 py-3 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">Annulla</button>
                        <button type="button" id="print-draft-btn" class="px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold flex items-center justify-center">Stampa / Esporta Bozza</button>
                        <button type="submit" id="save-pca-btn" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold flex items-center justify-center">
                            <span>Salva Controllo</span>
                        </button>
                    </div>
                </form>`;
            },
            // Genera il markup HTML per il form del verbale di sopralluogo
            newSopralluogoForm({ nextId, today }) {
                 const location = App.state.currentLocation;
                 const weather = App.state.currentWeather;
                 const temp = weather ? `${weather.temperature_2m}¬∞C` : 'N.D.';
                 const geo = location ? `${location.latitude}, ${location.longitude}`: 'Non disponibile';
                
                let photoUploadersHTML = '';
                // Crea i blocchi per l'upload delle foto (max 5)
                for (let i = 0; i < 5; i++) {
                     const photoKey = `photo_sopralluogo_${i}`;
                     photoUploadersHTML += `<div class="flex-shrink-0">
                        <label class="form-label">Foto ${i+1}</label>
                        ${this.photoUpload(photoKey)}
                        <input type="text" name="caption_${i}" class="form-input p-1 text-xs mt-1" placeholder="Didascalia...">
                     </div>`;
                }

                // Struttura del form per il sopralluogo
                return `<form id="new-sopralluogo-form" novalidate class="space-y-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">1. Dati Generali Verbale di Sopralluogo</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="sopralluogo-id" class="form-label">Verbale N¬∞</label><input type="text" id="sopralluogo-id" name="id" class="form-input bg-slate-100 dark:bg-slate-700" value="${nextId}" required readonly></div>
                            <div><label for="sopralluogo-date" class="form-label">Data</label><input type="date" id="sopralluogo-date" name="date" value="${today}" class="form-input" required></div>
                             <div><label for="sopralluogo-inspector" class="form-label">Compilatore</label><input type="text" id="sopralluogo-inspector" name="inspector" class="form-input" placeholder="Nome e Funzione" required></div>
                            <div><label for="sopralluogo-wbs" class="form-label">WBS / Area di Riferimento</label><input type="text" id="sopralluogo-wbs" name="wbs" class="form-input" placeholder="Es. GA03, Campo Base..." required></div>
                            <div><label class="form-label">Geolocalizzazione (Lat, Lon)</label><input type="text" class="form-input bg-slate-100 dark:bg-slate-700" value="${geo}" readonly></div>
                            <div><label class="form-label">Temperatura</label><input type="text" class="form-input bg-slate-100 dark:bg-slate-700" value="${temp}" readonly></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">2. Annotazioni e Note</h2>
                        <textarea id="sopralluogo-notes" name="notes" class="form-textarea" rows="10" placeholder="Inserire qui tutte le annotazioni, osservazioni e note rilevate durante il sopralluogo..."></textarea>
                    </div>

                     <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">3. Rilievi Fotografici</h2>
                        <div class="flex gap-4 overflow-x-auto py-2">
                           ${photoUploadersHTML}
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" onclick="App.ui.showTab('lista-pca')" class="px-6 py-3 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">Annulla</button>
                        <button type="button" id="print-draft-btn" class="px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold flex items-center justify-center">Stampa / Esporta Bozza</button>
                        <button type="submit" class="px-6 py-3 bg-teal-600 text-white rounded-md hover:bg-teal-700 font-semibold flex items-center justify-center">
                            <span>Salva Verbale</span>
                        </button>
                    </div>
                </form>`
            },
            // Template per la pagina Impostazioni
            settings: () => `<div class="space-y-8 max-w-2xl">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-bold mb-2">Archiviazione Dati</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-4 text-sm">Salva una copia di sicurezza dei tuoi verbali su un file, o ripristina i dati da un backup precedente.</p>
                    <div class="flex gap-4 flex-wrap">
                        <button id="export-btn" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">Esporta Dati</button>
                        <button id="import-btn" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">Importa Dati</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                    </div>
                </div>
                <div class="bg-red-50 dark:bg-red-900/20 p-6 rounded-lg border border-red-200 dark:border-red-800">
                    <h2 class="text-xl font-bold mb-2 text-red-600 dark:text-red-400">Zona Pericolo</h2>
                    <p class="text-red-800/80 dark:text-red-300/80 mb-4 text-sm">Le azioni in questa sezione sono irreversibili. Usare con la massima cautela.</p>
                    <button id="clear-all-btn" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">Svuota Archivio Dati</button>
                </div>
            </div>`,
            // Template per la stampa di un PCA (periodico, preliminare, finale)
            printReport(report, templates) {
                const chrysasLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp';
                const rtiLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/RTI.bmp';
                const typeLabels = { 'periodico': 'Piano di Controllo Ambientale', 'preliminare': 'Ispezione Preliminare (Ante Operam)', 'finale': 'Ispezione Finale (Post Operam)' };
                
                // Sezione meteo per stampa
                const weatherHTML = report.weather ? `
                    <div class="no-break" style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 11pt; font-weight: bold; margin-bottom: 0.5rem; border-bottom: 1px solid #ccc; padding-bottom: 4px;">Condizioni al Momento del Controllo</h3>
                        <table style="font-size: 9pt; width: 100%;">
                            <tr>
                                <td style="padding: 2px 5px;"><strong>Meteo:</strong> ${App.config.WEATHER_CODE_MAP[report.weather.weather_code]?.text || 'N/D'}</td>
                                <td style="padding: 2px 5px;"><strong>Temperatura:</strong> ${report.weather.temperature_2m}¬∞C</td>
                                ${report.location ? `<td style="padding: 2px 5px;"><strong>Geoloc:</strong> ${report.location.latitude}, ${report.location.longitude}</td>` : ''}
                            </tr>
                        </table>
                    </div>` : '';

                // Genera il corpo principale del report stampabile
                const reportBody = `
                    <div id="print-content">
                        <h1 style="text-align: center; font-size: 1.8rem; margin: 0; font-weight: bold; color: var(--print-text-primary);">${typeLabels[report.type]}</h1>
                        <h2 style="text-align: center; font-size: 1.2rem; margin-bottom: 2rem; color: var(--print-text-secondary);">Verbale di Controllo N¬∞ ${report.id}</h2>
                        
                        <!-- Tabella dati generali del PCA -->
                        <table class="no-break" style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 10pt;">
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg); width: 25%;">Data</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); width: 25%;">${new Date(report.date + "T00:00:00").toLocaleDateString('it-IT')}</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg); width: 25%;">WBS/Area</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); width: 25%;">${report.wbs || 'N.A.'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg);">Lavorazione/Oggetto</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color);" colspan="3">${report.activities || 'N.A.'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg);">Compilato da</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color);" colspan="3">${report.inspector || 'N.D.'}</td>
                                </tr>
                            </tbody>
                        </table>

                        ${weatherHTML} <!-- Inserisce sezione meteo se presente -->
                        
                        <!-- Iterazione sulle schede PCA per stampare check e osservazioni -->
                        ${templates.map(t => {
                            let contentHtml = '';
                             // Gestione specifica per PCA 04 (Rifiuti)
                             if (t.id === 'pca04') {
                                const checks = report.checks ? report.checks[t.id] : [];
                                contentHtml += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><tbody>
                                ${checks.map((check, idx) => {
                                    // Markup per dettaglio Non Conformit√†
                                    const ncObservationHtml = check.nc_observation ? 
                                    `<div style="font-size: 9pt; margin: 6px 0 6px 20px; padding: 8px; background-color: #FFF0F0; border-left: 2px solid #D32F2F; color: #333;">
                                        <strong>Nota NC:</strong> ${check.nc_observation}
                                    </div>` : '';
                                    // Markup per foto allegata
                                    const photoSrc = report.photos?.[t.id]?.[idx];
                                    const photoHtml = photoSrc ? `<div style="margin-top: 8px; margin-left: 20px;"><img src="${photoSrc}" style="max-width: 200px; border-radius: 4px; display: block; border: 1px solid #ddd;" alt="Foto allegata"></div>` : '';
                                    // Riga per ogni item della checklist
                                    return `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 8px 0; vertical-align: top; color: var(--print-text-secondary);">${check.item}${ncObservationHtml}${photoHtml}</td><td style="padding: 8px 0; text-align: right; font-weight: bold; width: 80px; vertical-align: top; color: ${check.result==='NC'?'#D32F2F':'var(--print-text-primary)'};">${check.result || 'N.D.'}</td></tr>`
                                }).join('')}
                                </tbody></table>`;

                                // Tabella dati rifiuti se presenti
                                if(report.cerData && report.cerData.length > 0){
                                    contentHtml += `<h3 class="no-break" style="font-weight:bold; font-size: 10pt; margin: 1rem 0 0.5rem 0;">Dettaglio Controllo Rifiuti</h3>
                                    <table class="no-break" style="width:100%; font-size: 7pt; border-collapse:collapse;">
                                        <thead><tr style="background-color:var(--print-header-bg);">
                                            <th style="border:1px solid var(--print-border-color); padding: 4px; text-align: left;">CER/Prod.</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px; text-align: left;">Ubic.</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px; text-align: left;">In Caratt. (N./Del)</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px; text-align: left;">R. Prova (N./Del)</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px;">Ident.</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px;">Delim.</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px;">Prod.</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px;">Carico</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px;">Val. RDP</th>
                                            <th style="border:1px solid var(--print-border-color); padding: 4px; text-align: left;">Note</th>
                                        </tr></thead><tbody>`;
                                    report.cerData.forEach(row => { // Righe tabella rifiuti
                                        contentHtml += `<tr>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px;">${row.cer || ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px;">${row.ubicazione || ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px;">${row.verbaleN || ''} ${row.verbaleDel ? 'del ' + new Date(row.verbaleDel + 'T00:00:00').toLocaleDateString('it-IT') : ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px;">${row.provaN || ''} ${row.provaDel ? 'del ' + new Date(row.provaDel + 'T00:00:00').toLocaleDateString('it-IT') : ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px; text-align:center;">${row.identificato || ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px; text-align:center;">${row.delimitato || ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px; text-align:center;">${row.produzione ? '‚úì' : ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px; text-align:center;">${row.carico ? '‚úì' : ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px; text-align:center;">${row.validita || ''}</td>
                                            <td style="border:1px solid var(--print-border-color); padding: 4px;">${row.note || ''}</td>
                                        </tr>`;
                                    });
                                    contentHtml += '</tbody></table>';
                                }
                            } else { // Gestione checklist standard (non PCA 04)
                                const checks = report.checks ? report.checks[t.id] : null;
                                if (!checks) return ''; // Non renderizza se non ci sono check per questa scheda
                                contentHtml += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><tbody>
                                ${checks.map((check, idx) => {
                                    // Markup per dettaglio Non Conformit√†
                                    const ncObservationHtml = check.nc_observation ? 
                                    `<div style="font-size: 9pt; margin: 6px 0 6px 20px; padding: 8px; background-color: #FFF0F0; border-left: 2px solid #D32F2F; color: #333;">
                                        <strong>Nota NC:</strong> ${check.nc_observation}
                                    </div>` : '';
                                    
                                    // Markup per campi extra condizionali
                                    let extraDataHtml = '';
                                    const extraData = report.extraData?.[t.id]?.[idx];
                                    if(extraData){
                                        extraDataHtml = '<div style="font-size: 9pt; margin: 6px 0 6px 20px; padding: 8px; background-color: #f8f8f8; border-left: 2px solid #ddd;">';
                                        for(const [key, value] of Object.entries(extraData)){
                                            const formattedKey = key.charAt(0).toUpperCase() + key.slice(1);
                                            extraDataHtml += `<span style="display: inline-block; min-width: 140px;"><strong>${formattedKey}:</strong></span> ${value || 'N.D.'} <br>`;
                                        }
                                        extraDataHtml += '</div>';
                                    }

                                    // Markup per foto allegata
                                    const photoSrc = report.photos?.[t.id]?.[idx];
                                    const photoHtml = photoSrc ? `<div style="margin-top: 8px; margin-left: 20px;"><img src="${photoSrc}" style="max-width: 200px; border-radius: 4px; display: block; border: 1px solid #ddd;" alt="Foto allegata"></div>` : '';

                                    // Riga per ogni item della checklist
                                    return `<tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px 0; vertical-align: top; color: var(--print-text-secondary);">
                                            ${check.item}
                                            ${extraDataHtml}
                                            ${ncObservationHtml}
                                            ${photoHtml}
                                        </td>
                                        <td style="padding: 8px 0; text-align: right; font-weight: bold; width: 80px; vertical-align: top; color: ${check.result==='NC'?'#D32F2F':'var(--print-text-primary)'};">${check.result || 'N.D.'}</td>
                                    </tr>`
                                }).join('')}
                                </tbody></table>`;
                            }
                            
                            // Markup per osservazioni generali della scheda PCA
                            const observationsText = report.observations ? (report.observations[t.id] || '') : '';
                            const observationsHtml = observationsText.trim() !== '' ? `<div class="no-break" style="background-color: #f8f8f8; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 1rem;"><h3 style="font-weight: bold; margin-bottom: 0.5rem; font-size: 11pt;">Note e Osservazioni Generali</h3><p style="font-size: 10pt; white-space: pre-wrap;">${observationsText}</p></div>` : '';

                            // Output per ogni scheda PCA (intestazione + check + osservazioni)
                            return `<div class="no-break" style="margin-bottom: 2rem;">
                                <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem; color: var(--print-text-primary);">
                                    <span style="font-size: 1.5rem; vertical-align: -0.2em; margin-right: 0.5rem;">${t.icon}</span>${t.title}
                                </h2>
                                ${contentHtml}
                                ${observationsHtml}
                            </div>`;
                        }).join('')}
                    </div>`;

                // Template completo per la stampa (intestazione, corpo, pi√® di pagina)
                return `<div id="print-area">
                    <header class="print-header">
                        <table style="width:100%; border-bottom: 2px solid var(--print-text-primary);">
                            <tr>
                                <td style="width:50%; text-align:left; vertical-align:middle; padding-bottom: 10px;">
                                    <img src="${chrysasLogoUrl}" alt="Logo CHRYSAS" style="height: 40px;">
                                </td>
                                <td style="width:50%; text-align:right; vertical-align:middle; padding-bottom: 10px;">
                                    <img src="${rtiLogoUrl}" alt="Logo RTI" style="height: 50px;">
                                </td>
                            </tr>
                        </table>
                    </header>
                    
                    ${reportBody}
                    
                    <footer class="print-footer">
                       <div style="text-align: center; font-size: 8pt; color: #888; border-top: 1px solid #ccc; padding-top: 5px;">
                            Documento generato in data ${new Date().toLocaleDateString('it-IT')} | Pagina <span class="page-number"></span> di <span class="total-pages"></span>
                       </div>
                    </footer>
                </div>
                <style>
                    #print-area { counter-reset: page; } /* Resetta contatore pagina */
                    .page-number::after { content: counter(page); } /* Inserisce numero pagina corrente */
                    .total-pages::after { content: counter(pages); } /* Inserisce numero totale pagine */
                </style>`;
            },
             // Template per la stampa del Verbale di Sopralluogo
             printSopralluogo(report) {
                const chrysasLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp';
                const rtiLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/RTI.bmp';

                 // Sezione meteo per stampa sopralluogo
                 const weatherHTML = report.weather ? `
                    <div class="no-break" style="margin-bottom: 1rem;">
                        <h3 style="font-size: 11pt; font-weight: bold; margin-bottom: 0.5rem; border-bottom: 1px solid #ccc; padding-bottom: 4px;">Condizioni Rilevate</h3>
                        <table style="font-size: 9pt; width: 100%;">
                            <tr>
                                <td style="padding: 2px 5px;"><strong>Meteo:</strong> ${App.config.WEATHER_CODE_MAP[report.weather.weather_code]?.text || 'N/D'}</td>
                                <td style="padding: 2px 5px;"><strong>Temperatura:</strong> ${report.weather.temperature_2m}¬∞C</td>
                                ${report.location ? `<td style="padding: 2px 5px;"><strong>Geoloc:</strong> ${report.location.latitude}, ${report.location.longitude}</td>` : ''}
                            </tr>
                        </table>
                    </div>` : '';
                
                // Sezione foto per stampa sopralluogo
                const photosHTML = report.photos && report.photos.length > 0 ? `
                    <div class="page-break" style="margin-top: 1.5rem;">
                         <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem;">Allegati Fotografici</h2>
                         <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                            ${report.photos.map(p => `
                                <div class="no-break" style="width: calc(50% - 0.5rem); margin-bottom: 1rem;">
                                    <img src="${p.src}" style="width: 100%; border: 1px solid #ccc; border-radius: 4px;">
                                    <p style="font-size: 9pt; text-align: center; margin-top: 0.5rem; background-color: #f8f8f8; padding: 4px;">${p.caption || 'Nessuna didascalia'}</p>
                                </div>
                            `).join('')}
                         </div>
                    </div>
                ` : '';

                // Corpo principale del report di sopralluogo
                const reportBody = `
                    <div>
                        <h1 style="text-align: center; font-size: 1.8rem; margin: 0; font-weight: bold;">VERBALE DI SOPRALLUOGO</h1>
                        <h2 style="text-align: center; font-size: 1.2rem; margin-bottom: 2rem; color: var(--print-text-secondary);">Verbale N¬∞ ${report.id}</h2>

                        <!-- Tabella dati generali sopralluogo -->
                        <table class="no-break" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 10pt;">
                             <tbody>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg); width: 25%;">Data</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); width: 75%;" colspan="3">${new Date(report.date + "T00:00:00").toLocaleDateString('it-IT')}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg);">Compilato da</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color);" colspan="3">${report.inspector || 'N.D.'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color); font-weight: bold; background-color: var(--print-header-bg);">WBS / Area</td>
                                    <td style="padding: 8px; border: 1px solid var(--print-border-color);" colspan="3">${report.wbs || 'N.A.'}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        ${weatherHTML} <!-- Sezione meteo -->

                        <div class="no-break" style="margin-top: 1.5rem;">
                            <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem;">Annotazioni e Note Rilevate</h2>
                            <p style="font-size: 10pt; white-space: pre-wrap;">${report.notes || 'Nessuna annotazione.'}</p>
                        </div>
                        
                        <div style="margin-top: 4rem; padding-top: 1rem; border-top: 1px solid #ccc;">
                           <p style="font-size: 10pt;">Firma del compilatore</p>
                        </div>
                    </div>
                `;

                 // Template completo per la stampa del sopralluogo
                 return `<div id="print-area">
                    <header class="print-header">
                        <table style="width:100%; border-bottom: 2px solid var(--print-text-primary);">
                            <tr>
                                <td style="width:50%; text-align:left; vertical-align:middle; padding-bottom: 10px;">
                                    <img src="${chrysasLogoUrl}" alt="Logo CHRYSAS" style="height: 40px;">
                                </td>
                                <td style="width:50%; text-align:right; vertical-align:middle; padding-bottom: 10px;">
                                    <img src="${rtiLogoUrl}" alt="Logo RTI" style="height: 50px;">
                                </td>
                            </tr>
                        </table>
                    </header>
                    
                    ${reportBody}
                    ${photosHTML} <!-- Sezione foto -->
                    
                    <footer class="print-footer">
                       <div style="text-align: center; font-size: 8pt; color: #888; border-top: 1px solid #ccc; padding-top: 5px;">
                            Verbale di Sopralluogo N¬∞ ${report.id} | Data: ${new Date().toLocaleDateString('it-IT')} | Pagina <span class="page-number"></span> di <span class="total-pages"></span>
                       </div>
                    </footer>
                </div>
                <style>
                    #print-area { counter-reset: page; }
                    .page-number::after { content: counter(page); }
                    .total-pages::after { content: counter(pages); }
                </style>`;
             }
        }
    };

    // Avvia l'applicazione
    App.init().catch(err => {
        console.error("ERRORE FATALE DURANTE L'INIZIALIZZAZIONE:", err);
        // Messaggio di errore critico se l'inizializzazione fallisce
        document.body.innerHTML = `<div style='padding: 2rem; text-align: center; font-family: sans-serif; color: #ef4444;'><h1>Errore Critico</h1><p>Impossibile avviare l'applicazione. Controlla la console (F12) per i dettagli.</p><p>${err.message}</p></div>`;
    });
});
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <!-- Contenitore principale dell'applicazione -->
    <div id="app-container">
        <!-- Sidebar di navigazione -->
        <aside id="sidebar" class="bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col">
            <div class="h-16 flex items-center justify-center px-6 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                <img src="https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp" alt="Logo CHRYSAS" class="h-8">
            </div>
            <nav id="sidebar-nav" class="flex-grow px-4 py-6 overflow-y-auto"></nav>
        </aside>
        
        <!-- Overlay per chiudere sidebar su schermi piccoli -->
        <div id="sidebar-overlay"></div>

        <!-- Contenitore principale del contenuto -->
        <div id="main-container" class="relative w-full">
            <!-- Header dell'applicazione -->
            <header class="h-16 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <!-- Bottone per aprire/chiudere la sidebar -->
                    <button id="sidebar-toggle-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Toggle Menu">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold"></h2>
                </div>

                <div class="flex items-center gap-6">
                    <!-- Widget Meteo -->
                    <div id="weather-widget" class="hidden lg:flex"></div>

                    <!-- Bottone cambio tema -->
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" aria-label="Toggle dark mode">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <!-- Data corrente -->
                    <div class="text-right hidden sm:block"><span id="current-date" class="text-sm text-slate-500 dark:text-slate-400"></span></div>
                </div>
            </header>
            
            <!-- Area principale del contenuto delle schede -->
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6"></main>
        </div>
    </div>
    <!-- Notifica Toast (posizionata in basso) -->
    <div id="toast" class="toast px-6 py-3 rounded-lg text-white font-medium shadow-lg" role="alert" aria-live="polite"></div>
    <!-- Contenitore per l'anteprima di stampa -->
    <div id="print-area-wrapper" class="hidden"></div>
    <!-- Overlay del Modale -->
    <div id="modal-overlay" class="modal-overlay"></div>
</body>
</html>