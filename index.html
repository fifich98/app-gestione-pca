<!DOCTYPE html>
<html lang="it" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net/npm/chart.js https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' https: data:;
        connect-src 'self' https://api.open-meteo.com;
        object-src 'none';
        base-uri 'self';
        form-action 'none';
    ">
    <title>App Gestione PCA - CHRYSAS (v4.0 - Migliorata)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js" defer></script>
    
    <style>
        :root {
            --print-header-bg: #f2f2f2;
            --print-border-color: #bbb;
            --print-text-primary: #000;
            --print-text-secondary: #333;
        }

        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .dark body { background-color: #0f172a; }

        /* --- Layout --- */
        #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 16rem; transition: transform 0.3s ease-in-out; will-change: transform; z-index: 1000; }
        #main-container { transition: padding-left 0.3s ease-in-out; }

        @media (max-width: 1023px) {
            #sidebar { transform: translateX(-100%); }
            .sidebar-open #sidebar { transform: translateX(0); }
            #main-container { padding-left: 0; }
            .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
            .sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
        }
        @media (min-width: 1024px) {
            #sidebar { transform: translateX(0); }
            #main-container { padding-left: 16rem; }
            .sidebar-collapsed #sidebar { transform: translateX(-100%); }
            .sidebar-collapsed #main-container { padding-left: 0; }
            .sidebar-overlay { display: none; }
        }

        /* --- Elementi UI con "Ombre e Luci" Migliorate --- */
        .sidebar-link { transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        .sidebar-link.active { @apply bg-blue-600 text-white font-semibold shadow-md; }
        
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s, transform 0.3s; z-index: 1050; }
        .toast.show { opacity: 1; bottom: 40px; transform: translateX(-50%) scale(1); }
        
        button, .sidebar-link, .dashboard-card { transition: all 0.2s ease-in-out; }
        button:hover:not(:disabled), .sidebar-link:hover, .dashboard-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* Ombra più pronunciata */
        }
        button:active:not(:disabled) { 
            transform: translateY(-1px); 
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); 
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .content-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1040; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .dark .modal-box { background-color: #1e293b; }
        .modal-overlay.visible .modal-box { transform: scale(1); }

        #weather-widget .loader, .photo-preview .loader { width: 1.25rem; height: 1.25rem; border: 2px solid #e2e8f0; border-top-color: #64748b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .accordion-header, .grouped-pca-header { cursor: pointer; transition: background-color 0.2s; }
        .accordion-content, .grouped-pca-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, margin 0.4s ease-in-out, opacity 0.3s; opacity: 0; }
        .conditional-section { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out, margin 0.4s ease-out, opacity 0.3s ease-out; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; }
        .accordion-content.open, .grouped-pca-content.open, .conditional-section.visible { max-height: 5000px; opacity: 1; }
        .conditional-section.visible { padding-top: 1rem; padding-bottom: 1rem; margin-top: 1rem; }
        .accordion-icon, .grouped-pca-icon { transition: transform 0.3s; }
        .accordion-header.open .accordion-icon, .grouped-pca-header.open .grouped-pca-icon { transform: rotate(180deg); }
        .grouped-pca-content.open { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb; }
        .dark .grouped-pca-content.open { border-top-color: #374151; }

        /* --- Stili Form migliorati con effetto "Luce" al focus --- */
        .form-label { @apply block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1; }
        .form-input, .form-select, .form-textarea { @apply block w-full border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-slate-700; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); } /* Effetto "glow" */
        .form-input:invalid, .form-select:invalid, .form-textarea:invalid { border-color: #ef4444 !important; }
        .form-checkbox { @apply rounded border-slate-400 text-blue-600 focus:ring-blue-500; }
        
        .hidden { display: none; }
        
        .cer-table-wrapper { overflow-x: auto; }
        .cer-table { min-width: 1200px; }

        /* Stili per le foto */
        .photo-uploader { position: relative; width: 100px; height: 100px; border: 2px dashed #d1d5db; border-radius: 0.5rem; overflow: hidden; cursor: pointer; transition: border-color 0.2s; background-color: #f9fafb; dark:bg-slate-700; }
        .dark .photo-uploader { border-color: #4b5563; }
        .photo-uploader:hover { border-color: #3b82f6; }
        .photo-preview { width: 100%; height: 100%; }
        .remove-photo-btn { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; line-height: 1; cursor: pointer; transition: background-color 0.2s; }
        .remove-photo-btn:hover { background-color: #ef4444; }

        /* --- Stili per la Stampa (invariati ma confermati corretti) --- */
        @media print {
            body, #print-area { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            body > *:not(#print-area-wrapper) { display: none !important; }
            #print-area-wrapper { display: block !important; }
            @page {
                size: A4;
                margin: 2.5cm 1.5cm;
                @top-center { content: element(header); }
                @bottom-center { content: element(footer); }
            }
            header.print-header { position: running(header); }
            footer.print-footer { position: running(footer); }
            .page-break { page-break-after: always; }
            .no-break { page-break-inside: avoid; }
        }
    </style>
    
    <script id="app-script" defer>
    // Gestione errori globale migliorata
    window.onerror = function(message, source, lineno, colno, error) {
        console.error("ERRORE GLOBALE NON GESTITO:", { message, source, lineno, colno, error });
        const toastEl = document.getElementById('toast');
        if (toastEl) {
            toastEl.textContent = 'Errore critico. Ricaricare la pagina.';
            toastEl.className = 'toast px-6 py-3 rounded-lg text-white font-medium shadow-lg bg-red-600 show';
        } else {
            alert('Si è verificato un errore critico. Si prega di ricaricare la pagina.');
        }
        return true; 
    };
    
    document.addEventListener('DOMContentLoaded', () => {

    const App = {
        config: {
            STORAGE_KEY: 'pca_app_data_idb_v18',
            TABS: [
                { id: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>' },
                { id: 'lista-pca', label: 'Lista Verbali', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' },
                { id: 'nuovo-pca', label: 'Nuovo PCA', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' },
                { id: 'sopralluogo', label: 'Verbale Sopralluogo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><circle cx="12" cy="15" r="2"></circle><path d="M12 10v3"></path></svg>' },
                { id: 'impostazioni', label: 'Impostazioni', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>' }
            ],
            WBS_DATA: { 'GA': { descrizione: 'Gallerie Artificiali', lavorazioni: ['Scavo di sbancamento', 'Posa armature e getti CLS', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti'] }, 'GN': { descrizione: 'Gallerie Naturali', lavorazioni: ['Scavo in naturale', 'Consolidamenti (spritz-beton, centine)', 'Rivestimenti e impermeabilizzazioni'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti', 'Vibrazioni'] }, 'AS': { descrizione: 'Aree di Stoccaggio', lavorazioni: ['Scavi e rivestimenti', 'Opere di sostegno e drenaggi'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Consumi'] }, 'TR': { descrizione: 'Trincee', lavorazioni: ['Scavi di trincea', 'Opere di sostegno (pali, diaframmi)', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Beni Culturali'] }, 'RI': { descrizione: 'Rilevati', lavorazioni: ['Formazione corpo del rilevato', 'Opere di sostegno', 'Sistemazioni idrauliche'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'VI': { descrizione: 'Viadotti', lavorazioni: ['Pali di fondazione e fondazioni', 'Elevazione pile e spalle', 'Varo impalcato e soletta'], aspetti: ['Rumore', 'Vibrazioni', 'Rifiuti', 'Sostanze Pericolose'] }, 'CB': { descrizione: 'Campo Base', lavorazioni: ['Installazione e gestione uffici/dormitori/mensa', 'Manutenzione aree e servizi'], aspetti: ['Acque', 'Rifiuti', 'Rumore', 'Consumi'] }, 'CO': { descrizione: 'Cantiere Operativo', lavorazioni: ['Allestimento aree stoccaggio', 'Gestione impianto di betonaggio', 'Officina e manutenzione mezzi'], aspetti: ['Polveri', 'Rumore', 'Acque', 'Rifiuti', 'Sostanze Pericolose'] }, 'NV': { descrizione: 'Nuova Viabilità', lavorazioni: ['Scavi e rilevati per nuova viabilità', 'Formazione sottofondi e pavimentazioni', 'Opere idrauliche e finiture'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'FA': { descrizione: 'Fabbricati', lavorazioni: ['Scavi e fondazioni', 'Elevazione strutture', 'Finiture e impianti'], aspetti: ['Polveri', 'Rumore', 'Rifiuti', 'Consumi'] } },
            CHECK_TEMPLATES_PERIODIC: [ { id: "pca01", title: "PCA 01: Scarichi Idrici ed Approvvigionamento", icon: "💧", significativita: "ALTA", items: ["Autorizzazione allo scarico acque reflue domestiche presente e valida?", "Autorizzazione allo scarico acque reflue industriali presente e valida?", "Rispetto delle prescrizioni contenute nelle autorizzazioni?", "Corretta gestione acque di lavorazione (es. scavo pali)?", "Kit di emergenza anti-sversamento presente e completo?", "Manutenzione impianti di depurazione/trattamento registrata?"] }, { id: "pca02", title: "PCA 02: Terre e Rocce da Scavo", icon: "⛰️", significativita: "ALTA", items: ["Aree di stoccaggio temporaneo identificate e conformi al PUT?", "Separazione dei cumuli per categorie omogenee?", "Documento di Trasporto (DDT) per le terre conforme e presente?", "Copertura dei cassoni dei mezzi in transito?"] }, { id: "pca03", title: "PCA 03: Emissioni in Atmosfera", icon: "💨", significativita: "ALTA", items: ["Autorizzazioni per impianti (es. calcestruzzo) presenti e valide?", "Copertura mezzi per trasporto materiali polverulenti?", "Bagnatura piste e/o cumuli eseguita regolarmente?", "Velocità dei mezzi in cantiere limitata a 30 km/h?", "Impianto lavaruote funzionante ed utilizzato?"] }, { id: "pca04", title: "PCA 04: Rifiuti", icon: "🗑️", significativita: "ALTA", items: ["Deposito temporaneo (DTR) ordinato e pulito?", "Rifiuti separati per CER e con corretta cartellonistica?", "Stoccaggio rifiuti pericolosi conforme (aree, bacini)?", "Registro di carico/scarico aggiornato (entro 10gg)?", "Quarta copia FIR ricevuta entro 90 giorni?"] }, { id: "pca05", title: "PCA 05: Sostanze Pericolose ed Emergenze", icon: "☣️", significativita: "MEDIA", items: ["Schede di Sicurezza (SDS) disponibili e aggiornate?", "Stoccaggio sostanze su bacini di contenimento idonei?", "Aree di stoccaggio segnalate e adeguate?", "Personale formato per la gestione delle emergenze?"] }, { id: "pca06", title: "PCA 06: Rumore e Vibrazioni", icon: "🔊", significativita: "MEDIA", items: ["Autorizzazione in deroga per rumore presente (se necessaria)?", "Rispetto degli orari di lavoro previsti?", "Barriere acustiche (se previste) integre ed efficaci?", "Manutenzione ordinaria dei mezzi per ridurre il rumore?", "Eseguita misurazione fonometrica periodica?"] }, { id: "pca07", title: "PCA 07: Suolo e Sottosuolo", icon: "🌱", significativita: "ALTA", items: ["Assenza di contaminazioni visive del suolo (macchie, sversamenti)?", "Corretto stoccaggio del terreno vegetale in cumuli separati?", "Utilizzo delle apposite vasche per lavaggio betoniere?", "Gestione corretta del calcestruzzo in esubero?"] }, { id: "pca08", title: "PCA 08: Beni Culturali e Archeologici", icon: "🏺", significativita: "ALTA", items: ["Presenza di archeologo durante le attività di scavo?", "Notifica agli enti competenti in caso di ritrovamento?", "Corretta gestione e inventario dei reperti?", "Disboscamento limitato alle aree strettamente necessarie?"] } ],
            ASPETTO_TO_PCA_ID_MAP: { 'Polveri': 'pca03', 'Rumore': 'pca06', 'Vibrazioni': 'pca06', 'Acque': 'pca01', 'Suolo': 'pca07', 'Rifiuti': 'pca04', 'Terre e Rocce': 'pca02', 'Sostanze Pericolose': 'pca05', 'Rifornimenti': 'pca05', 'Consumi': 'pca05', 'Beni Culturali': 'pca08' },
            FREQUENCY_MAP: { 'ALTA': { text: 'FREQUENZA ALTA', schedule: '(es. settimanale)', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', days: 7 }, 'MEDIA': { text: 'FREQUENZA MEDIA', schedule: '(es. quindicinale)', color: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300', days: 15 }, 'BASSA': { text: 'FREQUENZA BASSA', schedule: '(es. mensile)', color: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300', days: 30 } },
            CHECK_TEMPLATES_PRELIMINARE: [{ id: "preliminare", title: "Verifica Preliminare (Ante Operam)", icon: "📍", items: ["Eseguita analisi documentale (vincoli, servitù, prescrizioni)?", "Eseguita mappatura e documentazione dei recettori sensibili?", "Documentato stato della vegetazione con rilievo fotografico?", "Verificata e documentata assenza di rifiuti/materiali preesistenti?", "Verificata e documentata assenza di contaminazioni pregresse (macchie, odori)?"] }],
            CHECK_TEMPLATES_FINALE: [{ id: "finale", title: "Verifica Finale (Post Operam)", icon: "✅", items: ["Confronto con verbale preliminare ha dato esito positivo?", "Verificata completa rimozione di rifiuti, attrezzature e materiali di risulta?", "Eseguite correttamente le opere di ripristino ambientale (rinverdimenti, etc)?", "Verificata assenza di impatti residui visibili (contaminazioni, erosioni)?"] }],
            WBS_SIGNIFICANCE_MAP: {},
            WEATHER_CODE_MAP: { 0: {text:'Sereno', icon:'☀️'}, 1: {text:'Prevalentemente sereno', icon:'🌤️'}, 2: {text:'Parzialmente nuvoloso', icon:'⛅️'}, 3: {text:'Nuvoloso', icon:'☁️'}, 45: {text:'Nebbia', icon:'🌫️'}, 48: {text:'Nebbia con brina', icon:'🌫️'}, 51: {text:'Pioggerella leggera', icon:'🌦️'}, 53: {text:'Pioggerella moderata', icon:'🌦️'}, 55: {text:'Pioggerella forte', icon:'🌦️'}, 61: {text:'Pioggia leggera', icon:'🌧️'}, 63: {text:'Pioggia moderata', icon:'🌧️'}, 65: {text:'Pioggia forte', icon:'🌧️'}, 71: {text:'Nevicata leggera', icon:'❄️'}, 73: {text:'Nevicata moderata', icon:'❄️'}, 75: {text:'Nevicata forte', icon:'❄️'}, 80: {text:'Rovescio leggero', icon:'🌧️'}, 81: {text:'Rovescio moderato', icon:'🌧️'}, 82: {text:'Rovescio violento', icon:'🌧️'}, 95: {text:'Temporale', icon:'⛈️'}, 96: {text:'Temporale con grandine', icon:'⛈️'} }
        },
        state: { isSaving: false, tempPhotos: {}, activeChart: null, data: [], isSidebarOpen: localStorage.getItem('sidebarOpen') !== 'false', currentWeather: null, currentLocation: null },
        dom: {},
        
        async init() {
            this.dom = {
                appContainer: document.getElementById('app-container'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarNav: document.getElementById('sidebar-nav'),
                mainContent: document.getElementById('main-content'),
                pageTitle: document.getElementById('page-title'),
                currentDate: document.getElementById('current-date'),
                toast: document.getElementById('toast'),
                printAreaWrapper: document.getElementById('print-area-wrapper'),
                modal: document.getElementById('modal-overlay'),
                theme: { toggleBtn: document.getElementById('theme-toggle'), darkIcon: document.getElementById('theme-toggle-dark-icon'), lightIcon: document.getElementById('theme-toggle-light-icon') },
                sidebarToggleBtn: document.getElementById('sidebar-toggle-btn'),
                weatherWidget: document.getElementById('weather-widget')
            };
            this.ui.renderNav();
            this._computeWbsSignificance();
            this.handlers.attachGlobalListeners();
            this.ui.applyTheme(localStorage.getItem('theme') === 'dark', true);
            this.ui.setSidebarState(this.state.isSidebarOpen);
            try {
                this.state.data = await this.store.getAll();
            } catch (err) {
                console.error("Errore critico nel caricamento da IndexedDB:", err);
                this.ui.showToast("Errore nel caricare i dati. L'archivio potrebbe essere corrotto.", 'error');
                this.state.data = [];
            }
            await this.ui.showTab('dashboard');
            this.services.fetchLocationAndWeather();
        },
        
        _computeWbsSignificance() {
            const significanceValues = { 'ALTA': 2, 'MEDIA': 1, 'BASSA': 0 };
            for (const wbsCode in this.config.WBS_DATA) {
                const wbsData = this.config.WBS_DATA[wbsCode];
                let maxSignificance = -1;
                const requiredPcaIds = new Set(wbsData.aspetti.map(a => this.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                requiredPcaIds.forEach(pcaId => {
                    const template = this.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === pcaId);
                    if (template && template.significativita) {
                        const sigValue = significanceValues[template.significativita];
                        if (sigValue > maxSignificance) { maxSignificance = sigValue; }
                    }
                });
                const significanceKey = Object.keys(significanceValues).find(key => significanceValues[key] === maxSignificance);
                if (significanceKey) { this.config.WBS_SIGNIFICANCE_MAP[wbsCode] = significanceKey; }
            }
        },

        store: {
            dbStore: idbKeyval.createStore('pca-db', 'reports'),
            async getAll() { return (await idbKeyval.get(App.config.STORAGE_KEY, this.dbStore)) || []; },
            async saveAll(reports) {
                await idbKeyval.set(App.config.STORAGE_KEY, reports, this.dbStore);
                App.state.data = reports;
            },
            async getById(id) {
                const reports = await this.getAll();
                return reports.find(r => r && String(r.id) === String(id));
            },
            async save(newReport) {
                const reports = await this.getAll();
                const reportId = String(newReport.id);
                const existingIndex = reports.findIndex(r => r && String(r.id) === reportId);
                if (existingIndex !== -1) {
                    reports[existingIndex] = newReport;
                } else {
                    reports.push(newReport);
                }
                await this.saveAll(reports);
            },
            async delete(id) {
                let reports = await this.getAll();
                reports = reports.filter(r => r && String(r.id) !== String(id));
                await this.saveAll(reports);
            },
            async getNextId(prefix = '') {
                const reports = await this.getAll();
                const relevantIds = reports
                    .map(r => String(r.id))
                    .filter(id => id.startsWith(prefix))
                    .map(id => parseInt(id.replace(prefix, ''), 10))
                    .filter(num => !isNaN(num));
                
                const maxId = relevantIds.length > 0 ? Math.max(...relevantIds) : 0;
                return prefix + (maxId + 1);
            },
            getDashboardStats() {
                const reports = App.state.data; let openNc = 0; let totalChecks = 0; let compliantChecks = 0; const ncByAspect = {};
                reports.forEach(report => {
                    if (report && report.type === 'periodico' && report.checks) {
                        Object.entries(report.checks).forEach(([aspectId, aspectChecks]) => {
                            const template = App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === aspectId);
                            if (!template || !aspectChecks) return;
                            aspectChecks.forEach(check => {
                                if (check && check.result && check.result !== 'NA') {
                                    totalChecks++;
                                    if (check.result === 'C') compliantChecks++;
                                    if (check.result === 'NC') {
                                        openNc++;
                                        ncByAspect[template.title] = (ncByAspect[template.title] || 0) + 1;
                                    }
                                }
                            });
                        });
                    }
                });
                const avgCompliance = totalChecks > 0 ? `${((compliantChecks / totalChecks) * 100).toFixed(0)}%` : 'N.D.';
                return { totalPca: reports.length, openNc, totalChecks, avgCompliance, ncByAspect };
            },
        },

        services: {
            async fetchLocationAndWeather() {
                const widget = App.dom.weatherWidget;
                if (!widget) return;
                widget.innerHTML = `<div class="loader"></div><span>Geolocalizzazione...</span>`;

                if (!navigator.geolocation) {
                    widget.innerHTML = '<span>Geolocalizzazione non supportata.</span>';
                    App.state.currentWeather = null;
                    App.state.currentLocation = null;
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        App.state.currentLocation = { latitude: latitude.toFixed(5), longitude: longitude.toFixed(5) };
                        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude.toFixed(2)}&longitude=${longitude.toFixed(2)}&current=temperature_2m,precipitation,weather_code,wind_speed_10m`;
                        try {
                            const response = await fetch(apiUrl);
                            if (!response.ok) throw new Error('Risposta API non valida');
                            const data = await response.json();
                            App.state.currentWeather = data.current;
                            App.ui.renderWeather(data.current);
                        } catch (error) {
                            console.error("Errore API meteo:", error);
                            widget.textContent = 'Meteo non disponibile';
                            App.state.currentWeather = null;
                        }
                    },
                    (error) => {
                        console.warn("Errore geolocalizzazione:", error.message);
                        widget.innerHTML = '<span>Geolocalizzazione negata.</span>';
                        App.state.currentWeather = null;
                        App.state.currentLocation = null;
                    }
                );
            },
            getGreeting() {
                const hour = new Date().getHours();
                if (hour < 12) return 'Buongiorno';
                if (hour < 18) return 'Buon pomeriggio';
                return 'Buonasera';
            }
        },
        
        ui: {
            renderMap: { 'dashboard': 'renderDashboard', 'lista-pca': 'renderListaPca', 'nuovo-pca': 'renderNuovoPca', 'sopralluogo': 'renderNuovoSopralluogo', 'impostazioni': 'renderImpostazioni' },
            showToast(message, type = 'success') {
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
                App.dom.toast.textContent = message;
                App.dom.toast.className = `toast px-6 py-3 rounded-lg text-white font-medium shadow-lg ${colors[type]}`;
                setTimeout(() => { App.dom.toast.classList.add('show'); }, 10);
                setTimeout(() => { App.dom.toast.classList.remove('show'); }, 4000);
            },
            showModal(config) {
                return new Promise((resolve) => {
                    const { title, message, confirmText = 'Conferma', cancelText = 'Annulla', confirmColor = 'bg-red-600' } = config;
                    App.dom.modal.innerHTML = `
                        <div class="modal-box">
                            <h3 class="text-xl font-bold mb-4">${this.sanitize(title)}</h3>
                            <p class="text-slate-600 dark:text-slate-300 mb-6">${this.sanitize(message)}</p>
                            <div class="flex justify-end gap-4">
                                <button id="modal-cancel" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">${this.sanitize(cancelText)}</button>
                                <button id="modal-confirm" class="px-5 py-2 text-white rounded-md ${confirmColor} hover:opacity-90 font-semibold">${this.sanitize(confirmText)}</button>
                            </div>
                        </div>`;
                    App.dom.modal.classList.add('visible');
                    
                    const confirmBtn = document.getElementById('modal-confirm');
                    const cancelBtn = document.getElementById('modal-cancel');
                    const closeModal = (decision) => {
                        App.dom.modal.classList.remove('visible');
                        resolve(decision);
                    };
                    confirmBtn.onclick = () => closeModal(true);
                    cancelBtn.onclick = () => closeModal(false);
                    App.dom.modal.onclick = (e) => { if (e.target === App.dom.modal) closeModal(false); };
                });
            },
            async showTab(tabId) {
                App.state.tempPhotos = {};
                const tab = App.config.TABS.find(t => t.id === tabId);
                if (!tab) return;
                App.dom.sidebarNav.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.dataset.tabId === tabId));
                App.dom.pageTitle.textContent = tab.label;
                
                App.dom.mainContent.classList.remove('content-fade-in');
                void App.dom.mainContent.offsetWidth;

                const renderFunctionName = this.renderMap[tabId];
                if (this[renderFunctionName]) await this[renderFunctionName]();
                
                App.dom.mainContent.classList.add('content-fade-in');
            },
            renderNav() { App.dom.sidebarNav.innerHTML = App.config.TABS.map(t => `<a href="#" data-tab-id="${t.id}" class="sidebar-link flex items-center px-4 py-3 mt-2 text-slate-600 dark:text-slate-300 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">${t.icon} ${t.label}</a>`).join(''); },
            renderDashboard() {
                const stats = App.store.getDashboardStats();
                const frequencyStatuses = this.getFrequencyStatuses();
                const greeting = App.services.getGreeting();
                App.dom.mainContent.innerHTML = App.templates.dashboard(stats, frequencyStatuses.dueList, greeting);
                const ctx = document.getElementById('ncChart')?.getContext('2d');
                if (!ctx) return;
                if (App.state.activeChart) App.state.activeChart.destroy();
                const chartData = {
                    labels: Object.keys(stats.ncByAspect).map(l => l.substring(l.indexOf(':') + 1).trim()),
                    datasets: [{
                        label: 'NC',
                        data: Object.values(stats.ncByAspect),
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                };
                App.state.activeChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                        plugins: { legend: { display: false }, tooltip: { displayColors: false } }
                    }
                });
            },
            renderImpostazioni() {
                App.dom.mainContent.innerHTML = App.templates.settings();
                App.handlers.attachSettingsListeners();
            },
            renderListaPca() {
                try {
                    const reports = [...App.state.data].sort((a, b) => ( (b.date > a.date) ? 1 : -1 ));
                    const frequencyStatuses = this.getFrequencyStatuses();
                    
                    const groupedReports = reports.reduce((acc, report) => {
                        if (!report || !report.type) {
                            console.warn("Saltato report corrotto:", report);
                            return acc;
                        }
                        let key;
                        if(report.type === 'periodico') {
                            // CORREZIONE: Gestione sicura del caso in cui 'wbs' sia null o undefined.
                            key = report.wbs ? report.wbs.substring(0, 2).toUpperCase() : 'Generico';
                        } else if (report.type === 'sopralluogo') {
                            key = 'Sopralluoghi';
                        } else if (report.type === 'preliminare') {
                            key = 'Ispezioni Preliminari';
                        } else if (report.type === 'finale') {
                            key = 'Ispezioni Finali';
                        } else {
                            key = 'Generico';
                        }

                        if (!acc[key]) acc[key] = {
                            // MIGLIORAMENTO: Accesso sicuro con optional chaining '?.'.
                            descrizione: App.config.WBS_DATA[key]?.descrizione || key.replace(/([A-Z])/g, ' $1').trim(),
                            reports: []
                        };
                        acc[key].reports.push(report);
                        return acc;
                    }, {});

                    App.dom.mainContent.innerHTML = App.templates.pcaGroupedList(groupedReports, frequencyStatuses.statusMap);
                    App.handlers.attachPcaListListeners();
                } catch(err) {
                    console.error("Errore durante il rendering della lista PCA:", err);
                    App.dom.mainContent.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Errore!</strong><span class="block sm:inline"> Impossibile visualizzare la lista dei controlli.</span></div>`;
                }
            },
            getFrequencyStatuses() {
                const reports = App.state.data;
                const latestReportByWbs = {};
                [...reports].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                    if (r && r.type === 'periodico' && r.wbs) {
                        // CORREZIONE: Uso di `substring` sicuro.
                        const wbsCode = r.wbs.substring(0, 2).toUpperCase();
                        if (!latestReportByWbs[wbsCode]) {
                            latestReportByWbs[wbsCode] = r;
                        }
                    }
                });

                const statusMap = {};
                const dueList = [];
                const now = new Date();
                
                for (const wbsCode in App.config.WBS_SIGNIFICANCE_MAP) {
                    const significance = App.config.WBS_SIGNIFICANCE_MAP[wbsCode];
                    if (!significance) continue;

                    const report = latestReportByWbs[wbsCode];
                    const interval = App.config.FREQUENCY_MAP[significance].days;
                    
                    if(report) {
                        const lastDate = new Date(report.date + 'T00:00:00');
                        const dueDate = new Date(new Date(report.date + 'T00:00:00').setDate(lastDate.getDate() + interval));
                        const daysDiff = (dueDate - now) / (1000 * 3600 * 24);
                        
                        let status;
                        if (daysDiff < 0) {
                            status = { text: 'Scaduto', color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300', icon: '🔥', nextDate: dueDate };
                            dueList.push({ wbs: wbsCode, status: status, days: Math.round(daysDiff) });
                        } else if (daysDiff <= 3) {
                            status = { text: 'In Scadenza', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300', icon: '⚠️', nextDate: dueDate };
                            dueList.push({ wbs: wbsCode, status: status, days: Math.round(daysDiff) });
                        } else {
                            status = { text: 'OK', color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', icon: '✅', nextDate: dueDate };
                        }
                        statusMap[wbsCode] = status;

                    } else {
                        const status = { text: 'Da Eseguire', color: 'bg-gray-200 text-gray-800 dark:bg-slate-700 dark:text-slate-300', icon: '➡️', nextDate: null };
                        statusMap[wbsCode] = status;
                        dueList.push({ wbs: wbsCode, status: status, days: -Infinity });
                    }
                }
                dueList.sort((a,b) => a.days - b.days);
                return { statusMap, dueList };
            },
            renderWeather(weatherData) {
                const widget = App.dom.weatherWidget;
                if (!widget || !weatherData) return;
                
                const weatherInfo = App.config.WEATHER_CODE_MAP[weatherData.weather_code] || {text: 'N/D', icon: '❓'};
                
                widget.innerHTML = `
                    <span title="${weatherInfo.text}" class="text-xl">${weatherInfo.icon}</span>
                    <span class="font-semibold">${weatherData.temperature_2m}°C</span>
                    <span class="hidden sm:inline-flex items-center gap-1" title="Precipitazioni">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" fill="currentColor"><path d="M149.33,181.33,128,202.67,106.67,181.33a40,40,0,0,1,53.33-53.33l-5.33,5.33a32,32,0,0,0-45.34,45.34L128,197.33l18.67-18.66a8,8,0,0,1,11.33,11.33Z" opacity="0.2"></path><path d="M128,24A104.11,104.11,0,0,0,24,128c0,41.94,23.31,81.34,64,98.34V241.6a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16v-15.26c40.69-17,64-56.4,64-98.34A104.11,104.11,0,0,0,128,24Zm8,199.6v-8a16,16,0,0,0-16-16H94.48c-32.32-15.53-50.48-46.72-50.48-79.6,0-48.52,39.48-88,88-88s88,39.48,88,88c0,32.88-18.16,64.07-50.48,79.6H152a16,16,0,0,0-16,16v8Z"></path></svg>
                        ${weatherData.precipitation} mm
                    </span>
                    <span class="hidden sm:inline-flex items-center gap-1" title="Velocità del vento">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" fill="currentColor"><path d="M148,168a12,12,0,1,1-12-12A12,12,0,0,1,148,168Z" opacity="0.2"></path><path d="M248,128a12,12,0,0,1-12,12H132v8a24,24,0,0,1-48,0v-8H24a12,12,0,0,1,0-24H84v-8a24,24,0,0,1,48,0v8h104A12,12,0,0,1,248,128ZM108,88a24,24,0,0,1,48,0v8H108Zm0,80v-8h48v8a24,24,0,0,1-48,0Zm40-48a20,20,0,1,0-20,20A20,20,0,0,0,148,120Zm-28,0a8,8,0,1,1,8,8A8,8,0,0,1,120,120Z"></path></svg>
                        ${weatherData.wind_speed_10m.toFixed(1)} km/h
                    </span>
                `;
            },
            async renderNuovoPca() {
                const nextId = await App.store.getNextId('PCA-');
                const today = new Date().toISOString().slice(0, 10);
                App.dom.mainContent.innerHTML = App.templates.newPcaForm({ nextId, today });
                App.handlers.attachNewPcaFormListeners();
                this.updateFormRequirements('periodico');
            },
            async renderNuovoSopralluogo() {
                const nextId = await App.store.getNextId('VdS-');
                const today = new Date().toISOString().slice(0, 10);
                App.dom.mainContent.innerHTML = App.templates.newSopralluogoForm({ nextId, today });
                App.handlers.attachSopralluogoListeners();
            },
            updateFormRequirements(type) {
                const isPeriodico = type === 'periodico';
                document.getElementById('wbs-section')?.classList.toggle('visible', isPeriodico);
                document.getElementById('manual-section')?.classList.toggle('visible', !isPeriodico);
                
                document.getElementById('checklist-container-periodico').style.display = isPeriodico ? 'block' : 'none';
                document.getElementById('checklist-container-preliminare').style.display = type === 'preliminare' ? 'block' : 'none';
                document.getElementById('checklist-container-finale').style.display = type === 'finale' ? 'block' : 'none';
                
                const wbsInputs = ['pca-wbs-input', 'pca-lavorazione-select', 'pca-inspector-wbs'];
                const manualInputs = ['wbs-manual', 'inspector-manual', 'activities-manual'];
                
                wbsInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', isPeriodico));
                manualInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', !isPeriodico));
            },
            applyTheme(isDark, isInitial = false) {
                document.documentElement.classList.toggle('dark', isDark);
                App.dom.theme.darkIcon.classList.toggle('hidden', !isDark);
                App.dom.theme.lightIcon.classList.toggle('hidden', isDark);
                if (!isInitial) localStorage.setItem('theme', isDark ? 'dark' : 'light');
            },
            setSidebarState(isOpen) {
                App.state.isSidebarOpen = isOpen;
                localStorage.setItem('sidebarOpen', isOpen.toString());
                
                if (window.innerWidth < 1024) {
                    App.dom.appContainer.classList.toggle('sidebar-open', isOpen);
                    App.dom.sidebarOverlay.classList.toggle('visible', isOpen);
                } else {
                    App.dom.appContainer.classList.toggle('sidebar-collapsed', !isOpen);
                }
            },
            toggleSidebar() {
                this.setSidebarState(!App.state.isSidebarOpen);
            },
            resetPcaForm: () => { App.ui.showTab('nuovo-pca'); },
            async print(report) {
                if (!report) {
                    App.ui.showToast("Dati del verbale non validi.", "error");
                    return;
                }
                
                if (report.type === 'sopralluogo') {
                    App.dom.printAreaWrapper.innerHTML = App.templates.printSopralluogo(report);
                } else {
                    let templates;
                    if (report.type === 'preliminare') {
                        templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                    } else if (report.type === 'finale') {
                        templates = App.config.CHECK_TEMPLATES_FINALE;
                    } else if (report.type === 'periodico') {
                        templates = App.config.CHECK_TEMPLATES_PERIODIC;
                    }

                    if (!templates) {
                        console.error("Tipo di report non valido per la stampa:", report.type, report);
                        App.ui.showToast(`Impossibile stampare: tipo di verbale non riconosciuto ('${report.type}').`, "error");
                        return;
                    }
                    
                    App.dom.printAreaWrapper.innerHTML = App.templates.printReport(report, templates);
                }

                setTimeout(() => window.print(), 200);
            },
            sanitize(str) {
                if (typeof str !== 'string') return str;
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }
        },

        handlers: {
            debounce(func, delay = 300) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            },
            attachGlobalListeners() {
                App.dom.sidebarNav.addEventListener('click', e => { 
                    const link = e.target.closest('.sidebar-link');
                    if (link) { 
                        e.preventDefault(); 
                        App.ui.showTab(link.dataset.tabId);
                        if(window.innerWidth < 1024) { 
                            App.ui.setSidebarState(false); 
                        }
                    } 
                });
                
                App.dom.theme.toggleBtn.addEventListener('click', () => App.ui.applyTheme(!document.documentElement.classList.contains('dark')));
                
                App.dom.sidebarToggleBtn.addEventListener('click', () => App.ui.toggleSidebar());
                
                App.dom.sidebarOverlay.addEventListener('click', () => App.ui.setSidebarState(false));
                
                App.dom.currentDate.textContent = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                window.addEventListener('resize', () => {
                    App.ui.setSidebarState(App.state.isSidebarOpen);
                });
            },
            attachPcaListListeners() {
                const container = App.dom.mainContent;
                container.addEventListener('click', async (e) => {
                    const printBtn = e.target.closest('.print-pca-btn');
                    const deleteBtn = e.target.closest('.delete-pca-btn');
                    const header = e.target.closest('.grouped-pca-header');

                    if (printBtn) {
                        printBtn.disabled = true;
                        const report = await App.store.getById(printBtn.dataset.id);
                        await App.ui.print(report);
                        printBtn.disabled = false;
                    }
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        const report = await App.store.getById(id);
                        const confirmed = await App.ui.showModal({
                            title: 'Conferma Eliminazione',
                            message: `Sei sicuro di voler eliminare il verbale N° ${id} (${report.activities || report.wbs})? L'azione è irreversibile.`,
                            confirmText: 'Elimina',
                            confirmColor: 'bg-red-600'
                        });
                        if (confirmed) this.onDeletePca(id);
                    }
                    if(header) {
                        const content = header.nextElementSibling;
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
            },
            async onDeletePca(reportId) {
                await App.store.delete(reportId);
                App.ui.showToast(`Verbale N° ${reportId} eliminato.`, 'info');
                await App.ui.showTab('lista-pca');
            },
            attachNewPcaFormListeners() {
                const form = document.getElementById('new-pca-form'); if (!form) return;
                form.addEventListener('submit', (e) => this.onNewPcaSubmit(e));
                form.addEventListener('click', (e) => { 
                    if (e.target.closest('.photo-preview-content')) e.target.closest('.photo-uploader').querySelector('.photo-input').click(); 
                    if (e.target.closest('.remove-photo-btn')) this.onPhotoRemove(e);
                    if (e.target.matches('#cancel-pca-btn')) App.ui.resetPcaForm();
                    if (e.target.matches('#print-draft-btn')) this.onPrintDraft(form);
                    if (e.target.id === 'add-cer-row-btn') this.addCerRow();
                    if (e.target.closest('.cer-delete-row-btn')) e.target.closest('tr').remove();
                    
                    const accordionHeader = e.target.closest('.accordion-header');
                    if (accordionHeader) {
                        const content = accordionHeader.nextElementSibling;
                        accordionHeader.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
                form.querySelectorAll('.photo-input').forEach(i => i.addEventListener('change', (e) => this.onPhotoUpload(e)));
                form.addEventListener('change', (e) => {
                    if (e.target.type === 'radio' && e.target.name.startsWith('check_')) {
                        const wrapper = e.target.closest('.check-item-wrapper');
                        const ncObservationWrapper = wrapper.querySelector('.nc-observation-wrapper');
                        if (ncObservationWrapper) {
                             ncObservationWrapper.classList.toggle('visible', e.target.value === 'NC');
                        }
                        const conditionalSection = wrapper.querySelector('.conditional-section:not(.nc-observation-wrapper)');
                        if(conditionalSection){
                             conditionalSection.classList.toggle('visible', e.target.value === 'C');
                        }
                    }
                });
                document.getElementById('pca-type')?.addEventListener('change', (e) => App.ui.updateFormRequirements(e.target.value));
                document.getElementById('pca-wbs-input')?.addEventListener('input', (e) => {
                    const wbsCodeFull = e.target.value.toUpperCase(); const wbsCode = wbsCodeFull.substring(0, 2); const wbsData = App.config.WBS_DATA[wbsCode]; const lavorazioneSelect = document.getElementById('pca-lavorazione-select');
                    
                    const accordionContainer = document.getElementById('checklist-container-periodico');
                    const accordionContents = accordionContainer.querySelectorAll('.accordion-content');
                    const accordionHeaders = accordionContainer.querySelectorAll('.accordion-header');
                    
                    lavorazioneSelect.innerHTML = '<option value="">-- Prima inserisci WBS --</option>';
                    lavorazioneSelect.disabled = true;
                    accordionContainer.querySelectorAll('.pca-sheet-accordion').forEach(el => el.style.display = 'none');
                    accordionContents.forEach(c => c.classList.remove('open'));
                    accordionHeaders.forEach(h => h.classList.remove('open'));

                    if (wbsData && wbsCodeFull.length >= 2) {
                        App.ui.showToast('Checklist per ' + wbsCode + ' caricate.', 'info');
                        lavorazioneSelect.innerHTML = '<option value="">-- Seleziona Lavorazione --</option>';
                        wbsData.lavorazioni.forEach(lav => { const option = document.createElement('option'); option.value = lav; option.textContent = lav; lavorazioneSelect.appendChild(option); });
                        lavorazioneSelect.disabled = false;
                        
                        const requiredPcaIds = new Set(wbsData.aspetti.map(a => App.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                        let firstAccordionEl = null;

                        requiredPcaIds.forEach((sheetId, index) => { 
                            const accordionEl = document.getElementById(`accordion-${sheetId}`);
                            if (accordionEl) {
                                accordionEl.style.display = 'block';
                                if (index === 0) {
                                    firstAccordionEl = accordionEl;
                                }
                            }
                        });

                        if (firstAccordionEl) {
                            const header = firstAccordionEl.querySelector('.accordion-header');
                            const content = firstAccordionEl.querySelector('.accordion-content');
                            header.classList.add('open');
                            content.classList.add('open');
                        }
                    }
                });
            },
            addCerRow() {
                const index = Date.now(); 
                const container = document.getElementById('cer-table-rows');
                if (!container) return;

                const row = document.createElement('tr');
                row.className = 'cer-row';
                row.innerHTML = App.templates.wasteTableRow(index);
                container.appendChild(row);
            },
            _buildReportObjectFromForm(form) {
                const formData = new FormData(form);
                const reportType = formData.get('type');
                const sanitize = App.ui.sanitize;
                
                const report = { 
                    id: sanitize(formData.get('id')), 
                    type: sanitize(reportType), 
                    date: sanitize(formData.get('date')), 
                    inspector: sanitize(reportType === 'periodico' ? formData.get('inspector-wbs') : formData.get('inspector-manual')), 
                    wbs: sanitize(reportType === 'periodico' ? formData.get('wbs-input') : formData.get('wbs-manual')), 
                    activities: sanitize(reportType === 'periodico' ? formData.get('lavorazione') : formData.get('activities-manual')), 
                    weather: App.state.currentWeather,
                    location: App.state.currentLocation,
                    checks: {}, 
                    observations: {}, 
                    photos: {},
                    cerData: [],
                    extraData: {} // CORREZIONE: Inizializza l'oggetto per i dati extra
                };
                
                let templates;
                if (reportType === 'preliminare') templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                else if (reportType === 'finale') templates = App.config.CHECK_TEMPLATES_FINALE;
                else templates = App.config.CHECK_TEMPLATES_PERIODIC;

                templates.forEach(template => {
                    const sheetElement = document.getElementById(`accordion-${template.id}`);
                    if (sheetElement && window.getComputedStyle(sheetElement).display !== 'none') {
                        report.checks[template.id] = template.items.map((item, idx) => {
                            const result = sanitize(formData.get(`check_${template.id}_${idx}`));
                            const nc_observation = result === 'NC' ? sanitize(formData.get(`nc_observation_${template.id}_${idx}`)) : null;
                            const photoKey = `photo_${template.id}_${idx}`;
                            if(App.state.tempPhotos[photoKey]) {
                               if(!report.photos[template.id]) report.photos[template.id] = {};
                               report.photos[template.id][idx] = App.state.tempPhotos[photoKey];
                            }
                            
                            // CORREZIONE: Raccoglie i dati extra se la risposta è 'C'
                            if (result === 'C') {
                                const extraFields = form.querySelectorAll(`[name^="extra_${template.id}_${idx}"]`);
                                if(extraFields.length > 0) {
                                    if(!report.extraData[template.id]) report.extraData[template.id] = {};
                                    if(!report.extraData[template.id][idx]) report.extraData[template.id][idx] = {};
                                    extraFields.forEach(field => {
                                        const fieldName = field.name.split('_').pop();
                                        report.extraData[template.id][idx][fieldName] = sanitize(field.value);
                                    });
                                }
                            }

                            return { item: sanitize(item), result, nc_observation };
                        });
                        report.observations[template.id] = sanitize(formData.get(`observation_${template.id}`));
                    }
                });

                const cerContainer = document.getElementById('cer-table-rows');
                if (cerContainer) {
                    cerContainer.querySelectorAll('.cer-row').forEach(row => {
                        const rowData = {
                            cer: sanitize(row.querySelector('[name^="cer_produttore"]')?.value),
                            ubicazione: sanitize(row.querySelector('[name^="cer_ubicazione"]')?.value),
                            verbaleN: sanitize(row.querySelector('[name^="cer_verbaleN"]')?.value),
                            verbaleDel: sanitize(row.querySelector('[name^="cer_verbaleDel"]')?.value),
                            provaN: sanitize(row.querySelector('[name^="cer_provaN"]')?.value),
                            provaDel: sanitize(row.querySelector('[name^="cer_provaDel"]')?.value),
                            identificato: sanitize(row.querySelector('[name^="cer_identificato"]')?.value),
                            delimitato: sanitize(row.querySelector('[name^="cer_delimitato"]')?.value),
                            produzione: row.querySelector('[name^="cer_produzione"]')?.checked,
                            carico: row.querySelector('[name^="cer_carico"]')?.checked,
                            validita: sanitize(row.querySelector('[name^="cer_validita"]')?.value),
                            note: sanitize(row.querySelector('[name^="cer_note"]')?.value),
                        };
                        if (Object.values(rowData).some(v => (typeof v === 'string' && v.trim() !== '') || (typeof v === 'boolean' && v))) {
                            report.cerData.push(rowData);
                        }
                    });
                }
                return report;
            },
            async onPrintDraft(form) {
                const report = this._buildReportObjectFromForm(form);
                await App.ui.print(report);
            },
            async onNewPcaSubmit(e) {
                e.preventDefault();
                if (App.state.isSaving) return;
                
                const form = e.target;
                if (!form.checkValidity()) {
                    form.reportValidity();
                    App.ui.showToast('Compilare tutti i campi obbligatori evidenziati.', 'error');
                    return;
                }

                App.state.isSaving = true;
                const saveBtn = document.getElementById('save-pca-btn');
                if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Salvando...</span>`; }

                try {
                    const newReport = this._buildReportObjectFromForm(form);
                    await App.store.save(newReport);
                    App.ui.showToast('Controllo salvato con successo!', 'success');
                    App.ui.resetPcaForm();
                    await App.ui.showTab('lista-pca');
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    App.ui.showToast(error.message || 'Si è verificato un errore imprevisto.', 'error');
                } finally {
                    App.state.isSaving = false;
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = '<span>Salva Controllo</span>'; }
                }
            },
            onPhotoRemove(e) {
                e.preventDefault();
                e.stopPropagation();
                const uploader = e.target.closest('.photo-uploader');
                const input = uploader.querySelector('.photo-input');
                const preview = uploader.querySelector('.photo-preview-content');
                const key = input.dataset.key;

                input.value = '';
                preview.innerHTML = App.templates.imagePlaceholderIcon();
                delete App.state.tempPhotos[key];
                uploader.querySelector('.remove-photo-btn').classList.add('hidden');
            },
            async onPhotoUpload(e) { 
                const input = e.target; 
                const key = input.dataset.key; 
                const uploader = input.closest('.photo-uploader');
                const previewContainer = uploader.querySelector('.photo-preview-content');
                const removeBtn = uploader.querySelector('.remove-photo-btn');
                const file = input.files[0]; 
                
                if (!file || !previewContainer) return; 
                
                previewContainer.innerHTML = `<div class="loader"></div>`;
                
                try { 
                    const dataUrl = await this.resizeImage(file, 1024); 
                    previewContainer.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover" alt="Anteprima">`; 
                    App.state.tempPhotos[key] = dataUrl;
                    removeBtn.classList.remove('hidden');
                } catch (err) { 
                    previewContainer.innerHTML = App.templates.imagePlaceholderIcon(); 
                    delete App.state.tempPhotos[key]; 
                    removeBtn.classList.add('hidden');
                    App.ui.showToast("Errore nel caricamento foto.", "error"); 
                } 
            },
            resizeImage: (file, maxSize) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { let { width, height } = img; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.8)); }; img.onerror = reject; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); }),
            async attachSettingsListeners() { 
                document.getElementById('export-btn')?.addEventListener('click', this.exportData); 
                document.getElementById('import-btn')?.addEventListener('click', () => document.getElementById('import-file').click()); 
                document.getElementById('import-file')?.addEventListener('change', async (e) => {
                     const confirmed = await App.ui.showModal({
                         title: 'Conferma Importazione',
                         message: "ATTENZIONE: i dati attuali verranno SOVRASCRITTI in modo permanente. Continuare?",
                         confirmText: 'Sovrascrivi e Importa',
                         confirmColor: 'bg-orange-500'
                     });
                     if (confirmed) this.importData(e);
                });
                document.getElementById('clear-all-btn')?.addEventListener('click', this.onClearAllData);
            },
            async onClearAllData() {
                const modalHTML = `
                    <div class="modal-box">
                        <h3 class="text-xl font-bold mb-2 text-red-500">Azione Irreversibile</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-4">Sei assolutamente sicuro di voler eliminare TUTTI i verbali salvati? Questa azione non può essere annullata.</p>
                        <p class="text-slate-600 dark:text-slate-300 mb-4">Per confermare, digita "<b>ELIMINA</b>" nel campo sottostante.</p>
                        <input type="text" id="delete-confirm-input" class="form-input w-full mb-6" placeholder="ELIMINA">
                        <div class="flex justify-end gap-4">
                            <button id="modal-cancel" class="px-5 py-2 bg-slate-200 dark:bg-slate-600 rounded-md font-semibold">Annulla</button>
                            <button id="modal-confirm-delete" class="px-5 py-2 text-white rounded-md bg-red-600 font-semibold opacity-50 cursor-not-allowed" disabled>Elimina Tutto</button>
                        </div>
                    </div>`;

                App.dom.modal.innerHTML = modalHTML;
                App.dom.modal.classList.add('visible');

                const confirmInput = document.getElementById('delete-confirm-input');
                const confirmBtn = document.getElementById('modal-confirm-delete');
                const cancelBtn = document.getElementById('modal-cancel');

                confirmInput.addEventListener('input', () => {
                    if (confirmInput.value === 'ELIMINA') {
                        confirmBtn.disabled = false;
                        confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        confirmBtn.disabled = true;
                        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
                
                const closeModal = async (decision) => {
                    App.dom.modal.classList.remove('visible');
                    if (decision) {
                        await App.store.saveAll([]);
                        await App.ui.showTab('dashboard');
                        App.ui.showToast("Archivio svuotato con successo.", "info");
                    }
                };
                
                confirmBtn.onclick = () => closeModal(true);
                cancelBtn.onclick = () => closeModal(false);
                App.dom.modal.onclick = (e) => { if (e.target === App.dom.modal) closeModal(false); };
            },
            async exportData() { const data = await App.store.getAll(); if (data.length === 0) return App.ui.showToast("Nessun dato da esportare.", 'info'); const dataStr = JSON.stringify(data, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `pca_backup_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); App.ui.showToast("Esportazione dati completata.", 'success'); },
            importData(e) { 
                const file = e.target.files[0]; if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = async (event) => { 
                    try { 
                        const data = JSON.parse(event.target.result); 
                        if (!Array.isArray(data)) throw new Error("File non valido"); 
                        await App.store.saveAll(data); 
                        App.ui.showToast("Dati importati con successo!", 'success'); 
                        await App.ui.showTab('dashboard'); 
                    } catch (err) { App.ui.showToast("Errore: il file di backup non è valido.", 'error'); } 
                }; 
                reader.readAsText(file); 
                e.target.value = '';
            },
             attachSopralluogoListeners() {
                const form = document.getElementById('new-sopralluogo-form'); if (!form) return;
                form.addEventListener('submit', (e) => this.onSopralluogoSubmit(e));
                form.addEventListener('click', (e) => { 
                    if (e.target.closest('.photo-preview-content')) e.target.closest('.photo-uploader').querySelector('.photo-input').click(); 
                    if (e.target.closest('.remove-photo-btn')) this.onPhotoRemove(e);
                    if (e.target.matches('#print-draft-btn')) this.onPrintSopralluogoDraft(form);
                });
                form.querySelectorAll('.photo-input').forEach(i => i.addEventListener('change', (e) => this.onPhotoUpload(e)));
             },
              _buildSopralluogoObjectFromForm(form) {
                const formData = new FormData(form);
                const sanitize = App.ui.sanitize;
                const reportId = sanitize(formData.get('id'));

                const report = {
                    id: reportId,
                    type: 'sopralluogo',
                    date: sanitize(formData.get('date')),
                    wbs: sanitize(formData.get('wbs')),
                    activities: `Sopralluogo Area: ${sanitize(formData.get('wbs'))}`,
                    inspector: sanitize(formData.get('inspector')),
                    notes: sanitize(formData.get('notes')),
                    weather: App.state.currentWeather,
                    location: App.state.currentLocation,
                    photos: []
                };
                
                for(let i = 0; i < 5; i++){
                    const photoKey = `photo_sopralluogo_${i}`;
                    const caption = sanitize(formData.get(`caption_${i}`));
                    if(App.state.tempPhotos[photoKey]){
                        report.photos.push({
                            src: App.state.tempPhotos[photoKey],
                            caption: caption
                        });
                    }
                }
                return report;
             },
             async onPrintSopralluogoDraft(form) {
                const report = this._buildSopralluogoObjectFromForm(form);
                await App.ui.print(report);
             },
             async onSopralluogoSubmit(e) {
                e.preventDefault();
                if (App.state.isSaving) return;
                
                const form = e.target;
                if (!form.checkValidity()) {
                    form.reportValidity();
                    App.ui.showToast('Compilare tutti i campi obbligatori evidenziati.', 'error');
                    return;
                }

                App.state.isSaving = true;
                const saveBtn = form.querySelector('button[type="submit"]');
                if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Salvando...</span>`; }
                
                try {
                    const newReport = this._buildSopralluogoObjectFromForm(form);
                    await App.store.save(newReport);
                    App.ui.showToast('Verbale di Sopralluogo salvato!', 'success');
                    await App.ui.showTab('lista-pca');

                } catch (error) {
                    console.error("Errore durante il salvataggio del sopralluogo:", error);
                    App.ui.showToast(error.message || 'Si è verificato un errore imprevisto.', 'error');
                } finally {
                    App.state.isSaving = false;
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = '<span>Salva Verbale</span>'; }
                }
             }
        },
        
        templates: {
            // MIGLIORAMENTO: Template Dashboard migliorato graficamente
            dashboard: (stats, dueList, greeting) => {
                let dueListHtml = '<p class="text-slate-500 dark:text-slate-400">Tutti i controlli periodici sono aggiornati.</p>';
                if (dueList.length > 0) {
                    dueListHtml = `<ul class="space-y-3">${dueList.map(item => `
                        <li class="flex items-center justify-between p-3 rounded-lg bg-slate-100 dark:bg-slate-700/50">
                            <div>
                                <span class="font-bold">${item.wbs}</span>
                                <span class="text-sm text-slate-500 dark:text-slate-400 ml-2">${App.config.WBS_DATA[item.wbs]?.descrizione || 'Sconosciuto'}</span>
                            </div>
                            <span class="text-sm font-semibold px-2 py-0.5 rounded-full ${item.status.color}">${item.status.text}</span>
                        </li>`).join('')}</ul>`;
                }
                const cards = [
                    { label: 'Verbali Totali', value: stats.totalPca, color: 'blue', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>' },
                    { label: 'NC Aperte', value: stats.openNc, color: 'red', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>' },
                    { label: 'Check Eseguiti', value: stats.totalChecks, color: 'indigo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>' },
                    { label: 'Conformità Media', value: stats.avgCompliance, color: 'green', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' }
                ];
                return `
                <div class="mb-8">
                    <h2 class="text-3xl font-bold">${greeting}!</h2>
                    <p class="text-slate-500 dark:text-slate-400 mt-1">Ecco un riepilogo della situazione attuale.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    ${cards.map(card => `
                    <div class="dashboard-card bg-white dark:bg-slate-800 p-5 rounded-xl shadow-md flex items-center gap-5 border-t-4 border-${card.color}-500">
                        <div class="p-3 rounded-full bg-slate-100 dark:bg-slate-700 text-${card.color}-500">${card.icon}</div>
                        <div>
                            <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">${card.label}</h3>
                            <p class="mt-1 text-3xl font-semibold text-slate-800 dark:text-slate-100">${card.value}</p>
                        </div>
                    </div>`).join('')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
                    <div class="lg:col-span-3 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Non Conformità per Aspetto (PCA Periodici)</h3>
                        <div class="relative h-96 w-full"><canvas id="ncChart"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Controlli Periodici da Eseguire</h3>
                        <div class="max-h-96 overflow-y-auto pr-2">${dueListHtml}</div>
                    </div>
                </div>`;
            },
            // MIGLIORAMENTO: Template lista verbali con gruppi a fisarmonica (accordion)
            pcaGroupedList: (groupedReports, frequencyStatuses) => {
                const groupOrder = ['Sopralluoghi', 'Ispezioni Preliminari', 'Ispezioni Finali', ...Object.keys(App.config.WBS_DATA)];
                 const sortedGroupKeys = Object.keys(groupedReports).sort((a, b) => {
                    const indexA = groupOrder.indexOf(a);
                    const indexB = groupOrder.indexOf(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                if (sortedGroupKeys.length === 0) {
                    return `<div class="text-center p-8 bg-white dark:bg-slate-800 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold">Nessun verbale trovato</h3>
                                <p class="text-slate-500 dark:text-slate-400 mt-2">Inizia compilando il tuo primo verbale da "Nuovo PCA" o "Verbale Sopralluogo".</p>
                            </div>`;
                }
                
                return `<div class="space-y-4">
                    ${sortedGroupKeys.map(groupKey => {
                        const group = groupedReports[groupKey];
                        const reports = group.reports;
                        const reportCount = reports.length;
                        
                        return `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden">
                            <div class="grouped-pca-header p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700">
                                <div class="flex items-center gap-4">
                                    <span class="font-bold text-blue-600 dark:text-blue-400 text-lg">${groupKey}</span>
                                    <h3 class="text-lg font-semibold">${group.descrizione}</h3>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full dark:bg-blue-900 dark:text-blue-200">${reportCount} ${reportCount === 1 ? 'verbale' : 'verbali'}</span>
                                    <svg class="grouped-pca-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                            <div class="grouped-pca-content px-1 pb-1">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-transparent text-sm">
                                        <thead class="bg-slate-100 dark:bg-slate-800">
                                            <tr>
                                                ${['ID','Data','Tipo','Oggetto / WBS','Stato Frequenza', 'Prossimo Controllo', 'Azioni'].map(h=>`<th class="p-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">${h}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                            ${reports.map(report => {
                                                const wbsCode = report.wbs ? report.wbs.substring(0,2).toUpperCase() : null;
                                                const freqStatus = report.type === 'periodico' && wbsCode ? frequencyStatuses[wbsCode] : null;
                                                const typeLabels={'periodico':'PCA Periodico','preliminare':'PCA Preliminare','finale':'PCA Finale', 'sopralluogo': 'Sopralluogo'};
                                                const typeColors={'periodico':'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300','preliminare':'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300','finale':'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', 'sopralluogo': 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-300'};
                                                return `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                                                    <td class="p-3 font-medium text-slate-700 dark:text-slate-300">${report.id}</td>
                                                    <td class="p-3 whitespace-nowrap text-slate-600 dark:text-slate-400">${new Date(report.date+"T00:00:00").toLocaleDateString('it-IT')}</td>
                                                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeColors[report.type] || 'bg-gray-100 text-gray-800'}">${typeLabels[report.type]||'N.D.'}</span></td>
                                                    <td class="p-3 max-w-xs truncate text-slate-600 dark:text-slate-400" title="${report.activities||report.wbs||'N.A.'}">${report.activities||report.wbs||'N.A.'}</td>
                                                    <td class="p-3">
                                                        ${freqStatus ? `<span class="text-xs font-semibold px-2 py-1 rounded-full ${freqStatus.color}">${freqStatus.text}</span>` : '<span>-</span>'}
                                                    </td>
                                                    <td class="p-3 whitespace-nowrap text-slate-600 dark:text-slate-400">
                                                        ${freqStatus && freqStatus.nextDate ? freqStatus.nextDate.toLocaleDateString('it-IT') : '-'}
                                                    </td>
                                                    <td class="p-3">
                                                        <div class="flex items-center gap-4">
                                                            <button data-id="${report.id}" class="print-pca-btn text-slate-500 hover:text-blue-600" title="Stampa Verbale"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button>
                                                            <button data-id="${report.id}" class="delete-pca-btn text-slate-500 hover:text-red-600" title="Elimina Verbale"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                                        </div>
                                                    </td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`
                    }).join('')}
                </div>`;
            },
            imagePlaceholderIcon: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-slate-400 dark:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>`,
            photoUpload(key) {
                return `<div class="photo-uploader">
                    <input type="file" accept="image/*" class="photo-input hidden" data-key="${key}">
                    <div class="photo-preview flex items-center justify-center">
                        <div class="photo-preview-content flex items-center justify-center w-full h-full">
                           ${this.imagePlaceholderIcon()}
                        </div>
                    </div>
                    <button type="button" data-key="${key}" class="remove-photo-btn hidden">&times;</button>
                </div>`
            },
            // MIGLIORAMENTO: Template Checklist con opzioni condizionali verificate e foto
            renderChecklist(templates) {
                return templates.map(t => {
                    if (t.id === 'pca04') return ''; // Gestito da renderWasteSection
                    const freqInfo = App.config.FREQUENCY_MAP[t.significativita];
                    return `<div id="accordion-${t.id}" class="pca-sheet-accordion bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm" style="display: none;">
                        <div class="accordion-header p-4 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-t-lg">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-3">${t.icon} ${t.title}</h3>
                                ${freqInfo ? `<span class="text-sm font-semibold mt-1 px-2.5 py-1 rounded-full ${freqInfo.color}">${freqInfo.text}</span>` : ''}
                            </div>
                            <svg class="accordion-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="accordion-content p-6">
                            <div class="space-y-6">
                                ${t.items.map((item, idx) => {
                                    const baseName = `check_${t.id}_${idx}`;
                                    const extraContentId = `extra_${t.id}_${idx}`;
                                    let extraContentHTML = '';
                                    
                                    // Logica opzioni condizionali
                                    if (t.id === 'pca01' && (idx === 0 || idx === 1)) extraContentHTML = `<div class="w-full md:w-1/2 mt-2"><label for="${extraContentId}_auth" class="form-label">N° Autorizzazione</label><input type="text" id="${extraContentId}_auth" name="${extraContentId}_auth" class="form-input"></div>`;
                                    if (t.id === 'pca01' && idx === 5) extraContentHTML = `<div class="w-full md:w-1/2 mt-2"><label for="${extraContentId}_revisione" class="form-label">Data Ultima Revisione</label><input type="date" id="${extraContentId}_revisione" name="${extraContentId}_revisione" class="form-input"></div>`;
                                    if (t.id === 'pca02' && idx === 2) extraContentHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div><label for="${extraContentId}_ddt" class="form-label">N° DDT</label><input type="text" id="${extraContentId}_ddt" name="${extraContentId}_ddt" class="form-input"></div><div><label for="${extraContentId}_targa" class="form-label">Targa</label><input type="text" id="${extraContentId}_targa" name="${extraContentId}_targa" class="form-input"></div></div>`;
                                    if (t.id === 'pca03' && idx === 0) extraContentHTML = `<div class="w-full md:w-1/2 mt-2"><label for="${extraContentId}_auth" class="form-label">N° Autorizzazione</label><input type="text" id="${extraContentId}_auth" name="${extraContentId}_auth" class="form-input"></div>`;
                                    
                                    const photoKey = `photo_${t.id}_${idx}`;
                                    let photoUploaderHTML = '';
                                    // Aggiunge il box foto per items specifici
                                    if ((t.id === 'pca01' && idx === 4) || (t.id === 'pca02' && (idx === 0 || idx === 1)) || (t.id === 'pca05' && (idx === 0 || idx === 1)) || t.id === 'preliminare' || t.id === 'finale') {
                                        photoUploaderHTML = `<div class="flex-shrink-0">${this.photoUpload(photoKey)}</div>`;
                                    }

                                    return `<div class="check-item-wrapper border-t border-slate-200 dark:border-slate-700 py-4 first:border-t-0 first:pt-0">
                                        <div class="check-item flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                                            <label class="mr-4 text-sm flex-1 pt-1 dark:text-slate-300">${item}</label>
                                            <div class="flex items-center gap-x-6 text-sm flex-shrink-0">
                                                <label class="flex items-center cursor-pointer"><input name="${baseName}" type="radio" value="C" class="form-checkbox"><span class="ml-2 block">Sì</span></label>
                                                <label class="flex items-center cursor-pointer"><input name="${baseName}" type="radio" value="NC" class="form-checkbox"><span class="ml-2 block">No</span></label>
                                                <label class="flex items-center cursor-pointer"><input name="${baseName}" type="radio" value="NA" class="form-checkbox" checked><span class="ml-2 block">N.A.</span></label>
                                            </div>
                                        </div>
                                        <div class="nc-observation-wrapper conditional-section pl-4 border-l-2 border-red-500">
                                            <label for="nc_observation_${t.id}_${idx}" class="form-label text-red-700 dark:text-red-400">Dettaglio Non Conformità / Azione Correttiva</label>
                                            <textarea id="nc_observation_${t.id}_${idx}" name="nc_observation_${t.id}_${idx}" class="form-textarea" rows="2" placeholder="Descrivere il problema..."></textarea>
                                        </div>
                                        <div class="conditional-section">
                                            <div class="flex items-end gap-4">
                                                <div class="flex-grow">${extraContentHTML}</div>
                                                ${photoUploaderHTML}
                                            </div>
                                        </div>
                                    </div>`
                                }).join('')}
                            </div>
                            <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                                <label for="observation_${t.id}" class="form-label">Osservazioni Generali</label>
                                <textarea id="observation_${t.id}" name="observation_${t.id}" class="form-textarea" rows="3" placeholder="Inserire osservazioni generali relative a questa checklist..."></textarea>
                            </div>
                        </div>
                    </div>` 
                }).join('');
            },
            renderWasteSection(template) {
                if(!template) return '';
                const freqInfo = App.config.FREQUENCY_MAP[template.significativita];
                return `<div id="accordion-${template.id}" class="pca-sheet-accordion bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm" style="display: none;">
                    <div class="accordion-header p-4 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-t-lg">
                        <div>
                            <h3 class="text-lg font-semibold flex items-center gap-3">${template.icon} ${template.title}</h3>
                            <span class="text-sm font-semibold mt-1 px-2.5 py-1 rounded-full ${freqInfo.color}">${freqInfo.text}</span>
                        </div>
                        <svg class="accordion-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content p-6">
                        <div class="space-y-6">
                            ${template.items.map((item, idx) => `
                            <div class="check-item-wrapper border-t border-slate-200 dark:border-slate-700 py-4 first:border-t-0 first:pt-0">
                                <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                                    <label class="mr-4 text-sm flex-1 pt-1 dark:text-slate-300">${item}</label>
                                    <div class="flex items-center gap-x-6 text-sm flex-shrink-0">
                                        <label class="flex items-center cursor-pointer"><input name="check_${template.id}_${idx}" type="radio" value="C" class="form-checkbox"><span class="ml-2">Sì</span></label>
                                        <label class="flex items-center cursor-pointer"><input name="check_${template.id}_${idx}" type="radio" value="NC" class="form-checkbox"><span class="ml-2">No</span></label>
                                        <label class="flex items-center cursor-pointer"><input name="check_${template.id}_${idx}" type="radio" value="NA" class="form-checkbox" checked><span class="ml-2">N.A.</span></label>
                                    </div>
                                </div>
                                <div class="nc-observation-wrapper conditional-section pl-4 border-l-2 border-red-500">
                                    <label for="nc_observation_${template.id}_${idx}" class="form-label text-red-700 dark:text-red-400">Dettaglio Non Conformità</label>
                                    <textarea id="nc_observation_${template.id}_${idx}" name="nc_observation_${template.id}_${idx}" class="form-textarea" rows="2"></textarea>
                                </div>
                            </div>
                            `).join('')}
                        </div>
                        <h4 class="text-md font-semibold mt-8 mb-4 border-t pt-4 border-slate-200 dark:border-slate-700">Verifica Campioni Terre (se applicabile)</h4>
                        <div class="cer-table-wrapper">
                            <table class="cer-table w-full text-sm">
                                <thead class="bg-slate-100 dark:bg-slate-700"><tr>
                                    ${['Codice EER', 'Ubicazione', 'Verbale N°', 'Del', 'Prova N°', 'Del', 'Identificato?', 'Delimitato?', 'Produzione', 'Carico', 'Validità', 'Note', 'Azioni'].map(h => `<th class="p-2 text-left font-medium text-slate-600 dark:text-slate-300">${h}</th>`).join('')}
                                </tr></thead>
                                <tbody id="cer-table-rows"></tbody>
                            </table>
                        </div>
                        <button type="button" id="add-cer-row-btn" class="mt-4 px-4 py-2 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 font-semibold">+ Aggiungi Riga</button>
                    </div>
                </div>`;
            },
            wasteTableRow(index) {
                return `
                    <td class="p-1"><input type="text" name="cer_produttore_${index}" class="form-input"></td>
                    <td class="p-1"><input type="text" name="cer_ubicazione_${index}" class="form-input"></td>
                    <td class="p-1"><input type="text" name="cer_verbaleN_${index}" class="form-input"></td>
                    <td class="p-1"><input type="date" name="cer_verbaleDel_${index}" class="form-input"></td>
                    <td class="p-1"><input type="text" name="cer_provaN_${index}" class="form-input"></td>
                    <td class="p-1"><input type="date" name="cer_provaDel_${index}" class="form-input"></td>
                    <td class="p-1"><select name="cer_identificato_${index}" class="form-select"><option value="Sì">Sì</option><option value="No">No</option></select></td>
                    <td class="p-1"><select name="cer_delimitato_${index}" class="form-select"><option value="Sì">Sì</option><option value="No">No</option></select></td>
                    <td class="p-1 text-center"><input type="checkbox" name="cer_produzione_${index}" class="form-checkbox"></td>
                    <td class="p-1 text-center"><input type="checkbox" name="cer_carico_${index}" class="form-checkbox"></td>
                    <td class="p-1"><select name="cer_validita_${index}" class="form-select"><option value="Sì">Sì</option><option value="No">No</option></select></td>
                    <td class="p-1"><input type="text" name="cer_note_${index}" class="form-input"></td>
                    <td class="p-1 text-center"><button type="button" class="cer-delete-row-btn text-red-500 hover:text-red-700 p-2">&times;</button></td>
                `;
            },
            newPcaForm({ nextId, today }) {
                const periodicChecklists = this.renderChecklist(App.config.CHECK_TEMPLATES_PERIODIC);
                const wasteSection = this.renderWasteSection(App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === 'pca04'));
                return `<form id="new-pca-form" novalidate class="space-y-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">1. Dati Generali PCA</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="pca-id" class="form-label">Verbale N°</label><input type="text" id="pca-id" name="id" class="form-input" value="${nextId}" required></div>
                            <div><label for="pca-date" class="form-label">Data</label><input type="date" id="pca-date" name="date" value="${today}" class="form-input" required></div>
                            <div class="md:col-span-2"><label for="pca-type" class="form-label">Tipo di Controllo</label><select id="pca-type" name="type" class="form-select" required><option value="periodico" selected>Periodico (da WBS)</option><option value="preliminare">Preliminare (Ante Operam)</option><option value="finale">Finale (Post Operam)</option></select></div>
                        </div>
                        <div id="wbs-section" class="conditional-section mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="pca-wbs-input" class="form-label">1. Inserisci Codice WBS</label><input type="text" id="pca-wbs-input" name="wbs-input" class="form-input" placeholder="Es. RI12, GA01..."></div>
                                <div><label for="pca-lavorazione-select" class="form-label">2. Seleziona Lavorazione</label><select id="pca-lavorazione-select" name="lavorazione" class="form-select" disabled><option value="">-- Prima inserisci WBS --</option></select></div>
                            </div>
                            <div><label for="pca-inspector-wbs" class="form-label">Compilatore</label><input type="text" id="pca-inspector-wbs" name="inspector-wbs" class="form-input" placeholder="Nome e Funzione"></div>
                        </div>
                        <div id="manual-section" class="conditional-section mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="wbs-manual" class="form-label">Area di Riferimento</label><input id="wbs-manual" name="wbs-manual" class="form-input" placeholder="Es. Campo Base, Area Stoccaggio X..."></div>
                                <div><label for="inspector-manual" class="form-label">Compilatore</label><input id="inspector-manual" name="inspector-manual" class="form-input" placeholder="Nome e Funzione"></div>
                            </div>
                            <div><label for="activities-manual" class="form-label">Oggetto del controllo</label><textarea id="activities-manual" name="activities-manual" class="form-textarea" rows="2" placeholder="Es. Verifica dello stato dei luoghi prima delle attività..."></textarea></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">2. Checklist di Controllo</h2>
                        <div id="checklist-container-periodico" class="space-y-4">${periodicChecklists}${wasteSection}</div>
                        <div id="checklist-container-preliminare" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_PRELIMINARE)}</div>
                        <div id="checklist-container-finale" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_FINALE)}</div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-pca-btn" class="px-6 py-3 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-700 font-semibold">Annulla</button>
                        <button type="button" id="print-draft-btn" class="px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold flex items-center justify-center">Stampa Bozza</button>
                        <button type="submit" id="save-pca-btn" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold flex items-center justify-center shadow-lg hover:shadow-xl">
                            <span>Salva Controllo</span>
                        </button>
                    </div>
                </form>`;
            },
            newSopralluogoForm({ nextId, today }) {
                 return `<form id="new-sopralluogo-form" novalidate class="space-y-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">1. Dati Generali Verbale di Sopralluogo</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="vds-id" class="form-label">Verbale N°</label><input type="text" id="vds-id" name="id" class="form-input" value="${nextId}" required></div>
                            <div><label for="vds-date" class="form-label">Data</label><input type="date" id="vds-date" name="date" value="${today}" class="form-input" required></div>
                            <div><label for="vds-wbs" class="form-label">Area / WBS</label><input type="text" id="vds-wbs" name="wbs" class="form-input" placeholder="Es. Area Stoccaggio GA01" required></div>
                            <div><label for="vds-inspector" class="form-label">Compilatore/i</label><input type="text" id="vds-inspector" name="inspector" class="form-input" placeholder="Nome/i e Funzione/i" required></div>
                            <div class="md:col-span-2"><label for="vds-notes" class="form-label">Note e Osservazioni</label><textarea id="vds-notes" name="notes" class="form-textarea" rows="4" placeholder="Descrivere lo scopo del sopralluogo, le persone presenti, le osservazioni effettuate..."></textarea></div>
                        </div>
                    </div>
                     <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">2. Documentazione Fotografica</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                          ${[0,1,2,3,4].map(i => `
                            <div class="space-y-2">
                                <div class="flex justify-center">${this.photoUpload(`photo_sopralluogo_${i}`)}</div>
                                <label for="caption_${i}" class="form-label text-center">Didascalia Foto ${i + 1}</label>
                                <input type="text" id="caption_${i}" name="caption_${i}" class="form-input" placeholder="Descrizione della foto...">
                            </div>
                          `).join('')}
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="print-draft-btn" class="px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold flex items-center justify-center">Stampa Bozza</button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold flex items-center justify-center shadow-lg hover:shadow-xl">
                            <span>Salva Verbale</span>
                        </button>
                    </div>
                </form>`;
            },
            settings: () => {
                return `<div class="space-y-8 max-w-2xl mx-auto">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">Gestione Dati</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-6">Esporta i tuoi dati per creare un backup o importali per ripristinare uno stato precedente. L'importazione sovrascriverà tutti i dati attuali.</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="file" id="import-file" class="hidden" accept=".json">
                            <button id="import-btn" class="w-full px-5 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Importa Dati</button>
                            <button id="export-btn" class="w-full px-5 py-3 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Esporta Dati</button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md border-2 border-red-500">
                        <h2 class="text-xl font-bold mb-4 text-red-600 dark:text-red-400">Area di Pericolo</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-6">L'azione seguente eliminerà in modo permanente tutti i verbali salvati nell'applicazione. Questa operazione non può essere annullata. Si consiglia di esportare i dati prima di procedere.</p>
                        <button id="clear-all-btn" class="w-full px-5 py-3 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">Svuota Archivio</button>
                    </div>
                </div>`;
            },
            
            // CORREZIONE: Template di stampa con gestione di extraData e foto
            printReport(report, templates) {
                const chrysasLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp';
                const rtiLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOSIS.bmp'; // Assumo sia questo il logo RTI

                const sanitize = App.ui.sanitize;
                const header = `
                    <header class="print-header" style="width: 100%; font-size: 10pt; border-bottom: 2px solid var(--print-border-color); padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div style="text-align: left;"><img src="${chrysasLogoUrl}" alt="Logo CHRYSAS" style="height: 40px;"></div>
                        <div style="text-align: center; font-weight: bold;">
                            MODULO DI CONTROLLO AMBIENTALE (PCA)<br>
                            <span style="font-size: 9pt;">${report.type === 'periodico' ? 'Controllo Periodico' : (report.type === 'preliminare' ? 'Controllo Preliminare' : 'Controllo Finale')}</span>
                        </div>
                        <div style="text-align: right;"><img src="${rtiLogoUrl}" alt="Logo RTI" style="height: 40px;"></div>
                    </header>`;

                const footer = `
                    <footer class="print-footer" style="width: 100%; font-size: 8pt; border-top: 1px solid var(--print-border-color); padding-top: 0.5rem; text-align: center; color: var(--print-text-secondary);">
                        CHRYSAS S.r.l. - Documento generato da App Gestione PCA - Pagina <span class="pageNumber"></span> di <span class="totalPages"></span>
                    </footer>`;
                
                const reportBody = `
                <div id="print-content" style="font-size: 10pt; color: var(--print-text-primary);">
                    <div style="background-color: var(--print-header-bg); padding: 0.75rem; border: 1px solid var(--print-border-color); border-radius: 4px; margin-bottom: 1.5rem;">
                        <h2 style="font-size: 14pt; font-weight: bold; margin: 0 0 0.5rem 0;">Verbale N°: ${sanitize(report.id)}</h2>
                        <table style="width: 100%; font-size: 10pt;">
                            <tr>
                                <td style="padding: 4px 0;"><strong>Data:</strong> ${new Date(report.date + 'T00:00:00').toLocaleDateString('it-IT')}</td>
                                <td style="padding: 4px 0;"><strong>Area / WBS:</strong> ${sanitize(report.wbs)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0;" colspan="2"><strong>Attività/Oggetto:</strong> ${sanitize(report.activities)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0;"><strong>Compilatore:</strong> ${sanitize(report.inspector)}</td>
                                ${report.location ? `<td><strong>Coordinate:</strong> ${report.location.latitude}, ${report.location.longitude}</td>` : ''}
                            </tr>
                        </table>
                    </div>

                    ${templates.map(t => {
                        let contentHtml = '';
                        const checks = report.checks ? report.checks[t.id] : null;
                        if (!checks || checks.every(c => !c.result || c.result === 'NA')) return ''; // Salta se la checklist è vuota o solo N.A.

                        contentHtml += `<div class="no-break" style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 12pt; font-weight: bold; border-bottom: 1px solid var(--print-border-color); padding-bottom: 4px; margin-bottom: 0.5rem;">${sanitize(t.title)}</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><tbody>
                                ${checks.map((check, idx) => {
                                    if (!check.result || check.result === 'NA') return ''; // Salta i check N.A.
                                    
                                    const ncObservationHtml = check.nc_observation ? `<div class="no-break" style="font-size: 9pt; margin: 6px 0 6px 20px; padding: 8px; background-color: #ffebee; border-left: 2px solid #D32F2F;"><strong>Osservazione NC:</strong> ${sanitize(check.nc_observation)}</div>` : '';
                                    
                                    let extraDataHtml = '';
                                    const extraData = report.extraData?.[t.id]?.[idx];
                                    if(extraData){
                                        extraDataHtml = '<div class="no-break" style="font-size: 9pt; margin: 6px 0 6px 20px; padding: 8px; background-color: #f8f8f8; border-left: 2px solid #ddd;">';
                                        for(const [key, value] of Object.entries(extraData)){
                                            const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' '); // Formatta la chiave
                                            if (value) extraDataHtml += `<span style="display: inline-block; min-width: 140px;"><strong>${formattedKey}:</strong></span> ${sanitize(value)} <br>`;
                                        }
                                        extraDataHtml += '</div>';
                                    }

                                    const photoData = report.photos?.[t.id]?.[idx];
                                    const photoHtml = photoData ? `<div class="no-break" style="margin: 10px 0 10px 20px;"><img src="${photoData}" style="max-width: 300px; max-height: 200px; border: 1px solid #ccc; padding: 4px;"></div>` : '';

                                    return `<tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px 0; vertical-align: top; color: var(--print-text-secondary);">
                                            ${sanitize(check.item)}
                                            ${extraDataHtml}
                                            ${ncObservationHtml}
                                            ${photoHtml}
                                        </td>
                                        <td style="padding: 8px 0; text-align: right; font-weight: bold; width: 80px; vertical-align: top; color: ${check.result==='NC'?'#D32F2F':'var(--print-text-primary)'};">${sanitize(check.result) || 'N.D.'}</td>
                                    </tr>`
                                }).join('')}
                            </tbody></table>
                            ${report.observations?.[t.id] ? `<div class="no-break" style="font-size: 9pt; margin-top: 1rem; padding: 8px; background-color: #f0f4f8; border: 1px solid #d4dde5;"><strong>Osservazioni Generali:</strong> ${sanitize(report.observations[t.id])}</div>` : ''}
                        </div>`;
                        return contentHtml;
                    }).join('')}
                    
                    ${(report.cerData && report.cerData.length > 0) ? `
                    <div class="page-break"></div>
                    <h3 style="font-size: 12pt; font-weight: bold; border-bottom: 1px solid var(--print-border-color); padding-bottom: 4px; margin-bottom: 1rem;">Tabella Rifiuti / Terre</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                        <thead style="background-color: var(--print-header-bg);"><tr>${['EER', 'Ubic.', 'V. N°', 'V. Del', 'P. N°', 'P. Del', 'Ident.', 'Delim.', 'Prod.', 'Carico', 'Valid.', 'Note'].map(h => `<th style="border: 1px solid var(--print-border-color); padding: 4px;">${h}</th>`).join('')}</tr></thead>
                        <tbody>${report.cerData.map(r => `
                            <tr>
                                ${[r.cer, r.ubicazione, r.verbaleN, r.verbaleDel, r.provaN, r.provaDel, r.identificato, r.delimitato, r.produzione ? 'Sì':'No', r.carico ? 'Sì':'No', r.validita, r.note].map(d => `<td style="border: 1px solid var(--print-border-color); padding: 4px;">${sanitize(d)}</td>`).join('')}
                            </tr>`).join('')}
                        </tbody>
                    </table>` : ''}

                    <div style="margin-top: 5rem; padding-top: 2rem; border-top: 1px solid var(--print-border-color); display: flex; justify-content: space-around; font-size: 10pt;">
                        <div><p>Il Compilatore</p><p style="margin-top: 3rem;">_________________________</p></div>
                        <div><p>Il Responsabile</p><p style="margin-top: 3rem;">_________________________</p></div>
                    </div>
                </div>`;

                return `<div id="print-area">${header}${reportBody}${footer}</div>`;
            },
            printSopralluogo(report) { 
                const chrysasLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp';
                const rtiLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOSIS.bmp'; 
                const sanitize = App.ui.sanitize;

                const header = `<header class="print-header" style="width: 100%; font-size: 10pt; border-bottom: 2px solid var(--print-border-color); padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div style="text-align: left;"><img src="${chrysasLogoUrl}" alt="Logo CHRYSAS" style="height: 40px;"></div>
                        <div style="text-align: center; font-weight: bold;">VERBALE DI SOPRALLUOGO</div>
                        <div style="text-align: right;"><img src="${rtiLogoUrl}" alt="Logo RTI" style="height: 40px;"></div>
                    </header>`;

                const footer = `<footer class="print-footer" style="width: 100%; font-size: 8pt; border-top: 1px solid var(--print-border-color); padding-top: 0.5rem; text-align: center; color: var(--print-text-secondary);">
                        CHRYSAS S.r.l. - Documento generato da App Gestione PCA - Pagina <span class="pageNumber"></span> di <span class="totalPages"></span>
                    </footer>`;

                const photosHtml = (report.photos && report.photos.length > 0) ? `
                    <div class="page-break"></div>
                    <h3 style="font-size: 12pt; font-weight: bold; margin-top: 1.5rem; border-bottom: 1px solid var(--print-border-color); padding-bottom: 4px; margin-bottom: 1.5rem;">Documentazione Fotografica</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        ${report.photos.map(p => `
                        <div class="no-break" style="border: 1px solid #ccc; padding: 0.5rem; text-align: center;">
                            <img src="${p.src}" style="max-width: 100%; height: auto; max-height: 280px; margin-bottom: 0.5rem;">
                            <p style="font-size: 9pt; font-style: italic;">${sanitize(p.caption)}</p>
                        </div>
                        `).join('')}
                    </div>` : '';

                const reportBody = `
                    <div id="print-content" style="font-size: 10pt; color: var(--print-text-primary);">
                        <div style="background-color: var(--print-header-bg); padding: 0.75rem; border: 1px solid var(--print-border-color); border-radius: 4px; margin-bottom: 1.5rem;">
                            <h2 style="font-size: 14pt; font-weight: bold; margin: 0 0 0.5rem 0;">Verbale N°: ${sanitize(report.id)}</h2>
                            <table style="width: 100%; font-size: 10pt;">
                                <tr>
                                    <td style="padding: 4px 0; width: 50%;"><strong>Data:</strong> ${new Date(report.date + 'T00:00:00').toLocaleDateString('it-IT')}</td>
                                    <td style="padding: 4px 0;"><strong>Area di Riferimento:</strong> ${sanitize(report.wbs)}</td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding: 4px 0;"><strong>Presenti:</strong> ${sanitize(report.inspector)}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="no-break" style="margin-top: 1.5rem;">
                            <h3 style="font-size: 12pt; font-weight: bold; border-bottom: 1px solid var(--print-border-color); padding-bottom: 4px; margin-bottom: 0.5rem;">Note e Osservazioni</h3>
                            <p style="white-space: pre-wrap; line-height: 1.6;">${sanitize(report.notes)}</p>
                        </div>
                        <div style="margin-top: 5rem; padding-top: 2rem; border-top: 1px solid var(--print-border-color); display: flex; justify-content: space-around; font-size: 10pt;">
                            <div><p>Il Compilatore</p><p style="margin-top: 3rem;">_________________________</p></div>
                            <div><p>Per Presa Visione</p><p style="margin-top: 3rem;">_________________________</p></div>
                        </div>
                        ${photosHtml}
                    </div>`;

                return `<div id="print-area">${header}${reportBody}${footer}</div>`;
            },
        }
    };

    App.init().catch(err => {
        console.error("ERRORE FATALE DURANTE L'INIZIALIZZAZIONE:", err);
        document.body.innerHTML = `<div style='padding: 2rem; text-align: center; font-family: sans-serif; color: #ef4444;'><h1>Errore Critico</h1><p>Impossibile avviare l'applicazione. Controlla la console (F12) per i dettagli.</p><p>${err.message}</p></div>`;
    });
});
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="app-container">
        <aside id="sidebar" class="bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col shadow-lg">
            <div class="h-16 flex items-center justify-center px-6 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                <img src="https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp" alt="Logo CHRYSAS" class="h-8">
            </div>
            <nav id="sidebar-nav" class="flex-grow px-4 py-6 overflow-y-auto"></nav>
        </aside>
        
        <div id="sidebar-overlay"></div>

        <div id="main-container" class="relative w-full">
            <header class="h-16 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Toggle Menu">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold"></h2>
                </div>

                <div class="flex items-center gap-6">
                    <div id="weather-widget" class="hidden lg:flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400"></div>

                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" aria-label="Toggle dark mode">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="text-right hidden sm:block"><span id="current-date" class="text-sm text-slate-500 dark:text-slate-400"></span></div>
                </div>
            </header>
            
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6 md:p-8"></main>
        </div>
    </div>
    <div id="toast" class="toast px-6 py-3 rounded-lg text-white font-medium shadow-lg" role="alert" aria-live="polite"></div>
    <div id="print-area-wrapper" class="hidden"></div>
    <div id="modal-overlay" class="modal-overlay"></div>
</body>
</html>