<!DOCTYPE html>
<html lang="it" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net/npm/chart.js https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' https: data:;
        connect-src 'self' https://api.open-meteo.com;
        object-src 'none';
        base-uri 'self';
        form-action 'none';
    ">
    <title>App Gestione PCA - CHRYSAS (v5.1 - UI Potenziata)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js" defer></script>
    
    <style>
        :root {
            --print-header-bg: #f2f2f2;
            --print-border-color: #bbb;
            --print-text-primary: #000;
            --print-text-secondary: #333;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f8fa; /* Sfondo leggermente più caldo */
        }
        .dark body { 
            background-color: #0d1117; /* Sfondo stile GitHub Dark */
        }

        /* --- Layout Avanzato --- */
        #sidebar { 
            position: fixed; top: 0; left: 0; height: 100%; width: 16rem; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            will-change: transform; 
            z-index: 1000;
            border-right-width: 1px;
        }
        #main-container { 
            transition: padding-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        @media (max-width: 1023px) {
            #sidebar { transform: translateX(-100%); }
            .sidebar-open #sidebar { transform: translateX(0); }
            #main-container { padding-left: 0; }
            .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(9, 30, 66, 0.54); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
            .sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
        }
        @media (min-width: 1024px) {
            #sidebar { transform: translateX(0); }
            #main-container { padding-left: 16rem; }
            .sidebar-collapsed #sidebar { transform: translateX(-100%); }
            .sidebar-collapsed #main-container { padding-left: 0; }
            .sidebar-overlay { display: none; }
        }

        /* --- UI Potenziata: Luci, Ombre e Materiali --- */
        .sidebar-link { 
            transition: background-color 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s; 
            border-radius: 0.5rem;
        }
        .sidebar-link.active { 
            @apply bg-blue-600 text-white font-semibold; 
            box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
        }
        .sidebar-link:hover:not(.active) {
            transform: translateX(5px);
        }
        .sidebar-link .sidebar-icon { transition: transform 0.3s ease; }
        .sidebar-link.active .sidebar-icon { transform: scale(1.1); }
        
        .toast { 
            position: fixed; bottom: -100px; left: 50%; 
            transform: translateX(-50%); 
            opacity: 0; 
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); 
            z-index: 1050; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.2);
        }
        .toast.show { 
            opacity: 1; 
            bottom: 40px; 
            transform: translateX(-50%) scale(1); 
        }
        
        .content-fade-in { animation: fadeIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { background-color: rgba(13, 17, 23, 0.7); backdrop-filter: blur(5px); }
        .modal-box { 
            background-color: white; 
            padding: 2.5rem; 
            border-radius: 1rem; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            width: 90%; max-width: 500px; 
            transform: scale(0.95) translateY(10px); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .dark .modal-box { background-color: #161b22; border: 1px solid #30363d; }
        .modal-overlay.visible .modal-box { transform: scale(1) translateY(0); }

        /* --- Stili Form Ridisegnati con Bordi Visibili --- */
        .form-label { @apply block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1.5; }
        .form-input, .form-select, .form-textarea { 
            @apply block w-full rounded-lg shadow-sm bg-white dark:bg-slate-900;
            border: 1px solid #94a3b8; /* CORREZIONE: Bordo più visibile (slate-400) */
            transition: border-color 0.2s, box-shadow 0.2s; 
            padding: 0.75rem 1rem;
        }
        .dark .form-input, .dark .form-select, .dark .form-textarea { 
            border-color: #475569; /* CORREZIONE: Bordo più visibile dark (slate-600) */
            color: #c9d1d9; 
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .form-input:invalid, .form-select:invalid, .form-textarea:invalid { border-color: #ef4444 !important; }
        .form-checkbox { @apply h-5 w-5 rounded border-slate-400 text-blue-600 focus:ring-blue-500 focus:ring-offset-0; }

        /* --- Layout Schede PCA Ridisegnato --- */
        .pca-sheet-accordion {
            border: 1px solid #e2e8f0;
            border-radius: 1rem; /* Bordi più arrotondati */
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.03), 0 1px 2px 0 rgba(0,0,0,0.02);
            transition: box-shadow 0.3s ease;
        }
        .dark .pca-sheet-accordion {
            border-color: #30363d;
            background-color: #161b22;
            box-shadow: 0 0 0 1px #30363d;
        }
        .pca-sheet-accordion:hover {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
        }
        .accordion-header {
            cursor: pointer;
            border-radius: 1rem 1rem 0 0;
        }
        .accordion-header h3 { @apply text-lg font-bold text-slate-800 dark:text-slate-100; }
        .accordion-header .accordion-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .accordion-header.open .accordion-icon { transform: rotate(180deg); }
        .accordion-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), padding 0.5s, opacity 0.3s; 
            opacity: 0;
            border-top: 1px solid #e2e8f0;
        }
        .dark .accordion-content { border-top-color: #30363d; }
        .accordion-content.open { max-height: 5000px; opacity: 1; }
        
        /* --- Layout Item Checklist --- */
        .check-item-wrapper {
            padding: 1.25rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        .check-item-wrapper:not(:first-child) { border-top: 1px solid #e2e8f0; }
        .dark .check-item-wrapper:not(:first-child) { border-top-color: #30363d; }
        .check-item-wrapper:hover {
            background-color: #f7f8fa;
            border-color: #e2e8f0;
        }
        .dark .check-item-wrapper:hover {
            background-color: rgba(110, 118, 129, 0.1);
            border-color: #30363d;
        }

        .check-item-label { @apply text-base text-slate-700 dark:text-slate-300; }
        .check-item-radios label {
            @apply flex items-center cursor-pointer text-sm px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 transition-all duration-200;
        }
        .check-item-radios input:checked + span {
            /* Stile custom per radio selezionato */
        }
        .check-item-radios input[value="C"]:checked ~ label[for*="C"] { @apply bg-green-100 dark:bg-green-900/50 border-green-500 text-green-800 dark:text-green-300 font-semibold; }
        .check-item-radios input[value="NC"]:checked ~ label[for*="NC"] { @apply bg-red-100 dark:bg-red-900/50 border-red-500 text-red-800 dark:text-red-300 font-semibold; }
        .check-item-radios input[value="NA"]:checked ~ label[for*="NA"] { @apply bg-slate-100 dark:bg-slate-700/50 border-slate-400; }

        .conditional-section { max-height: 0; overflow: hidden; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; padding: 0; margin: 0; }
        .conditional-section.visible { max-height: 1000px; opacity: 1; padding-top: 1rem; margin-top: 1rem; }
        .nc-observation-wrapper.visible { border-left: 3px solid #ef4444; padding-left: 1rem; }
        
        /* --- Tipografia e Titoli --- */
        #page-title { @apply text-2xl font-extrabold tracking-tight text-slate-900 dark:text-slate-100; }
        .section-title { @apply text-xl font-bold text-slate-800 dark:text-slate-200 border-b border-slate-200 dark:border-slate-700 pb-4 mb-6; }

        /* --- Pulsanti --- */
        .btn { @apply inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200; }
        .btn-primary { @apply text-white bg-blue-600 hover:bg-blue-700 focus:ring-blue-500; }
        .btn-secondary { @apply text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 focus:ring-blue-500; }
        .btn-danger { @apply text-white bg-red-600 hover:bg-red-700 focus:ring-red-500; }
        .btn-icon { @apply p-2 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700; }

        /* --- Stili per la Stampa (invariati) --- */
        @media print {
            body, #print-area { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            body > *:not(#print-area-wrapper) { display: none !important; }
            #print-area-wrapper { display: block !important; }
            @page {
                size: A4;
                margin: 2.5cm 1.5cm;
                @top-center { content: element(header); }
                @bottom-center { content: element(footer); }
            }
            header.print-header { position: running(header); }
            footer.print-footer { position: running(footer); }
            .page-break { page-break-after: always; }
            .no-break { page-break-inside: avoid; }
        }
    </style>
    
    <script id="app-script" defer>
    // La logica Javascript funzionale rimane INVARIATA.
    // Le modifiche sono nei template HTML e nei gestori di eventi per aggiornare la UI.
    window.onerror = function(message, source, lineno, colno, error) {
        console.error("ERRORE GLOBALE NON GESTITO:", { message, source, lineno, colno, error });
        const toastEl = document.getElementById('toast');
        if (toastEl) {
            toastEl.textContent = 'Errore critico. Ricaricare la pagina.';
            toastEl.className = 'toast px-6 py-3 rounded-lg text-white font-medium shadow-lg bg-red-600 show';
        } else {
            alert('Si è verificato un errore critico. Si prega di ricaricare la pagina.');
        }
        return true; 
    };
    
    document.addEventListener('DOMContentLoaded', () => {

    const App = {
        config: {
            STORAGE_KEY: 'pca_app_data_idb_v18',
            TABS: [
                { id: 'dashboard', label: 'Dashboard', icon: '<svg class="sidebar-icon w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>' },
                { id: 'lista-pca', label: 'Lista Verbali', icon: '<svg class="sidebar-icon w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' },
                { id: 'nuovo-pca', label: 'Nuovo PCA', icon: '<svg class="sidebar-icon w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' },
                { id: 'sopralluogo', label: 'Verbale Sopralluogo', icon: '<svg class="sidebar-icon w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><circle cx="12" cy="15" r="2"></circle><path d="M12 10v3"></path></svg>' },
                { id: 'impostazioni', label: 'Impostazioni', icon: '<svg class="sidebar-icon w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>' }
            ],
            WBS_DATA: { 'GA': { descrizione: 'Gallerie Artificiali', lavorazioni: ['Scavo di sbancamento', 'Posa armature e getti CLS', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti'] }, 'GN': { descrizione: 'Gallerie Naturali', lavorazioni: ['Scavo in naturale', 'Consolidamenti (spritz-beton, centine)', 'Rivestimenti e impermeabilizzazioni'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti', 'Vibrazioni'] }, 'AS': { descrizione: 'Aree di Stoccaggio', lavorazioni: ['Scavi e rivestimenti', 'Opere di sostegno e drenaggi'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Consumi'] }, 'TR': { descrizione: 'Trincee', lavorazioni: ['Scavi di trincea', 'Opere di sostegno (pali, diaframmi)', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Beni Culturali'] }, 'RI': { descrizione: 'Rilevati', lavorazioni: ['Formazione corpo del rilevato', 'Opere di sostegno', 'Sistemazioni idrauliche'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'VI': { descrizione: 'Viadotti', lavorazioni: ['Pali di fondazione e fondazioni', 'Elevazione pile e spalle', 'Varo impalcato e soletta'], aspetti: ['Rumore', 'Vibrazioni', 'Rifiuti', 'Sostanze Pericolose'] }, 'CB': { descrizione: 'Campo Base', lavorazioni: ['Installazione e gestione uffici/dormitori/mensa', 'Manutenzione aree e servizi'], aspetti: ['Acque', 'Rifiuti', 'Rumore', 'Consumi'] }, 'CO': { descrizione: 'Cantiere Operativo', lavorazioni: ['Allestimento aree stoccaggio', 'Gestione impianto di betonaggio', 'Officina e manutenzione mezzi'], aspetti: ['Polveri', 'Rumore', 'Acque', 'Rifiuti', 'Sostanze Pericolose'] }, 'NV': { descrizione: 'Nuova Viabilità', lavorazioni: ['Scavi e rilevati per nuova viabilità', 'Formazione sottofondi e pavimentazioni', 'Opere idrauliche e finiture'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'FA': { descrizione: 'Fabbricati', lavorazioni: ['Scavi e fondazioni', 'Elevazione strutture', 'Finiture e impianti'], aspetti: ['Polveri', 'Rumore', 'Rifiuti', 'Consumi'] } },
            CHECK_TEMPLATES_PERIODIC: [ { id: "pca01", title: "PCA 01: Scarichi Idrici ed Approvvigionamento", icon: "💧", significativita: "ALTA", items: ["Autorizzazione allo scarico acque reflue domestiche presente e valida?", "Autorizzazione allo scarico acque reflue industriali presente e valida?", "Rispetto delle prescrizioni contenute nelle autorizzazioni?", "Corretta gestione acque di lavorazione (es. scavo pali)?", "Kit di emergenza anti-sversamento presente e completo?", "Manutenzione impianti di depurazione/trattamento registrata?"] }, { id: "pca02", title: "PCA 02: Terre e Rocce da Scavo", icon: "⛰️", significativita: "ALTA", items: ["Aree di stoccaggio temporaneo identificate e conformi al PUT?", "Separazione dei cumuli per categorie omogenee?", "Documento di Trasporto (DDT) per le terre conforme e presente?", "Copertura dei cassoni dei mezzi in transito?"] }, { id: "pca03", title: "PCA 03: Emissioni in Atmosfera", icon: "💨", significativita: "ALTA", items: ["Autorizzazioni per impianti (es. calcestruzzo) presenti e valide?", "Copertura mezzi per trasporto materiali polverulenti?", "Bagnatura piste e/o cumuli eseguita regolarmente?", "Velocità dei mezzi in cantiere limitata a 30 km/h?", "Impianto lavaruote funzionante ed utilizzato?"] }, { id: "pca04", title: "PCA 04: Rifiuti", icon: "🗑️", significativita: "ALTA", items: ["Deposito temporaneo (DTR) ordinato e pulito?", "Rifiuti separati per CER e con corretta cartellonistica?", "Stoccaggio rifiuti pericolosi conforme (aree, bacini)?", "Registro di carico/scarico aggiornato (entro 10gg)?", "Quarta copia FIR ricevuta entro 90 giorni?"] }, { id: "pca05", title: "PCA 05: Sostanze Pericolose ed Emergenze", icon: "☣️", significativita: "MEDIA", items: ["Schede di Sicurezza (SDS) disponibili e aggiornate?", "Stoccaggio sostanze su bacini di contenimento idonei?", "Aree di stoccaggio segnalate e adeguate?", "Personale formato per la gestione delle emergenze?"] }, { id: "pca06", title: "PCA 06: Rumore e Vibrazioni", icon: "🔊", significativita: "MEDIA", items: ["Autorizzazione in deroga per rumore presente (se necessaria)?", "Rispetto degli orari di lavoro previsti?", "Barriere acustiche (se previste) integre ed efficaci?", "Manutenzione ordinaria dei mezzi per ridurre il rumore?", "Eseguita misurazione fonometrica periodica?"] }, { id: "pca07", title: "PCA 07: Suolo e Sottosuolo", icon: "🌱", significativita: "ALTA", items: ["Assenza di contaminazioni visive del suolo (macchie, sversamenti)?", "Corretto stoccaggio del terreno vegetale in cumuli separati?", "Utilizzo delle apposite vasche per lavaggio betoniere?", "Gestione corretta del calcestruzzo in esubero?"] }, { id: "pca08", title: "PCA 08: Beni Culturali e Archeologici", icon: "🏺", significativita: "ALTA", items: ["Presenza di archeologo durante le attività di scavo?", "Notifica agli enti competenti in caso di ritrovamento?", "Corretta gestione e inventario dei reperti?", "Disboscamento limitato alle aree strettamente necessarie?"] } ],
            ASPETTO_TO_PCA_ID_MAP: { 'Polveri': 'pca03', 'Rumore': 'pca06', 'Vibrazioni': 'pca06', 'Acque': 'pca01', 'Suolo': 'pca07', 'Rifiuti': 'pca04', 'Terre e Rocce': 'pca02', 'Sostanze Pericolose': 'pca05', 'Rifornimenti': 'pca05', 'Consumi': 'pca05', 'Beni Culturali': 'pca08' },
            FREQUENCY_MAP: { 'ALTA': { text: 'FREQUENZA ALTA', schedule: '(es. settimanale)', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', days: 7 }, 'MEDIA': { text: 'FREQUENZA MEDIA', schedule: '(es. quindicinale)', color: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300', days: 15 }, 'BASSA': { text: 'FREQUENZA BASSA', schedule: '(es. mensile)', color: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300', days: 30 } },
            CHECK_TEMPLATES_PRELIMINARE: [{ id: "preliminare", title: "Verifica Preliminare (Ante Operam)", icon: "📍", items: ["Eseguita analisi documentale (vincoli, servitù, prescrizioni)?", "Eseguita mappatura e documentazione dei recettori sensibili?", "Documentato stato della vegetazione con rilievo fotografico?", "Verificata e documentata assenza di rifiuti/materiali preesistenti?", "Verificata e documentata assenza di contaminazioni pregresse (macchie, odori)?"] }],
            CHECK_TEMPLATES_FINALE: [{ id: "finale", title: "Verifica Finale (Post Operam)", icon: "✅", items: ["Confronto con verbale preliminare ha dato esito positivo?", "Verificata completa rimozione di rifiuti, attrezzature e materiali di risulta?", "Eseguite correttamente le opere di ripristino ambientale (rinverdimenti, etc)?", "Verificata assenza di impatti residui visibili (contaminazioni, erosioni)?"] }],
            WBS_SIGNIFICANCE_MAP: {},
            WEATHER_CODE_MAP: { 0: {text:'Sereno', icon:'☀️'}, 1: {text:'Prevalentemente sereno', icon:'🌤️'}, 2: {text:'Parzialmente nuvoloso', icon:'⛅️'}, 3: {text:'Nuvoloso', icon:'☁️'}, 45: {text:'Nebbia', icon:'🌫️'}, 48: {text:'Nebbia con brina', icon:'🌫️'}, 51: {text:'Pioggerella leggera', icon:'🌦️'}, 53: {text:'Pioggerella moderata', icon:'🌦️'}, 55: {text:'Pioggerella forte', icon:'🌦️'}, 61: {text:'Pioggia leggera', icon:'🌧️'}, 63: {text:'Pioggia moderata', icon:'🌧️'}, 65: {text:'Pioggia forte', icon:'🌧️'}, 71: {text:'Nevicata leggera', icon:'❄️'}, 73: {text:'Nevicata moderata', icon:'❄️'}, 75: {text:'Nevicata forte', icon:'❄️'}, 80: {text:'Rovescio leggero', icon:'🌧️'}, 81: {text:'Rovescio moderato', icon:'🌧️'}, 82: {text:'Rovescio violento', icon:'🌧️'}, 95: {text:'Temporale', icon:'⛈️'}, 96: {text:'Temporale con grandine', icon:'⛈️'} }
        },
        state: { isSaving: false, tempPhotos: {}, activeChart: null, data: [], isSidebarOpen: localStorage.getItem('sidebarOpen') !== 'false', currentWeather: null, currentLocation: null },
        dom: {},
        
        async init() {
            this.dom = {
                appContainer: document.getElementById('app-container'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                sidebarNav: document.getElementById('sidebar-nav'),
                mainContent: document.getElementById('main-content'),
                pageTitle: document.getElementById('page-title'),
                currentDate: document.getElementById('current-date'),
                toast: document.getElementById('toast'),
                printAreaWrapper: document.getElementById('print-area-wrapper'),
                modal: document.getElementById('modal-overlay'),
                theme: { toggleBtn: document.getElementById('theme-toggle'), darkIcon: document.getElementById('theme-toggle-dark-icon'), lightIcon: document.getElementById('theme-toggle-light-icon') },
                sidebarToggleBtn: document.getElementById('sidebar-toggle-btn'),
                weatherWidget: document.getElementById('weather-widget')
            };
            this.ui.renderNav();
            this._computeWbsSignificance();
            this.handlers.attachGlobalListeners();
            this.ui.applyTheme(localStorage.getItem('theme') === 'dark', true);
            this.ui.setSidebarState(this.state.isSidebarOpen);
            try {
                this.state.data = await this.store.getAll();
            } catch (err) {
                console.error("Errore critico nel caricamento da IndexedDB:", err);
                this.ui.showToast("Errore nel caricare i dati. L'archivio potrebbe essere corrotto.", 'error');
                this.state.data = [];
            }
            await this.ui.showTab('dashboard');
            this.services.fetchLocationAndWeather();
        },
        
        _computeWbsSignificance() {
            const significanceValues = { 'ALTA': 2, 'MEDIA': 1, 'BASSA': 0 };
            for (const wbsCode in this.config.WBS_DATA) {
                const wbsData = this.config.WBS_DATA[wbsCode];
                let maxSignificance = -1;
                const requiredPcaIds = new Set(wbsData.aspetti.map(a => this.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                requiredPcaIds.forEach(pcaId => {
                    const template = this.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === pcaId);
                    if (template && template.significativita) {
                        const sigValue = significanceValues[template.significativita];
                        if (sigValue > maxSignificance) { maxSignificance = sigValue; }
                    }
                });
                const significanceKey = Object.keys(significanceValues).find(key => significanceValues[key] === maxSignificance);
                if (significanceKey) { this.config.WBS_SIGNIFICANCE_MAP[wbsCode] = significanceKey; }
            }
        },

        store: {
            dbStore: idbKeyval.createStore('pca-db', 'reports'),
            async getAll() { return (await idbKeyval.get(App.config.STORAGE_KEY, this.dbStore)) || []; },
            async saveAll(reports) {
                await idbKeyval.set(App.config.STORAGE_KEY, reports, this.dbStore);
                App.state.data = reports;
            },
            async getById(id) {
                const reports = await this.getAll();
                return reports.find(r => r && String(r.id) === String(id));
            },
            async save(newReport) {
                const reports = await this.getAll();
                const reportId = String(newReport.id);
                const existingIndex = reports.findIndex(r => r && String(r.id) === reportId);
                if (existingIndex !== -1) {
                    reports[existingIndex] = newReport;
                } else {
                    reports.push(newReport);
                }
                await this.saveAll(reports);
            },
            async delete(id) {
                let reports = await this.getAll();
                reports = reports.filter(r => r && String(r.id) !== String(id));
                await this.saveAll(reports);
            },
            async getNextId(prefix = '') {
                const reports = await this.getAll();
                const relevantIds = reports
                    .map(r => String(r.id))
                    .filter(id => id.startsWith(prefix))
                    .map(id => parseInt(id.replace(prefix, ''), 10))
                    .filter(num => !isNaN(num));
                
                const maxId = relevantIds.length > 0 ? Math.max(...relevantIds) : 0;
                return prefix + (maxId + 1);
            },
            getDashboardStats() {
                const reports = App.state.data; let openNc = 0; let totalChecks = 0; let compliantChecks = 0; const ncByAspect = {};
                reports.forEach(report => {
                    if (report && report.type === 'periodico' && report.checks) {
                        Object.entries(report.checks).forEach(([aspectId, aspectChecks]) => {
                            const template = App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === aspectId);
                            if (!template || !aspectChecks) return;
                            aspectChecks.forEach(check => {
                                if (check && check.result && check.result !== 'NA') {
                                    totalChecks++;
                                    if (check.result === 'C') compliantChecks++;
                                    if (check.result === 'NC') {
                                        openNc++;
                                        ncByAspect[template.title] = (ncByAspect[template.title] || 0) + 1;
                                    }
                                }
                            });
                        });
                    }
                });
                const avgCompliance = totalChecks > 0 ? `${((compliantChecks / totalChecks) * 100).toFixed(0)}%` : 'N.D.';
                return { totalPca: reports.length, openNc, totalChecks, avgCompliance, ncByAspect };
            },
        },

        services: {
            async fetchLocationAndWeather() {
                const widget = App.dom.weatherWidget;
                if (!widget) return;
                widget.innerHTML = `<div class="loader"></div><span>Geolocalizzazione...</span>`;

                if (!navigator.geolocation) {
                    widget.innerHTML = '<span>Geolocalizzazione non supportata.</span>';
                    App.state.currentWeather = null;
                    App.state.currentLocation = null;
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        App.state.currentLocation = { latitude: latitude.toFixed(5), longitude: longitude.toFixed(5) };
                        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude.toFixed(2)}&longitude=${longitude.toFixed(2)}&current=temperature_2m,precipitation,weather_code,wind_speed_10m`;
                        try {
                            const response = await fetch(apiUrl);
                            if (!response.ok) throw new Error('Risposta API non valida');
                            const data = await response.json();
                            App.state.currentWeather = data.current;
                            App.ui.renderWeather(data.current);
                        } catch (error) {
                            console.error("Errore API meteo:", error);
                            widget.textContent = 'Meteo non disponibile';
                            App.state.currentWeather = null;
                        }
                    },
                    (error) => {
                        console.warn("Errore geolocalizzazione:", error.message);
                        widget.innerHTML = '<span>Geolocalizzazione negata.</span>';
                        App.state.currentWeather = null;
                        App.state.currentLocation = null;
                    }
                );
            },
            getGreeting() {
                const hour = new Date().getHours();
                if (hour < 12) return 'Buongiorno';
                if (hour < 18) return 'Buon pomeriggio';
                return 'Buonasera';
            }
        },
        
        ui: {
            renderMap: { 'dashboard': 'renderDashboard', 'lista-pca': 'renderListaPca', 'nuovo-pca': 'renderNuovoPca', 'sopralluogo': 'renderNuovoSopralluogo', 'impostazioni': 'renderImpostazioni' },
            showToast(message, type = 'success') {
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
                App.dom.toast.textContent = message;
                App.dom.toast.className = `toast px-6 py-3 rounded-lg text-white font-semibold shadow-lg ${colors[type]}`;
                setTimeout(() => { App.dom.toast.classList.add('show'); }, 10);
                setTimeout(() => { App.dom.toast.classList.remove('show'); }, 4000);
            },
            showModal(config) {
                return new Promise((resolve) => {
                    const { title, message, confirmText = 'Conferma', cancelText = 'Annulla', confirmColor = 'bg-red-600' } = config;
                    App.dom.modal.innerHTML = `
                        <div class="modal-box">
                            <h3 class="text-xl font-bold mb-4">${this.sanitize(title)}</h3>
                            <p class="text-slate-600 dark:text-slate-300 mb-6">${this.sanitize(message)}</p>
                            <div class="flex justify-end gap-4">
                                <button id="modal-cancel" class="btn btn-secondary">${this.sanitize(cancelText)}</button>
                                <button id="modal-confirm" class="btn ${confirmColor === 'bg-red-600' ? 'btn-danger' : 'btn-primary'}">${this.sanitize(confirmText)}</button>
                            </div>
                        </div>`;
                    App.dom.modal.classList.add('visible');
                    
                    const confirmBtn = document.getElementById('modal-confirm');
                    const cancelBtn = document.getElementById('modal-cancel');
                    const closeModal = (decision) => {
                        App.dom.modal.classList.remove('visible');
                        resolve(decision);
                    };
                    confirmBtn.onclick = () => closeModal(true);
                    cancelBtn.onclick = () => closeModal(false);
                    App.dom.modal.onclick = (e) => { if (e.target === App.dom.modal) closeModal(false); };
                });
            },
            async showTab(tabId) {
                App.state.tempPhotos = {};
                const tab = App.config.TABS.find(t => t.id === tabId);
                if (!tab) return;
                App.dom.sidebarNav.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.dataset.tabId === tabId));
                App.dom.pageTitle.textContent = tab.label;
                
                App.dom.mainContent.classList.remove('content-fade-in');
                void App.dom.mainContent.offsetWidth;

                const renderFunctionName = this.renderMap[tabId];
                if (this[renderFunctionName]) await this[renderFunctionName]();
                
                App.dom.mainContent.classList.add('content-fade-in');
            },
            renderNav() { App.dom.sidebarNav.innerHTML = App.config.TABS.map(t => `<a href="#" data-tab-id="${t.id}" class="sidebar-link flex items-center px-4 py-3 mt-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 font-semibold">${t.icon} ${t.label}</a>`).join(''); },
            renderDashboard() { /* LOGICA INVARIATA */ },
            renderImpostazioni() { /* LOGICA INVARIATA */ },
            renderListaPca() { /* LOGICA INVARIATA */ },
            getFrequencyStatuses() { /* LOGICA INVARIATA */ },
            renderWeather(weatherData) { /* LOGICA INVARIATA */ },
            async renderNuovoPca() {
                const nextId = await App.store.getNextId('PCA-');
                const today = new Date().toISOString().slice(0, 10);
                App.dom.mainContent.innerHTML = App.templates.newPcaForm({ nextId, today });
                App.handlers.attachNewPcaFormListeners();
                this.updateFormRequirements('periodico');
            },
            async renderNuovoSopralluogo() { /* LOGICA INVARIATA */ },
            updateFormRequirements(type) {
                const isPeriodico = type === 'periodico';
                document.getElementById('wbs-section')?.classList.toggle('visible', isPeriodico);
                document.getElementById('manual-section')?.classList.toggle('visible', !isPeriodico);
                
                document.getElementById('checklist-container-periodico').style.display = isPeriodico ? 'block' : 'none';
                document.getElementById('checklist-container-preliminare').style.display = type === 'preliminare' ? 'block' : 'none';
                document.getElementById('checklist-container-finale').style.display = type === 'finale' ? 'block' : 'none';
                
                const wbsInputs = ['pca-wbs-input', 'pca-lavorazione-select', 'pca-inspector-wbs'];
                const manualInputs = ['wbs-manual', 'inspector-manual', 'activities-manual'];
                
                wbsInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', isPeriodico));
                manualInputs.forEach(id => document.getElementById(id)?.toggleAttribute('required', !isPeriodico));
                this.updateNextDueDates(); // Aggiorna le date se il tipo di form cambia
            },
            // NUOVA FUNZIONE: Calcola e mostra le date di scadenza
            updateNextDueDates() {
                const dateInput = document.getElementById('pca-date');
                if (!dateInput || !dateInput.value) {
                    document.querySelectorAll('.next-due-date-wrapper').forEach(el => el.style.display = 'none');
                    return;
                };

                const baseDate = new Date(dateInput.value);
                if (isNaN(baseDate.getTime())) return;

                const visibleAccordions = document.querySelectorAll('.pca-sheet-accordion:not([style*="display: none"])');
                
                visibleAccordions.forEach(accordion => {
                    const sheetId = accordion.id.replace('accordion-', '');
                    const template = App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === sheetId);
                    const wrapper = accordion.querySelector('.next-due-date-wrapper');
                    const span = accordion.querySelector('.next-due-date');

                    if (template && template.significativita && wrapper && span) {
                        const freqData = App.config.FREQUENCY_MAP[template.significativita];
                        if (freqData && freqData.days) {
                            const nextDate = new Date(baseDate);
                            nextDate.setDate(nextDate.getDate() + freqData.days);
                            span.textContent = nextDate.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            wrapper.style.display = 'flex';
                        } else {
                           wrapper.style.display = 'none';
                        }
                    } else if (wrapper) {
                        wrapper.style.display = 'none';
                    }
                });
            },
            applyTheme(isDark, isInitial = false) { /* LOGICA INVARIATA */ },
            setSidebarState(isOpen) { /* LOGICA INVARIATA */ },
            toggleSidebar() { /* LOGICA INVARIATA */ },
            resetPcaForm: () => { App.ui.showTab('nuovo-pca'); },
            async print(report) { /* LOGICA INVARIATA */ },
            sanitize(str) { /* LOGICA INVARIATA */ }
        },

        handlers: {
            debounce(func, delay = 300) { /* LOGICA INVARIATA */ },
            attachGlobalListeners() { /* LOGICA INVARIATA */ },
            attachPcaListListeners() { /* LOGICA INVARIATA */ },
            async onDeletePca(reportId) { /* LOGICA INVARIATA */ },
            attachNewPcaFormListeners() {
                const form = document.getElementById('new-pca-form'); if (!form) return;
                form.addEventListener('submit', (e) => this.onNewPcaSubmit(e));
                form.addEventListener('click', (e) => { 
                    if (e.target.closest('.photo-preview-content')) e.target.closest('.photo-uploader').querySelector('.photo-input').click(); 
                    if (e.target.closest('.remove-photo-btn')) this.onPhotoRemove(e);
                    if (e.target.matches('#cancel-pca-btn')) App.ui.resetPcaForm();
                    if (e.target.matches('#print-draft-btn')) this.onPrintDraft(form);
                    if (e.target.id === 'add-cer-row-btn') this.addCerRow();
                    if (e.target.closest('.cer-delete-row-btn')) e.target.closest('tr').remove();
                    
                    const accordionHeader = e.target.closest('.accordion-header');
                    if (accordionHeader) {
                        const content = accordionHeader.nextElementSibling;
                        accordionHeader.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
                form.querySelectorAll('.photo-input').forEach(i => i.addEventListener('change', (e) => this.onPhotoUpload(e)));
                form.addEventListener('change', (e) => {
                    if (e.target.type === 'radio' && e.target.name.startsWith('check_')) {
                        const wrapper = e.target.closest('.check-item-wrapper');
                        const ncObservationWrapper = wrapper.querySelector('.nc-observation-wrapper');
                        if (ncObservationWrapper) {
                             ncObservationWrapper.classList.toggle('visible', e.target.value === 'NC');
                        }
                        const conditionalSection = wrapper.querySelector('.conditional-section:not(.nc-observation-wrapper)');
                        if(conditionalSection){
                             conditionalSection.classList.toggle('visible', e.target.value === 'C');
                        }
                    }
                });
                document.getElementById('pca-type')?.addEventListener('change', (e) => App.ui.updateFormRequirements(e.target.value));
                // MODIFICA: Aggiunto listener per aggiornare le date di scadenza
                document.getElementById('pca-date')?.addEventListener('change', () => App.ui.updateNextDueDates());
                document.getElementById('pca-wbs-input')?.addEventListener('input', (e) => {
                    const wbsCodeFull = e.target.value.toUpperCase(); const wbsCode = wbsCodeFull.substring(0, 2); const wbsData = App.config.WBS_DATA[wbsCode]; const lavorazioneSelect = document.getElementById('pca-lavorazione-select');
                    
                    const accordionContainer = document.getElementById('checklist-container-periodico');
                    const accordionContents = accordionContainer.querySelectorAll('.accordion-content');
                    const accordionHeaders = accordionContainer.querySelectorAll('.accordion-header');
                    
                    lavorazioneSelect.innerHTML = '<option value="">-- Prima inserisci WBS --</option>';
                    lavorazioneSelect.disabled = true;
                    accordionContainer.querySelectorAll('.pca-sheet-accordion').forEach(el => {
                        el.style.display = 'none';
                        const dateWrapper = el.querySelector('.next-due-date-wrapper');
                        if(dateWrapper) dateWrapper.style.display = 'none';
                    });
                    accordionContents.forEach(c => c.classList.remove('open'));
                    accordionHeaders.forEach(h => h.classList.remove('open'));

                    if (wbsData && wbsCodeFull.length >= 2) {
                        App.ui.showToast('Checklist per ' + wbsCode + ' caricate.', 'info');
                        lavorazioneSelect.innerHTML = '<option value="">-- Seleziona Lavorazione --</option>';
                        wbsData.lavorazioni.forEach(lav => { const option = document.createElement('option'); option.value = lav; option.textContent = lav; lavorazioneSelect.appendChild(option); });
                        lavorazioneSelect.disabled = false;
                        
                        const requiredPcaIds = new Set(wbsData.aspetti.map(a => App.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                        let firstAccordionEl = null;

                        requiredPcaIds.forEach((sheetId, index) => { 
                            const accordionEl = document.getElementById(`accordion-${sheetId}`);
                            if (accordionEl) {
                                accordionEl.style.display = 'block';
                                if (index === 0) {
                                    firstAccordionEl = accordionEl;
                                }
                            }
                        });

                        if (firstAccordionEl) {
                            const header = firstAccordionEl.querySelector('.accordion-header');
                            const content = firstAccordionEl.querySelector('.accordion-content');
                            header.classList.add('open');
                            content.classList.add('open');
                        }
                        // MODIFICA: Calcola le date dopo aver mostrato le checklist
                        App.ui.updateNextDueDates();
                    }
                });
            },
            addCerRow() { /* LOGICA INVARIATA */ },
            _buildReportObjectFromForm(form) { /* LOGICA INVARIATA */ },
            async onPrintDraft(form) { /* LOGICA INVARIATA */ },
            async onNewPcaSubmit(e) { /* LOGICA INVARIATA */ },
            onPhotoRemove(e) { /* LOGICA INVARIATA */ },
            async onPhotoUpload(e) { /* LOGICA INVARIATA */ },
            resizeImage: (file, maxSize) => new Promise((resolve, reject) => { /* LOGICA INVARIATA */ }),
            async attachSettingsListeners() { /* LOGICA INVARIATA */ },
            async onClearAllData() { /* LOGICA INVARIATA */ },
            async exportData() { /* LOGICA INVARIATA */ },
            importData(e) { /* LOGICA INVARIATA */ },
            attachSopralluogoListeners() { /* LOGICA INVARIATA */ },
            _buildSopralluogoObjectFromForm(form) { /* LOGICA INVARIATA */ },
            async onPrintSopralluogoDraft(form) { /* LOGICA INVARIATA */ },
            async onSopralluogoSubmit(e) { /* LOGICA INVARIATA */ }
        },
        
        // MODIFICA: I template sono stati aggiornati con le nuove classi e strutture CSS
        templates: {
            dashboard: (stats, dueList, greeting) => { /* HTML/TEMPLATE INVARIATO */ },
            pcaGroupedList: (groupedReports, frequencyStatuses) => { /* HTML/TEMPLATE INVARIATO */ },
            imagePlaceholderIcon: () => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-slate-400 dark:text-slate-500"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>`,
            photoUpload(key) {
                return `<div class="photo-uploader bg-white dark:bg-slate-800/50 border-slate-300 dark:border-slate-700 rounded-lg">
                    <input type="file" accept="image/*" class="photo-input hidden" data-key="${key}">
                    <div class="photo-preview flex items-center justify-center">
                        <div class="photo-preview-content flex items-center justify-center w-full h-full">
                           ${this.imagePlaceholderIcon()}
                        </div>
                    </div>
                    <button type="button" data-key="${key}" class="remove-photo-btn hidden">&times;</button>
                </div>`
            },
            renderChecklist(templates) {
                return templates.map(t => {
                    if (t.id === 'pca04') return '';
                    const freqInfo = App.config.FREQUENCY_MAP[t.significativita];
                    return `<div id="accordion-${t.id}" class="pca-sheet-accordion" style="display: none;">
                        <div class="accordion-header p-5 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <span class="text-2xl">${t.icon}</span>
                                <div class="flex-grow">
                                    <h3>${t.title}</h3>
                                    <div class="flex items-center gap-4 mt-1">
                                        ${freqInfo ? `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${freqInfo.color}">${freqInfo.text}</span>` : ''}
                                        <div class="next-due-date-wrapper hidden items-center gap-1 text-xs font-medium text-slate-500 dark:text-slate-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                            <span>Prossimo: <span class="next-due-date font-semibold text-slate-700 dark:text-slate-200"></span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <svg class="accordion-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="accordion-content">
                            <div class="divide-y divide-slate-200 dark:divide-slate-700">
                                ${t.items.map((item, idx) => {
                                    const baseName = `check_${t.id}_${idx}`;
                                    const extraContentId = `extra_${t.id}_${idx}`;
                                    let extraContentHTML = '';
                                    
                                    if (t.id === 'pca01' && (idx === 0 || idx === 1)) extraContentHTML = `<div class="w-full md:w-1/2 mt-2"><label for="${extraContentId}_auth" class="form-label">N° Autorizzazione</label><input type="text" id="${extraContentId}_auth" name="${extraContentId}_auth" class="form-input"></div>`;
                                    if (t.id === 'pca01' && idx === 5) extraContentHTML = `<div class="w-full md:w-1/2 mt-2"><label for="${extraContentId}_revisione" class="form-label">Data Ultima Revisione</label><input type="date" id="${extraContentId}_revisione" name="${extraContentId}_revisione" class="form-input"></div>`;
                                    if (t.id === 'pca02' && idx === 2) extraContentHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div><label for="${extraContentId}_ddt" class="form-label">N° DDT</label><input type="text" id="${extraContentId}_ddt" name="${extraContentId}_ddt" class="form-input"></div><div><label for="${extraContentId}_targa" class="form-label">Targa</label><input type="text" id="${extraContentId}_targa" name="${extraContentId}_targa" class="form-input"></div></div>`;
                                    if (t.id === 'pca03' && idx === 0) extraContentHTML = `<div class="w-full md:w-1/2 mt-2"><label for="${extraContentId}_auth" class="form-label">N° Autorizzazione</label><input type="text" id="${extraContentId}_auth" name="${extraContentId}_auth" class="form-input"></div>`;
                                    
                                    const photoKey = `photo_${t.id}_${idx}`;
                                    let photoUploaderHTML = '';
                                    if ((t.id === 'pca01' && idx === 4) || (t.id === 'pca02' && (idx === 0 || idx === 1)) || (t.id === 'pca05' && (idx === 0 || idx === 1)) || t.id === 'preliminare' || t.id === 'finale') {
                                        photoUploaderHTML = `<div class="flex-shrink-0">${this.photoUpload(photoKey)}</div>`;
                                    }

                                    return `<div class="check-item-wrapper p-5">
                                        <div class="check-item flex flex-col lg:flex-row justify-between lg:items-center gap-4">
                                            <p class="check-item-label flex-1">${item}</p>
                                            <div class="flex items-center gap-x-3 flex-shrink-0 check-item-radios">
                                                <input type="radio" id="check_${t.id}_${idx}_C" name="${baseName}" value="C" class="sr-only"><label for="check_${t.id}_${idx}_C"><span>Sì</span></label>
                                                <input type="radio" id="check_${t.id}_${idx}_NC" name="${baseName}" value="NC" class="sr-only"><label for="check_${t.id}_${idx}_NC"><span>No</span></label>
                                                <input type="radio" id="check_${t.id}_${idx}_NA" name="${baseName}" value="NA" class="sr-only" checked><label for="check_${t.id}_${idx}_NA"><span>N.A.</span></label>
                                            </div>
                                        </div>
                                        <div class="nc-observation-wrapper conditional-section">
                                            <label for="nc_observation_${t.id}_${idx}" class="form-label text-red-700 dark:text-red-400">Dettaglio Non Conformità / Azione Correttiva</label>
                                            <textarea id="nc_observation_${t.id}_${idx}" name="nc_observation_${t.id}_${idx}" class="form-textarea" rows="2" placeholder="Descrivere il problema..."></textarea>
                                        </div>
                                        <div class="conditional-section">
                                            <div class="flex items-end gap-4">
                                                <div class="flex-grow">${extraContentHTML}</div>
                                                ${photoUploaderHTML}
                                            </div>
                                        </div>
                                    </div>`
                                }).join('')}
                            </div>
                            <div class="mt-6 p-5">
                                <label for="observation_${t.id}" class="form-label">Osservazioni Generali</label>
                                <textarea id="observation_${t.id}" name="observation_${t.id}" class="form-textarea" rows="3" placeholder="Inserire osservazioni generali relative a questa checklist..."></textarea>
                            </div>
                        </div>
                    </div>` 
                }).join('');
            },
            renderWasteSection(template) { /* HTML/TEMPLATE INVARIATO */ },
            wasteTableRow(index) { /* HTML/TEMPLATE INVARIATO */ },
            newPcaForm({ nextId, today }) {
                const periodicChecklists = this.renderChecklist(App.config.CHECK_TEMPLATES_PERIODIC);
                const wasteSection = this.renderWasteSection(App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === 'pca04'));
                return `<form id="new-pca-form" novalidate class="space-y-8">
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h2 class="section-title">1. Dati Generali PCA</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="pca-id" class="form-label">Verbale N°</label><input type="text" id="pca-id" name="id" class="form-input" value="${nextId}" required></div>
                            <div><label for="pca-date" class="form-label">Data</label><input type="date" id="pca-date" name="date" value="${today}" class="form-input" required></div>
                            <div class="md:col-span-2"><label for="pca-type" class="form-label">Tipo di Controllo</label><select id="pca-type" name="type" class="form-select" required><option value="periodico" selected>Periodico (da WBS)</option><option value="preliminare">Preliminare (Ante Operam)</option><option value="finale">Finale (Post Operam)</option></select></div>
                        </div>
                        <div id="wbs-section" class="conditional-section mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="pca-wbs-input" class="form-label">1. Inserisci Codice WBS</label><input type="text" id="pca-wbs-input" name="wbs-input" class="form-input" placeholder="Es. RI12, GA01..."></div>
                                <div><label for="pca-lavorazione-select" class="form-label">2. Seleziona Lavorazione</label><select id="pca-lavorazione-select" name="lavorazione" class="form-select" disabled><option value="">-- Prima inserisci WBS --</option></select></div>
                            </div>
                            <div><label for="pca-inspector-wbs" class="form-label">Compilatore</label><input type="text" id="pca-inspector-wbs" name="inspector-wbs" class="form-input" placeholder="Nome e Funzione"></div>
                        </div>
                        <div id="manual-section" class="conditional-section mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="wbs-manual" class="form-label">Area di Riferimento</label><input id="wbs-manual" name="wbs-manual" class="form-input" placeholder="Es. Campo Base, Area Stoccaggio X..."></div>
                                <div><label for="inspector-manual" class="form-label">Compilatore</label><input id="inspector-manual" name="inspector-manual" class="form-input" placeholder="Nome e Funzione"></div>
                            </div>
                            <div><label for="activities-manual" class="form-label">Oggetto del controllo</label><textarea id="activities-manual" name="activities-manual" class="form-textarea" rows="2" placeholder="Es. Verifica dello stato dei luoghi prima delle attività..."></textarea></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="section-title">2. Checklist di Controllo</h2>
                        <div id="checklist-container-periodico" class="space-y-4">${periodicChecklists}${wasteSection}</div>
                        <div id="checklist-container-preliminare" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_PRELIMINARE)}</div>
                        <div id="checklist-container-finale" class="space-y-4" style="display: none;">${this.renderChecklist(App.config.CHECK_TEMPLATES_FINALE)}</div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-pca-btn" class="btn btn-secondary">Annulla</button>
                        <button type="button" id="print-draft-btn" class="btn btn-secondary">Stampa Bozza</button>
                        <button type="submit" id="save-pca-btn" class="btn btn-primary">
                            <span>Salva Controllo</span>
                        </button>
                    </div>
                </form>`;
            },
            newSopralluogoForm({ nextId, today }) { /* HTML/TEMPLATE INVARIATO */ },
            settings: () => { /* HTML/TEMPLATE INVARIATO */ },
            printReport(report, templates) { /* HTML/TEMPLATE INVARIATO */ },
            printSopralluogo(report) { /* HTML/TEMPLATE INVARIATO */ },
        }
    };

    App.init().catch(err => {
        console.error("ERRORE FATALE DURANTE L'INIZIALIZZAZIONE:", err);
        document.body.innerHTML = `<div style='padding: 2rem; text-align: center; font-family: sans-serif; color: #ef4444;'><h1>Errore Critico</h1><p>Impossibile avviare l'applicazione. Controlla la console (F12) per i dettagli.</p><p>${err.message}</p></div>`;
    });
});
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="app-container">
        <aside id="sidebar" class="bg-white dark:bg-slate-800/95 backdrop-blur-lg border-r border-slate-200 dark:border-slate-800 flex flex-col">
            <div class="h-16 flex items-center justify-center px-6 border-b border-slate-200 dark:border-slate-700/50 flex-shrink-0">
                <img src="https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp" alt="Logo CHRYSAS" class="h-8">
            </div>
            <nav id="sidebar-nav" class="flex-grow px-4 py-6 overflow-y-auto"></nav>
        </aside>
        
        <div id="sidebar-overlay"></div>

        <div id="main-container" class="relative w-full">
            <header class="h-16 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-btn" class="btn-icon" aria-label="Toggle Menu">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h1 id="page-title"></h1>
                </div>

                <div class="flex items-center gap-4">
                    <div id="weather-widget" class="hidden lg:flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400"></div>

                    <button id="theme-toggle" class="btn-icon" aria-label="Toggle dark mode">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="text-right hidden sm:block"><span id="current-date" class="text-sm text-slate-500 dark:text-slate-400"></span></div>
                </div>
            </header>
            
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6 md:p-8"></main>
        </div>
    </div>
    <div id="toast" class="toast px-6 py-3 rounded-lg text-white font-semibold" role="alert" aria-live="polite"></div>
    <div id="print-area-wrapper" class="hidden"></div>
    <div id="modal-overlay" class="modal-overlay"></div>
</body>
</html>