<!DOCTYPE html>
<html lang="it" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Gestione PCA - CHRYSAS (v. Ottimizzata)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <style>
        :root {
            --color-primary: #3b82f6; --color-primary-hover: #2563eb;
            --color-danger: #ef4444; --color-danger-hover: #d93d3d;
            --color-background-light: #f8fafc; --color-background-dark: #0f172a;
            --color-card-light: #ffffff; --color-card-dark: #1e293b;
            --color-text-light: #0f172a; --color-text-dark: #f1f5f9;
            --color-border-light: #e2e8f0; --color-border-dark: #334155;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background-light); color: var(--color-text-light); transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: var(--color-background-dark); color: var(--color-text-dark); }
        
        /* Animazioni e Transizioni Generali */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .content-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .loader { width: 1.25rem; height: 1.25rem; border: 2px solid var(--color-border-light); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }

        /* Layout Sidebar */
        #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 16rem; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        #main-container { transition: padding-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (max-width: 1023px) {
            #sidebar { transform: translateX(-100%); }
            .sidebar-open #sidebar { transform: translateX(0); }
            #main-container { padding-left: 0; }
            .sidebar-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
            .sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
        }
        @media (min-width: 1024px) {
            #sidebar { transform: translateX(0); }
            #main-container { padding-left: 16rem; }
            .sidebar-collapsed #sidebar { transform: translateX(-100%); }
            .sidebar-collapsed #main-container { padding-left: 0; }
        }

        /* Componenti UI */
        .sidebar-link { transition: all 0.2s; }
        .sidebar-link.active { background-color: var(--color-primary); color: white; font-weight: 600; }
        .sidebar-link:not(.active):hover { background-color: #f1f5f9; }
        .dark .sidebar-link:not(.active):hover { background-color: var(--color-border-dark); }

        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); opacity: 0; transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); z-index: 1050; }
        .toast.show { opacity: 1; bottom: 40px; }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1040; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box { background-color: var(--color-card-light); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .dark .modal-box { background-color: var(--color-card-dark); }
        .modal-overlay.visible .modal-box { transform: scale(1); }

        /* DRY: Stili unificati per accordion */
        .collapsible-header { cursor: pointer; transition: background-color 0.2s; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-header.open + .collapsible-content { max-height: 5000px; /* Valore alto per contenere tutto */ }
        .collapsible-icon { transition: transform 0.3s; }
        .collapsible-header.open .collapsible-icon { transform: rotate(180deg); }

        /* Form */
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; }
        .form-input, .form-select, .form-textarea { background-color: var(--color-card-light); border: 1px solid var(--color-border-light); transition: all 0.2s; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .dark .form-input, .dark .form-select, .dark .form-textarea { background-color: #1f2937; border-color: var(--color-border-dark); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); border-color: var(--color-primary); outline: none; }

        /* Bottoni */
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; cursor: pointer; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; }
        .dark .btn-secondary { background-color: #334155; color: #f1f5f9; }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }

        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">

    <div id="app-container">
        <aside id="sidebar" class="bg-white dark:bg-slate-800/95 backdrop-blur-sm border-r border-slate-200 dark:border-slate-700 flex flex-col">
            <div class="h-16 flex items-center justify-center px-6 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                <img src="https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp" alt="Logo CHRYSAS" class="h-8">
            </div>
            <nav id="sidebar-nav" class="flex-grow px-4 py-6 overflow-y-auto"></nav>
        </aside>
        
        <div id="sidebar-overlay"></div>

        <div id="main-container" class="relative w-full">
            <header class="h-16 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Toggle Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h1 id="page-title" class="text-xl font-bold"></h1>
                </div>
                <div class="flex items-center gap-6">
                    <div id="weather-widget" class="hidden lg:flex items-center gap-3 text-sm text-slate-600 dark:text-slate-300"></div>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" aria-label="Toggle dark mode">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="text-right hidden sm:block"><p id="current-date" class="text-sm text-slate-500 dark:text-slate-400"></p></div>
                </div>
            </header>
            
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6 lg:p-8"></main>
        </div>
    </div>

    <div id="toast-container"></div>
    <div id="modal-container"></div>

    <script type="module">
        // --- IMPORT DEI MODULI FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, addDoc, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // =================================================================================
        // --- 1. CONFIGURAZIONE E STATO GLOBALE ---
        // =================================================================================
        
        const Config = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            firebaseConfig: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Inserisci qui la tua config di fallback */ },
            TABS: [
                 { id: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>' },
                 { id: 'lista-pca', label: 'Lista Controlli', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>' },
                 { id: 'nuovo-pca', label: 'Nuovo PCA', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' },
                 { id: 'nuovo-sopralluogo', label: 'Verbale Sopralluogo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>' },
                 { id: 'impostazioni', label: 'Impostazioni', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>' }
            ],
            WBS_DATA: { 'GA': { descrizione: 'Gallerie Artificiali', lavorazioni: ['Scavo di sbancamento', 'Posa armature e getti CLS', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti'] }, 'GN': { descrizione: 'Gallerie Naturali', lavorazioni: ['Scavo in naturale', 'Consolidamenti (spritz-beton, centine)', 'Rivestimenti e impermeabilizzazioni'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti', 'Vibrazioni'] }, 'AS': { descrizione: 'Aree di Stoccaggio', lavorazioni: ['Scavi e rivestimenti', 'Opere di sostegno e drenaggi'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Consumi'] }, 'TR': { descrizione: 'Trincee', lavorazioni: ['Scavi di trincea', 'Opere di sostegno (pali, diaframmi)', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Beni Culturali'] }, 'RI': { descrizione: 'Rilevati', lavorazioni: ['Formazione corpo del rilevato', 'Opere di sostegno', 'Sistemazioni idrauliche'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'VI': { descrizione: 'Viadotti', lavorazioni: ['Pali di fondazione e fondazioni', 'Elevazione pile e spalle', 'Varo impalcato e soletta'], aspetti: ['Rumore', 'Vibrazioni', 'Rifiuti', 'Sostanze Pericolose'] }, 'CB': { descrizione: 'Campo Base', lavorazioni: ['Installazione e gestione uffici/dormitori/mensa', 'Manutenzione aree e servizi'], aspetti: ['Acque', 'Rifiuti', 'Rumore', 'Consumi'] }, 'CO': { descrizione: 'Cantiere Operativo', lavorazioni: ['Allestimento aree stoccaggio', 'Gestione impianto di betonaggio', 'Officina e manutenzione mezzi'], aspetti: ['Polveri', 'Rumore', 'Acque', 'Rifiuti', 'Sostanze Pericolose'] }, 'NV': { descrizione: 'Nuova Viabilità', lavorazioni: ['Scavi e rilevati per nuova viabilità', 'Formazione sottofondi e pavimentazioni', 'Opere idrauliche e finiture'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'FA': { descrizione: 'Fabbricati', lavorazioni: ['Scavi e fondazioni', 'Elevazione strutture', 'Finiture e impianti'], aspetti: ['Polveri', 'Rumore', 'Rifiuti', 'Consumi'] } },
            CHECK_TEMPLATES_PERIODIC: [ { id: "pca01", title: "PCA 01: Scarichi Idrici ed Approvvigionamento", icon: "💧", significativita: "ALTA", items: ["Autorizzazione allo scarico acque reflue domestiche presente e valida?", "Autorizzazione allo scarico acque reflue industriali presente e valida?", "Rispetto delle prescrizioni contenute nelle autorizzazioni?", "Corretta gestione acque di lavorazione (es. scavo pali)?", "Kit di emergenza anti-sversamento presente e completo?", "Manutenzione impianti di depurazione/trattamento registrata?"] }, { id: "pca02", title: "PCA 02: Terre e Rocce da Scavo", icon: "⛰️", significativita: "ALTA", items: ["Aree di stoccaggio temporaneo identificate e conformi al PUT?", "Separazione dei cumuli per categorie omogenee?", "Documento di Trasporto (DDT) per le terre conforme e presente?", "Copertura dei cassoni dei mezzi in transito?"] }, { id: "pca03", title: "PCA 03: Emissioni in Atmosfera", icon: "💨", significativita: "ALTA", items: ["Autorizzazioni per impianti (es. calcestruzzo) presenti e valide?", "Copertura mezzi per trasporto materiali polverulenti?", "Bagnatura piste e/o cumuli eseguita regolarmente?", "Velocità dei mezzi in cantiere limitata a 30 km/h?", "Impianto lavaruote funzionante ed utilizzato?"] }, { id: "pca04", title: "PCA 04: Rifiuti", icon: "🗑️", significativita: "ALTA", items: ["Deposito temporaneo (DTR) ordinato e pulito?", "Rifiuti separati per CER e con corretta cartellonistica?", "Stoccaggio rifiuti pericolosi conforme (aree, bacini)?", "Registro di carico/scarico aggiornato (entro 10gg)?", "Quarta copia FIR ricevuta entro 90 giorni?"] }, { id: "pca05", title: "PCA 05: Sostanze Pericolose ed Emergenze", icon: "☣️", significativita: "MEDIA", items: ["Schede di Sicurezza (SDS) disponibili e aggiornate?", "Stoccaggio sostanze su bacini di contenimento idonei?", "Aree di stoccaggio segnalate e adeguate?", "Personale formato per la gestione delle emergenze?"] }, { id: "pca06", title: "PCA 06: Rumore e Vibrazioni", icon: "🔊", significativita: "MEDIA", items: ["Autorizzazione in deroga per rumore presente (se necessaria)?", "Rispetto degli orari di lavoro previsti?", "Barriere acustiche (se previste) integre ed efficaci?", "Manutenzione ordinaria dei mezzi per ridurre il rumore?", "Eseguita misurazione fonometrica periodica?"] }, { id: "pca07", title: "PCA 07: Suolo e Sottosuolo", icon: "🌱", significativita: "ALTA", items: ["Assenza di contaminazioni visive del suolo (macchie, sversamenti)?", "Corretto stoccaggio del terreno vegetale in cumuli separati?", "Utilizzo delle apposite vasche per lavaggio betoniere?", "Gestione corretta del calcestruzzo in esubero?"] }, { id: "pca08", title: "PCA 08: Beni Culturali e Archeologici", icon: "🏺", significativita: "ALTA", items: ["Presenza di archeologo durante le attività di scavo?", "Notifica agli enti competenti in caso di ritrovamento?", "Corretta gestione e inventario dei reperti?", "Disboscamento limitato alle aree strettamente necessarie?"] } ],
            ASPETTO_TO_PCA_ID_MAP: { 'Polveri': 'pca03', 'Rumore': 'pca06', 'Vibrazioni': 'pca06', 'Acque': 'pca01', 'Suolo': 'pca07', 'Rifiuti': 'pca04', 'Terre e Rocce': 'pca02', 'Sostanze Pericolose': 'pca05', 'Rifornimenti': 'pca05', 'Consumi': 'pca05', 'Beni Culturali': 'pca08' },
            FREQUENCY_MAP: { 'ALTA': { text: 'Settimanale', days: 7 }, 'MEDIA': { text: 'Quindicinale', days: 15 }, 'BASSA': { text: 'Mensile', days: 30 } },
            WEATHER_CODE_MAP: { 0: {text:'Sereno', icon:'☀️'}, 1: {text:'Prevalentemente sereno', icon:'🌤️'}, 2: {text:'Parzialmente nuvoloso', icon:'⛅️'}, 3: {text:'Nuvoloso', icon:'☁️'}, 45: {text:'Nebbia', icon:'🌫️'}, 48: {text:'Nebbia con brina', icon:'🌫️'}, 51: {text:'Pioggerella leggera', icon:'🌦️'}, 53: {text:'Pioggerella moderata', icon:'🌦️'}, 55: {text:'Pioggerella forte', icon:'🌦️'}, 61: {text:'Pioggia leggera', icon:'🌧️'}, 63: {text:'Pioggia moderata', icon:'🌧️'}, 65: {text:'Pioggia forte', icon:'🌧️'}, 71: {text:'Nevicata leggera', icon:'❄️'}, 73: {text:'Nevicata moderata', icon:'❄️'}, 75: {text:'Nevicata forte', icon:'❄️'}, 80: {text:'Rovescio leggero', icon:'🌧️'}, 81: {text:'Rovescio moderato', icon:'🌧️'}, 82: {text:'Rovescio violento', icon:'🌧️'}, 95: {text:'Temporale', icon:'⛈️'}, 96: {text:'Temporale con grandine', icon:'⛈️'} }
        };

        const AppState = {
            user: null,
            isAuthReady: false,
            reports: [],
            activeView: 'dashboard',
            sidebarOpen: localStorage.getItem('sidebarOpen') !== 'false',
            currentWeather: null,
            currentPosition: null,
            activeChart: null,
            isSaving: false,
            tempPhotos: {}
        };
        
        // =================================================================================
        // --- 2. MODULI DI SERVIZIO (Logica "invisibile") ---
        // =================================================================================

        /**
         * PubSub: un semplice sistema per far comunicare i moduli tra loro.
         * Esempio: un modulo "pubblica" un evento come 'reportsChanged', 
         * e altri moduli "sottoscrivono" quell'evento per reagire.
         */
        const PubSub = {
            events: {},
            subscribe(eventName, fn) {
                this.events[eventName] = this.events[eventName] || [];
                this.events[eventName].push(fn);
            },
            publish(eventName, data) {
                if (this.events[eventName]) {
                    this.events[eventName].forEach(fn => fn(data));
                }
            }
        };

        /**
         * FirebaseService: gestisce tutta la comunicazione con Firebase.
         * Isolare questa logica rende il resto dell'app indipendente da Firebase.
         */
        const FirebaseService = {
            init() {
                try {
                    this.app = initializeApp(Config.firebaseConfig);
                    this.auth = getAuth(this.app);
                    this.db = getFirestore(this.app);
                    this.storage = getStorage(this.app);
                    console.log("✅ Firebase inizializzato.");
                    return true;
                } catch (e) {
                    console.error("🔥 Errore Inizializzazione Firebase:", e);
                    alert("Impossibile connettersi al database. L'applicazione non può funzionare correttamente.");
                    return false;
                }
            },

            handleAuth() {
                onAuthStateChanged(this.auth, (user) => {
                    if (user) {
                        AppState.user = user;
                        PubSub.publish('authReady');
                    } else {
                        signInAnonymously(this.auth).catch(err => console.error("🔥 Errore login anonimo:", err));
                    }
                });
            },
            
            getReportsPath() {
                return `/artifacts/${Config.appId}/users/${AppState.user.uid}/reports`;
            },

            listenToReports() {
                const q = query(collection(this.db, this.getReportsPath()));
                onSnapshot(q, (snapshot) => {
                    const reports = snapshot.docs.map(d => {
                        const data = d.data();
                        // Converte il timestamp di Firebase in una stringa di data ISO
                        if (data.date?.toDate) data.date = data.date.toDate().toISOString().slice(0, 10);
                        return { docId: d.id, ...data };
                    });
                    AppState.reports = reports;
                    PubSub.publish('reportsChanged', reports);
                }, (error) => {
                    console.error("🔥 Errore listener report:", error);
                    UI.toast.show("Errore di sincronizzazione dati.", "error");
                });
            },

            async saveReport(reportData) {
                const reportToSave = { ...reportData };
                if(reportToSave.date) reportToSave.date = new Date(reportToSave.date);
                const docId = reportToSave.docId;
                delete reportToSave.docId;

                if (docId) {
                    await setDoc(doc(this.db, this.getReportsPath(), docId), reportToSave, { merge: true });
                    return docId;
                } else {
                    const docRef = await addDoc(collection(this.db, this.getReportsPath()), reportToSave);
                    return docRef.id;
                }
            },

            async deleteReport(report) {
                if (!report?.docId) return;

                // Elimina le foto associate
                if (report.photos) {
                    const photoUrls = Object.values(report.photos).flat();
                    const deletePromises = photoUrls.map(url => {
                        try {
                           if (url.startsWith('gs://') || url.startsWith('https://firebasestorage.googleapis.com')) {
                               return deleteObject(ref(this.storage, url));
                           }
                        } catch (err) {
                           if (err.code !== 'storage/object-not-found') console.warn("Impossibile eliminare foto:", err);
                        }
                        return Promise.resolve(); // Ignora errori o URL non validi
                    });
                    await Promise.all(deletePromises);
                }
                // Elimina il documento
                await deleteDoc(doc(this.db, this.getReportsPath(), report.docId));
            },

            async uploadPhoto(base64, reportDocId, photoKey) {
                const photoPath = `artifacts/${Config.appId}/users/${AppState.user.uid}/${reportDocId}/${photoKey}-${Date.now()}.jpg`;
                const storageRef = ref(this.storage, photoPath);
                await uploadString(storageRef, base64, 'data_url');
                return getDownloadURL(storageRef);
            }
        };

        // =================================================================================
        // --- 3. MODULO UI (Gestione Interfaccia Utente) ---
        // =================================================================================

        const UI = {
            dom: {},

            init() {
                // Raccoglie tutti gli elementi del DOM in un unico posto per un accesso facile
                this.dom = {
                    appContainer: document.getElementById('app-container'),
                    sidebar: document.getElementById('sidebar'),
                    sidebarOverlay: document.getElementById('sidebar-overlay'),
                    sidebarNav: document.getElementById('sidebar-nav'),
                    mainContent: document.getElementById('main-content'),
                    pageTitle: document.getElementById('page-title'),
                    currentDate: document.getElementById('current-date'),
                    toastContainer: document.getElementById('toast-container'),
                    modalContainer: document.getElementById('modal-container'),
                    sidebarToggleBtn: document.getElementById('sidebar-toggle-btn'),
                    weatherWidget: document.getElementById('weather-widget'),
                    theme: {
                        toggleBtn: document.getElementById('theme-toggle'),
                        darkIcon: document.getElementById('theme-toggle-dark-icon'),
                        lightIcon: document.getElementById('theme-toggle-light-icon')
                    }
                };
                this.initListeners();
                this.theme.init();
                this.sidebar.init();
                this.updateDate();
                this.renderSidebarMenu();
            },

            initListeners() {
                this.dom.theme.toggleBtn.addEventListener('click', () => this.theme.toggle());
                this.dom.sidebarToggleBtn.addEventListener('click', () => this.sidebar.toggle());
                this.dom.sidebarOverlay.addEventListener('click', () => this.sidebar.close());
                this.dom.sidebarNav.addEventListener('click', (e) => {
                    if (e.target.closest('a') && window.innerWidth < 1024) {
                        this.sidebar.close();
                    }
                });
                
                // Event Delegation per gli accordion
                this.dom.mainContent.addEventListener('click', e => {
                    const header = e.target.closest('.collapsible-header');
                    if (header) {
                         header.classList.toggle('open');
                    }
                });
            },

            renderView(viewId, content) {
                this.dom.mainContent.innerHTML = '';
                this.dom.mainContent.appendChild(content);
                this.dom.pageTitle.textContent = Config.TABS.find(t => t.id === viewId)?.label || 'Dashboard';
                this.dom.sidebarNav.querySelectorAll('a').forEach(a => {
                    a.classList.toggle('active', a.hash === `#${viewId}`);
                });
                window.scrollTo(0, 0);
            },
            
            renderSidebarMenu() {
                 this.dom.sidebarNav.innerHTML = Config.TABS.map(t => 
                    `<a href="#${t.id}" class="sidebar-link flex items-center gap-3 px-4 py-3 mt-2 text-slate-600 dark:text-slate-300 rounded-md">${t.icon} <span>${t.label}</span></a>`
                ).join('');
            },

            updateDate() {
                this.dom.currentDate.textContent = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            },

            updateWeather(weatherData) {
                 if (!weatherData) {
                    this.dom.weatherWidget.innerHTML = `<span>N/D</span>`;
                    return;
                }
                const weatherInfo = Config.WEATHER_CODE_MAP[weatherData.weather_code] || {text: 'Sconosciuto', icon: '❓'};
                this.dom.weatherWidget.innerHTML = `<span title="${weatherInfo.text}" class="text-xl">${weatherInfo.icon}</span> <span class="font-semibold">${weatherData.temperature_2m}°C</span>`;
            },
            
            // Sotto-modulo per la gestione del tema
            theme: {
                init() { this.apply(localStorage.getItem('theme') === 'dark'); },
                apply(isDark) {
                    document.documentElement.classList.toggle('dark', isDark);
                    UI.dom.theme.darkIcon.classList.toggle('hidden', !isDark);
                    UI.dom.theme.lightIcon.classList.toggle('hidden', isDark);
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                },
                toggle() { this.apply(!document.documentElement.classList.contains('dark')); }
            },

            // Sotto-modulo per la gestione della sidebar
            sidebar: {
                init() { this.set(AppState.sidebarOpen); },
                set(isOpen) {
                    AppState.sidebarOpen = isOpen;
                    localStorage.setItem('sidebarOpen', isOpen);
                    const isMobile = window.innerWidth < 1024;
                    if (isMobile) {
                        UI.dom.appContainer.classList.toggle('sidebar-open', isOpen);
                        UI.dom.sidebarOverlay.classList.toggle('visible', isOpen);
                    } else {
                        UI.dom.appContainer.classList.toggle('sidebar-collapsed', !isOpen);
                    }
                },
                toggle() { this.set(!AppState.sidebarOpen); },
                close() { this.set(false); }
            },

            // Sotto-modulo per i toast (notifiche a comparsa)
            toast: {
                show(message, type = 'success') {
                    const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                    const toastEl = Utils.dom.create(`<div class="toast px-6 py-3 rounded-lg text-white font-medium shadow-lg ${colors[type]}">${message}</div>`);
                    UI.dom.toastContainer.appendChild(toastEl);
                    setTimeout(() => toastEl.classList.add('show'), 10);
                    setTimeout(() => {
                        toastEl.classList.remove('show');
                        toastEl.addEventListener('transitionend', () => toastEl.remove());
                    }, 4000);
                }
            },
            
            // Sotto-modulo per i modal (finestre di conferma)
            modal: {
                show({ title, message, confirmText = 'Conferma', cancelText = 'Annulla', confirmColor = 'btn-danger' }) {
                    return new Promise((resolve) => {
                        const modalOverlay = Utils.dom.create(`
                            <div class="modal-overlay">
                                <div class="modal-box">
                                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                                    <p class="text-slate-600 dark:text-slate-300 mb-6">${message}</p>
                                    <div class="flex justify-end gap-4">
                                        <button class="cancel-btn btn btn-secondary">${cancelText}</button>
                                        <button class="confirm-btn btn ${confirmColor}">${confirmText}</button>
                                    </div>
                                </div>
                            </div>`);

                        const closeModal = (decision) => {
                            modalOverlay.classList.remove('visible');
                            modalOverlay.addEventListener('transitionend', () => {
                                modalOverlay.remove();
                                resolve(decision);
                            });
                        };

                        modalOverlay.querySelector('.confirm-btn').onclick = () => closeModal(true);
                        modalOverlay.querySelector('.cancel-btn').onclick = () => closeModal(false);
                        modalOverlay.onclick = (e) => { if (e.target === modalOverlay) closeModal(false); };
                        
                        UI.dom.modalContainer.appendChild(modalOverlay);
                        setTimeout(() => modalOverlay.classList.add('visible'), 10);
                    });
                }
            }
        };
        
        // =================================================================================
        // --- 4. VIEWS (Le "Pagine" dell'Applicazione) ---
        // =================================================================================

        const DashboardView = {
            render() {
                const container = Utils.dom.create(`<div class="content-fade-in"></div>`);
                
                // Calcolo statistiche
                const stats = this.calculateStats(AppState.reports);
                
                const greeting = Utils.getGreeting();
                
                container.innerHTML = `
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold">${greeting}!</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">Riepilogo della situazione attuale.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-blue-500"><h3>Controlli Totali</h3><p class="text-3xl font-semibold">${stats.totalPca}</p></div>
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-red-500"><h3>NC Aperte</h3><p class="text-3xl font-semibold">${stats.openNc}</p></div>
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-green-500"><h3>Conformità</h3><p class="text-3xl font-semibold">${stats.avgCompliance}</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                        <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm" id="ncChartContainer">
                            <h3 class="text-lg font-semibold mb-4">Non Conformità per Aspetto</h3>
                            <div class="relative h-96"><canvas id="ncChart"></canvas></div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                            <h3 class="text-lg font-semibold mb-4">PCA da Compilare</h3>
                            <div id="due-list-container" class="space-y-2"></div>
                        </div>
                    </div>
                `;

                // Renderizza il grafico
                this.renderChart(container.querySelector('#ncChart'), container.querySelector('#ncChartContainer'), stats.ncByAspect);

                // Renderizza la lista delle scadenze
                this.renderDueList(container.querySelector('#due-list-container'));

                return container;
            },

            calculateStats(reports) {
                let openNc = 0, totalChecks = 0, compliantChecks = 0;
                const ncByAspect = {};
                reports.forEach(r => {
                    if (r?.type === 'periodico' && r.checks) {
                        Object.entries(r.checks).forEach(([aspectId, checks]) => {
                            const template = Config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === aspectId);
                            if (!template || !checks) return;
                            (checks || []).forEach(c => {
                                if (c?.result && c.result !== 'NA') {
                                    totalChecks++;
                                    if (c.result === 'C') compliantChecks++;
                                    if (c.result === 'NC') {
                                        openNc++;
                                        ncByAspect[template.title] = (ncByAspect[template.title] || 0) + 1;
                                    }
                                }
                            });
                        });
                    }
                });
                const avgCompliance = totalChecks > 0 ? `${((compliantChecks / totalChecks) * 100).toFixed(0)}%` : 'N.D.';
                return { totalPca: reports.length, openNc, avgCompliance, ncByAspect };
            },

            renderChart(canvas, container, ncData) {
                if (AppState.activeChart) AppState.activeChart.destroy();
                
                if (canvas && Object.keys(ncData).length > 0) {
                    AppState.activeChart = new Chart(canvas.getContext('2d'), { 
                        type: 'bar', 
                        data: { 
                            labels: Object.keys(ncData), 
                            datasets: [{ data: Object.values(ncData), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 }] 
                        }, 
                        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false }} } 
                    });
                } else {
                    container.innerHTML = `<h3 class="text-lg font-semibold mb-4">Non Conformità per Aspetto</h3><div class="flex items-center justify-center h-full text-center text-slate-500 dark:text-slate-400 mt-16"><p>Nessuna non conformità registrata. Ottimo lavoro! 👍</p></div>`;
                }
            },

            renderDueList(container) {
                const dueList = Utils.getFrequencyStatuses();
                if (dueList.length > 0) {
                    container.innerHTML = dueList.map(item => 
                        `<li class="p-3 rounded-lg bg-slate-100 dark:bg-slate-700/50 list-none"><p class="font-semibold">${item.template.title}</p><p class="text-sm text-red-500">${item.status}</p></li>`
                    ).join('');
                } else {
                    container.innerHTML = `<p class="text-slate-500 dark:text-slate-400">Tutti i controlli periodici sono aggiornati.</p>`;
                }
            }
        };

        const ReportListView = {
            render() {
                const reports = [...AppState.reports].sort((a, b) => (b.id || 0) - (a.id || 0));
                
                if (reports.length === 0) {
                    return Utils.dom.create(`<div class="text-center p-8 bg-white dark:bg-slate-800 rounded-lg"><h3 class="text-xl font-semibold">Nessun controllo trovato.</h3><a href="#nuovo-pca" class="btn btn-primary mt-4">Crea il primo controllo</a></div>`);
                }

                const groupedReports = this.groupReports(reports);
                const sortedWbsKeys = this.sortGroups(Object.keys(groupedReports));

                const view = Utils.dom.create(`<div class="space-y-6"></div>`);
                sortedWbsKeys.forEach(wbsKey => {
                    const groupReports = groupedReports[wbsKey];
                    const wbsInfo = Config.WBS_DATA[wbsKey] || { descrizione: 'Verbali di Sopralluogo' };
                    
                    const groupContainer = Utils.dom.create(`
                        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm overflow-hidden">
                            <div class="collapsible-header p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100">
                                <h3 class="text-lg font-semibold">${wbsInfo.descrizione} (${groupReports.length})</h3>
                                <svg class="collapsible-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="collapsible-content">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-slate-100 dark:bg-slate-800"><tr>${['ID','Data','Tipo','Oggetto/Lavorazione', 'Azioni'].map(h=>`<th class="p-3 text-left text-xs uppercase">${h}</th>`).join('')}</tr></thead>
                                        <tbody class="report-list-tbody divide-y divide-slate-200 dark:divide-slate-700">
                                            ${this.renderTableRows(groupReports)}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`);
                    view.appendChild(groupContainer);
                });
                
                // EVENT DELEGATION: un solo listener per tutta la tabella
                view.addEventListener('click', async (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    if(deleteBtn) {
                        const reportId = deleteBtn.dataset.reportId;
                        const report = AppState.reports.find(r => r.docId === reportId);
                        if(report) {
                            const confirmed = await UI.modal.show({ title: 'Conferma Eliminazione', message: `Sei sicuro di voler eliminare il report N° ${report.id}? L'azione è irreversibile.`, confirmColor: 'btn-danger'});
                            if (confirmed) {
                                UI.toast.show('Eliminazione in corso...', 'info');
                                try {
                                    await FirebaseService.deleteReport(report);
                                    UI.toast.show('Report eliminato!', 'success');
                                } catch (err) {
                                    UI.toast.show('Errore durante l\'eliminazione.', 'error');
                                    console.error(err);
                                }
                            }
                        }
                    }
                    const printBtn = e.target.closest('.print-btn');
                    if(printBtn) {
                        // Logica di stampa da implementare
                        UI.toast.show('Funzione di stampa in preparazione.', 'info');
                    }
                });

                return view;
            },

            groupReports(reports) {
                 return reports.reduce((acc, report) => {
                    if (!report) return acc;
                    const key = report.type === 'sopralluogo' ? 'SOPRALLUOGHI' : (report.wbs?.substring(0, 2).toUpperCase() || 'GENERICO');
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(report);
                    return acc;
                }, {});
            },
            
            sortGroups(keys) {
                const wbsOrder = ['SOPRALLUOGHI', ...Object.keys(Config.WBS_DATA), 'GENERICO'];
                return keys.sort((a, b) => wbsOrder.indexOf(a) - wbsOrder.indexOf(b));
            },

            renderTableRows(reports) {
                const typeLabels={'periodico':'Periodico','preliminare':'Preliminare','finale':'Finale', 'sopralluogo': 'Sopralluogo'};
                return reports.map(r => `
                    <tr>
                        <td class="p-3 font-medium">${r.id}</td>
                        <td class="p-3">${r.date}</td>
                        <td class="p-3">${typeLabels[r.type]||'N.D.'}</td>
                        <td class="p-3 max-w-xs truncate">${Utils.sanitize(r.activities||r.observations?.sopralluogo||'N.A.')}</td>
                        <td class="p-3"><div class="flex gap-4">
                            <button class="print-btn text-slate-500 hover:text-blue-600" title="Stampa" data-report-id="${r.docId}"><svg class="w-5 h-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button>
                            <button class="delete-btn text-slate-500 hover:text-red-600" title="Elimina" data-report-id="${r.docId}"><svg class="w-5 h-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div></td>
                    </tr>`
                ).join('');
            }
        };

        const FormView = {
            render(type = 'pca') {
                AppState.tempPhotos = {}; // Resetta le foto temporanee
                const form = Utils.dom.create('<form novalidate class="space-y-8"></form>');
                form.id = type === 'pca' ? 'new-pca-form' : 'new-sopralluogo-form';
                
                const nextId = (AppState.reports.reduce((max, r) => Math.max(max, r.id || 0), 0) || 0) + 1;
                const today = new Date().toISOString().slice(0,10);

                if (type === 'pca') {
                    form.appendChild(this.createPcaFormBody(nextId, today));
                } else {
                    form.appendChild(this.createSopralluogoFormBody(nextId, today));
                    this.fetchGeoWeather();
                }

                this.attachFormListeners(form);
                return form;
            },

            createPcaFormBody: (nextId, today) => {
                const fragment = document.createDocumentFragment();
                // Dati Generali
                fragment.appendChild(Utils.dom.create(`
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b pb-4">Dati Generali</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="form-label">Verbale N°</label><input type="number" name="id" value="${nextId}" required class="form-input"></div>
                            <div><label class="form-label">Data</label><input type="date" name="date" value="${today}" required class="form-input"></div>
                            <div class="md:col-span-2"><label class="form-label">Compilatore</label><input type="text" name="inspector" class="form-input" required></div>
                        </div>
                    </div>`));
                
                // WBS e Lavorazioni
                 fragment.appendChild(Utils.dom.create(`
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b pb-4">Area di Lavoro (WBS)</h2>
                        <div id="wbs-section" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label class="form-label">Codice WBS</label><input type="text" name="wbs-input" placeholder="Es. RI12, GA01..." class="form-input" required></div>
                            <div><label class="form-label">Lavorazione</label><select name="lavorazione" disabled class="form-select" required><option value="">-- Prima inserisci WBS --</option></select></div>
                       </div>
                    </div>`));

                // Checklists
                const checklistsContainer = Utils.dom.create(
                    `<div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-6 border-b pb-4">Checklist di Controllo</h2>
                        <div id="checklists-wrapper" class="space-y-4">
                           <p class="text-slate-500">Inserisci un codice WBS valido per visualizzare le checklist pertinenti.</p>
                        </div>
                    </div>`);
                const checklistInnerContainer = checklistsContainer.querySelector('#checklists-wrapper');
                
                let checkListHtml = '';
                Config.CHECK_TEMPLATES_PERIODIC.forEach(template => {
                    checkListHtml += `
                        <div class="pca-sheet-accordion hidden" data-template-id="${template.id}">
                            <div class="collapsible-header p-4 flex justify-between items-center border rounded-t-lg">
                                <h3 class="text-lg font-semibold flex items-center gap-3">${template.icon} ${template.title}</h3>
                                <svg class="collapsible-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="collapsible-content border border-t-0 rounded-b-lg">
                                <div class="p-4 space-y-3 divide-y dark:divide-slate-700">
                                ${template.items.map((item, idx) => `
                                    <div class="pt-4 first:pt-0" data-item-index="${idx}">
                                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                                            <label class="mr-4 text-sm flex-1">${Utils.sanitize(item)}</label>
                                            <div class="flex items-center gap-x-5 text-sm flex-shrink-0">
                                                ${['C', 'NC', 'NA'].map(val => `<div><input id="check_${template.id}_${idx}_${val}" name="check_${template.id}_${idx}" type="radio" value="${val}" class="form-checkbox" ${val==='C'?'checked':''}> <label for="check_${template.id}_${idx}_${val}" class="ml-2">${val==='C'?'Conf.':(val==='NC'?'Non Conf.':'N.A.')}</label></div>`).join('')}
                                            </div>
                                        </div>
                                        <div class="extra-content-wrapper space-y-2">
                                            <textarea name="notes_${template.id}_${idx}" class="form-textarea mt-2 text-sm" placeholder="Note / Azioni Correttive..."></textarea>
                                            <div class="photo-upload-container" data-photo-key="photo_${template.id}_${idx}"></div>
                                        </div>
                                    </div>`).join('')}
                                </div>
                            </div>
                        </div>`;
                });
                checklistInnerContainer.innerHTML = checkListHtml; // Aggiunge tutte le checklist, ma nascoste
                fragment.appendChild(checklistsContainer);

                // Pulsanti
                fragment.appendChild(Utils.dom.create(`
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="submit" class="btn btn-primary">Salva Controllo</button>
                    </div>`));

                return fragment;
            },

            createSopralluogoFormBody: (nextId, today) => { /* ... Logica simile, omessa per brevità ... */ return Utils.dom.create('<div>Form sopralluogo</div>') },
            
            fetchGeoWeather(){ /* ... Logica simile, omessa per brevità ... */ },

            attachFormListeners(form) {
                form.addEventListener('submit', this.onFormSubmit);
                
                const wbsInput = form.querySelector('input[name="wbs-input"]');
                if (wbsInput) {
                    wbsInput.addEventListener('input', e => {
                        const wbsCode = e.target.value.toUpperCase().substring(0, 2);
                        const wbsData = Config.WBS_DATA[wbsCode];
                        const lavorazioneSelect = form.querySelector('select[name="lavorazione"]');
                        const checklistsWrapper = form.querySelector('#checklists-wrapper');

                        // Reset
                        lavorazioneSelect.innerHTML = '<option value="">-- Seleziona lavorazione --</option>';
                        lavorazioneSelect.disabled = true;
                        checklistsWrapper.querySelectorAll('.pca-sheet-accordion').forEach(el => el.classList.add('hidden'));

                        if (wbsData) {
                            wbsData.lavorazioni.forEach(lav => lavorazioneSelect.add(new Option(lav, lav)));
                            lavorazioneSelect.disabled = false;
                            
                            const requiredPcaIds = new Set(wbsData.aspetti.map(a => Config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                            
                            checklistsWrapper.querySelectorAll('.pca-sheet-accordion').forEach(accordionEl => {
                                if (requiredPcaIds.has(accordionEl.dataset.templateId)) {
                                    accordionEl.classList.remove('hidden');
                                }
                            });
                        }
                    });
                }
                
                form.addEventListener('change', e => {
                     // Logica per mostrare campi extra quando si seleziona "Non Conforme"
                     if (e.target.type === 'radio' && e.target.value === 'NC') {
                         const extra = e.target.closest('[data-item-index]').querySelector('.extra-content-wrapper');
                         if(extra) extra.classList.add('visible');
                     } else if (e.target.type === 'radio' && e.target.value !== 'NC') {
                         const extra = e.target.closest('[data-item-index]').querySelector('.extra-content-wrapper');
                         if(extra) extra.classList.remove('visible');
                     }
                });
            },

            async onFormSubmit(event) {
                event.preventDefault();
                if (AppState.isSaving) return;
                const form = event.target;
                if(!form.checkValidity()) {
                    UI.toast.show('Per favore, compila tutti i campi obbligatori.', 'error');
                    form.reportValidity();
                    return;
                }

                const saveBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = saveBtn.innerHTML;
                
                AppState.isSaving = true;
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<div class="loader"></div><span>Salvataggio...</span>`;
                
                try {
                    const formData = new FormData(form);
                    const isPca = form.id === 'new-pca-form';
                    
                    let newReport = {
                        id: parseInt(formData.get('id')),
                        date: Utils.sanitize(formData.get('date')),
                        inspector: Utils.sanitize(formData.get('inspector')),
                        wbs: Utils.sanitize(formData.get('wbs-input') || formData.get('wbs')),
                        type: isPca ? 'periodico' : 'sopralluogo',
                        photos: {}, // Verrà popolato dopo
                    };

                    if (isPca) {
                        newReport.activities = Utils.sanitize(formData.get('lavorazione'));
                        newReport.checks = {};
                        form.querySelectorAll('.pca-sheet-accordion:not(.hidden)').forEach(accordion => {
                            const templateId = accordion.dataset.templateId;
                            const template = Config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === templateId);
                            if (!template) return;
                            
                            newReport.checks[templateId] = template.items.map((item, idx) => ({
                                item,
                                result: formData.get(`check_${templateId}_${idx}`),
                                notes: Utils.sanitize(formData.get(`notes_${templateId}_${idx}`)) || null,
                            }));
                        });
                    } else { /* ... logica per sopralluogo ... */ }

                    const docId = await FirebaseService.saveReport(newReport);
                    
                    // Gestione foto (se presenti)
                    // ... logica foto ...

                    UI.toast.show(`Report N° ${newReport.id} salvato con successo.`, 'success');
                    Router.navigate('lista-pca');

                } catch (error) {
                    console.error("🔥 Errore salvataggio:", error);
                    UI.toast.show("Errore durante il salvataggio.", "error");
                } finally {
                    AppState.isSaving = false;
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalBtnText;
                }
            }
        };

        const SettingsView = { /* ... La logica delle impostazioni può essere inserita qui ... */ 
            render(){ return Utils.dom.create('<div>Impostazioni</div>'); } 
        };
        
        // =================================================================================
        // --- 5. UTILS (Funzioni di Supporto) ---
        // =================================================================================
        
        const Utils = {
            dom: {
                create(htmlString) {
                    const template = document.createElement('template');
                    template.innerHTML = htmlString.trim();
                    return template.content.firstChild;
                }
            },
            sanitize(str) {
                const temp = document.createElement('div');
                temp.textContent = str || "";
                return temp.innerHTML;
            },
            getGreeting() {
                const hour = new Date().getHours();
                if (hour < 12) return 'Buongiorno';
                if (hour < 18) return 'Buon pomeriggio';
                return 'Buonasera';
            },
            getFrequencyStatuses() {
                 const dueList = [];
                const now = new Date();
                const latestPcaReports = {};
                AppState.reports
                    .filter(r => r.type === 'periodico' && r.checks)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(report => {
                        Object.keys(report.checks).forEach(pcaId => {
                            if (!latestPcaReports[pcaId]) {
                                latestPcaReports[pcaId] = report;
                            }
                        });
                    });
                
                Config.CHECK_TEMPLATES_PERIODIC.forEach(template => {
                    const lastReport = latestPcaReports[template.id];
                    const frequency = Config.FREQUENCY_MAP[template.significativita];
                    if (!frequency) return;
                    if (lastReport) {
                        const lastDate = new Date(lastReport.date);
                        const dueDate = new Date(lastDate.setDate(lastDate.getDate() + frequency.days));
                        if (dueDate < now) {
                            dueList.push({ template, status: 'Scaduto', dueDate });
                        }
                    } else {
                        dueList.push({ template, status: 'Da compilare', dueDate: null });
                    }
                });
                return dueList.sort((a,b) => (a.dueDate || 0) - (b.dueDate || 0));
            }
        };

        // =================================================================================
        // --- 6. ROUTER (Gestore delle Pagine) ---
        // =================================================================================

        const Router = {
            routes: {
                'dashboard': DashboardView,
                'lista-pca': ReportListView,
                'nuovo-pca': () => FormView.render('pca'),
                'nuovo-sopralluogo': () => FormView.render('sopralluogo'),
                'impostazioni': SettingsView
            },
            init() {
                window.addEventListener('hashchange', () => this.loadRoute());
                this.loadRoute(); // Carica la rotta iniziale
            },
            loadRoute() {
                const viewId = window.location.hash.substring(1) || 'dashboard';
                const view = this.routes[viewId];
                
                if (view) {
                    // Se la "rotta" è una funzione (come per i form), la esegue per ottenere il contenuto.
                    // Altrimenti, chiama il metodo render() dell'oggetto view.
                    const content = typeof view === 'function' ? view() : view.render();
                    UI.renderView(viewId, content);
                } else {
                    // Fallback alla dashboard se la rotta non esiste
                    this.navigate('dashboard');
                }
            },
            navigate(viewId) {
                window.location.hash = viewId;
            }
        };

        // =================================================================================
        // --- 7. APP CORE (Punto di Ingresso Principale) ---
        // =================================================================================

        const AppCore = {
            init() {
                console.log("🚀 Avvio AppCore...");
                
                UI.init();

                if (!FirebaseService.init()) {
                    return; // Interrompe l'avvio se Firebase non è configurato
                }
                
                // Il flusso di avvio ora è guidato dagli eventi
                PubSub.subscribe('authReady', this.onAuthReady);
                PubSub.subscribe('reportsChanged', this.onReportsChanged);

                FirebaseService.handleAuth();
            },
            
            onAuthReady() {
                console.log("👤 Utente autenticato:", AppState.user.uid);
                AppState.isAuthReady = true;
                FirebaseService.listenToReports();
                this.fetchWeather();
                Router.init();
            },

            onReportsChanged() {
                // Quando i dati cambiano, ricarica la vista corrente
                // per mostrare i dati aggiornati.
                if (AppState.isAuthReady) {
                    Router.loadRoute();
                }
            },
            
            fetchWeather() {
                 if (!navigator.geolocation) return;
                 navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        AppState.currentPosition = { latitude, longitude };
                        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude.toFixed(2)}&longitude=${longitude.toFixed(2)}&current=temperature_2m,weather_code`;
                        try {
                            const response = await fetch(apiUrl);
                            const data = await response.json();
                            AppState.currentWeather = data.current;
                            UI.updateWeather(data.current);
                        } catch (error) { 
                            console.error("Weather fetch failed", error); 
                            UI.updateWeather(null);
                        }
                    },
                    () => { UI.updateWeather(null); }
                );
            }
        };

        // --- AVVIO DELL'APPLICAZIONE ---
        document.addEventListener('DOMContentLoaded', () => AppCore.init());

    </script>
</body>
</html>