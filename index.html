<!DOCTYPE html>
<html lang="it" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Gestione PCA - CHRYSAS (Versione Finale)</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <style>
        :root {
            --color-primary: #3b82f6; --color-primary-hover: #2563eb;
            --color-danger: #ef4444;
            --color-background-light: #f8fafc; --color-background-dark: #0f172a;
            --color-card-light: #ffffff; --color-card-dark: #1e293b;
            --color-text-light: #0f172a; --color-text-dark: #f1f5f9;
            --color-border-light: #e2e8f0; --color-border-dark: #334155;
        }

        @media print {
            :root { --print-border-color: #bbb; --print-text-primary: #000; }
            body, #print-area { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            body > *:not(#print-area-wrapper) { display: none !important; }
            #print-area-wrapper { display: block !important; }
            @page {
                size: A4; margin: 2.5cm 1.5cm;
                @top-center { content: element(header); }
                @bottom-center { content: element(footer); }
            }
            header.print-header { position: running(header); }
            footer.print-footer { position: running(footer); }
            .no-break { page-break-inside: avoid; }
        }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background-light); color: var(--color-text-light); }
        .dark body { background-color: var(--color-background-dark); color: var(--color-text-dark); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .content-fade-in { animation: fadeIn 0.5s ease-out forwards; }

        #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 16rem; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        #main-container { transition: padding-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        @media (max-width: 1023px) {
            #sidebar { transform: translateX(-100%); }
            .sidebar-open #sidebar { transform: translateX(0); }
            #main-container { padding-left: 0; }
            .sidebar-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999; }
            .sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
        }
        @media (min-width: 1024px) {
            #sidebar { transform: translateX(0); }
            #main-container { padding-left: 16rem; }
            .sidebar-collapsed #sidebar { transform: translateX(-100%); }
            .sidebar-collapsed #main-container { padding-left: 0; }
        }

        .sidebar-link { transition: all 0.2s; }
        .sidebar-link.active { background-color: var(--color-primary); color: white; font-weight: 600; }
        .sidebar-link:not(.active):hover { background-color: #f1f5f9; }
        .dark .sidebar-link:not(.active):hover { background-color: var(--color-border-dark); }
        
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); opacity: 0; transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1); z-index: 1050; }
        .toast.show { opacity: 1; bottom: 40px; }
        
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1040; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box { background-color: var(--color-card-light); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .dark .modal-box { background-color: var(--color-card-dark); }
        .modal-overlay.visible .modal-box { transform: scale(1); }

        .loader { width: 1.25rem; height: 1.25rem; border: 2px solid #e2e8f0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }

        .accordion-header, .grouped-pca-header { cursor: pointer; transition: background-color 0.2s; }
        .accordion-content, .grouped-pca-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out; }
        .accordion-content.open, .grouped-pca-content.open { max-height: 5000px; }
        .accordion-icon, .grouped-pca-icon { transition: transform 0.3s; }
        .accordion-header.open .accordion-icon, .grouped-pca-header.open .grouped-pca-icon { transform: rotate(180deg); }

        .form-input, .form-select, .form-textarea { background-color: var(--color-card-light); border: 1px solid var(--color-border-light); transition: all 0.2s; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .dark .form-input, .dark .form-select, .dark .form-textarea { background-color: #1f2937; border-color: var(--color-border-dark); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); border-color: var(--color-primary); }
        
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; }
        .dark .btn-secondary { background-color: #334155; color: #f1f5f9; }
        .btn-danger { background-color: var(--color-danger); color: white; }

        .extra-content-wrapper { max-height: 0; overflow: hidden; transition: all 0.4s ease-in-out; opacity: 0; }
        .extra-content-wrapper.visible { max-height: 1000px; opacity: 1; padding-top: 1rem; margin-top: 1rem; border-top: 1px solid var(--color-border-light); }
        .dark .extra-content-wrapper.visible { border-top-color: var(--color-border-dark); }

        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">

    <div id="app-container">
        <aside id="sidebar" class="bg-white dark:bg-slate-800/95 backdrop-blur-sm border-r border-slate-200 dark:border-slate-700 flex flex-col">
            <div class="h-16 flex items-center justify-center px-6 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                <img src="https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp" alt="Logo CHRYSAS" class="h-8">
            </div>
            <nav id="sidebar-nav" class="flex-grow px-4 py-6 overflow-y-auto"></nav>
        </aside>
        
        <div id="sidebar-overlay"></div>

        <div id="main-container" class="relative w-full">
            <header class="h-16 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 sticky top-0 z-50">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-btn" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700" aria-label="Toggle Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h1 id="page-title" class="text-xl font-bold"></h1>
                </div>

                <div class="flex items-center gap-6">
                    <div id="weather-widget" class="hidden lg:flex items-center gap-3 text-sm text-slate-600 dark:text-slate-300"></div>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" aria-label="Toggle dark mode">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="text-right hidden sm:block"><p id="current-date" class="text-sm text-slate-500 dark:text-slate-400"></p></div>
                </div>
            </header>
            
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6 lg:p-8"></main>
        </div>
    </div>

    <div id="toast" class="toast px-6 py-3 rounded-lg text-white font-medium shadow-lg" role="alert" aria-live="polite"></div>
    <div id="print-area-wrapper" class="hidden"></div>
    <div id="modal-overlay" class="modal-overlay"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        window.onerror = function(message, source, lineno, colno, error) {
            console.error("ERRORE GLOBALE:", { message, source, lineno, colno, error });
            App.ui?.showToast('Si è verificato un errore critico.', 'error');
            return true; 
        };
        
        const App = {
            config: {
                appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
                firebaseConfig: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_STORAGE_BUCKET", messagingSenderId: "YOUR_MESSAGING_SENDER_ID", appId: "YOUR_APP_ID"
                },
                initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
                TABS: [
                    { id: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>' },
                    { id: 'lista-pca', label: 'Lista Controlli', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>' },
                    { id: 'nuovo-pca', label: 'Nuovo PCA', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>' },
                    { id: 'nuovo-sopralluogo', label: 'Verbale Sopralluogo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>' },
                    { id: 'impostazioni', label: 'Impostazioni', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>' }
                ],
                WBS_DATA: { 'GA': { descrizione: 'Gallerie Artificiali', lavorazioni: ['Scavo di sbancamento', 'Posa armature e getti CLS', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti'] }, 'GN': { descrizione: 'Gallerie Naturali', lavorazioni: ['Scavo in naturale', 'Consolidamenti (spritz-beton, centine)', 'Rivestimenti e impermeabilizzazioni'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Rifornimenti', 'Acque', 'Rifiuti', 'Vibrazioni'] }, 'AS': { descrizione: 'Aree di Stoccaggio', lavorazioni: ['Scavi e rivestimenti', 'Opere di sostegno e drenaggi'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Consumi'] }, 'TR': { descrizione: 'Trincee', lavorazioni: ['Scavi di trincea', 'Opere di sostegno (pali, diaframmi)', 'Impermeabilizzazioni e rinterri'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Acque', 'Beni Culturali'] }, 'RI': { descrizione: 'Rilevati', lavorazioni: ['Formazione corpo del rilevato', 'Opere di sostegno', 'Sistemazioni idrauliche'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'VI': { descrizione: 'Viadotti', lavorazioni: ['Pali di fondazione e fondazioni', 'Elevazione pile e spalle', 'Varo impalcato e soletta'], aspetti: ['Rumore', 'Vibrazioni', 'Rifiuti', 'Sostanze Pericolose'] }, 'CB': { descrizione: 'Campo Base', lavorazioni: ['Installazione e gestione uffici/dormitori/mensa', 'Manutenzione aree e servizi'], aspetti: ['Acque', 'Rifiuti', 'Rumore', 'Consumi'] }, 'CO': { descrizione: 'Cantiere Operativo', lavorazioni: ['Allestimento aree stoccaggio', 'Gestione impianto di betonaggio', 'Officina e manutenzione mezzi'], aspetti: ['Polveri', 'Rumore', 'Acque', 'Rifiuti', 'Sostanze Pericolose'] }, 'NV': { descrizione: 'Nuova Viabilità', lavorazioni: ['Scavi e rilevati per nuova viabilità', 'Formazione sottofondi e pavimentazioni', 'Opere idrauliche e finiture'], aspetti: ['Polveri', 'Rumore', 'Terre e Rocce', 'Consumi'] }, 'FA': { descrizione: 'Fabbricati', lavorazioni: ['Scavi e fondazioni', 'Elevazione strutture', 'Finiture e impianti'], aspetti: ['Polveri', 'Rumore', 'Rifiuti', 'Consumi'] } },
                CHECK_TEMPLATES_PERIODIC: [ { id: "pca01", title: "PCA 01: Scarichi Idrici ed Approvvigionamento", icon: "💧", significativita: "ALTA", items: ["Autorizzazione allo scarico acque reflue domestiche presente e valida?", "Autorizzazione allo scarico acque reflue industriali presente e valida?", "Rispetto delle prescrizioni contenute nelle autorizzazioni?", "Corretta gestione acque di lavorazione (es. scavo pali)?", "Kit di emergenza anti-sversamento presente e completo?", "Manutenzione impianti di depurazione/trattamento registrata?"] }, { id: "pca02", title: "PCA 02: Terre e Rocce da Scavo", icon: "⛰️", significativita: "ALTA", items: ["Aree di stoccaggio temporaneo identificate e conformi al PUT?", "Separazione dei cumuli per categorie omogenee?", "Documento di Trasporto (DDT) per le terre conforme e presente?", "Copertura dei cassoni dei mezzi in transito?"] }, { id: "pca03", title: "PCA 03: Emissioni in Atmosfera", icon: "💨", significativita: "ALTA", items: ["Autorizzazioni per impianti (es. calcestruzzo) presenti e valide?", "Copertura mezzi per trasporto materiali polverulenti?", "Bagnatura piste e/o cumuli eseguita regolarmente?", "Velocità dei mezzi in cantiere limitata a 30 km/h?", "Impianto lavaruote funzionante ed utilizzato?"] }, { id: "pca04", title: "PCA 04: Rifiuti", icon: "🗑️", significativita: "ALTA", items: ["Deposito temporaneo (DTR) ordinato e pulito?", "Rifiuti separati per CER e con corretta cartellonistica?", "Stoccaggio rifiuti pericolosi conforme (aree, bacini)?", "Registro di carico/scarico aggiornato (entro 10gg)?", "Quarta copia FIR ricevuta entro 90 giorni?"] }, { id: "pca05", title: "PCA 05: Sostanze Pericolose ed Emergenze", icon: "☣️", significativita: "MEDIA", items: ["Schede di Sicurezza (SDS) disponibili e aggiornate?", "Stoccaggio sostanze su bacini di contenimento idonei?", "Aree di stoccaggio segnalate e adeguate?", "Personale formato per la gestione delle emergenze?"] }, { id: "pca06", title: "PCA 06: Rumore e Vibrazioni", icon: "🔊", significativita: "MEDIA", items: ["Autorizzazione in deroga per rumore presente (se necessaria)?", "Rispetto degli orari di lavoro previsti?", "Barriere acustiche (se previste) integre ed efficaci?", "Manutenzione ordinaria dei mezzi per ridurre il rumore?", "Eseguita misurazione fonometrica periodica?"] }, { id: "pca07", title: "PCA 07: Suolo e Sottosuolo", icon: "🌱", significativita: "ALTA", items: ["Assenza di contaminazioni visive del suolo (macchie, sversamenti)?", "Corretto stoccaggio del terreno vegetale in cumuli separati?", "Utilizzo delle apposite vasche per lavaggio betoniere?", "Gestione corretta del calcestruzzo in esubero?"] }, { id: "pca08", title: "PCA 08: Beni Culturali e Archeologici", icon: "🏺", significativita: "ALTA", items: ["Presenza di archeologo durante le attività di scavo?", "Notifica agli enti competenti in caso di ritrovamento?", "Corretta gestione e inventario dei reperti?", "Disboscamento limitato alle aree strettamente necessarie?"] } ],
                ASPETTO_TO_PCA_ID_MAP: { 'Polveri': 'pca03', 'Rumore': 'pca06', 'Vibrazioni': 'pca06', 'Acque': 'pca01', 'Suolo': 'pca07', 'Rifiuti': 'pca04', 'Terre e Rocce': 'pca02', 'Sostanze Pericolose': 'pca05', 'Rifornimenti': 'pca05', 'Consumi': 'pca05', 'Beni Culturali': 'pca08' },
                FREQUENCY_MAP: { 'ALTA': { text: 'Settimanale', days: 7 }, 'MEDIA': { text: 'Quindicinale', days: 15 }, 'BASSA': { text: 'Mensile', days: 30 } },
                CHECK_TEMPLATES_PRELIMINARE: [{ id: "stato_luoghi", title: "Verifica Stato dei Luoghi (Punto Zero)", icon: "📍", items: ["Analisi vincoli specifici e servitù completata", "Mappatura recettori sensibili eseguita", "Stato della vegetazione documentato", "Verificata assenza di rifiuti preesistenti", "Verificata assenza di contaminazione pregressa"] }],
                CHECK_TEMPLATES_FINALE: [{ id: "ripristino", title: "Verifica Ripristino Finale", icon: "✅", items: ["Area riconsegnata come da verbale preliminare", "Completa rimozione rifiuti e attrezzature", "Opere di ripristino ambientale eseguite", "Assenza di impatti residui visibili"] }],
                WEATHER_CODE_MAP: { 0: {text:'Sereno', icon:'☀️'}, 1: {text:'Prevalentemente sereno', icon:'🌤️'}, 2: {text:'Parzialmente nuvoloso', icon:'⛅️'}, 3: {text:'Nuvoloso', icon:'☁️'}, 45: {text:'Nebbia', icon:'🌫️'}, 48: {text:'Nebbia con brina', icon:'🌫️'}, 51: {text:'Pioggerella leggera', icon:'🌦️'}, 53: {text:'Pioggerella moderata', icon:'🌦️'}, 55: {text:'Pioggerella forte', icon:'🌦️'}, 61: {text:'Pioggia leggera', icon:'🌧️'}, 63: {text:'Pioggia moderata', icon:'🌧️'}, 65: {text:'Pioggia forte', icon:'🌧️'}, 71: {text:'Nevicata leggera', icon:'❄️'}, 73: {text:'Nevicata moderata', icon:'❄️'}, 75: {text:'Nevicata forte', icon:'❄️'}, 80: {text:'Rovescio leggero', icon:'🌧️'}, 81: {text:'Rovescio moderato', icon:'🌧️'}, 82: {text:'Rovescio violento', icon:'🌧️'}, 95: {text:'Temporale', icon:'⛈️'}, 96: {text:'Temporale con grandine', icon:'⛈️'} }
            },
            state: {
                isSaving: false, tempPhotos: {}, activeChart: null, reports: [], 
                isSidebarOpen: localStorage.getItem('sidebarOpen') !== 'false',
                currentWeather: null, currentPosition: null,
                app: null, auth: null, db: null, storage: null, userId: null,
                isAuthReady: false, unsubscribe: null
            },
            dom: {},
            
            async init() {
                this.dom = {
                    appContainer: document.getElementById('app-container'), sidebar: document.getElementById('sidebar'),
                    sidebarOverlay: document.getElementById('sidebar-overlay'), sidebarNav: document.getElementById('sidebar-nav'),
                    mainContent: document.getElementById('main-content'), pageTitle: document.getElementById('page-title'),
                    currentDate: document.getElementById('current-date'), toast: document.getElementById('toast'),
                    printAreaWrapper: document.getElementById('print-area-wrapper'), modal: document.getElementById('modal-overlay'),
                    theme: { toggleBtn: document.getElementById('theme-toggle'), darkIcon: document.getElementById('theme-toggle-dark-icon'), lightIcon: document.getElementById('theme-toggle-light-icon') },
                    sidebarToggleBtn: document.getElementById('sidebar-toggle-btn'), weatherWidget: document.getElementById('weather-widget')
                };
                
                this.ui.renderNav();
                this.handlers.attachGlobalListeners();
                this.ui.applyTheme(localStorage.getItem('theme') === 'dark', true);
                this.ui.setSidebarState(this.state.isSidebarOpen);
                
                this.firebase.init();
                this.services.fetchWeather();
                await this.ui.showTab('dashboard');
            },
            
            firebase: {
                init() {
                    try {
                        App.state.app = initializeApp(App.config.firebaseConfig);
                        App.state.auth = getAuth(App.state.app);
                        App.state.db = getFirestore(App.state.app);
                        App.state.storage = getStorage(App.state.app);
                        
                        onAuthStateChanged(App.state.auth, async (user) => {
                            if (user) {
                                App.state.userId = user.uid;
                                App.state.isAuthReady = true;
                                console.log("Utente autenticato:", App.state.userId);
                                App.store.listenForReports();
                            } else {
                                App.state.isAuthReady = false;
                                console.log("Nessun utente, tentativo di login...");
                                if (App.config.initialAuthToken) await signInWithCustomToken(App.state.auth, App.config.initialAuthToken);
                                else await signInAnonymously(App.state.auth);
                            }
                        });
                    } catch (error) {
                        console.error("Errore Inizializzazione Firebase:", error);
                        App.ui.showToast("Impossibile connettersi al database.", "error");
                    }
                }
            },

            store: {
                listenForReports() {
                    if (App.state.unsubscribe) App.state.unsubscribe();
                    if (!App.state.isAuthReady) return;
                    
                    const reportsCollectionPath = `/artifacts/${App.config.appId}/users/${App.state.userId}/reports`;
                    const q = query(collection(App.state.db, reportsCollectionPath));
                    
                    App.state.unsubscribe = onSnapshot(q, (querySnapshot) => {
                        const reports = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.date?.toDate) data.date = data.date.toDate().toISOString().slice(0,10);
                            reports.push({ docId: doc.id, ...data });
                        });
                        App.state.reports = reports;
                        
                        const activeTab = document.querySelector('.sidebar-link.active')?.dataset.tabId;
                        if(activeTab && document.getElementById('main-content').hasChildNodes()) {
                             App.ui.showTab(activeTab, false);
                        }
                    }, (error) => {
                        console.error("Errore listener Firestore:", error);
                        App.ui.showToast("Errore di sincronizzazione dati.", "error");
                    });
                },

                async save(reportData) {
                    if (!App.state.isAuthReady) throw new Error("Autenticazione non pronta.");
                    const reportsCollectionPath = `/artifacts/${App.config.appId}/users/${App.state.userId}/reports`;
                    
                    const reportToSave = { ...reportData };
                    if(reportToSave.date) reportToSave.date = new Date(reportToSave.date);
                    delete reportToSave.docId;

                    if (reportData.docId) {
                        const docRef = doc(App.state.db, reportsCollectionPath, reportData.docId);
                        await setDoc(docRef, reportToSave, { merge: true });
                        return reportData.docId;
                    } else {
                        const docRef = await addDoc(collection(App.state.db, reportsCollectionPath), reportToSave);
                        return docRef.id;
                    }
                },

                async delete(reportDocId) {
                    if (!App.state.isAuthReady) throw new Error("Autenticazione non pronta.");
                    const reportDocPath = `/artifacts/${App.config.appId}/users/${App.state.userId}/reports/${reportDocId}`;
                    const report = App.state.reports.find(r => r.docId === reportDocId);
                    if (report?.photos) {
                        const photoUrls = Object.values(report.photos).flat();
                        for(const url of photoUrls) {
                             try {
                                const photoRef = ref(App.state.storage, url);
                                await deleteObject(photoRef);
                            } catch (err) {
                                if(err.code !== 'storage/object-not-found') console.warn("Impossibile eliminare foto:", err);
                            }
                        }
                    }
                    await deleteDoc(doc(App.state.db, reportDocPath));
                },
                
                async uploadPhoto(base64, reportDocId, photoKey) {
                    if (!App.state.isAuthReady) throw new Error("Autenticazione non pronta.");
                    const photoPath = `artifacts/${App.config.appId}/users/${App.state.userId}/${reportDocId}/${photoKey}.jpg`;
                    const storageRef = ref(App.state.storage, photoPath);
                    await uploadString(storageRef, base64, 'data_url');
                    return await getDownloadURL(storageRef);
                },

                async getById(docId) { return App.state.reports.find(r => r.docId === docId); },
                
                async getNextId() {
                    const reports = App.state.reports;
                    if (!reports || reports.length === 0) return 1;
                    return reports.reduce((max, r) => Math.max(max, r.id || 0), 0) + 1;
                },
                
                getDashboardStats() {
                    const reports = App.state.reports;
                    let openNc = 0, totalChecks = 0, compliantChecks = 0;
                    const ncByAspect = {};
                    reports.forEach(report => {
                        if (report?.type === 'periodico' && report.checks) {
                            Object.entries(report.checks).forEach(([aspectId, aspectChecks]) => {
                                const template = App.config.CHECK_TEMPLATES_PERIODIC.find(t => t.id === aspectId);
                                if (!template || !aspectChecks) return;
                                (aspectChecks || []).forEach(check => {
                                    if (check?.result && check.result !== 'NA') {
                                        totalChecks++;
                                        if (check.result === 'C') compliantChecks++;
                                        if (check.result === 'NC') {
                                            openNc++;
                                            ncByAspect[template.title] = (ncByAspect[template.title] || 0) + 1;
                                        }
                                    }
                                });
                            });
                        }
                    });
                    const avgCompliance = totalChecks > 0 ? `${((compliantChecks / totalChecks) * 100).toFixed(0)}%` : 'N.D.';
                    return { totalPca: reports.length, openNc, totalChecks, avgCompliance, ncByAspect };
                },
            },

            services: {
                async fetchWeather() {
                    const widget = App.dom.weatherWidget;
                    if (!widget) return;
                    widget.innerHTML = `<div class="loader"></div>`;
                    if (!navigator.geolocation) {
                        widget.innerHTML = '<span>N/D</span>';
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            App.state.currentPosition = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                            const { latitude, longitude } = position.coords;
                            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude.toFixed(2)}&longitude=${longitude.toFixed(2)}&current=temperature_2m,weather_code`;
                            try {
                                const response = await fetch(apiUrl);
                                const data = await response.json();
                                App.state.currentWeather = data.current; 
                                App.ui.renderWeather(data.current);
                            } catch (error) { widget.textContent = 'N/D'; }
                        },
                        () => { widget.innerHTML = '<span>N/D</span>'; }
                    );
                },
                getGreeting() {
                    const hour = new Date().getHours();
                    if (hour < 12) return 'Buongiorno';
                    if (hour < 18) return 'Buon pomeriggio';
                    return 'Buonasera';
                }
            },
            
            ui: {
                renderMap: { 'dashboard': 'renderDashboard', 'lista-pca': 'renderListaPca', 'nuovo-pca': 'renderNuovoPca', 'nuovo-sopralluogo': 'renderNuovoSopralluogo', 'impostazioni': 'renderImpostazioni' },
                showToast(message, type = 'success') {
                    const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                    App.dom.toast.textContent = message;
                    App.dom.toast.className = `toast px-6 py-3 rounded-lg text-white font-medium shadow-lg ${colors[type]}`;
                    setTimeout(() => { App.dom.toast.classList.add('show'); }, 10);
                    setTimeout(() => { App.dom.toast.classList.remove('show'); }, 4000);
                },
                showModal(config) {
                    return new Promise((resolve) => {
                        const { title, message, confirmText = 'Conferma', cancelText = 'Annulla', confirmColor = 'btn-danger' } = config;
                        App.dom.modal.innerHTML = `
                            <div class="modal-box">
                                <h3 class="text-xl font-bold mb-4">${this.sanitize(title)}</h3>
                                <p class="text-slate-600 dark:text-slate-300 mb-6">${this.sanitize(message)}</p>
                                <div class="flex justify-end gap-4">
                                    <button id="modal-cancel" class="btn btn-secondary">${this.sanitize(cancelText)}</button>
                                    <button id="modal-confirm" class="btn ${confirmColor}">${this.sanitize(confirmText)}</button>
                                </div>
                            </div>`;
                        App.dom.modal.classList.add('visible');
                        const confirmBtn = document.getElementById('modal-confirm');
                        const cancelBtn = document.getElementById('modal-cancel');
                        const closeModal = (decision) => { App.dom.modal.classList.remove('visible'); resolve(decision); };
                        confirmBtn.onclick = () => closeModal(true);
                        cancelBtn.onclick = () => closeModal(false);
                        App.dom.modal.onclick = (e) => { if (e.target === App.dom.modal) closeModal(false); };
                    });
                },
                async showTab(tabId, animate = true) {
                    const tab = App.config.TABS.find(t => t.id === tabId);
                    if (!tab) return;
                    App.dom.sidebarNav.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.dataset.tabId === tabId));
                    App.dom.pageTitle.textContent = tab.label;
                    
                    if (animate) {
                        App.dom.mainContent.classList.remove('content-fade-in');
                        void App.dom.mainContent.offsetWidth;
                    }

                    const renderFunctionName = this.renderMap[tabId];
                    if (this[renderFunctionName]) await this[renderFunctionName]();
                    
                    if (animate) App.dom.mainContent.classList.add('content-fade-in');
                },
                renderNav() { App.dom.sidebarNav.innerHTML = App.config.TABS.map(t => `<a href="#" data-tab-id="${t.id}" class="sidebar-link flex items-center px-4 py-3 mt-2 text-slate-600 dark:text-slate-300 rounded-md">${t.icon} <span class="ml-3">${t.label}</span></a>`).join(''); },
                renderDashboard() {
                    const stats = App.store.getDashboardStats();
                    const greeting = App.services.getGreeting();
                    const dueList = this.getFrequencyStatuses();
                    App.dom.mainContent.innerHTML = App.templates.dashboard(stats, greeting, dueList);
                    const ctx = document.getElementById('ncChart')?.getContext('2d');
                    if (!ctx || Object.keys(stats.ncByAspect).length === 0) {
                        document.getElementById('ncChartContainer').innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400">Nessuna non conformità registrata.</p>`;
                        return;
                    };
                    if (App.state.activeChart) App.state.activeChart.destroy();
                    App.state.activeChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(stats.ncByAspect), datasets: [{ data: Object.values(stats.ncByAspect), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false }} } });
                },
                getFrequencyStatuses() {
                    const dueList = [];
                    const now = new Date();
                    const checkedPcas = new Set();

                    // Trova l'ultimo report per ogni tipo di PCA
                    const latestPcaReports = {};
                    App.state.reports
                        .filter(r => r.type === 'periodico' && r.checks)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .forEach(report => {
                            Object.keys(report.checks).forEach(pcaId => {
                                if (!latestPcaReports[pcaId]) {
                                    latestPcaReports[pcaId] = report;
                                }
                            });
                        });
                    
                    // Controlla ogni template PCA per vedere se è da compilare
                    App.config.CHECK_TEMPLATES_PERIODIC.forEach(template => {
                        const lastReport = latestPcaReports[template.id];
                        const frequency = App.config.FREQUENCY_MAP[template.significativita];
                        if (!frequency) return;

                        if (lastReport) {
                            const lastDate = new Date(lastReport.date);
                            const dueDate = new Date(lastDate.setDate(lastDate.getDate() + frequency.days));
                            if (dueDate < now) {
                                dueList.push({ template, status: 'Scaduto', dueDate });
                            }
                        } else {
                            // Se non è mai stato compilato, è da fare
                            dueList.push({ template, status: 'Da compilare', dueDate: null });
                        }
                    });
                    
                    return dueList.sort((a,b) => (a.dueDate || 0) - (b.dueDate || 0));
                },
                renderImpostazioni() {
                    App.dom.mainContent.innerHTML = App.templates.settings();
                    App.handlers.attachSettingsListeners();
                },
                renderListaPca() {
                    const reports = [...App.state.reports].sort((a, b) => (b.id || 0) - (a.id || 0));
                    const groupedReports = reports.reduce((acc, report) => {
                        if (!report) return acc;
                        const key = report.type === 'sopralluogo' ? 'SOPRALLUOGHI' : (report.wbs?.substring(0, 2).toUpperCase() || 'GENERICO');
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(report);
                        return acc;
                    }, {});
                    App.dom.mainContent.innerHTML = App.templates.pcaGroupedList(groupedReports);
                    App.handlers.attachPcaListListeners();
                },
                renderWeather(weatherData, elementId = 'weather-widget') {
                    const widget = document.getElementById(elementId);
                    if (!widget || !weatherData) return;
                    const weatherInfo = App.config.WEATHER_CODE_MAP[weatherData.weather_code] || {text: 'N/D', icon: '❓'};
                    widget.innerHTML = `<span title="${weatherInfo.text}" class="text-xl">${weatherInfo.icon}</span> <span class="font-semibold">${weatherData.temperature_2m}°C</span>`;
                },
                async renderNuovoPca() {
                    const nextId = await App.store.getNextId();
                    const today = new Date().toISOString().slice(0, 10);
                    App.dom.mainContent.innerHTML = App.templates.newPcaForm({ nextId, today });
                    App.handlers.attachNewPcaFormListeners();
                    this.updateFormRequirements('periodico');
                },
                 async renderNuovoSopralluogo() {
                    const nextId = await App.store.getNextId();
                    const today = new Date().toISOString().slice(0, 10);
                    App.dom.mainContent.innerHTML = App.templates.newSopralluogoForm({ nextId, today });
                    App.handlers.attachNewSopralluogoFormListeners();
                    if (App.state.currentWeather) App.ui.renderWeather(App.state.currentWeather, 'sopralluogo-weather-display');
                    if (App.state.currentPosition) {
                        const posEl = document.getElementById('sopralluogo-position-display');
                        if (posEl) posEl.textContent = `Lat: ${App.state.currentPosition.latitude.toFixed(4)}, Lon: ${App.state.currentPosition.longitude.toFixed(4)}`;
                    }
                },
                updateFormRequirements(type) {
                    document.getElementById('wbs-section').style.display = type === 'periodico' ? 'block' : 'none';
                    document.getElementById('manual-section').style.display = type !== 'periodico' ? 'block' : 'none';
                    document.getElementById('checklist-container-periodico').style.display = type === 'periodico' ? 'block' : 'none';
                    document.getElementById('checklist-container-preliminare').style.display = type === 'preliminare' ? 'block' : 'none';
                    document.getElementById('checklist-container-finale').style.display = type === 'finale' ? 'block' : 'none';
                },
                applyTheme(isDark, isInitial = false) {
                    document.documentElement.classList.toggle('dark', isDark);
                    App.dom.theme.darkIcon.classList.toggle('hidden', !isDark);
                    App.dom.theme.lightIcon.classList.toggle('hidden', isDark);
                    if (!isInitial) localStorage.setItem('theme', isDark ? 'dark' : 'light');
                },
                setSidebarState(isOpen) {
                    App.state.isSidebarOpen = isOpen;
                    localStorage.setItem('sidebarOpen', isOpen.toString());
                    if (window.innerWidth < 1024) {
                        App.dom.appContainer.classList.toggle('sidebar-open', isOpen);
                        App.dom.sidebarOverlay.classList.toggle('visible', isOpen);
                    } else App.dom.appContainer.classList.toggle('sidebar-collapsed', !isOpen);
                },
                toggleSidebar() { this.setSidebarState(!App.state.isSidebarOpen); },
                resetPcaForm: () => { App.state.tempPhotos = {}; App.ui.renderNuovoPca(); },
                async prepareAndPrintReport(docIdOrObject) {
                    const report = typeof docIdOrObject === 'string' ? await App.store.getById(docIdOrObject) : docIdOrObject;
                    if (!report) return App.ui.showToast("Report non trovato", "error");
                    let templates = [];
                    if (report.type === 'periodico') templates = App.config.CHECK_TEMPLATES_PERIODIC;
                    else if (report.type === 'preliminare') templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                    else if (report.type === 'finale') templates = App.config.CHECK_TEMPLATES_FINALE;
                    
                    App.dom.printAreaWrapper.innerHTML = App.templates.printReport(report, templates);
                    setTimeout(() => window.print(), 200);
                },
                sanitize(str) {
                    const temp = document.createElement('div');
                    temp.textContent = str || "";
                    return temp.innerHTML;
                }
            },

            handlers: {
                debounce(func, delay = 250) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; },
                attachGlobalListeners() {
                    App.dom.sidebarNav.addEventListener('click', e => { 
                        const link = e.target.closest('.sidebar-link');
                        if (link) { e.preventDefault(); App.ui.showTab(link.dataset.tabId); if(window.innerWidth < 1024) App.ui.setSidebarState(false); } 
                    });
                    App.dom.theme.toggleBtn.addEventListener('click', () => App.ui.applyTheme(!document.documentElement.classList.contains('dark')));
                    App.dom.sidebarToggleBtn.addEventListener('click', () => App.ui.toggleSidebar());
                    App.dom.sidebarOverlay.addEventListener('click', () => App.ui.setSidebarState(false));
                    App.dom.currentDate.textContent = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                },
                attachPcaListListeners() {
                    App.dom.mainContent.addEventListener('click', (e) => {
                        const printBtn = e.target.closest('.print-pca-btn');
                        const deleteBtn = e.target.closest('.delete-pca-btn');
                        const header = e.target.closest('.grouped-pca-header');
                        if (printBtn) this.onPrintPca(printBtn.dataset.docId);
                        if (deleteBtn) {
                            const id = deleteBtn.dataset.id; const docId = deleteBtn.dataset.docId;
                            this.debounce(async () => {
                                 const confirmed = await App.ui.showModal({ title: 'Conferma Eliminazione', message: `Sei sicuro di voler eliminare il Controllo N° ${id}?`, confirmText: 'Elimina', confirmColor: 'btn-danger' });
                                if (confirmed) this.onDeletePca(docId, id);
                            })();
                        }
                        if(header) { header.classList.toggle('open'); header.nextElementSibling.classList.toggle('open'); }
                    });
                },
                onPrintPca: (docId) => App.ui.prepareAndPrintReport(docId),
                async onDeletePca(docId, numericId) {
                    await App.store.delete(docId);
                    App.ui.showToast(`Controllo N° ${numericId} eliminato.`, 'info');
                },
                attachNewPcaFormListeners() {
                    const form = document.getElementById('new-pca-form'); if (!form) return;
                    form.addEventListener('submit', (e) => this.onNewPcaSubmit(e));
                    form.addEventListener('click', (e) => { 
                        if (e.target.matches('.add-photo-btn')) e.target.previousElementSibling.click(); 
                        if (e.target.closest('.remove-photo-btn')) this.onRemovePhoto(e.target.closest('.remove-photo-btn'));
                        if (e.target.matches('#cancel-pca-btn')) App.ui.resetPcaForm();
                        if (e.target.matches('#print-draft-btn')) this.onPrintDraft(form);
                        const accordionHeader = e.target.closest('.accordion-header');
                        if (accordionHeader) { accordionHeader.classList.toggle('open'); accordionHeader.nextElementSibling.classList.toggle('open'); }
                    });
                    form.querySelectorAll('.photo-input').forEach(i => i.addEventListener('change', (e) => this.onPhotoUpload(e)));
                    form.addEventListener('change', (e) => {
                        if (e.target.type === 'radio' && e.target.name.startsWith('check_')) {
                            const extraContentId = `extra_content_wrapper_${e.target.name}`;
                            const extraContentEl = document.getElementById(extraContentId);
                            if (extraContentEl) {
                                const isCompliant = e.target.value === 'C';
                                extraContentEl.classList.toggle('visible', isCompliant);
                                extraContentEl.querySelectorAll('input, select, textarea').forEach(input => input.required = isCompliant);
                            }
                        }
                    });
                    document.getElementById('pca-type')?.addEventListener('change', (e) => App.ui.updateFormRequirements(e.target.value));
                    document.getElementById('pca-wbs-input')?.addEventListener('input', this.debounce((e) => {
                        const wbsCode = e.target.value.toUpperCase().substring(0, 2);
                        const wbsData = App.config.WBS_DATA[wbsCode];
                        const lavorazioneSelect = document.getElementById('pca-lavorazione-select');
                        document.querySelectorAll('.pca-sheet-accordion').forEach(el => el.style.display = 'none');
                        lavorazioneSelect.innerHTML = '<option value="">-- Prima inserisci WBS --</option>';
                        lavorazioneSelect.disabled = true;

                        if (wbsData) {
                            wbsData.lavorazioni.forEach(lav => lavorazioneSelect.add(new Option(lav, lav)));
                            lavorazioneSelect.disabled = false;
                            const requiredPcaIds = new Set(wbsData.aspetti.map(a => App.config.ASPETTO_TO_PCA_ID_MAP[a]).filter(Boolean));
                            requiredPcaIds.forEach(sheetId => { 
                                const accordionEl = document.getElementById(`accordion-${sheetId}`);
                                if (accordionEl) accordionEl.style.display = 'block';
                            });
                        }
                    }));
                },
                async onNewPcaSubmit(e) {
                    e.preventDefault();
                    if (App.state.isSaving) return;
                    const form = e.target;
                    if (!form.checkValidity()) { form.reportValidity(); return App.ui.showToast('Compilare tutti i campi obbligatori.', 'error'); }

                    App.state.isSaving = true;
                    const saveBtn = document.getElementById('save-pca-btn');
                    const originalBtnText = saveBtn.textContent;
                    if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = `<div class="loader"></div><span>Salvataggio...</span>`; }

                    try {
                        const newReport = this.getReportDataFromForm(form);
                        const docId = await App.store.save(newReport);

                        if(saveBtn) saveBtn.innerHTML = `<div class="loader"></div><span>Caricamento foto...</span>`;
                        const photoPromises = Object.entries(App.state.tempPhotos).map(([key, base64]) => 
                            App.store.uploadPhoto(base64, docId, key).then(url => ({key, url}))
                        );
                        
                        const uploadedPhotos = await Promise.all(photoPromises);
                        if(uploadedPhotos.length > 0) {
                            const photoUrls = uploadedPhotos.reduce((acc, {key, url}) => {
                                const parts = key.split('_');
                                const templateId = parts[1];
                                const itemIndex = parts[2];
                                if (!acc[templateId]) acc[templateId] = {};
                                acc[templateId][itemIndex] = url;
                                return acc;
                            }, {});
                            await App.store.save({ docId: docId, photos: photoUrls });
                        }

                        App.ui.showToast(`PCA N° ${newReport.id} salvato.`, 'success');
                        App.ui.resetPcaForm();
                        await App.ui.showTab('lista-pca');
                    } catch (error) {
                        console.error("Errore salvataggio:", error);
                        App.ui.showToast(error.message || 'Errore imprevisto.', 'error');
                    } finally {
                        App.state.isSaving = false;
                        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = originalBtnText; }
                    }
                },
                async attachNewSopralluogoFormListeners() {
                    const form = document.getElementById('new-sopralluogo-form'); if (!form) return;
                    form.addEventListener('submit', (e) => this.onNewSopralluogoSubmit(e));
                    form.querySelector('#print-draft-btn')?.addEventListener('click', () => this.onPrintDraft(form));
                },
                async onNewSopralluogoSubmit(e) {
                    e.preventDefault();
                    if (App.state.isSaving) return;
                    const form = e.target;
                    if (!form.checkValidity()) { form.reportValidity(); return App.ui.showToast('Compilare tutti i campi.', 'error'); }

                    App.state.isSaving = true;
                    const saveBtn = document.getElementById('save-sopralluogo-btn');
                    const originalBtnText = saveBtn.textContent;
                    if (saveBtn) { saveBtn.disabled = true; saveBtn.innerHTML = `<div class="loader"></div><span>Salvataggio...</span>`; }

                    try {
                        const newReport = this.getReportDataFromForm(form);
                        const docId = await App.store.save(newReport);

                        if(saveBtn) saveBtn.innerHTML = `<div class="loader"></div><span>Caricamento foto...</span>`;
                        const photoPromises = Object.entries(App.state.tempPhotos).map(([key, base64]) => 
                            App.store.uploadPhoto(base64, docId, key).then(url => ({key, url}))
                        );
                        
                        const uploadedPhotos = await Promise.all(photoPromises);
                        if(uploadedPhotos.length > 0) {
                            const photoUrls = { sopralluogo: uploadedPhotos.map(p => p.url) };
                            await App.store.save({ docId: docId, photos: photoUrls });
                        }

                        App.ui.showToast(`Verbale di Sopralluogo N° ${newReport.id} salvato.`, 'success');
                        App.state.tempPhotos = {};
                        await App.ui.showTab('lista-pca');
                    } catch (error) {
                        console.error("Errore salvataggio sopralluogo:", error);
                        App.ui.showToast(error.message || 'Errore imprevisto.', 'error');
                    } finally {
                        App.state.isSaving = false;
                        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = originalBtnText; }
                    }
                },
                async onPhotoUpload(e) { 
                    const input = e.target; const key = input.dataset.key; 
                    const previewContainer = document.getElementById(`preview_${key}`); const file = input.files[0]; 
                    if (!file || !previewContainer) return; 
                    previewContainer.innerHTML = `<div class="loader"></div>`; 
                    try { 
                        const dataUrl = await this.resizeImage(file, 1024); 
                        previewContainer.innerHTML = App.templates.photoPreview(dataUrl, key);
                        App.state.tempPhotos[key] = dataUrl; 
                    } catch (err) { 
                        previewContainer.innerHTML = App.templates.imagePlaceholderIcon(); 
                        delete App.state.tempPhotos[key]; 
                        App.ui.showToast("Errore caricamento foto.", "error"); 
                    } 
                },
                onRemovePhoto(button) {
                    const key = button.dataset.key;
                    const previewContainer = document.getElementById(`preview_${key}`);
                    const fileInput = previewContainer.closest('.photo-upload-container').querySelector('.photo-input');
                    delete App.state.tempPhotos[key];
                    previewContainer.innerHTML = App.templates.imagePlaceholderIcon();
                    if (fileInput) fileInput.value = ''; 
                },
                resizeImage: (file, maxSize) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { let { width, height } = img; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.8)); }; img.onerror = reject; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); }),
                async attachSettingsListeners() { 
                    document.getElementById('export-btn')?.addEventListener('click', this.exportData); 
                    document.getElementById('import-btn')?.addEventListener('click', () => document.getElementById('import-file').click()); 
                    document.getElementById('import-file')?.addEventListener('change', (e) => this.importData(e));
                    document.getElementById('clear-all-btn')?.addEventListener('click', this.onClearAllData);
                },
                async onClearAllData() {
                    const confirmed = await App.ui.showModal({ title: 'Azione Irreversibile', message: "Sei sicuro di voler eliminare TUTTI i dati? L'azione non può essere annullata.", confirmText: 'Elimina Tutto', confirmColor: 'btn-danger' });
                    if (!confirmed) return;
                    const batch = writeBatch(App.state.db);
                    App.state.reports.forEach(report => {
                        const docRef = doc(App.state.db, `/artifacts/${App.config.appId}/users/${App.state.userId}/reports`, report.docId);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    App.ui.showToast("Archivio svuotato con successo.", "info");
                },
                exportData() { 
                    const data = App.state.reports.map(r => { const { docId, ...rest } = r; return rest; });
                    if (data.length === 0) return App.ui.showToast("Nessun dato da esportare.", 'info');
                    const dataStr = JSON.stringify(data, null, 2); 
                    const blob = new Blob([dataStr], { type: 'application/json' }); 
                    const url = URL.createObjectURL(blob); 
                    const a = document.createElement('a'); a.href = url; a.download = `pca_backup_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); 
                    App.ui.showToast("Esportazione completata.", 'success'); 
                },
                importData(e) { 
                    const file = e.target.files[0]; if (!file) return; 
                    const reader = new FileReader(); 
                    reader.onload = async (event) => { 
                        try { 
                            const data = JSON.parse(event.target.result); 
                            if (!Array.isArray(data)) throw new Error("File non valido"); 
                            const batch = writeBatch(App.state.db);
                            const path = `/artifacts/${App.config.appId}/users/${App.state.userId}/reports`;
                            data.forEach(report => batch.set(doc(collection(App.state.db, path)), report));
                            await batch.commit();
                            App.ui.showToast("Dati importati con successo!", 'success'); 
                        } catch (err) { App.ui.showToast("Errore: il file non è valido.", 'error'); } 
                    }; 
                    reader.readAsText(file); e.target.value = '';
                },
                getReportDataFromForm(form) {
                    const formData = new FormData(form);
                    const sanitize = App.ui.sanitize;
                    const reportType = sanitize(form.id.includes('sopralluogo') ? 'sopralluogo' : formData.get('type'));
                    
                    if (reportType === 'sopralluogo') {
                        return {
                            id: parseInt(formData.get('id')), type: 'sopralluogo',
                            date: sanitize(formData.get('date')), wbs: sanitize(formData.get('wbs')),
                            inspector: sanitize(formData.get('inspector')),
                            observations: { sopralluogo: sanitize(formData.get('observations')) },
                            weather: App.state.currentWeather, position: App.state.currentPosition,
                            photos: { sopralluogo: Object.values(App.state.tempPhotos) }
                        };
                    }
                    
                    const newReport = { 
                        id: parseInt(formData.get('id')), type: reportType, 
                        date: sanitize(formData.get('date')), 
                        inspector: sanitize(formData.get('inspector-wbs') || formData.get('inspector-manual')), 
                        wbs: sanitize(formData.get('wbs-input') || formData.get('wbs-manual')), 
                        activities: sanitize(formData.get('lavorazione') || formData.get('activities-manual')), 
                        weather: App.state.currentWeather, checks: {}, observations: {}, extras: {}, photos: {}
                    };
                    
                    let templates = App.config.CHECK_TEMPLATES_PERIODIC;
                    if(reportType === 'preliminare') templates = App.config.CHECK_TEMPLATES_PRELIMINARE;
                    if(reportType === 'finale') templates = App.config.CHECK_TEMPLATES_FINALE;

                    templates.forEach(template => {
                        const sheetEl = document.getElementById(`accordion-${template.id}`);
                        if (sheetEl && sheetEl.style.display !== 'none') {
                            newReport.checks[template.id] = template.items.map((item, idx) => ({ item: sanitize(item), result: sanitize(formData.get(`check_${template.id}_${idx}`)) }));
                            newReport.observations[template.id] = sanitize(formData.get(`observation_${template.id}`));
                            newReport.extras[template.id] = {};
                            template.items.forEach((item, idx) => {
                                const baseName = `check_${template.id}_${idx}`;
                                if(formData.get(baseName) === 'C') {
                                    newReport.extras[template.id][idx] = {};
                                    for(const [key, value] of formData.entries()) {
                                        if (key.startsWith(`extra_${baseName}`)) {
                                            newReport.extras[template.id][idx][key.replace(`extra_${baseName}_`, '')] = sanitize(value);
                                        }
                                    }
                                }
                            });
                            const photoKey = `photo_${template.id}_${idx}`;
                            if(App.state.tempPhotos[photoKey]) {
                                if(!newReport.photos[template.id]) newReport.photos[template.id] = {};
                                newReport.photos[template.id][idx] = App.state.tempPhotos[photoKey];
                            }
                        }
                    });
                    return newReport;
                },
                onPrintDraft(form) {
                    const reportData = this.getReportDataFromForm(form);
                    App.ui.prepareAndPrintReport(reportData);
                }
            },
            
            templates: {
                dashboard: (stats, greeting, dueList) => {
                    const dueListHtml = dueList.length > 0
                        ? `<ul class="space-y-2">${dueList.map(item => `
                            <li class="p-3 rounded-lg bg-slate-100 dark:bg-slate-700/50">
                                <p class="font-semibold">${item.template.title}</p>
                                <p class="text-sm text-red-500">${item.status}</p>
                            </li>`).join('')}</ul>`
                        : `<p class="text-slate-500 dark:text-slate-400">Tutti i controlli periodici sono aggiornati.</p>`;
                    
                    return `
                    <div class="mb-8"><h2 class="text-3xl font-bold">${greeting}!</h2><p class="text-slate-500 dark:text-slate-400 mt-1">Riepilogo della situazione attuale.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${[{ label: 'Controlli Totali', value: stats.totalPca, color: 'blue' }, { label: 'NC Aperte', value: stats.openNc, color: 'red' }, { label: 'Conformità', value: stats.avgCompliance, color: 'green' }].map(card => `<div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border-l-4 border-${card.color}-500"><h3>${card.label}</h3><p class="text-3xl font-semibold">${card.value}</p></div>`).join('')}
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                        <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm" id="ncChartContainer"><h3 class="text-lg font-semibold mb-4">Non Conformità per Aspetto</h3><div class="relative h-96"><canvas id="ncChart"></canvas></div></div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><h3 class="text-lg font-semibold mb-4">PCA da Compilare</h3>${dueListHtml}</div>
                    </div>`;
                },
                pcaGroupedList: (groupedReports) => {
                    const wbsOrder = ['SOPRALLUOGHI', ...Object.keys(App.config.WBS_DATA)];
                    const sortedWbsKeys = Object.keys(groupedReports).sort((a, b) => wbsOrder.indexOf(a) - wbsOrder.indexOf(b));
                    return `<div class="space-y-6">
                        ${(sortedWbsKeys.length === 0) ? `<div class="text-center p-8 bg-white dark:bg-slate-800 rounded-lg"><h3 class="text-xl font-semibold">Nessun controllo trovato.</h3></div>` :
                            sortedWbsKeys.map(wbsKey => {
                                const reports = groupedReports[wbsKey] || [];
                                const wbsInfo = App.config.WBS_DATA[wbsKey] || { descrizione: 'Verbali di Sopralluogo' };
                                const typeLabels={'periodico':'Periodico','preliminare':'Preliminare','finale':'Finale', 'sopralluogo': 'Sopralluogo'};
                                return `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm overflow-hidden"><div class="grouped-pca-header p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100"><h3 class="text-lg font-semibold">${wbsInfo.descrizione}</h3><svg class="grouped-pca-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                                <div class="grouped-pca-content"><div class="overflow-x-auto"><table class="min-w-full text-sm">
                                <thead class="bg-slate-100 dark:bg-slate-800"><tr>${['ID','Data','Tipo','Oggetto/Lavorazione', 'Azioni'].map(h=>`<th class="p-3 text-left text-xs uppercase">${h}</th>`).join('')}</tr></thead>
                                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">${reports.map(r => `<tr>
                                    <td class="p-3 font-medium">${r.id}</td>
                                    <td class="p-3">${r.date}</td>
                                    <td class="p-3">${typeLabels[r.type]||'N.D.'}</td>
                                    <td class="p-3">${r.activities||r.observations?.sopralluogo?.substring(0,50)+'...'||'N.A.'}</td>
                                    <td class="p-3"><div class="flex gap-4">
                                        <button data-doc-id="${r.docId}" class="print-pca-btn text-slate-500 hover:text-blue-600" title="Stampa"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg></button>
                                        <button data-id="${r.id}" data-doc-id="${r.docId}" class="delete-pca-btn text-slate-500 hover:text-red-600" title="Elimina"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div></td></tr>`).join('')}</tbody></table></div></div></div>`;
                        }).join('')}</div>`;
                },
                imagePlaceholderIcon: () => `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`,
                photoPreview: (src, key) => `<div class="relative group"><img src="${src}" class="w-24 h-24 object-cover rounded-md"><button type="button" data-key="${key}" class="remove-photo-btn absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>`,
                photoUpload: (key) => `<div class="photo-upload-container mt-4"><label class="form-label mb-2 block">Rilievo Fotografico</label><div class="flex items-center gap-4"><div id="preview_${key}" class="w-24 h-24 bg-slate-100 dark:bg-slate-700 rounded-md flex items-center justify-center text-slate-400 border-2 border-dashed dark:border-slate-500">${App.templates.imagePlaceholderIcon()}</div><input type="file" accept="image/*" class="photo-input hidden" data-key="${key}"><button type="button" class="add-photo-btn btn btn-secondary text-sm">Aggiungi Foto</button></div></div>`,
                extraContent: {
                    'pca01_0': () => `<div><label class="form-label">N° Autorizzazione</label><input type="text" name="extra_check_pca01_0_auth" class="form-input"></div>`,
                    'pca01_1': () => `<div><label class="form-label">N° Autorizzazione</label><input type="text" name="extra_check_pca01_1_auth" class="form-input"></div>`,
                    'pca01_4': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca01_5': () => `<div><label class="form-label">Data Ultima Revisione</label><input type="date" name="extra_check_pca01_5_revisione" class="form-input"></div>`,
                    'pca02_0': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca02_1': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca02_2': () => `<div class="grid grid-cols-2 gap-4"><div><label class="form-label">N° DDT</label><input type="text" name="extra_check_pca02_2_ddt" class="form-input"></div><div><label class="form-label">Targa</label><input type="text" name="extra_check_pca02_2_targa" class="form-input"></div></div>`,
                    'pca03_0': () => `<div><label class="form-label">N° Autorizzazione</label><input type="text" name="extra_check_pca03_0_auth" class="form-input"></div>`,
                    'pca03_4': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca04_0': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca04_1': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca04_2': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca04_4': () => `<div><label class="form-label">N° FIR</label><input type="text" name="extra_check_pca04_4_fir" class="form-input"></div>`,
                    'pca05_1': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca06_0': () => `<div><label class="form-label">Rif. Autorizzazione</label><input type="text" name="extra_check_pca06_0_auth" class="form-input"></div>`,
                    'pca06_2': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca06_4': () => `<div><label class="form-label">Valore Misurato (dBA)</label><input type="number" step="0.1" name="extra_check_pca06_4_valore" class="form-input"></div>`,
                    'pca07_0': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                    'pca07_1': (id, idx) => App.templates.photoUpload(`photo_${id}_${idx}`),
                },
                renderChecklist(templates) {
                    return templates.map(t => {
                        const frequency = App.config.FREQUENCY_MAP[t.significativita];
                        const nextDueDate = new Date();
                        if (frequency) nextDueDate.setDate(nextDueDate.getDate() + frequency.days);
                        
                        return `<div id="accordion-${t.id}" class="pca-sheet-accordion bg-white dark:bg-slate-800 border rounded-lg" style="display:none;">
                        <div class="accordion-header p-4 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-3">${t.icon} ${t.title}</h3>
                                ${frequency ? `<p class="text-xs text-slate-500 mt-1">Frequenza: ${frequency.text}. Prossimo controllo: ${nextDueDate.toLocaleDateString('it-IT')}</p>` : ''}
                            </div>
                            <svg class="accordion-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="accordion-content p-4"><div class="space-y-3 divide-y dark:divide-slate-700">
                            ${t.items.map((item, idx) => {
                                const baseName = `check_${t.id}_${idx}`;
                                const extraContentKey = `${t.id}_${idx}`;
                                const extraContentHTML = this.extraContent[extraContentKey] ? this.extraContent[extraContentKey](t.id, idx) : '';
                                return `<div class="pt-4 first:pt-0">
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                                    <label for="${baseName}_C" class="mr-4 text-sm flex-1">${item}</label>
                                    <div class="flex items-center gap-x-5 text-sm flex-shrink-0">
                                        ${['C', 'NC', 'NA'].map(val => `<div><input id="${baseName}_${val}" name="${baseName}" type="radio" value="${val}" class="form-checkbox" ${val==='NA'?'checked':''}> <label for="${baseName}_${val}" class="ml-2">${val==='C'?'Sì':(val==='NC'?'No':'N.A.')}</label></div>`).join('')}
                                    </div>
                                </div>
                                ${extraContentHTML ? `<div id="extra_content_wrapper_${baseName}" class="extra-content-wrapper"><div class="extra-content-inner">${extraContentHTML}</div></div>` : ''}
                            </div>`}).join('')}
                        </div>
                        <div class="mt-4 p-4 border-t dark:border-slate-700"><label class="form-label mb-2 block">Osservazioni</label><textarea name="observation_${t.id}" class="form-textarea" rows="3"></textarea></div></div>
                    </div>`}).join('');
                },
                newPcaForm: ({ nextId, today }) => `
                    <form id="new-pca-form" novalidate class="space-y-8">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                            <h2 class="text-xl font-bold mb-6 border-b pb-4">Dati Generali</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="pca-id" class="form-label">Verbale N°</label><input type="number" id="pca-id" name="id" value="${nextId}" required class="form-input"></div>
                                <div><label for="pca-date" class="form-label">Data</label><input type="date" id="pca-date" name="date" value="${today}" required class="form-input"></div>
                                <div class="md:col-span-2"><label for="pca-type" class="form-label">Tipo Controllo</label><select id="pca-type" name="type" required class="form-select"><option value="periodico" selected>Periodico</option><option value="preliminare">Preliminare</option><option value="finale">Finale</option></select></div>
                            </div>
                            <div id="wbs-section" class="mt-6 space-y-4">
                                <div><label for="pca-wbs-input" class="form-label">Codice WBS</label><input type="text" id="pca-wbs-input" name="wbs-input" placeholder="Es. RI12, GA01..." class="form-input"></div>
                                <div><label for="pca-lavorazione-select" class="form-label">Lavorazione</label><select id="pca-lavorazione-select" name="lavorazione" disabled class="form-select"><option value="">-- Prima inserisci WBS --</option></select></div>
                                <div><label for="pca-inspector-wbs" class="form-label">Compilatore</label><input type="text" id="pca-inspector-wbs" name="inspector-wbs" class="form-input"></div>
                            </div>
                            <div id="manual-section" style="display: none;" class="mt-6 space-y-4">
                                <div><label for="wbs-manual" class="form-label">Area</label><input id="wbs-manual" name="wbs-manual" class="form-input"></div>
                                <div><label for="activities-manual" class="form-label">Oggetto</label><textarea id="activities-manual" name="activities-manual" rows="2" class="form-textarea"></textarea></div>
                                <div><label for="inspector-manual" class="form-label">Compilatore</label><input id="inspector-manual" name="inspector-manual" class="form-input"></div>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold mb-6 border-b pb-4">Checklist</h2>
                            <div id="checklist-container-periodico" class="space-y-4">${App.templates.renderChecklist(App.config.CHECK_TEMPLATES_PERIODIC)}</div>
                            <div id="checklist-container-preliminare" style="display: none;" class="space-y-4">${App.templates.renderChecklist(App.config.CHECK_TEMPLATES_PRELIMINARE)}</div>
                            <div id="checklist-container-finale" style="display: none;" class="space-y-4">${App.templates.renderChecklist(App.config.CHECK_TEMPLATES_FINALE)}</div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="print-draft-btn" class="btn btn-secondary">Stampa Bozza</button>
                            <button type="submit" id="save-pca-btn" class="btn btn-primary">Salva Controllo</button>
                        </div>
                    </form>`,
                newSopralluogoForm({ nextId, today }) {
                    return `<form id="new-sopralluogo-form" novalidate class="space-y-8">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                            <h2 class="text-xl font-bold mb-6 border-b pb-4">1. Dati Generali</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="sopralluogo-id" class="form-label">Verbale N°</label><input type="number" id="sopralluogo-id" name="id" value="${nextId}" required class="form-input"></div>
                                <div><label for="sopralluogo-date" class="form-label">Data</label><input type="date" id="sopralluogo-date" name="date" value="${today}" required class="form-input"></div>
                                <div><label for="sopralluogo-wbs" class="form-label">Area / WBS</label><input id="sopralluogo-wbs" name="wbs" required class="form-input" placeholder="Es. Campo Base, GA01..."></div>
                                <div><label for="sopralluogo-inspector" class="form-label">Compilatore</label><input id="sopralluogo-inspector" name="inspector" required class="form-input" placeholder="Nome e Funzione"></div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                            <h2 class="text-xl font-bold mb-4 border-b pb-4">2. Condizioni al Contorno</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><h3 class="font-semibold">Posizione Rilevata</h3><p id="sopralluogo-position-display" class="text-slate-500">Recupero coordinate...</p></div>
                                <div><h3 class="font-semibold">Condizioni Meteo</h3><div id="sopralluogo-weather-display" class="flex items-center gap-2"><div class="loader"></div></div></div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                            <h2 class="text-xl font-bold mb-4 border-b pb-4">3. Osservazioni del Sopralluogo</h2>
                            <textarea id="sopralluogo-observations" name="observations" class="form-textarea" rows="10" placeholder="Descrivere qui le osservazioni..."></textarea>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                            <h2 class="text-xl font-bold mb-4 border-b pb-4">4. Rilievo Fotografico (max 8)</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${Array.from({ length: 8 }).map((_, i) => this.photoUpload(`sopralluogo_photo_${i}`)).join('')}
                            </div>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="print-draft-btn" class="btn btn-secondary">Stampa Bozza</button>
                            <button type="submit" id="save-sopralluogo-btn" class="btn btn-primary">Salva Verbale</button>
                        </div>
                    </form>`;
                },
                settings: () => `<div class="space-y-8 max-w-2xl">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold mb-2">Archiviazione Dati</h2>
                        <p class="text-slate-500 dark:text-slate-400 mb-4 text-sm">Salva una copia di sicurezza o ripristina i dati da un backup.</p>
                        <div class="flex gap-4 flex-wrap">
                            <button id="export-btn" class="btn btn-primary">Esporta Dati</button>
                            <button id="import-btn" class="btn btn-secondary">Importa Dati</button>
                            <input type="file" id="import-file" class="hidden" accept=".json">
                        </div>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 p-6 rounded-lg border border-red-200 dark:border-red-800">
                        <h2 class="text-xl font-bold mb-2 text-red-600 dark:text-red-400">Zona Pericolo</h2>
                        <p class="text-red-800/80 dark:text-red-300/80 mb-4 text-sm">L'azione seguente è irreversibile.</p>
                        <button id="clear-all-btn" class="btn btn-danger">Svuota Archivio Dati</button>
                    </div>
                </div>`,
                printReport(report, templates) {
                    const chrysasLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/LOGOCHRYSAS.bmp';
                    const rtiLogoUrl = 'https://raw.githubusercontent.com/fifich98/app-gestione-pca/main/RTI.bmp';
                    const typeLabels = { 'periodico': 'Controllo Periodico Ambientale', 'preliminare': 'Ispezione Preliminare', 'finale': 'Ispezione Finale', 'sopralluogo': 'Verbale di Sopralluogo'};
                    const renderPhoto = (photoUrl) => photoUrl ? `<div style="margin-top: 8px;"><img src="${photoUrl}" style="max-width: 350px; max-height: 350px; border-radius: 4px; border: 1px solid #ddd;" alt="Foto allegata"></div>` : '';
                    
                    const bodySopralluogo = `<div class="no-break">
                        <h2 style="font-size: 1.3rem; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem;">Osservazioni</h2>
                        <p style="font-size: 10pt; white-space: pre-wrap;">${report.observations?.sopralluogo || 'Nessuna osservazione.'}</p>
                        <h2 style="font-size: 1.3rem; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem;">Rilievo Fotografico</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            ${(report.photos?.sopralluogo || []).map(url => renderPhoto(url)).join('') || '<p>Nessuna foto allegata.</p>'}
                        </div>
                    </div>`;
                    const bodyPca = templates.map(t => {
                        const checks = report.checks ? report.checks[t.id] : null; if (!checks) return '';
                        return `<div class="no-break" style="margin-bottom: 2rem;">
                            <h2 style="font-size: 1.3rem; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem;">${t.icon} ${t.title}</h2>
                            <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                            ${checks.map((item, idx) => `<tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 8px 0; vertical-align: top;">
                                    ${item.item}
                                    ${renderPhoto(report.photos?.[t.id]?.[idx])}
                                </td>
                                <td style="padding: 8px 0; text-align: right; font-weight: bold; width: 80px; vertical-align: top;">${item.result || 'N.D.'}</td>
                            </tr>`).join('')}
                            </table>
                            ${report.observations?.[t.id] ? `<div class="no-break" style="background: #f8f8f8; padding: 1rem; margin-top: 1rem; border-radius: 4px;"><h3 style="font-weight: bold; margin-bottom: 0.5rem;">Osservazioni</h3><p style="font-size: 10pt; white-space: pre-wrap;">${report.observations[t.id]}</p></div>` : ''}
                        </div>`;
                    }).join('');
                    
                    return `<div id="print-area">
                        <header class="print-header"><table style="width:100%; border-bottom: 2px solid #000;"><tr>
                            <td style="width:50%;"><img src="${chrysasLogoUrl}" alt="Logo CHRYSAS" style="height: 40px;"></td>
                            <td style="width:50%; text-align:right;"><img src="${rtiLogoUrl}" alt="Logo RTI" style="height: 50px;"></td>
                        </tr></table></header>
                        <h1 style="text-align: center; font-size: 1.5rem; margin: 1.5rem 0;">${typeLabels[report.type]} - Verbale N° ${report.id}</h1>
                        <table class="no-break" style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 10pt;">
                            <tr><td style="padding: 8px; border: 1px solid #bbb; font-weight: bold; background: #f2f2f2;">Data</td><td style="padding: 8px; border: 1px solid #bbb;">${new Date(report.date).toLocaleDateString('it-IT')}</td><td style="padding: 8px; border: 1px solid #bbb; font-weight: bold; background: #f2f2f2;">WBS/Area</td><td style="padding: 8px; border: 1px solid #bbb;">${report.wbs || 'N.A.'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #bbb; font-weight: bold; background: #f2f2f2;">Oggetto/Lavorazione</td><td style="padding: 8px; border: 1px solid #bbb;" colspan="3">${report.activities || 'N.A.'}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #bbb; font-weight: bold; background: #f2f2f2;">Compilato da</td><td style="padding: 8px; border: 1px solid #bbb;" colspan="3">${report.inspector || 'N.D.'}</td></tr>
                        </table>
                        ${report.type === 'sopralluogo' ? bodySopralluogo : bodyPca}
                        <footer class="print-footer"><div style="text-align: center; font-size: 8pt; color: #888; border-top: 1px solid #ccc; padding-top: 5px;">Documento generato il ${new Date().toLocaleDateString('it-IT')}</div></footer>
                    </div>`;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => { App.init(); });
    </script>
</body>
</html>
